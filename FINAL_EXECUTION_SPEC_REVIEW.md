# ìµœì¢… ì‹¤í–‰ ìŠ¤í™ ê²€í†  ë³´ê³ ì„œ

## âš ï¸ SSOT ì„ ì–¸ (ë‹¨ì¼ ì§„ì‹¤ ì›ì²œ) - í•„ìˆ˜ ê³ ì •

**ì´ ë¬¸ì„œëŠ” ì‹œìŠ¤í…œì˜ ë‹¨ì¼ ì§„ì‹¤ ì›ì²œ(SSOT)ì…ë‹ˆë‹¤. ëª¨ë“  êµ¬í˜„ì€ ì´ ê·œì¹™ì„ ë”°ë¼ì•¼ í•©ë‹ˆë‹¤.**

### í•µì‹¬ SSOT ê·œì¹™

1. **`orders.status`ëŠ” ì§‘ê³„ ê²°ê³¼(ë·°/í‘œì‹œìš©)ì´ë©°, ì§ì ‘ ì •ì±… íŒë‹¨ ê¸°ì¤€ìœ¼ë¡œ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤.**
   - í™˜ë¶ˆ/ì–‘ë„/ì œì¬ íŒë‹¨ì€ `warranties.status`ë¥¼ ê¸°ì¤€ìœ¼ë¡œ í•œë‹¤.
   - `orders.status`ëŠ” ì§‘ê³„ í•¨ìˆ˜ë¡œë§Œ ê°±ì‹ ë˜ë©°, ê´€ë¦¬ì ìˆ˜ë™ ìˆ˜ì • ê¸ˆì§€.

2. **`order_item_units.unit_status`ëŠ” ë¬¼ë¥˜ ë‹¨ìœ„ ìƒíƒœ(ë°°ì†¡/ì¬ê³  íë¦„)ì˜ ì§„ì‹¤ ì›ì²œì´ë‹¤.**
   - ë°°ì†¡ ìƒíƒœ íŒë‹¨ì€ `unit_status`ë¥¼ ê¸°ì¤€ìœ¼ë¡œ í•œë‹¤.
   - `orders.status`ëŠ” `unit_status` ì§‘ê³„ ê²°ê³¼ì¼ ë¿ì´ë‹¤.

3. **`stock_units.status`ëŠ” ì‹¤ë¬¼ ì¬ê³  ìƒíƒœì˜ ì§„ì‹¤ ì›ì²œì´ë‹¤.**
   - **ì±…ì„ ê²½ê³„:** ì¬íŒë§¤ ê°€ëŠ¥ ì—¬ë¶€ì˜ ìµœì¢… ê²Œì´íŠ¸ëŠ” **`stock_units.status = 'in_stock'`** ì´ë‹¤. (Paid íŠ¸ëœì­ì…˜ì€ ì˜¤ì§ ì´ ì¡°ê±´ë§Œ ë³¸ë‹¤).

4. **`warranties.status`ëŠ” ê¶Œë¦¬/ì •ì±… ìƒíƒœ(í™œì„±í™”/ì–‘ë„/í™˜ë¶ˆ ê°€ëŠ¥ ì—¬ë¶€)ì˜ ì§„ì‹¤ ì›ì²œì´ë‹¤.**
   - í™˜ë¶ˆ ê°€ëŠ¥ ì—¬ë¶€ íŒì •ì€ `warranties.status`ë§Œ ë³¸ë‹¤.
   - í™œì„±í™” ê°€ëŠ¥ ì—¬ë¶€ íŒì •ì€ `warranties.status`ë¥¼ 1ì°¨ ê¸°ì¤€ìœ¼ë¡œ í•˜ë˜, **ì£¼ë¬¸ ê·€ì† ê²€ì¦(`orders.user_id`)**ê³¼ **Refunded ì—¬ë¶€**ë¥¼ í•¨ê»˜ í™•ì¸í•œë‹¤.

5. **`invoices`ëŠ” ë¬¸ì„œ(ìŠ¤ëƒ…ìƒ·)ì´ë©°, "ê¶Œë¦¬ íŒë‹¨ ê¸°ì¤€"ì´ ì•„ë‹ˆë¼ "ì¦ë¹™/ì¡°íšŒ" ì—­í• ì´ë‹¤.**
   - í™œì„±í™”/í™˜ë¶ˆ íŒì •ì— `invoices`ë¥¼ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤.
   - `invoices`ëŠ” ë°œê¸‰ ì‹œì ì˜ ì£¼ë¬¸ ì •ë³´ë¥¼ ê³ ì • ì €ì¥í•˜ëŠ” ìŠ¤ëƒ…ìƒ·ì¼ ë¿ì´ë‹¤.

### ì „ì—­ ì •í•©ì„± ê·œì¹™

1. **ì „ì—­ ë½ ìˆœì„œ(í•„ìˆ˜):** `stock_units`(ë¬¼ë¦¬) â†’ `orders`(ê²°ì œ) â†’ `warranties`(ê¶Œë¦¬) â†’ `invoices`(ë¬¸ì„œ)

2. **ì „ì—­ ì›ìì„± ê·œì¹™(í•„ìˆ˜):** ìƒíƒœ ì „ì´ëŠ” `UPDATE ... WHERE ì¡°ê±´`ìœ¼ë¡œë§Œ ìˆ˜í–‰í•˜ë©° `affectedRows=1` ê²€ì¦ í•„ìˆ˜.

3. **ì „ì—­ ìœ ë‹ˆí¬ ì œì•½(í•„ìˆ˜ - DB ë ˆë²¨ ê°•ì œ):**
   - `order_idempotency`: `UNIQUE(owner_key, idem_key)`
   - `paid_events`: `UNIQUE(order_id, payment_key)`
   - **`order_item_units` (ì´ì¤‘ íŒë§¤ ë°©ì§€ - MySQL íŒ¨í„´):**
     - **`UNIQUE(stock_unit_id, active_lock)`**
     - **`active_lock` ì •ì˜:** `CASE WHEN unit_status IN ('reserved', 'shipped', 'delivered') THEN 1 ELSE NULL END`
     - **ìš´ì˜ ê·œì¹™:** ìœ„ ìƒíƒœ ì§‘í•©ì€ ì‹¤ì œ `order_item_units` í…Œì´ë¸”ì˜ ENUMê³¼ ì¼ì¹˜í•´ì•¼ í•˜ë©°, ì‹ ê·œ ìƒíƒœ ì¶”ê°€ ì‹œ `active_lock` ì •ì˜ë¥¼ ê°±ì‹ í•´ì•¼ í•œë‹¤.
   - `warranties`: `UNIQUE(token_pk)` (í† í°ë‹¹ ë ˆì½”ë“œ 1ê°œ ê°•ì œ)
   - `invoices`: `UNIQUE(invoice_number)`, `UNIQUE(invoice_group_id, invoice_part_no)`

4. **í† í° ì²´ê³„(í•„ìˆ˜):** ë¹„íšŒì› ì¡°íšŒëŠ” `guest_order_access_token`(90ì¼), Claimì€ `claim_token`(ë‹¨ê¸°)ìœ¼ë¡œ ì² ì €íˆ ë¶„ë¦¬.

5. **ì–‘ë„ ìš”ì²­ ë‹¨ì¼í™”(í•„ìˆ˜):** `warranty_id`ë‹¹ `requested` ìƒíƒœëŠ” 1ê°œë§Œ ìœ ì§€ (ì·¨ì†Œ í›„ ì¬ìƒì„±).

---

## ğŸ“‹ ê²€í†  ê°œìš”

ìµœì¢… ì‹¤í–‰ ìŠ¤í™ì„ í˜„ì¬ ì‹œìŠ¤í…œê³¼ ë¹„êµí•˜ì—¬ **êµ¬í˜„ ê°€ëŠ¥ì„±**, **í˜¸í™˜ì„±**, **ì ì¬ì  ë¬¸ì œì **, **ê°œì„  ì œì•ˆ**ì„ ìƒì„¸íˆ ë¶„ì„í•©ë‹ˆë‹¤.

---

## ğŸ“Š í•µì‹¬ ê·œì¹™ í‘œ (ë¬¸ì„œ ìƒë‹¨ ê³ ì •)

### 1. orders.status ì§‘ê³„ ê·œì¹™ í‘œ

| ì§‘ê³„ ìƒíƒœ | ì¡°ê±´ | ë¹„ê³  |
|----------|------|------|
| `pending` | `paid_events` ì—†ìŒ (ë˜ëŠ” `paid_at` NULL) | ê²°ì œ ì „ |
| `paid` | `paid_events` ì¡´ì¬ (ë˜ëŠ” `paid_at` NOT NULL) AND `unit`ì´ 1ê°œ ì´ìƒ `reserved` ì´ìƒ ì¡´ì¬ | ê²°ì œ ì™„ë£Œ |
| `partial_shipped` | ì¼ë¶€ `unit` `shipped` ì´ìƒ, ì¼ë¶€ëŠ” `reserved` | ë¶€ë¶„ ë°°ì†¡ (í™•ì •) |
| `shipped` | ëª¨ë“  `unit` `shipped` ì´ìƒ | ì „ì²´ ë°°ì†¡ |
| `partial_delivered` | ì¼ë¶€ `delivered` ì´ìƒ, ì¼ë¶€ `shipped` | ë¶€ë¶„ ë°°ì†¡ ì™„ë£Œ (í™•ì •) |
| `delivered` | ëª¨ë“  `unit` `delivered` ì´ìƒ | ì „ì²´ ë°°ì†¡ ì™„ë£Œ |
| `refunded` | ëª¨ë“  `unit`ì´ í™˜ë¶ˆ ìµœì¢… ìƒíƒœ ë„ë‹¬ | í™˜ë¶ˆ ì™„ë£Œ |
| `payment_failed` | (í™•ì¥ ì˜µì…˜) ê²°ì œ ì‹¤íŒ¨ ì´ë²¤íŠ¸ ë°œìƒ, `paid_events` ì—†ìŒ | í‘œì‹œìš©, ìš´ì˜ ìš”êµ¬ ì‹œ ì¶”ê°€ |
| `payment_expired` | (í™•ì¥ ì˜µì…˜) ê²°ì œ ë§Œë£Œ ì´ë²¤íŠ¸ ë°œìƒ, `paid_events` ì—†ìŒ | í‘œì‹œìš©, ìš´ì˜ ìš”êµ¬ ì‹œ ì¶”ê°€ |

**ê·œì¹™ ê³ ì • ë¬¸ì¥**:
- `orders.status`ëŠ” ê³„ì‚° ê²°ê³¼ë‹¤ (ì§‘ê³„ í•¨ìˆ˜ë¡œë§Œ ê°±ì‹ )
- íŒì •ì— ì‚¬ìš© ê¸ˆì§€ (í™˜ë¶ˆ/ì–‘ë„/ì œì¬ íŒë‹¨ì€ `warranties.status`)
- ê´€ë¦¬ì ìˆ˜ë™ ìˆ˜ì • ê¸ˆì§€ (ê¸°ì¡´ `PUT /api/admin/orders/:orderId/status` APIëŠ” ì œê±° ë˜ëŠ” ì§‘ê³„ í•¨ìˆ˜ë¡œ ëŒ€ì²´)
- `partial_*` ì‚¬ìš© í™•ì • (ì„ íƒì´ ì•„ë‹˜)
- **ê²°ì œ SSOT ê³ ì •**: `paid_events` ì¡´ì¬ê°€ SSOTì´ë©°, `paid_at`ì€ ìºì‹œ/íŒŒìƒ í•„ë“œ. `paid_events` ì¡´ì¬í•˜ì§€ë§Œ `paid_at`ì´ NULLì¸ ìƒíƒœëŠ” ê¸ˆì§€(ë™ê¸°í™” í•„ìˆ˜)
- **í™•ì¥ ìƒíƒœ ì •ì±…**: `payment_failed`/`payment_expired`ëŠ” `paid_events` ì¡´ì¬ ì‹œ ë” ì´ìƒ active ìƒíƒœë¡œ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ(íˆìŠ¤í† ë¦¬ë¡œë§Œ ë‚¨ìŒ). ìš°ì„ ìˆœìœ„: `paid` > `payment_failed`/`payment_expired` > `pending`
- ì¶”ê°€ ìƒíƒœì˜ ì…ë ¥/ê°±ì‹ ë„ ì§‘ê³„ í•¨ìˆ˜(ë˜ëŠ” ê²°ì œ ì´ë²¤íŠ¸ ì§‘ê³„ í•¨ìˆ˜)ë¡œë§Œ ê°±ì‹ 

### 2. shipments + shipment_units ëª¨ë¸ í™•ì • í‘œ (Bì•ˆ: ìš´ì˜í˜•)

| í…Œì´ë¸” | ì»¬ëŸ¼ | ì œì•½ | ë¹„ê³  |
|--------|------|------|------|
| `shipments` | `shipment_id` (PK) | - | ì†¡ì¥ ì •ë³´ |
| | `order_id` (FK) | - | ì£¼ë¬¸ ì—°ê²° |
| | `carrier_code` | NOT NULL | íƒë°°ì‚¬ ì½”ë“œ |
| | `tracking_number` | NOT NULL | ì†¡ì¥ë²ˆí˜¸ |
| | `active_key` | GENERATED ALWAYS AS (CASE WHEN voided_at IS NULL THEN CONCAT(carrier_code, ':', tracking_number) ELSE NULL END) | ìœ íš¨ ì†¡ì¥ í‚¤ (B-2 í™•ì •) |
| | - | UNIQUE(active_key) | ìœ íš¨ shipmentë§Œ ì¤‘ë³µ ê¸ˆì§€ (B-2 í™•ì •) |
| | `shipped_at` | - | ë°œì†¡ ì‹œê° |
| | `created_by_admin_id` | - | ê´€ë¦¬ì ID |
| | `voided_at` | NULL | ë¬´íš¨í™” ì‹œê° (Bì•ˆ í•µì‹¬) |
| | `void_reason` | NULL | ë¬´íš¨í™” ì‚¬ìœ  (Bì•ˆ í•µì‹¬) |
| `shipment_units` | `shipment_id` (FK) | - | ì†¡ì¥ ì—°ê²° |
| | `order_item_unit_id` (FK) | - | ì‹¤ë¬¼ ì—°ê²° |
| | - | PRIMARY KEY (shipment_id, order_item_unit_id) | ë³µí•©í‚¤, ì´ë ¥ í—ˆìš© (Bì•ˆ) |
| `order_item_units` | `current_shipment_id` (FK) | NULL | í˜„ì¬ ìœ íš¨ ì†¡ì¥ (Bì•ˆ í•µì‹¬) |

**Bì•ˆ í™•ì • ê·œì¹™ (8ì¤„ ê³ ì •)**:
1. **ì†¡ì¥ ìœ ë‹ˆí¬ ì •ì±…(í™•ì •)**: ìœ íš¨ shipment(`voided_at IS NULL`)ì— ëŒ€í•´ì„œë§Œ `(carrier_code, tracking_number)` ì¤‘ë³µ ê¸ˆì§€
2. **êµ¬í˜„(í™•ì •)**: generated column `active_key` + `UNIQUE(active_key)`. (ê¸°ì¡´ `UNIQUE(carrier_code, tracking_number)` ì‚¬ìš© ê¸ˆì§€)
3. **shipmentsëŠ” ì‚­ì œ ê¸ˆì§€. voidë§Œ í—ˆìš©**
4. **replace(êµì²´)ëŠ” void + ì‹ ê·œ shipment ìƒì„± + shipment_units ì¬ë§¤í•‘ + current_shipment_id ê°±ì‹ ì„ í•œ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ìˆ˜í–‰**
5. **current_shipment_idê°€ NULLì´ ì•„ë‹ˆë©´, shipment_unitsì— `(current_shipment_id, order_item_unit_id)` í–‰ì´ ë°˜ë“œì‹œ ì¡´ì¬í•´ì•¼ í•¨**
6. **current_shipment_idëŠ” ìœ íš¨ shipment(`voided_at IS NULL`)ë§Œ ì°¸ì¡° ê°€ëŠ¥**
7. **delivered ì´í›„ replace ê¸ˆì§€. delivered ì´í›„ resendëŠ” "ì¶”ê°€ shipment ìƒì„±"ë§Œ í—ˆìš©**
8. **delivered ì´í›„ resendëŠ” orders.statusë¥¼ ë³€ê²½í•˜ì§€ ì•Šìœ¼ë©°, ìš´ì˜ UIëŠ” shipment ë ˆì´ì–´ì—ì„œ ì¬ë°°ì†¡ ìƒíƒœë¥¼ í‘œì‹œ**

**ì•ˆì „ ì¡°ê±´(í•„ìˆ˜)**:
- `carrier_code`, `tracking_number`ëŠ” `NOT NULL` ê³ ì •
- voidëŠ” `voided_at`ì„ ì±„ìš°ëŠ” ë°©ì‹ìœ¼ë¡œë§Œ ìˆ˜í–‰(ì‚­ì œ ê¸ˆì§€)
- `active_key`ëŠ” `voided_at` ë³€í™”ì— ë”°ë¼ ê°’/NULLì´ ìë™ìœ¼ë¡œ ë°”ë€Œì–´ì•¼ í•¨
- `current_shipment_id` ì •í•©ì„±ì€ API íŠ¸ëœì­ì…˜ìœ¼ë¡œ ë³´ì¥í•˜ë©°, ì‹¤íŒ¨ ì‹œ ì „ì²´ ë¡¤ë°±

**ì¤‘ë³µ ë§¤í•‘ í—ˆìš© ë²”ìœ„(í™•ì •)**:
- **"ë™ì‹œ ìœ íš¨ shipment ê¸ˆì§€" ì •ì˜**: í•œ `order_item_unit`ì€ 'í˜„ì¬ ìœ íš¨ shipment' ê´€ì ì—ì„œ `current_shipment_id`ë¡œ ë‹¨ í•˜ë‚˜ë§Œ ëŒ€í‘œëœë‹¤
- **shipment_units ì´ë ¥ ì •ì±…**: `shipment_units`ì—ëŠ” ê³¼ê±° shipment ë§¤í•‘ ì´ë ¥ì´ ë³µìˆ˜ ì¡´ì¬í•  ìˆ˜ ìˆìœ¼ë‚˜, `current_shipment_id`ê°€ ê°€ë¦¬í‚¤ëŠ” shipmentì— ëŒ€í•œ ë§¤í•‘ì€ ë°˜ë“œì‹œ ì¡´ì¬í•´ì•¼ í•œë‹¤(ê·œì¹™ 5ë²ˆ)
- **replace íŠ¸ëœì­ì…˜ ì™„ë£Œ ì¡°ê±´**: replace íŠ¸ëœì­ì…˜ì´ ì™„ë£Œë˜ë©´, `current_shipment_id`ê°€ ê°€ë¦¬í‚¤ëŠ” shipmentëŠ” `voided_at IS NULL`ì´ì–´ì•¼ í•œë‹¤(ê·œì¹™ 6ë²ˆ)
- **êµ¬í˜„ ê¸ˆì§€**: `shipment_units` ë ˆë²¨ì—ì„œ `order_item_unit_id`ì— ëŒ€í•œ UNIQUE ì œì•½ì„ ì¶”ê°€í•˜ëŠ” í–‰ìœ„ëŠ” ê¸ˆì§€(ì´ë ¥ ë³´ì¡´ ëª©ì ê³¼ ì¶©ëŒ)

### 2-1. FK ì‚­ì œ ì •ì±… í‘œ (ì‹ ê·œ)

| FK ê´€ê³„ | í˜„ì¬ ì •ì±… | ìˆ˜ì • ì •ì±… | ë¹„ê³  |
|---------|----------|----------|------|
| `warranties.token_pk` â†’ `token_master.token_pk` | - | `ON DELETE RESTRICT` | token_master ì‚­ì œ ê¸ˆì§€ |
| `warranties.owner_user_id` â†’ `users.user_id` | `ON DELETE RESTRICT` | `ON DELETE RESTRICT` | ìœ ì§€ |
| `order_item_units.current_shipment_id` â†’ `shipments.shipment_id` | - | `ON DELETE RESTRICT` | shipment ì‚­ì œ ê¸ˆì§€ |

**ì›ì¹™ ê³ ì • ë¬¸ì¥**:
- `token_master`ëŠ” ì‚­ì œ ê¸ˆì§€ (ìš´ì˜ ì •ì±…)
- ëª¨ë“  `token_pk` ì°¸ì¡° FKëŠ” `ON DELETE RESTRICT` (ë˜ëŠ” `NO ACTION`)
- ìì‹ ì»¬ëŸ¼(`token_pk`)ì€ `NOT NULL` ìœ ì§€
- ì˜ˆì™¸: ì—†ìŒ (ì˜ˆì™¸ê°€ ìˆìœ¼ë©´ ë¬¸ì„œì— ì˜ˆì™¸ ì¡°ê±´/ì ˆì°¨ ì¶”ê°€)

### 2-2. ì¬ë°œì†¡/ì†¡ì¥ êµì²´ ì •ì±… í‘œ (ì‹ ê·œ, Bì•ˆ í™•ì •)

| ì •ì±… | ì„ íƒ | ì„¤ëª… |
|------|------|------|
| **ì˜µì…˜ 1 (ê°•ê²½/ë‹¨ìˆœ)** | âŒ ì±„íƒ ì•ˆ í•¨ | ì¬ë°œì†¡/êµì²´ ë¶ˆí—ˆ, `order_item_unit_id UNIQUE` ìœ ì§€ |
| **ì˜µì…˜ 2 (ìš´ì˜í˜• ê¶Œì¥)** | âœ… **ì±„íƒ** | ì¬ë°œì†¡/êµì²´ í—ˆìš© + ì´ë ¥ ìœ ì§€ (Bì•ˆ) |

**Bì•ˆ (ì˜µì…˜ 2) í™•ì • ê·œì¹™**:
- `shipment_units`: `(shipment_id, order_item_unit_id)` ë³µí•©í‚¤ë¡œ ì´ë ¥ í—ˆìš©
- `order_item_units.current_shipment_id`: "í˜„ì¬ ìœ íš¨ ì†¡ì¥" 1ê°œ ê³ ì •
- `shipments.voided_at`/`void_reason`: ë¬´íš¨í™” ì²˜ë¦¬
- **ì†¡ì¥ êµì²´ íë¦„(í™•ì •)**:
  1. ê¸°ì¡´ shipmentë¥¼ `voided_at` + `void_reason`ìœ¼ë¡œ ë¬´íš¨í™”
  2. ìƒˆ shipment ìƒì„±
  3. `shipment_units`ì— ë™ì¼ unit ì¬ë§¤í•‘
  4. `order_item_units.current_shipment_id`ë¥¼ ìƒˆ shipmentë¡œ êµì²´
  5. `unit_status`ëŠ” `shipped` ìœ ì§€ (ë˜ëŒë¦¬ì§€ ì•ŠìŒ)
- **í•µì‹¬ ê¸ˆì§€**: "shipment ì—†ì´ `shipped`ë¡œ ë°”ê¾¸ê¸°"ëŠ” ê·¸ëŒ€ë¡œ ê¸ˆì§€ ìœ ì§€
- **RESTRICT ì •ì±…**: `shipments`ëŠ” ì‚­ì œ ê¸ˆì§€(`ON DELETE RESTRICT`). êµì²´ëŠ” void + ì‹ ê·œ shipment ìƒì„± + `current_shipment_id` ê°±ì‹ ì„ 'ì›ìì ìœ¼ë¡œ ê°•ì œ'í•œë‹¤

### 3. ê´€ë¦¬ì í˜ì´ì§€ ì •ë³´ êµ¬ì¡° (í™•ì •)

**ê´€ë¦¬ìê°€ í•„ìš”í•œ ì •ë³´ (ë°°ì†¡/í™˜ë¶ˆ ì²˜ë¦¬ í•„ìˆ˜)**:
- **ì£¼ë¬¸ ì •ë³´** (`orders`): ì£¼ë¬¸ë²ˆí˜¸, ê³ ê° ì •ë³´, ì£¼ë¬¸ ìƒíƒœ, ê²°ì œ ì •ë³´ ë“±
- **ì£¼ë¬¸ í•­ëª©** (`order_items`): ì œí’ˆëª…, ìˆ˜ëŸ‰, ê°€ê²© ë“±
- **ì£¼ë¬¸ í•­ëª© ë‹¨ìœ„** (`order_item_units`): ì‹œë¦¬ì–¼ ë„˜ë²„, í† í° ì •ë³´ (`token_master.token` - ë‚œìˆ˜ 20ì), ë°°ì†¡ ìƒíƒœ, ë³´ì¦ì„œ ìƒíƒœ ë“±
- **ë°°ì†¡ ì •ë³´** (`shipments`, `shipment_units`): ì†¡ì¥ë²ˆí˜¸, íƒë°°ì‚¬, ë°°ì†¡ ìƒíƒœ ë“±

**ê´€ë¦¬ì í˜ì´ì§€ ê¸°ëŠ¥**:
1. **ì£¼ë¬¸ ëª©ë¡**: ì£¼ë¬¸ ê²€ìƒ‰/í•„í„°, ì£¼ë¬¸ ìƒíƒœ í™•ì¸
2. **ì£¼ë¬¸ ìƒì„¸ (3ë‹¨ êµ¬ì¡°)**:
   - 1ë‹¨: ì£¼ë¬¸ ì •ë³´ (`orders`)
   - 2ë‹¨: ì£¼ë¬¸ í•­ëª© (`order_items`)
   - 3ë‹¨: ì£¼ë¬¸ í•­ëª© ë‹¨ìœ„ (`order_item_units`) - **ì‹œë¦¬ì–¼ ë„˜ë²„ì™€ í† í°(ë‚œìˆ˜ 20ì) í™•ì¸ í•„ìˆ˜**
3. **ë°°ì†¡ ì²˜ë¦¬**: ì‹œë¦¬ì–¼ ë„˜ë²„ì™€ í† í°ì„ í™•ì¸í•˜ì—¬ í˜„ì‹¤ì—ì„œ í•´ë‹¹ ì œí’ˆì„ ì°¾ì•„ ì†¡ì¥ ìƒì„±
4. **í™˜ë¶ˆ ì²˜ë¦¬**: ì‹œë¦¬ì–¼ ë„˜ë²„ì™€ í† í°ì„ í™•ì¸í•˜ì—¬ í˜„ì‹¤ì—ì„œ í•´ë‹¹ ì œí’ˆì„ ì°¾ì•„ í™˜ë¶ˆ ì²˜ë¦¬

**í•µì‹¬**: ê´€ë¦¬ìëŠ” ê° ì œí’ˆì˜ ì‹œë¦¬ì–¼ ë„˜ë²„ì™€ í† í°(ë‚œìˆ˜ 20ì)ì„ í™•ì¸í•˜ì—¬ í˜„ì‹¤ì—ì„œ í•´ë‹¹ ì œí’ˆì„ ì°¾ì•„ ë°°ì†¡/í™˜ë¶ˆ ì²˜ë¦¬í•  ìˆ˜ ìˆì–´ì•¼ í•¨

**âš ï¸ í† í° ë…¸ì¶œ ë²”ìœ„ ì •ì±… (ë³´ì•ˆ í•„ìˆ˜)**:

**ìš´ì˜ì—ì„œ ê°€ì¥ ë¯¼ê°í•œ ê±´ í† í° ë…¸ì¶œì´ë‹¤. ê´€ë¦¬ì í™”ë©´ì´ ìœ ì¶œë˜ë©´ ì‹¤ë¬¼ ë§¤ì¹­ì´ ê°€ëŠ¥í•´ì§„ë‹¤.**

**ê¶Œì¥ ì •ì±…**:
1. **ëª©ë¡ í™”ë©´**: í† í° ë§ˆìŠ¤í‚¹ (ì˜ˆ: ì• 4ì/ë’¤ 4ìë§Œ í‘œì‹œ)
   - ì˜ˆ: `ABC1...5678` (ì „ì²´ 20ì ì¤‘ ì• 4ì + ë’¤ 4ìë§Œ)
2. **ìƒì„¸ í™”ë©´**: ì „ì²´ í† í° í‘œì‹œ (ë°°ì†¡/í™˜ë¶ˆ ì²˜ë¦¬ ì‹œ í•„ìš”)
3. **ì ‘ê·¼ê¶Œí•œ ë¶„ë¦¬**: "ì „ì²´ í† í° ë³´ê¸°" ê¶Œí•œì„ ë³„ë„ë¡œ ê´€ë¦¬ (ê°€ëŠ¥í•˜ë©´ ë² ìŠ¤íŠ¸)

**êµ¬í˜„ ì˜ˆì‹œ**:
```javascript
// ëª©ë¡ í™”ë©´ (ë§ˆìŠ¤í‚¹)
function maskToken(token) {
  if (!token || token.length < 8) return token;
  return token.substring(0, 4) + '...' + token.substring(token.length - 4);
}

// ìƒì„¸ í™”ë©´ (ì „ì²´ í‘œì‹œ, ê¶Œí•œ í™•ì¸)
function canViewFullToken(adminUser) {
  // ì—­í•  ê¸°ë°˜ ì ‘ê·¼ ì œì–´ (RBAC)
  return adminUser.role === 'super_admin' || adminUser.role === 'warehouse_manager';
}
```

**ë³´ì•ˆ íš¨ê³¼**:
- ë‚´ë¶€ì ì‹¤ìˆ˜/ìŠ¤í¬ë¦°ìƒ· ìœ ì¶œ ë¦¬ìŠ¤í¬ ê°ì†Œ
- í•„ìš”í•  ë•Œë§Œ ì „ì²´ í† í°ì„ ë³´ê²Œ í•¨
- DB ìœ ì¶œ ì‹œì—ë„ ëª©ë¡ í™”ë©´ ìŠ¤í¬ë¦°ìƒ·ë§Œìœ¼ë¡œëŠ” ì‹¤ë¬¼ ë§¤ì¹­ ë¶ˆê°€

### 4. í™˜ë¶ˆ ì •ì±… (í™•ì •)

**í™˜ë¶ˆ ì ‘ìˆ˜ ë°©ì‹(í™•ì •)**:
- âŒ **ê³ ê° ì§ì ‘ í™˜ë¶ˆ ìš”ì²­ ë¶ˆê°€**: ê³ ê°ì´ ë²„íŠ¼ì´ë‚˜ APIë¡œ ì§ì ‘ í™˜ë¶ˆ ìš”ì²­í•  ìˆ˜ ì—†ìŒ
- âœ… **ë¬¸ì˜ ì‹œìŠ¤í…œìœ¼ë¡œë§Œ ì ‘ìˆ˜**: ê³ ê° ë¬¸ì˜(`inquiries`)ì— í™˜ë¶ˆ ìš”ì²­ì´ ë“¤ì–´ì˜¤ë©´ ê´€ë¦¬ìê°€ í™•ì¸
- âœ… **ê´€ë¦¬ì ìˆ˜ë™ ì²˜ë¦¬**: ê´€ë¦¬ì í˜ì´ì§€ì—ì„œ í™•ì¸ í›„ ìˆ˜ë™ìœ¼ë¡œ í™˜ë¶ˆ ì²˜ë¦¬

**í™˜ë¶ˆ ì²˜ë¦¬ íë¦„(í™•ì •)**:
1. ê³ ê°ì´ ë¬¸ì˜ ì‹œìŠ¤í…œ(`/contact.html` ë˜ëŠ” `/api/inquiries`)ì„ í†µí•´ í™˜ë¶ˆ ìš”ì²­
2. ê´€ë¦¬ìê°€ ë¬¸ì˜ ëª©ë¡ì—ì„œ í™˜ë¶ˆ ìš”ì²­ í™•ì¸
3. ê´€ë¦¬ìê°€ ì£¼ë¬¸ ìƒì„¸ í˜ì´ì§€ì—ì„œ ì‹œë¦¬ì–¼ ë„˜ë²„ í™•ì¸ (`order_item_units`)
4. ê´€ë¦¬ìê°€ `warranties.status` í™•ì¸ í›„ í™˜ë¶ˆ ì²˜ë¦¬ (`POST /api/admin/refunds/process`)
5. í™˜ë¶ˆ ì²˜ë¦¬ ì‹œ:
   - `warranties.status` â†’ `revoked` ì „ì´
   - `warranties.revoked_at` ê¸°ë¡
   - `order_item_units.unit_status` ì—…ë°ì´íŠ¸
   - ì¬ê³  ìƒíƒœ: `stock_units.status` â†’ `in_stock` (ì¬íŒë§¤ ê°€ëŠ¥)
   - **í† í° ì¬ë°œê¸‰ ì—†ìŒ**: ì‹¤ë¬¼ ë³´ì¦ì„œì— ì´ë¯¸ QRì´ ì¸ì‡„ë˜ì–´ ìˆì–´ ë¹„ìš© ë¶€ë‹´ìœ¼ë¡œ ì¸í•´ í† í° ì¬ë°œê¸‰í•˜ì§€ ì•ŠìŒ. **í™œì„±í™” ì‹œì  ì¸ë³´ì´ìŠ¤ ì—°ë™ í™•ì¸ìœ¼ë¡œ í™˜ë¶ˆëœ ì£¼ë¬¸ì˜ ë³´ì¦ì„œ í™œì„±í™”ë¥¼ ì°¨ë‹¨í•˜ë¯€ë¡œ í† í° ì¬ë°œê¸‰ ì—†ì´ë„ ì•ˆì „**
6. `orders.status` ì§‘ê³„ í•¨ìˆ˜ë¡œ ìë™ ì—…ë°ì´íŠ¸

**ì¬íŒë§¤ ì‹œ ë³´ì¦ì„œ ì²˜ë¦¬ ì •ì±…(í™•ì •, í•µì‹¬ ë°©ì–´ ë©”ì»¤ë‹ˆì¦˜)**:
- **ì¬íŒë§¤ ì‹œ ê°™ì€ token ì‚¬ìš© (í† í° ì¬ë°œê¸‰ ì—†ìŒ)**: ì¬íŒë§¤ ì‹œ ê°™ì€ `token_pk`ë¥¼ ì‚¬ìš©í•¨ (ì‹¤ë¬¼ ë³´ì¦ì„œì— ì´ë¯¸ QRì´ ì¸ì‡„ë˜ì–´ ìˆì–´ ë¹„ìš© ë¶€ë‹´ìœ¼ë¡œ ì¸í•´ í† í° ì¬ë°œê¸‰í•˜ì§€ ì•ŠìŒ)
- **ê°™ì€ tokenì— ëŒ€í•´ warranties ë ˆì½”ë“œëŠ” í•˜ë‚˜ë§Œ ìœ ì§€**: ê°™ì€ `token_pk`ì— ëŒ€í•´ warranties ë ˆì½”ë“œëŠ” í•˜ë‚˜(ë˜ëŠ” ìµœì†Œí•œ ìœ íš¨ 1ê°œ)ë§Œ ìœ ì§€í•¨
- **ì¬íŒë§¤ ì „ê¹Œì§€ revoked ìƒíƒœ ìœ ì§€**: í™˜ë¶ˆ ì²˜ë¦¬ í›„ ì¬íŒë§¤ë˜ê¸° ì „ê¹Œì§€ëŠ” `warranties.status = 'revoked'` ìƒíƒœë¡œ ìœ ì§€
- **paid ì²˜ë¦¬ ì‹œ ê¸°ì¡´ revoked warranties ì—…ë°ì´íŠ¸**: ì¬íŒë§¤ëœ ìƒí’ˆì´ paid ì²˜ë¦¬ë˜ë©´, ê¸°ì¡´ `revoked` ìƒíƒœ warrantiesë¥¼ ì—…ë°ì´íŠ¸í•¨ (`status = 'issued'` ë˜ëŠ” `'issued_unassigned'`, ìƒˆë¡œìš´ `source_order_item_unit_id`ì™€ ì—°ê²°, ìƒˆë¡œìš´ `owner_user_id` ì„¤ì •). **ìƒˆë¡œìš´ warranties ë ˆì½”ë“œë¥¼ ìƒì„±í•˜ì§€ ì•Šê³  ê¸°ì¡´ ë ˆì½”ë“œë¥¼ ì—…ë°ì´íŠ¸**
- **âš ï¸ ì¬íŒë§¤ ì‹œ ë™ì‹œì„± ë¬¸ì œ ë°©ì§€ (í•„ìˆ˜)**: ì¬íŒë§¤ ë¡œì§ì€ ë°˜ë“œì‹œ `stock_units ë½ (FOR UPDATE SKIP LOCKED) â†’ order_item_units ìƒì„± â†’ warranties ì—…ë°ì´íŠ¸`ê°€ í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ì´ì–´ì•¼ í•¨. ë™ì‹œì— ë‘ ì£¼ë¬¸ì´ ê°™ì€ ì¬ê³ ë¥¼ ì¡ëŠ” ê²ƒì„ ë°©ì§€
- **âš ï¸ revoked â†’ issued ì „ì´ ì¡°ê±´ (ë³´ì•ˆ ì •ì±…)**: `revoked` â†’ `issued` ì „ì´ëŠ” **ìƒˆë¡œìš´ `paid_events`ê°€ ìƒì„±ëœ ê²½ìš°ë§Œ í—ˆìš©**. ê´€ë¦¬ì ìˆ˜ë™ ë³€ê²½ ê¸ˆì§€ (ê´€ë¦¬ì ì‹¤ìˆ˜ë¡œ ê¶Œë¦¬ ë¶€í™œ ì‚¬ê³  ë°©ì§€)
- **QR ìŠ¤ìº” ì‹œ ë³´ì¦ì„œ ì¡°íšŒ**: QR ìŠ¤ìº” ì‹œ `token`ìœ¼ë¡œ `warranties`ë¥¼ ì¡°íšŒí•  ë•Œ, ê°™ì€ `token_pk`ì— ëŒ€í•´ í•˜ë‚˜ì˜ warranties ë ˆì½”ë“œë§Œ ì¡´ì¬í•˜ë¯€ë¡œ ë‹¨ìˆœ ì¡°íšŒ
- **ì²« í™œì„±í™” ì‹œì  ì¸ë³´ì´ìŠ¤ ì—°ë™ í™•ì¸ (í•µì‹¬ ë°©ì–´)**: ì²« í™œì„±í™” ì‹œ(`issued` â†’ `active` ì „ì´ ì‹œì—ë§Œ) í•´ë‹¹ ë³´ì¦ì„œê°€ ì†í•œ ì£¼ë¬¸(ì¸ë³´ì´ìŠ¤)ì´ ê³„ì •ì— ì—°ë™ë˜ì–´ ìˆê³  ì •ìƒ ìƒíƒœì¸ì§€ í™•ì¸ â†’ í™˜ë¶ˆëœ ì£¼ë¬¸ì´ë©´ í™œì„±í™” ë¶ˆê°€, ì •ìƒ ì£¼ë¬¸ì´ë©´ í™œì„±í™” ê°€ëŠ¥. **ì´ê²ƒì´ í•µì‹¬ ë°©ì–´ ë©”ì»¤ë‹ˆì¦˜ìœ¼ë¡œ, í† í° ì¬ë°œê¸‰ ì—†ì´ë„ ì•ˆì „í•˜ê²Œ ì°¨ë‹¨ ê°€ëŠ¥**
- **ì–‘ë„ ì‹œ ì¸ë³´ì´ìŠ¤ ì—°ë™ í™•ì¸ ë¶ˆí•„ìš”**: ì–‘ë„ ì‹œì—ëŠ” ë³´ì¦ì„œ ìƒíƒœë¥¼ `active`ë¡œ ìœ ì§€í•˜ê³  ì†Œìœ ìë§Œ ë³€ê²½í•˜ë¯€ë¡œ, ì–‘ë„ ë°›ì€ ì†Œìœ ìëŠ” ì¸ë³´ì´ìŠ¤ ì—°ë™ í™•ì¸ ì—†ì´ ë°”ë¡œ ì‚¬ìš© ê°€ëŠ¥
- **ê²°ê³¼**: ì¬íŒë§¤ ì‹œ ìƒˆë¡œìš´ tokenì„ ë§Œë“¤ì§€ ì•Šì•„ë„ ë˜ê³ , ê°™ì€ tokenì— ëŒ€í•´ warranties ë ˆì½”ë“œê°€ í•˜ë‚˜ë§Œ ìœ ì§€ë˜ë¯€ë¡œ "í˜„ì¬ ìœ íš¨ ë³´ì¦ì„œ" ì •ì˜ê°€ ëª…í™•í•¨

**í™˜ë¶ˆ í›„ ë³´ì•ˆ ì •ì±…(í™•ì •, ì‹¤ë¬¼ ë³´ì¦ì„œ íŠ¹ì„± ë°˜ì˜)**:
- **í† í° ì¬ë°œê¸‰ ì—†ìŒ**: ì‹¤ë¬¼ ë³´ì¦ì„œì— ì´ë¯¸ QRì´ ì¸ì‡„ë˜ì–´ ìˆì–´ í™˜ë¶ˆ ì‹œ í† í° ì¬ë°œê¸‰í•˜ì§€ ì•ŠìŒ (ë¹„ìš© ë¶€ë‹´)
- **ì¬íŒë§¤ ì‹œ ê°™ì€ token ì‚¬ìš©**: ì¬íŒë§¤ ì‹œ ê°™ì€ `token_pk`ë¥¼ ì‚¬ìš©í•¨ (ì‹¤ë¬¼ ë³´ì¦ì„œì— ì´ë¯¸ QRì´ ì¸ì‡„ë˜ì–´ ìˆì–´ ë¹„ìš© ë¶€ë‹´ìœ¼ë¡œ ì¸í•´ í† í° ì¬ë°œê¸‰í•˜ì§€ ì•ŠìŒ)
- **ê°™ì€ tokenì— ëŒ€í•´ warranties ë ˆì½”ë“œëŠ” í•˜ë‚˜ë§Œ ìœ ì§€**: ê°™ì€ `token_pk`ì— ëŒ€í•´ warranties ë ˆì½”ë“œëŠ” í•˜ë‚˜(ë˜ëŠ” ìµœì†Œí•œ ìœ íš¨ 1ê°œ)ë§Œ ìœ ì§€í•¨
- **ì¬íŒë§¤ ì „ê¹Œì§€ revoked ìƒíƒœ ìœ ì§€**: í™˜ë¶ˆ ì²˜ë¦¬ í›„ ì¬íŒë§¤ë˜ê¸° ì „ê¹Œì§€ëŠ” `warranties.status = 'revoked'` ìƒíƒœë¡œ ìœ ì§€
- **paid ì²˜ë¦¬ ì‹œ ê¸°ì¡´ revoked warranties ì—…ë°ì´íŠ¸**: ì¬íŒë§¤ëœ ìƒí’ˆì´ paid ì²˜ë¦¬ë˜ë©´, ê¸°ì¡´ `revoked` ìƒíƒœ warrantiesë¥¼ ì—…ë°ì´íŠ¸í•¨ (ìƒˆë¡œìš´ `source_order_item_unit_id`ì™€ ì—°ê²°, ìƒˆë¡œìš´ `owner_user_id` ì„¤ì •). **ìƒˆë¡œìš´ warranties ë ˆì½”ë“œë¥¼ ìƒì„±í•˜ì§€ ì•Šê³  ê¸°ì¡´ ë ˆì½”ë“œë¥¼ ì—…ë°ì´íŠ¸**
- **ì²« í™œì„±í™” ì‹œì  ì¸ë³´ì´ìŠ¤ ì—°ë™ í™•ì¸ (í•µì‹¬ ë°©ì–´ ë©”ì»¤ë‹ˆì¦˜)**: ì²« í™œì„±í™” ì‹œ(`issued` â†’ `active` ì „ì´ ì‹œì—ë§Œ) í•´ë‹¹ ë³´ì¦ì„œê°€ ì†í•œ ì£¼ë¬¸(ì¸ë³´ì´ìŠ¤)ì´ ê³„ì •ì— ì—°ë™ë˜ì–´ ìˆê³  ì •ìƒ ìƒíƒœì¸ì§€ í™•ì¸ â†’ í™˜ë¶ˆëœ ì£¼ë¬¸ì´ë©´ í™œì„±í™” ë¶ˆê°€, ì •ìƒ ì£¼ë¬¸ì´ë©´ í™œì„±í™” ê°€ëŠ¥. **ì´ê²ƒì´ í•µì‹¬ ë°©ì–´ ë©”ì»¤ë‹ˆì¦˜ìœ¼ë¡œ, í† í° ì¬ë°œê¸‰ ì—†ì´ë„ ì•ˆì „í•˜ê²Œ ì°¨ë‹¨ ê°€ëŠ¥**
- **ì–‘ë„ ì‹œ ì¸ë³´ì´ìŠ¤ ì—°ë™ í™•ì¸ ë¶ˆí•„ìš”**: ì–‘ë„ ì‹œì—ëŠ” ë³´ì¦ì„œ ìƒíƒœë¥¼ `active`ë¡œ ìœ ì§€í•˜ê³  ì†Œìœ ìë§Œ ë³€ê²½í•˜ë¯€ë¡œ, ì–‘ë„ ë°›ì€ ì†Œìœ ìëŠ” ì¸ë³´ì´ìŠ¤ ì—°ë™ í™•ì¸ ì—†ì´ ë°”ë¡œ ì‚¬ìš© ê°€ëŠ¥
- **ë³´ì¦ì„œ ìƒíƒœ ê²€ì¦ (ë³´ì¡° ë°©ì–´)**: QR ìŠ¤ìº” ì‹œ `warranties.status` í™•ì¸ â†’ `revoked` ìƒíƒœë©´ ì ‘ê·¼ ê±°ë¶€
- **í™œì„±í™” ìƒíƒœ ê²€ì¦ (ë³´ì¡° ë°©ì–´)**: `revoked` ìƒíƒœì—ì„œëŠ” í™œì„±í™” ë¶ˆê°€ëŠ¥ (`issued` â†’ `active`ë§Œ ê°€ëŠ¥)
- **ê²°ê³¼**: ì¬íŒë§¤ ì‹œ ìƒˆë¡œìš´ tokenì„ ë§Œë“¤ì§€ ì•Šì•„ë„ ë˜ê³ , ê°™ì€ tokenì— ëŒ€í•´ warranties ë ˆì½”ë“œê°€ í•˜ë‚˜ë§Œ ìœ ì§€ë˜ë¯€ë¡œ "í˜„ì¬ ìœ íš¨ ë³´ì¦ì„œ" ì •ì˜ê°€ ëª…í™•í•¨

**í™˜ë¶ˆ ê°€ëŠ¥ íŒì • ê¸°ì¤€(í™•ì •, ì½”ë“œ ë ˆë²¨ ê°•ì œ)**:
- **íŒì • ê¸°ì¤€: `warranties.status`ë§Œ ë³¸ë‹¤** (ë‹¨ì¼ ì§„ì‹¤, SSOT)
- íŒì • ë¡œì§:
  - `revoked` â†’ ê±°ë¶€ (ì´ë¯¸ í™˜ë¶ˆ ì™„ë£Œ)
  - `active` â†’ ê±°ë¶€ (í™œì„±í™”ëœ ë³´ì¦ì„œëŠ” í™˜ë¶ˆ ë¶ˆê°€)
  - `issued` / `issued_unassigned` â†’ í—ˆìš© (ì •ì±… ë²”ìœ„ ë‚´)
- âŒ `orders.status`ë¡œ íŒë‹¨ ê¸ˆì§€
- âŒ `unit_status`ë¡œ íŒë‹¨ ê¸ˆì§€

**âš ï¸ ì½”ë“œ ë ˆë²¨ ê°€ë“œ (í•„ìˆ˜ êµ¬í˜„)**:
```javascript
// âŒ ê¸ˆì§€: orders.statusë‚˜ unit_statusë¡œ ë¶„ê¸°
if (order.status === 'paid' && warranty.status === 'active') {
  // í™˜ë¶ˆ ê±°ë¶€ ë¡œì§
}

// âœ… ì˜¬ë°”ë¥¸ êµ¬í˜„: warranties.statusë§Œ ë³¸ë‹¤
async function canRefundWarranty(warrantyId) {
  const [warranties] = await connection.execute(
    'SELECT status FROM warranties WHERE warranty_id = ?',
    [warrantyId]
  );
  
  if (warranties.length === 0) {
    return { allowed: false, reason: 'ë³´ì¦ì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' };
  }
  
  const warranty = warranties[0];
  
  // warranties.statusë§Œ ë³¸ë‹¤
  if (warranty.status === 'revoked') {
    return { allowed: false, reason: 'ì´ë¯¸ í™˜ë¶ˆ ì²˜ë¦¬ëœ ë³´ì¦ì„œì…ë‹ˆë‹¤.' };
  }
  
  if (warranty.status === 'active') {
    return { allowed: false, reason: 'í™œì„±í™”ëœ ë³´ì¦ì„œëŠ” í™˜ë¶ˆí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' };
  }
  
  if (warranty.status === 'issued' || warranty.status === 'issued_unassigned') {
    return { allowed: true };
  }
  
  return { allowed: false, reason: 'í™˜ë¶ˆí•  ìˆ˜ ì—†ëŠ” ìƒíƒœì…ë‹ˆë‹¤.' };
}
```

**í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ ê³ ì •**:
- âœ… `orders.status = 'paid'`, `warranties.status = 'active'` â†’ í™˜ë¶ˆ ê±°ë¶€
- âœ… `orders.status = 'paid'`, `warranties.status = 'issued'` â†’ í™˜ë¶ˆ í—ˆìš©
- âœ… `orders.status = 'refunded'`, `warranties.status = 'issued'` â†’ í™˜ë¶ˆ í—ˆìš© (ì´ë¯¸ í™˜ë¶ˆëœ ì£¼ë¬¸ì˜ ë‹¤ë¥¸ ë³´ì¦ì„œ)

**í™˜ë¶ˆ í›„ QR ì½”ë“œ ì•…ìš© ë°©ì§€ ì •ì±… (ì‹¤ë¬¼ ë³´ì¦ì„œ íŠ¹ì„± ë°˜ì˜)**:

**ì‹œë‚˜ë¦¬ì˜¤ ë¶„ì„**:
1. ê³ ê°ì´ ìƒí’ˆ ì£¼ë¬¸ â†’ QR ì½”ë“œê°€ ë‹´ê¸´ ì‹¤ë¬¼ ë³´ì¦ì„œ ìˆ˜ë ¹
2. QR ì½”ë“œë¥¼ ì‚¬ì§„ìœ¼ë¡œ ì €ì¥
3. í™˜ë¶ˆ ì²˜ë¦¬ â†’ `warranties.status` â†’ `revoked`
4. ì €ì¥í•œ QR ì½”ë“œë¡œ ë³´ì¦ì„œ í™œì„±í™” ì‹œë„

**ëŒ€ì‘ ë°©ì•ˆ (í•µì‹¬ ë°©ì–´ + ë³´ì¡° ë°©ì–´, í† í° ì¬ë°œê¸‰ ì—†ìŒ)**:
1. **í™œì„±í™” ì‹œì  ì¸ë³´ì´ìŠ¤ ì—°ë™ í™•ì¸ (í•µì‹¬ ë°©ì–´ ë©”ì»¤ë‹ˆì¦˜)**: í™œì„±í™” ì‹œ í•´ë‹¹ ë³´ì¦ì„œê°€ ì†í•œ ì£¼ë¬¸(ì¸ë³´ì´ìŠ¤)ì´ ê³„ì •ì— ì—°ë™ë˜ì–´ ìˆê³  í™˜ë¶ˆë˜ì§€ ì•Šì•˜ëŠ”ì§€ í™•ì¸ â†’ í™˜ë¶ˆëœ ì£¼ë¬¸ì´ë©´ í™œì„±í™” ë¶ˆê°€. **ì´ê²ƒì´ í•µì‹¬ ë°©ì–´ ë©”ì»¤ë‹ˆì¦˜ìœ¼ë¡œ, í† í° ì¬ë°œê¸‰ ì—†ì´ë„ ì•ˆì „í•˜ê²Œ ì°¨ë‹¨ ê°€ëŠ¥**
2. **ë³´ì¦ì„œ ìƒíƒœ ê²€ì¦ (ë³´ì¡° ë°©ì–´)**: QR ìŠ¤ìº” ì‹œ `warranties.status` í™•ì¸ â†’ `revoked` ìƒíƒœë©´ ì ‘ê·¼ ê±°ë¶€
3. **í™œì„±í™” ìƒíƒœ ê²€ì¦ (ë³´ì¡° ë°©ì–´)**: í™œì„±í™”ëŠ” `issued` â†’ `active`ë§Œ ê°€ëŠ¥, `revoked` ìƒíƒœì—ì„œëŠ” í™œì„±í™” ë¶ˆê°€ëŠ¥

**êµ¬í˜„ ì˜ˆì‹œ**:
```javascript
// QR ìŠ¤ìº” ì‹œ ë³´ì¦ì„œ ìƒíƒœ ê²€ì¦
router.get('/a/:token', authenticateToken, async (req, res) => {
  const token = req.params.token;
  const userId = req.user.userId;
  
  // 1. í† í°ìœ¼ë¡œ ë³´ì¦ì„œ ì¡°íšŒ
  const [warranties] = await connection.execute(
    `SELECT w.*, tm.token_pk 
     FROM warranties w
     JOIN token_master tm ON w.token_pk = tm.token_pk
     WHERE tm.token = ? AND w.owner_user_id = ?`,
    [token, userId]
  );
  
  if (warranties.length === 0) {
    return res.status(404).json({ message: 'ë³´ì¦ì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' });
  }
  
  const warranty = warranties[0];
  
  // 2. ë³´ì¦ì„œ ìƒíƒœ ê²€ì¦ (revoked ìƒíƒœë©´ ì ‘ê·¼ ê±°ë¶€)
  if (warranty.status === 'revoked') {
    return res.status(403).json({ 
      message: 'í™˜ë¶ˆ ì²˜ë¦¬ëœ ë³´ì¦ì„œì…ë‹ˆë‹¤. ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' 
    });
  }
  
  // 3. ë³´ì¦ì„œ ì •ë³´ ë°˜í™˜
  return res.json({ warranty });
});

// í™œì„±í™” APIì—ì„œë„ ìƒíƒœ ê²€ì¦
router.post('/api/warranties/:warrantyId/activate', authenticateToken, async (req, res) => {
  const warrantyId = req.params.warrantyId;
  const userId = req.user.userId;
  
  const [warranties] = await connection.execute(
    `SELECT w.*, oiu.order_item_unit_id, oi.order_item_id, o.order_id, o.user_id as order_user_id
     FROM warranties w
     LEFT JOIN order_item_units oiu ON w.source_order_item_unit_id = oiu.order_item_unit_id
     LEFT JOIN order_items oi ON oiu.order_item_id = oi.order_item_id
     LEFT JOIN orders o ON oi.order_id = o.order_id
     WHERE w.warranty_id = ? AND w.owner_user_id = ?`,
    [warrantyId, userId]
  );
  
  if (warranties.length === 0) {
    return res.status(404).json({ message: 'ë³´ì¦ì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' });
  }
  
  const warranty = warranties[0];
  
  // revoked ìƒíƒœë©´ í™œì„±í™” ë¶ˆê°€
  if (warranty.status === 'revoked') {
    return res.status(403).json({ 
      message: 'í™˜ë¶ˆ ì²˜ë¦¬ëœ ë³´ì¦ì„œëŠ” í™œì„±í™”í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' 
    });
  }
  
  // issued ìƒíƒœë§Œ í™œì„±í™” ê°€ëŠ¥
  if (warranty.status !== 'issued') {
    return res.status(400).json({ 
      message: 'í™œì„±í™”í•  ìˆ˜ ì—†ëŠ” ìƒíƒœì…ë‹ˆë‹¤.' 
    });
  }
  
  // í•µì‹¬ ë°©ì–´: ì¸ë³´ì´ìŠ¤ ì—°ë™ í™•ì¸ (í™˜ë¶ˆëœ ì£¼ë¬¸ì´ë©´ í™œì„±í™” ë¶ˆê°€)
  if (!warranty.order_user_id || warranty.order_user_id !== userId) {
    return res.status(403).json({ 
      message: 'í•´ë‹¹ ë³´ì¦ì„œê°€ ì†í•œ ì£¼ë¬¸ì´ ê³„ì •ì— ì—°ë™ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.' 
    });
  }
  
  // í•µì‹¬ ë°©ì–´: ì£¼ë¬¸ì´ í™˜ë¶ˆë˜ì—ˆëŠ”ì§€ í™•ì¸ (í™˜ë¶ˆëœ ì£¼ë¬¸ì´ë©´ í™œì„±í™” ë¶ˆê°€)
  // orders.statusê°€ 'refunded'ì´ê±°ë‚˜, order_item_units.unit_statusê°€ í™˜ë¶ˆ ìƒíƒœì¸ì§€ í™•ì¸
  const [orderStatus] = await connection.execute(
    `SELECT o.status, oiu.unit_status
     FROM orders o
     JOIN order_items oi ON o.order_id = oi.order_id
     JOIN order_item_units oiu ON oi.order_item_id = oiu.order_item_id
     WHERE oiu.order_item_unit_id = ?`,
    [warranty.source_order_item_unit_id]
  );
  
  if (orderStatus.length > 0) {
    const status = orderStatus[0];
    // í™˜ë¶ˆëœ ì£¼ë¬¸ì´ë©´ í™œì„±í™” ë¶ˆê°€ (í•µì‹¬ ë°©ì–´)
    if (status.status === 'refunded' || status.unit_status === 'refunded') {
      return res.status(403).json({ 
        message: 'í™˜ë¶ˆ ì²˜ë¦¬ëœ ì£¼ë¬¸ì˜ ë³´ì¦ì„œëŠ” í™œì„±í™”í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' 
      });
    }
  }
  
  // í™œì„±í™” ì²˜ë¦¬...
});
```

**í™•ì¸ ë°©ë²•**:
- í™˜ë¶ˆ ì²˜ë¦¬ ë¡œê·¸ í™•ì¸: `warranty_events`ì—ì„œ í™˜ë¶ˆ ì´ë²¤íŠ¸ í™•ì¸
- ë³´ì¦ì„œ ìƒíƒœ í™•ì¸: `warranties.status = 'revoked'` í™•ì¸
- QR ìŠ¤ìº” ì‹œë„ ë¡œê·¸ í™•ì¸: `revoked` ìƒíƒœ ë³´ì¦ì„œ ì ‘ê·¼ ì‹œë„ ë¡œê·¸ í™•ì¸
- í™œì„±í™” ì‹œë„ ë¡œê·¸ í™•ì¸: í™˜ë¶ˆëœ ë³´ì¦ì„œ í™œì„±í™” ì‹œë„ ë¡œê·¸ í™•ì¸

**ê²°ë¡ **:
- **í•µì‹¬ ë°©ì–´ ë©”ì»¤ë‹ˆì¦˜**: ì²« í™œì„±í™” ì‹œ(`issued` â†’ `active` ì „ì´ ì‹œì—ë§Œ) ì¸ë³´ì´ìŠ¤ ì—°ë™ í™•ì¸ìœ¼ë¡œ í™˜ë¶ˆëœ ì£¼ë¬¸ì˜ ë³´ì¦ì„œ í™œì„±í™” ì°¨ë‹¨ â†’ í† í° ì¬ë°œê¸‰ ì—†ì´ë„ ì•ˆì „í•˜ê²Œ ì°¨ë‹¨ ê°€ëŠ¥
- **ì¬íŒë§¤ ì‹œë‚˜ë¦¬ì˜¤**: ì¬íŒë§¤ ì‹œ ê°™ì€ tokenì„ ì‚¬ìš©í•˜ê³ , ì¬íŒë§¤ ì „ê¹Œì§€ëŠ” `revoked` ìƒíƒœë¡œ ìœ ì§€. paid ì²˜ë¦¬ ì‹œ ê¸°ì¡´ `revoked` ìƒíƒœ warrantiesë¥¼ ì—…ë°ì´íŠ¸í•¨ (ìƒˆë¡œìš´ warranties ë ˆì½”ë“œë¥¼ ìƒì„±í•˜ì§€ ì•ŠìŒ). ê°™ì€ tokenì— ëŒ€í•´ warranties ë ˆì½”ë“œëŠ” í•˜ë‚˜ë§Œ ìœ ì§€ë˜ë¯€ë¡œ "í˜„ì¬ ìœ íš¨ ë³´ì¦ì„œ" ì •ì˜ê°€ ëª…í™•í•¨
- **ì–‘ë„ ì‹œë‚˜ë¦¬ì˜¤**: ì–‘ë„ ì‹œì—ëŠ” ë³´ì¦ì„œ ìƒíƒœë¥¼ `active`ë¡œ ìœ ì§€í•˜ê³  ì†Œìœ ìë§Œ ë³€ê²½í•˜ë¯€ë¡œ, ì–‘ë„ ë°›ì€ ì†Œìœ ìëŠ” ì¸ë³´ì´ìŠ¤ ì—°ë™ í™•ì¸ ì—†ì´ ë°”ë¡œ ì‚¬ìš© ê°€ëŠ¥
- **ê²°ê³¼**: ì¬íŒë§¤ ì‹œ ìƒˆë¡œìš´ tokenì„ ë§Œë“¤ì§€ ì•Šì•„ë„ ë˜ê³ , ê°™ì€ tokenì— ëŒ€í•´ warranties ë ˆì½”ë“œê°€ í•˜ë‚˜ë§Œ ìœ ì§€ë˜ë¯€ë¡œ ì˜µì…˜ ì§€ì˜¥ì— ë¹ ì§€ì§€ ì•ŠìŒ
- í™˜ë¶ˆ ì „ì— ì°ì–´ë‘” QR ì½”ë“œëŠ” ì²« í™œì„±í™” ì‹œì ì— í™˜ë¶ˆëœ ì£¼ë¬¸ í™•ì¸ìœ¼ë¡œ ì°¨ë‹¨ë¨ (í† í° ì¬ë°œê¸‰ ë¶ˆí•„ìš”)
- `revoked` ìƒíƒœë©´ QR ìŠ¤ìº” ì‹œ ì ‘ê·¼ ê±°ë¶€ (ë³´ì¡° ë°©ì–´)
- `revoked` ìƒíƒœì—ì„œëŠ” í™œì„±í™” ë¶ˆê°€ëŠ¥ (ë³´ì¡° ë°©ì–´)
- **ì²« í™œì„±í™” ì‹œì  ì¸ë³´ì´ìŠ¤ ì—°ë™ í™•ì¸ì´ í•µì‹¬ ë°©ì–´ ë©”ì»¤ë‹ˆì¦˜**ìœ¼ë¡œ, í™˜ë¶ˆëœ ì£¼ë¬¸ì´ë©´ í™œì„±í™” ìì²´ê°€ ë¶ˆê°€ëŠ¥í•˜ë¯€ë¡œ í† í° ì¬ë°œê¸‰ ì—†ì´ë„ ì•ˆì „

### 5. ì–‘ë„ ì •ì±… (í™•ì •)

**ì–‘ë„ ê°€ëŠ¥ ì¡°ê±´(í™•ì •)**:
- `warranties.status = 'active'`ì¸ ê²½ìš°ë§Œ ì–‘ë„ ê°€ëŠ¥ (í™œì„±í™”ëœ ë³´ì¦ì„œë§Œ)
- ì–‘ë„ëŠ” ì†Œìœ ê¶Œ ë³€ê²½ì´ë©°, í† í°(`token_master`)ì€ ê·¸ëŒ€ë¡œ ìœ ì§€

**ì–‘ë„ ì²˜ë¦¬ íë¦„(í™•ì •)**:
1. í˜„ì¬ ì†Œìœ ìê°€ ë³´ì¦ì„œì—ì„œ "ì–‘ë„í•˜ê¸°" ë²„íŠ¼ í´ë¦­
2. ìˆ˜ë ¹ì ì´ë©”ì¼ ì…ë ¥
3. ì‹œìŠ¤í…œì´ ëœë¤ 7ì ì½”ë“œ ìƒì„± (72ì‹œê°„ ìœ íš¨)
4. `warranty_transfers` í…Œì´ë¸”ì— ì–‘ë„ ìš”ì²­ ê¸°ë¡ (ìƒíƒœ: `requested`)
5. ì‹œìŠ¤í…œì´ ì–‘ë„ ë§í¬ë¥¼ ì´ë©”ì¼ë¡œ ìˆ˜ë ¹ìì—ê²Œ ì „ì†¡ (ëœë¤ 7ì ì½”ë“œ í¬í•¨)
6. ìˆ˜ë ¹ìê°€ ë§í¬ í´ë¦­ â†’ ë¡œê·¸ì¸ ìš”êµ¬
7. ìˆ˜ë ¹ìê°€ ë¡œê·¸ì¸ í›„ ëœë¤ 7ì ì½”ë“œ ì…ë ¥
8. ìˆ˜ë ¹ìê°€ "ìˆ˜ë½" ë²„íŠ¼ í´ë¦­
9. `warranty_transfers.status` â†’ `accepted` â†’ `completed`
10. `warranties.owner_user_id` ë³€ê²½ (ê¸°ì¡´ ì†Œìœ ì â†’ ìƒˆ ì†Œìœ ì)
11. **`warranties.status`ëŠ” `active` ìƒíƒœë¡œ ìœ ì§€** (í™œì„±í™”ë¥¼ ë‹¤ì‹œ í•  í•„ìš” ì—†ìŒ)
12. `warranty_events`ì— ì–‘ë„ ì´ë²¤íŠ¸ ê¸°ë¡
13. ì–‘ë„ ì™„ë£Œ ì´ë©”ì¼ ë°œì†¡ (ì–‘ë„ì ë° ìˆ˜ë ¹ì ëª¨ë‘)

**ì–‘ë„ í›„ ì†Œìœ ê¶Œ ì •ì±…(í™•ì •)**:
- **1í† í° = 1ì†Œìœ ì í•„ìˆ˜ ì¡°ê±´**: í•œ í† í°ì€ ë™ì‹œì— í•œ ëª…ì˜ ì†Œìœ ìë§Œ ê°€ì§ˆ ìˆ˜ ìˆìŒ
- **ì–‘ë„ í›„ ì›ë˜ ì†Œìœ ìëŠ” ë” ì´ìƒ ê·¸ ë³´ì¦ì„œì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŒ**:
  - ì›ë˜ ì†Œìœ ìì˜ ë§ˆì´í˜ì´ì§€ì—ì„œ ë³´ì¦ì„œ ì œê±°
  - QR ìŠ¤ìº” ì‹œë„ ì‹œ ì†Œìœ ì ë¶ˆì¼ì¹˜ë¡œ ì ‘ê·¼ ê±°ë¶€
  - ì›ë˜ ì†Œìœ ìëŠ” ë‹¤ì‹œ QRì„ ì°ê±°ë‚˜ í•´ì„œ ê·¸ ë³´ì¦ì„œë¥¼ ìì‹ ì˜ ê³„ì •ì— ë„£ì„ ìˆ˜ ì—†ìŒ
- **ìƒˆ ì†Œìœ ìëŠ” ì¦‰ì‹œ ë³´ì¦ì„œ ì‚¬ìš© ê°€ëŠ¥** (`active` ìƒíƒœ ìœ ì§€, ì¬í™œì„±í™” ë¶ˆí•„ìš”)

**ì–‘ë„ ìš”ì²­ ë§Œë£Œ ì •ì±…(í™•ì •)**:
- ëœë¤ 7ì ì½”ë“œëŠ” 72ì‹œê°„ ìœ íš¨
- ë§Œë£Œ ì‹œ `warranty_transfers.status` â†’ `expired`
- ë§Œë£Œëœ ìš”ì²­ì€ ìë™ìœ¼ë¡œ ë¬´íš¨í™”

**ì–‘ë„ ì·¨ì†Œ ì •ì±…(í™•ì •)**:
- ì–‘ë„ ìš”ì²­ìëŠ” `requested` ìƒíƒœì—ì„œ ì·¨ì†Œ ê°€ëŠ¥
- ì·¨ì†Œ ì‹œ `warranty_transfers.status` â†’ `cancelled`

### 6. ë³´ì¦ì„œ í™œì„±í™” ì •ì±… (í™•ì •)

**í™œì„±í™” ê°€ëŠ¥ ì¡°ê±´(í™•ì •)**:
- `warranties.status = 'issued'` (ê³„ì •ì— ì—°ë™ëœ ë³´ì¦ì„œë§Œ, ì²« í™œì„±í™” ì‹œì—ë§Œ)
- `warranties.owner_user_id = í˜„ì¬ ë¡œê·¸ì¸í•œ user_id` (ì†Œìœ ì í™•ì¸)
- **í•µì‹¬ ì¡°ê±´ (ì²« í™œì„±í™” ì‹œì—ë§Œ ì ìš©)**: ì²« í™œì„±í™” ì‹œ(`issued` â†’ `active` ì „ì´ ì‹œì—ë§Œ) í•´ë‹¹ ë³´ì¦ì„œê°€ ì†í•œ ì£¼ë¬¸(ì¸ë³´ì´ìŠ¤)ì´ ê³„ì •ì— ì—°ë™ë˜ì–´ ìˆê³  ì •ìƒ ìƒíƒœì—¬ì•¼ í•¨: `warranties.source_order_item_unit_id` â†’ `order_item_units` â†’ `order_items` â†’ `orders.user_id = í˜„ì¬ ë¡œê·¸ì¸í•œ user_id` AND `orders.status != 'refunded'` (ì¸ë³´ì´ìŠ¤ ì—°ë™ í™•ì¸ + í™˜ë¶ˆ ìƒíƒœ í™•ì¸). **ì´ê²ƒì´ í™˜ë¶ˆ í›„ QR ì½”ë“œ ì•…ìš© ë°©ì§€ì˜ í•µì‹¬ ë°©ì–´ ë©”ì»¤ë‹ˆì¦˜** (í™˜ë¶ˆëœ ì£¼ë¬¸ì´ë©´ í™œì„±í™” ë¶ˆê°€, ì •ìƒ ì£¼ë¬¸ì´ë©´ í™œì„±í™” ê°€ëŠ¥)
- **ì–‘ë„ ì‹œ ì¸ë³´ì´ìŠ¤ ì—°ë™ í™•ì¸ ë¶ˆí•„ìš”**: ì–‘ë„ ì‹œì—ëŠ” ë³´ì¦ì„œ ìƒíƒœë¥¼ `active`ë¡œ ìœ ì§€í•˜ê³  ì†Œìœ ìë§Œ ë³€ê²½í•˜ë¯€ë¡œ, ì–‘ë„ ë°›ì€ ì†Œìœ ìëŠ” ì¸ë³´ì´ìŠ¤ ì—°ë™ í™•ì¸ ì—†ì´ ë°”ë¡œ ì‚¬ìš© ê°€ëŠ¥
- ë™ì˜ ì²´í¬ í•„ìˆ˜ (`agree: true`, ì²« í™œì„±í™” ì‹œì—ë§Œ)

**í™œì„±í™” ì²˜ë¦¬ íë¦„(í™•ì •)**:
1. ì‚¬ìš©ìê°€ ë§ˆì´í˜ì´ì§€ì—ì„œ ë³´ì¦ì„œ í™•ì¸
2. "í™œì„±í™”" ë²„íŠ¼ í´ë¦­
3. ë™ì˜ ë¬¸êµ¬ í™•ì¸: "ì´ ë³´ì¦ì„œë¥¼ í™œì„±í™”í•˜ë©´ í™˜ë¶ˆì´ ì œí•œë©ë‹ˆë‹¤"
4. ë™ì˜ ì²´í¬ í›„ í™œì„±í™” ìš”ì²­ (`POST /api/warranties/:warrantyId/activate`)
5. ì„œë²„ ê²€ì¦:
   - `warranties.owner_user_id = í˜„ì¬ ë¡œê·¸ì¸í•œ user_id` í™•ì¸
   - `warranties.status = 'issued'` í™•ì¸ (í™˜ë¶ˆ ì²˜ë¦¬ ì‹œ `warranties.status` â†’ `revoked`ë¡œ ë³€ê²½ë˜ë¯€ë¡œ, ì´ë¯¸ í™˜ë¶ˆëœ ë³´ì¦ì„œëŠ” ì—¬ê¸°ì„œ ì°¨ë‹¨ë¨. ì–‘ë„ ë°›ì€ ë³´ì¦ì„œëŠ” ì´ë¯¸ `active` ìƒíƒœì´ë¯€ë¡œ ì—¬ê¸°ì„œ ì°¨ë‹¨ë¨)
   - **í•µì‹¬ ê²€ì¦ (ì²« í™œì„±í™” ì‹œì—ë§Œ ì ìš©)**: ì²« í™œì„±í™” ì‹œ(`issued` â†’ `active` ì „ì´ ì‹œì—ë§Œ) í•´ë‹¹ ë³´ì¦ì„œê°€ ì†í•œ ì£¼ë¬¸ì´ ê³„ì •ì— ì—°ë™ë˜ì–´ ìˆê³  ì •ìƒ ìƒíƒœì¸ì§€ í™•ì¸: `warranties.source_order_item_unit_id` â†’ `order_item_units` â†’ `order_items` â†’ `orders.user_id = í˜„ì¬ ë¡œê·¸ì¸í•œ user_id` AND `orders.status != 'refunded'` (ì¸ë³´ì´ìŠ¤ ì—°ë™ í™•ì¸ + í™˜ë¶ˆ ìƒíƒœ í™•ì¸). **ì´ê²ƒì´ í™˜ë¶ˆ í›„ QR ì½”ë“œ ì•…ìš© ë°©ì§€ì˜ í•µì‹¬ ë°©ì–´ ë©”ì»¤ë‹ˆì¦˜** (í™˜ë¶ˆëœ ì£¼ë¬¸ì´ë©´ í™œì„±í™” ë¶ˆê°€, ì •ìƒ ì£¼ë¬¸ì´ë©´ í™œì„±í™” ê°€ëŠ¥)
   - **ì–‘ë„ ë°›ì€ ë³´ì¦ì„œëŠ” ì¸ë³´ì´ìŠ¤ ì—°ë™ í™•ì¸ ë¶ˆí•„ìš”**: ì–‘ë„ ë°›ì€ ë³´ì¦ì„œëŠ” ì´ë¯¸ `active` ìƒíƒœì´ë¯€ë¡œ ì¸ë³´ì´ìŠ¤ ì—°ë™ í™•ì¸ ì—†ì´ ë°”ë¡œ ì‚¬ìš© ê°€ëŠ¥
6. ë™ì˜ ì²´í¬ í™•ì¸ (`agree: true`)
7. `warranties.status` â†’ `active` ì „ì´
8. `warranties.activated_at` ê¸°ë¡
9. `warranty_events`ì— í™œì„±í™” ì´ë²¤íŠ¸ ê¸°ë¡

**í™œì„±í™” ì‹¤íŒ¨ ì‚¬ë¡€**:
- ë³´ì¦ì„œê°€ ê³„ì •ì— ì—°ë™ë˜ì§€ ì•ŠìŒ (`warranties.owner_user_id != í˜„ì¬ user_id`)
- ë³´ì¦ì„œ ìƒíƒœê°€ `issued`ê°€ ì•„ë‹˜ (`revoked`, `active`, `suspended` ë“±ì€ í™œì„±í™” ë¶ˆê°€)
- **í•µì‹¬ ì‹¤íŒ¨ ì‚¬ë¡€: í•´ë‹¹ ë³´ì¦ì„œê°€ ì†í•œ ì£¼ë¬¸(ì¸ë³´ì´ìŠ¤)ì´ ê³„ì •ì— ì—°ë™ë˜ì§€ ì•ŠìŒ** (`orders.user_id != í˜„ì¬ user_id`)
- **í•µì‹¬ ì‹¤íŒ¨ ì‚¬ë¡€: í•´ë‹¹ ë³´ì¦ì„œê°€ ì†í•œ ì£¼ë¬¸ì´ í™˜ë¶ˆë¨** (`orders.status = 'refunded'` ë˜ëŠ” `order_item_units.unit_status = 'refunded'`). **ì´ê²ƒì´ í™˜ë¶ˆ í›„ QR ì½”ë“œ ì•…ìš© ë°©ì§€ì˜ í•µì‹¬ ë°©ì–´ ë©”ì»¤ë‹ˆì¦˜**
- ë™ì˜ ì²´í¬ ì—†ìŒ (`agree != true`)
- **í™˜ë¶ˆëœ ë³´ì¦ì„œ (`warranties.status = 'revoked'`)ëŠ” í™œì„±í™” ë¶ˆê°€ëŠ¥** (ë˜ëŒë¦¬ê¸° ê¸ˆì§€, ë³´ì¡° ë°©ì–´)

**ì˜ˆì‹œ ì‹œë‚˜ë¦¬ì˜¤**:
- A, B, C ì œí’ˆì„ êµ¬ë§¤ â†’ ì¸ë³´ì´ìŠ¤ ìƒì„±
- ë¹„íšŒì› ì£¼ë¬¸ â†’ `orders.user_id = NULL`, `warranties.status = 'issued_unassigned'`
- claim (ê³„ì • ì—°ë™) â†’ `orders.user_id = í˜„ì¬ user_id`, `warranties.status = 'issued'`
- A ë³´ì¦ì„œ í™œì„±í™” ì‹œë„:
  - âœ… `warranties.owner_user_id = í˜„ì¬ user_id` í™•ì¸
  - âœ… `warranties.status = 'issued'` í™•ì¸
  - âœ… **`warranties.source_order_item_unit_id` â†’ `order_item_units` â†’ `order_items` â†’ `orders.user_id = í˜„ì¬ user_id` í™•ì¸** (ì¸ë³´ì´ìŠ¤ ì—°ë™ í™•ì¸)
  - âœ… ë™ì˜ ì²´í¬ í™•ì¸
  - â†’ í™œì„±í™” ì„±ê³µ

### 7. warranties.status ì „ì´í‘œ (ê¶Œë¦¬ SSOT) - ë‹¨ì¼ ì „ì´í‘œ ê³ ì •

**âš ï¸ ìš´ì˜ ì •ì±… ê³ ì •**: ì•„ë˜ ì „ì´í‘œëŠ” "ëˆ„ê°€ ì–´ë–¤ ìƒíƒœì—ì„œ ë­˜ ëˆŒëŸ¬ë„ ë˜ëŠ”ì§€"ë¥¼ í•œ ëˆˆì— ë³´ì—¬ì£¼ëŠ” ë‹¨ì¼ ì§„ì‹¤(SSOT)ì…ë‹ˆë‹¤. ìƒˆ ê¸°ëŠ¥ ì¶”ê°€ ì‹œ ë°˜ë“œì‹œ ì´ í‘œë¥¼ ë¨¼ì € ìˆ˜ì •í•´ì•¼ í•©ë‹ˆë‹¤.

| í˜„ì¬ ìƒíƒœ | ì „ì´ ê°€ëŠ¥ ìƒíƒœ | ì „ì´ API/ì¡°ê±´ | ë¹„ê³  |
|----------|--------------|------------|------|
| `issued_unassigned` | `issued` | `claim` | ê³„ì • ì—°ë™ë§Œ |
| | `revoked` | `admin refund` | í™˜ë¶ˆ ìŠ¹ì¸ (ê´€ë¦¬ì ìˆ˜ë™) |
| `issued` | `active` | `activate` | í™œì„±í™” (ë™ì˜ í•„ìˆ˜, ì¸ë³´ì´ìŠ¤ ì—°ë™ í™•ì¸) |
| | `revoked` | `admin refund` | í™˜ë¶ˆ ìŠ¹ì¸ (ê´€ë¦¬ì ìˆ˜ë™) |
| | `suspended` | `admin suspend` | ì œì¬ |
| `active` | `revoked` | `admin refund` | í™˜ë¶ˆ ìŠ¹ì¸ (ê´€ë¦¬ì ìˆ˜ë™) |
| | `suspended` | `admin suspend` | ì œì¬ |
| | `active` (ìœ ì§€) | `transfer` | ì–‘ë„ ì™„ë£Œ (ì†Œìœ ìë§Œ ë³€ê²½, ìƒíƒœëŠ” `active` ìœ ì§€, `ownership_transferred` ì´ë²¤íŠ¸) |
| `revoked` | `issued` / `issued_unassigned` | `paid (ì¬íŒë§¤)` | âš ï¸ **paid_events ìƒì„±ëœ ê²½ìš°ë§Œ í—ˆìš©, ê´€ë¦¬ì ìˆ˜ë™ ë³€ê²½ ê¸ˆì§€, affectedRows=1 ê²€ì¦ í•„ìˆ˜** |
| `suspended` | `issued` | `admin resume` | ì œì¬ í•´ì œ (í™œì„±í™”ëŠ” ë³„ë„ ì ˆì°¨) |

**ì „ì´ ë¶ˆê°€ëŠ¥í•œ ìƒíƒœ**:
- `revoked` â†’ `active` (ì§ì ‘ ì „ì´ ë¶ˆê°€, ì¬íŒë§¤ í›„ í™œì„±í™” í•„ìš”)
- `revoked` â†’ `suspended` (ì˜ë¯¸ ì—†ìŒ)
- `active` â†’ `issued` (ë˜ëŒë¦¬ê¸° ë¶ˆê°€)
- `issued` â†’ `issued_unassigned` (ë˜ëŒë¦¬ê¸° ë¶ˆê°€)

**âš ï¸ ìƒíƒœ ì „ì´ ê·œì¹™ (DB ì—…ë°ì´íŠ¸ ì¡°ê±´ìœ¼ë¡œ ê°•ì œ)**:
- **í™œì„±í™”**: `issued` â†’ `active` ë§Œ í—ˆìš© (ë‹¤ë¥¸ ìƒíƒœì—ì„œ í™œì„±í™” ë¶ˆê°€)
- **ì •ì§€/í•´ì œ**: `active` â†” `suspended` ë§Œ í—ˆìš©
- **í™˜ë¶ˆ/íšŒìˆ˜**: `active`/`suspended`/`issued` â†’ `revoked` í—ˆìš©
- **ì¬íŒë§¤**: `revoked` â†’ `issued`(ë˜ëŠ” `issued_unassigned`)ë§Œ í—ˆìš©

**ëª¨ë“  ìƒíƒœ ë³€ê²½ UPDATEëŠ” ë‹¤ìŒ ì›ì¹™ì„ ë”°ë¼ì•¼ í•¨**:
```sql
-- âœ… ì˜¬ë°”ë¥¸ íŒ¨í„´
UPDATE warranties 
SET status = ?, ...
WHERE warranty_id = ? AND status IN (?, ?, ...)  -- í˜„ì¬ ìƒíƒœ ì¡°ê±´ í¬í•¨
-- affectedRows=1 ê²€ì¦ í•„ìˆ˜
```

**ì „ì´ ê·œì¹™ ê³ ì •**:
- `claim`: `issued_unassigned` â†’ `issued` (ì´ ì „ì´ë§Œ í—ˆìš©)
- `activate`: `issued` â†’ `active` (ì´ ì „ì´ë§Œ í—ˆìš©, ë™ì˜ í•„ìˆ˜). **í™œì„±í™” ì¡°ê±´: í•´ë‹¹ ë³´ì¦ì„œê°€ ì†í•œ ì£¼ë¬¸(ì¸ë³´ì´ìŠ¤)ì´ ê³„ì •ì— ì—°ë™ë˜ì–´ ìˆì–´ì•¼ í•¨ (`orders.user_id = í˜„ì¬ ë¡œê·¸ì¸í•œ user_id`)**
- `admin suspend`: `issued`/`active` â†’ `suspended`
- `admin resume`: `suspended` â†’ `issued` (ì´ ì „ì´ë§Œ í—ˆìš©). í™œì„±í™”(`active`)ëŠ” ë³„ë„ ì ˆì°¨(ë™ì˜/ì¬í™•ì¸)ë¥¼ í†µí•´ì„œë§Œ ê°€ëŠ¥
- `admin refund`: `issued`/`issued_unassigned` â†’ `revoked` (ë˜ëŠ” `refunded`). **ê´€ë¦¬ì ìˆ˜ë™ ì²˜ë¦¬ë§Œ ê°€ëŠ¥, ê³ ê° ì§ì ‘ ìš”ì²­ ë¶ˆê°€**
- `transfer`: `active` â†’ `active` (ìƒíƒœ ìœ ì§€, ì†Œìœ ìë§Œ ë³€ê²½). **ì‚¬ìš©ì ê°„ ìš”ì²­/ìˆ˜ë½ ë°©ì‹, 72ì‹œê°„ ì œí•œ, ëœë¤ 7ì ì½”ë“œ ê²€ì¦ í•„ìˆ˜. ì–‘ë„ í›„ ì›ë˜ ì†Œìœ ìëŠ” ë” ì´ìƒ ì ‘ê·¼ ë¶ˆê°€ (1í† í° = 1ì†Œìœ ì)**
- `revoked`ëŠ” ë˜ëŒë¦¬ê¸° ê¸ˆì§€ (ì •ì±… ê³ ì •)
- ì–‘ë„ëŠ” ë˜ëŒë¦¬ê¸° ê¸ˆì§€ (ì •ì±… ê³ ì •)
- ëª¨ë“  ì „ì´ëŠ” `warranty_events`ì— ê¸°ë¡ (ëˆ„ê°€/ì–¸ì œ/ì™œ)

---

## âš ï¸ ë¬¸ì„œ ì‹ ë¢°ë„ ê·œì¹™ (ìƒë‹¨ ê³ ì •)

**í™•ì¸ë¨ í‘œê¸° ê·œì¹™(í™•ì •)**:
- "í™•ì¸ë¨" ë¬¸ì¥ì€ ì „ë¶€ "ê·¼ê±°:"ë¥¼ ë°”ë¡œ ì˜†ì— ë¶™ì´ëŠ” í˜•ì‹ìœ¼ë¡œ ê³ ì •
- ê·¼ê±° ì˜ˆ: migration íŒŒì¼ëª… + í…Œì´ë¸” DDL ì¶œë ¥ ìº¡ì²˜(or SHOW CREATE TABLE ê²°ê³¼) + ì»¤ë°‹/ê²½ë¡œ
- ê·¼ê±°ë¥¼ ë‹¹ì¥ ëª» ë¶™ì´ë©´ "(ì „ì œ) ~ë¼ë©´"ìœ¼ë¡œ ì „ë¶€ ì¡°ê±´ë¬¸ ì²˜ë¦¬
- **ê·¼ê±° ì—†ëŠ” í™•ì¸ë¨ ê¸ˆì§€** (ë¬¸ì„œ ì‹ ë¢°ë„ ìœ ì§€ í•„ìˆ˜)

---

## âœ… ìŠ¤í™ì˜ ìš°ìˆ˜í•œ ë¶€ë¶„

### 1. SSOT 3ì¤‘ ë¶„ë¦¬ ì›ì¹™ â­â­â­â­â­
**ë§¤ìš° ìš°ìˆ˜**: ìƒíƒœê°€ ì„ì´ì§€ ì•Šì•„ ë²„ê·¸ ìœ„í—˜ ìµœì†Œí™”

**í˜„ì¬ ì‹œìŠ¤í…œê³¼ ë¹„êµ (ì¡°ê±´ë¶€)**:
- âš ï¸ (ì „ì œ) `backend/add_order_status_column.sql`ì´ ì ìš©ë˜ì–´ ìˆë‹¤ë©´ `orders.status` ì¡´ì¬
- âš ï¸ (í™•ì¸ í•„ìš”) `order_item_units` í…Œì´ë¸” ì¡´ì¬ ì—¬ë¶€ í™•ì¸ í•„ìš”
- âš ï¸ (í™•ì¸ í•„ìš”) `warranties.status` ì»¬ëŸ¼ ì¡´ì¬ ì—¬ë¶€ í™•ì¸ í•„ìš”

**êµ¬í˜„ ê°€ëŠ¥ì„±**: ë†’ìŒ (ì‹ ê·œ ì»¬ëŸ¼ ì¶”ê°€ë§Œ í•„ìš”)

### 2. ë©±ë“±ì„± DB UNIQUE ì œì•½ â­â­â­â­â­
**ë§¤ìš° ìš°ìˆ˜**: ì½”ë“œê°€ ì•„ë‹Œ DB ë ˆë²¨ì—ì„œ ë³´ì¥

**í˜„ì¬ ì‹œìŠ¤í…œê³¼ ë¹„êµ**:
```sql
-- í˜„ì¬: order_idempotency í…Œì´ë¸” ì¡´ì¬ (í…Œì´ë¸”ëª… í™•ì •: order_idempotency)
-- backend/migrations/2025-10-29_add_order_idempotency.sql (ê°€ì •)
CREATE TABLE order_idempotency (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  user_id INT NOT NULL,  -- âš ï¸ NULL í—ˆìš© í•„ìš”
  idem_key VARCHAR(64),
  order_number VARCHAR(32),
  UNIQUE(user_id, idem_key)  -- âš ï¸ owner_key ë°©ì‹ìœ¼ë¡œ ë³€ê²½ í•„ìš”
);
```

**ìŠ¤í™ ì œì•ˆ**:
```sql
order_idempotency(
  owner_key VARCHAR(100),  -- u:123 / g:abcdef
  idem_key VARCHAR(64),
  order_id INT,
  UNIQUE(owner_key, idem_key)
)
```

**ë¹„êµ ê²°ê³¼**:
- âœ… ê¸°ë³¸ êµ¬ì¡° ì¡´ì¬
- âš ï¸ `owner_key` ë°©ì‹ìœ¼ë¡œ ë³€ê²½ í•„ìš”
- âš ï¸ `user_id` NULL í—ˆìš© í•„ìš”

**êµ¬í˜„ ê°€ëŠ¥ì„±**: ë†’ìŒ (ë§ˆì´ê·¸ë ˆì´ì…˜ í•„ìš”)

### 3. ë¹„íšŒì› ì‹ë³„ ì„¸ì…˜ ê³ ì • â­â­â­â­â­
**ë§¤ìš° ìš°ìˆ˜**: ìš”ì²­ë§ˆë‹¤ ìƒˆë¡œ ìƒì„±í•˜ì§€ ì•ŠìŒ

**í˜„ì¬ ì‹œìŠ¤í…œê³¼ ë¹„êµ**:
- âŒ í˜„ì¬: ë¹„íšŒì› ì£¼ë¬¸ ë¶ˆê°€ëŠ¥
- âŒ `guest_session_id` ê°œë… ì—†ìŒ

**ìŠ¤í™ ì œì•ˆ**:
```
guest_session_id(ì¿ í‚¤) = ë¹„íšŒì› owner ì‹ë³„ì
orders.guest_id = guest_session_id(ë˜ëŠ” í•´ì‹œ)
```

**êµ¬í˜„ ê°€ëŠ¥ì„±**: ë†’ìŒ (ì‹ ê·œ êµ¬í˜„)

**ì£¼ì˜ì‚¬í•­**:
- ì¿ í‚¤ ë§Œë£Œ ì •ì±… í•„ìš”
- ì„¸ì…˜ ê³ ì • ë©”ì»¤ë‹ˆì¦˜ í•„ìš”

### 4. ë¶€ë¶„ ì„±ê³µ ê¸ˆì§€ (ì›ìí™”) â­â­â­â­â­
**ë§¤ìš° ìš°ìˆ˜**: íŠ¸ëœì­ì…˜ìœ¼ë¡œ ë³´ì¥

**í˜„ì¬ ì‹œìŠ¤í…œê³¼ ë¹„êµ**:
- âš ï¸ í˜„ì¬: paid ì²˜ë¦¬ íŠ¸ëœì­ì…˜ ì—†ìŒ
- âš ï¸ ì¬ê³  ë°°ì • ì—†ìŒ

**ìŠ¤í™ ì œì•ˆ**:
```
paid_events ë©±ë“± INSERT â†’ ì£¼ë¬¸ ì ê¸ˆ â†’ ì¬ê³  ì˜ˆì•½ â†’ unit ìƒì„± â†’ warranty ìƒì„± â†’ orders ì—…ë°ì´íŠ¸ â†’ COMMIT
```

**êµ¬í˜„ ê°€ëŠ¥ì„±**: ë†’ìŒ (ì‹ ê·œ êµ¬í˜„)

### 5. token_pk ë‚´ë¶€ FK ë¶„ë¦¬ â­â­â­â­â­
**ë§¤ìš° ìš°ìˆ˜**: ì™¸ë¶€ ë…¸ì¶œê³¼ ë‚´ë¶€ ì¡°ì¸ ë¶„ë¦¬

**í˜„ì¬ ì‹œìŠ¤í…œê³¼ ë¹„êµ (ê·¼ê±° ëª…ì‹œ)**:
```sql
-- í™•ì¸ ê·¼ê±°: backend/migrations/005_create_token_master_table.sql
-- (ì „ì œ) í•´ë‹¹ ë§ˆì´ê·¸ë ˆì´ì…˜ì´ ì ìš©ë˜ì–´ ìˆë‹¤ë©´:
-- token_master.tokenì´ PK
token VARCHAR(20) PRIMARY KEY
```

**ìŠ¤í™ ì œì•ˆ**:
```sql
token_pk INT AUTO_INCREMENT PRIMARY KEY
token VARCHAR(20) UNIQUE  -- ì™¸ë¶€ ì…ë ¥/í‘œì‹œ
```

**ë¹„êµ ê²°ê³¼**:
- âš ï¸ í˜„ì¬: `token`ì´ PK
- âš ï¸ `token_pk` ì¶”ê°€ í•„ìš”

**êµ¬í˜„ ê°€ëŠ¥ì„±**: ë†’ìŒ (ë§ˆì´ê·¸ë ˆì´ì…˜ í•„ìš”)

**ì£¼ì˜ì‚¬í•­**:
- ê¸°ì¡´ ì½”ë“œì—ì„œ `token`ì„ FKë¡œ ì‚¬ìš©í•˜ëŠ” ë¶€ë¶„ ëª¨ë‘ ìˆ˜ì • í•„ìš”
- ì ì§„ì  ë§ˆì´ê·¸ë ˆì´ì…˜ ì „ëµ í•„ìš”

---

## âš ï¸ ì ì¬ì  ë¬¸ì œì  ë° ê°œì„  ì œì•ˆ

### 1. token_pk ë§ˆì´ê·¸ë ˆì´ì…˜ ë³µì¡ì„± âš ï¸

#### ë¬¸ì œ
**í˜„ì¬ ì‹œìŠ¤í…œ**:
```sql
-- token_master.tokenì´ PK
token VARCHAR(20) PRIMARY KEY

-- warranties.tokenì´ FK
warranties.token VARCHAR(20)  -- token_master.token ì°¸ì¡°
```

**ìŠ¤í™ ì œì•ˆ**:
```sql
-- token_master.token_pkê°€ PK
token_pk INT AUTO_INCREMENT PRIMARY KEY
token VARCHAR(20) UNIQUE

-- warranties.token_pkê°€ FK
warranties.token_pk INT  -- token_master.token_pk ì°¸ì¡°
```

#### âš ï¸ ì¤‘ìš”: PK êµì²´ëŠ” ë‹¨ìˆœ ADDë¡œ ë¶ˆê°€ëŠ¥
**MySQLì€ PKë¥¼ 2ê°œ ë‘˜ ìˆ˜ ì—†ìŒ**. ê¸°ì¡´ PK(`token`)ë¥¼ ìœ ì§€í•œ ì±„ ìƒˆ PK(`token_pk`)ë¥¼ `ADD ... PRIMARY KEY`ë¡œ ë°”ë¡œ ì¶”ê°€í•˜ë©´ ì‹¤íŒ¨í•©ë‹ˆë‹¤.

#### ì •ì„ ë§ˆì´ê·¸ë ˆì´ì…˜ ìˆœì„œ (ì‹¤í–‰ ê°€ëŠ¥í•œ DDL)

**Phase 1: token_master í…Œì´ë¸” PK êµì²´**
```sql
-- 1-1. ê¸°ì¡´ FK ì œì•½ í™•ì¸ ë° ì œê±° (warranties.token â†’ token_master.token)
-- ë¨¼ì € ì–´ë–¤ í…Œì´ë¸”ì´ tokenì„ FKë¡œ ì°¸ì¡°í•˜ëŠ”ì§€ í™•ì¸
SELECT 
  TABLE_NAME, CONSTRAINT_NAME
FROM information_schema.KEY_COLUMN_USAGE
WHERE REFERENCED_TABLE_NAME = 'token_master'
  AND REFERENCED_COLUMN_NAME = 'token';

-- 1-2. warranties.token FK ì œê±° (ì˜ˆì‹œ)
ALTER TABLE warranties 
  DROP FOREIGN KEY warranties_ibfk_token;  -- ì‹¤ì œ FK ì´ë¦„ í™•ì¸ í•„ìš”

-- 1-3. token_pk ì»¬ëŸ¼ ì¶”ê°€ (NULL í—ˆìš©, ì¼ë‹¨ PK ì•„ë‹˜)
ALTER TABLE token_master 
  ADD COLUMN token_pk INT NULL AFTER token;

-- 1-4. token_pk ê°’ ì±„ìš°ê¸° (ì„ì‹œ ë²ˆí˜¸ ë¶€ì—¬)
SET @row_number = 0;
UPDATE token_master 
SET token_pk = (@row_number := @row_number + 1)
ORDER BY token;

-- 1-5. token_pkë¥¼ NOT NULLë¡œ ë³€ê²½
ALTER TABLE token_master 
  MODIFY COLUMN token_pk INT NOT NULL;

-- 1-6. AUTO_INCREMENT ì„¤ì •ì„ ìœ„í•œ ì„ì‹œ í…Œì´ë¸” ì¬ìƒì„± (ì•ˆì „í•œ ë°©ë²•)
-- ì˜µì…˜ A: í…Œì´ë¸” ì¬ìƒì„± (ë°ì´í„° ë°±ì—… í•„ìˆ˜)
CREATE TABLE token_master_new (
  token_pk INT AUTO_INCREMENT PRIMARY KEY,
  token VARCHAR(20) NOT NULL UNIQUE,
  internal_code VARCHAR(100) NOT NULL,
  product_name VARCHAR(255) NOT NULL,
  is_blocked TINYINT(1) DEFAULT 0,
  scan_count INT DEFAULT 0,
  first_scanned_at DATETIME NULL,
  last_scanned_at DATETIME NULL,
  created_at DATETIME NOT NULL,
  updated_at DATETIME NOT NULL,
  INDEX idx_internal_code (internal_code),
  INDEX idx_is_blocked (is_blocked)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- ë°ì´í„° ë³µì‚¬ (token_pkëŠ” AUTO_INCREMENTë¡œ ìë™ ìƒì„±)
INSERT INTO token_master_new 
  (token, internal_code, product_name, is_blocked, scan_count, 
   first_scanned_at, last_scanned_at, created_at, updated_at)
SELECT 
  token, internal_code, product_name, is_blocked, scan_count,
  first_scanned_at, last_scanned_at, created_at, updated_at
FROM token_master
ORDER BY token;

-- ê¸°ì¡´ í…Œì´ë¸” ë°±ì—…
RENAME TABLE token_master TO token_master_backup;

-- ìƒˆ í…Œì´ë¸”ë¡œ êµì²´
RENAME TABLE token_master_new TO token_master;

-- âš ï¸ ì˜µì…˜ B: ALTER TABLEë¡œ PK êµì²´ (ë¶€ë¡/ì°¸ê³ ìš©, ì‹¤ë¬´ ì ìš© ì „ ê²€ì¦ í•„ìˆ˜)
-- âš ï¸ ì£¼ì˜: ìš´ì˜ ì•ˆì •ì„± ê´€ì ì—ì„œ ì˜µì…˜ A(ì¬ìƒì„± ìŠ¤ì™‘)ë¥¼ ì •ì‹ ë£¨íŠ¸ë¡œ ê¶Œì¥
-- ì˜µì…˜ BëŠ” ê²€ì¦ ì ˆì°¨ë¥¼ ë°˜ë“œì‹œ ê±°ì³ì•¼ í•¨

-- 1-6-1. ê¸°ì¡´ PK ì œê±°
ALTER TABLE token_master 
  DROP PRIMARY KEY;

-- 1-6-2. tokenì„ UNIQUEë¡œ ë³€ê²½ (ì‚¬ì „ ê²€ì¦: token ì¤‘ë³µ 0ê±´ í™•ì¸)
-- ê²€ì¦ SQL:
-- SELECT COUNT(*) as duplicate_count FROM (
--   SELECT token, COUNT(*) as cnt FROM token_master GROUP BY token HAVING cnt > 1
-- ) AS duplicates;
-- ê²°ê³¼ê°€ 0ì´ì–´ì•¼ í•¨

ALTER TABLE token_master 
  MODIFY COLUMN token VARCHAR(20) NOT NULL UNIQUE;

-- 1-6-3. token_pkë¥¼ PKë¡œ ì„¤ì • (ì‚¬ì „ ê²€ì¦: token_pk NULL 0ê±´ í™•ì¸)
-- ê²€ì¦ SQL:
-- SELECT COUNT(*) as null_count FROM token_master WHERE token_pk IS NULL;
-- ê²°ê³¼ê°€ 0ì´ì–´ì•¼ í•¨

ALTER TABLE token_master 
  MODIFY COLUMN token_pk INT AUTO_INCREMENT PRIMARY KEY;

-- ì‚¬í›„ ê²€ì¦ SQL (ì˜µì…˜ B ì‚¬ìš© ì‹œ í•„ìˆ˜):
-- 1. token_pk NULL ê²€ì¦
SELECT COUNT(*) as null_count FROM token_master WHERE token_pk IS NULL;
-- ê²°ê³¼: 0

-- 2. token UNIQUE ê²€ì¦
SELECT COUNT(*) as duplicate_count FROM (
  SELECT token, COUNT(*) as cnt FROM token_master GROUP BY token HAVING cnt > 1
) AS duplicates;
-- ê²°ê³¼: 0

-- 3. ì°¸ì¡° ë¬´ê²°ì„± ê²€ì¦ (warranties.token_pk)
SELECT COUNT(*) as orphan_count 
FROM warranties w
LEFT JOIN token_master tm ON w.token_pk = tm.token_pk
WHERE w.token_pk IS NOT NULL AND tm.token_pk IS NULL;
-- ê²°ê³¼: 0
```

**Phase 2: warranties í…Œì´ë¸” FK ì „í™˜**
```sql
-- 2-1. warranties.token_pk ì»¬ëŸ¼ ì¶”ê°€
ALTER TABLE warranties 
  ADD COLUMN token_pk INT NULL;

-- 2-2. ê¸°ì¡´ ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ (token â†’ token_pk ë§¤í•‘)
UPDATE warranties w
JOIN token_master tm ON w.token = tm.token
SET w.token_pk = tm.token_pk;

-- 2-3. token_pkë¥¼ NOT NULLë¡œ ë³€ê²½ (ë°ì´í„° ê²€ì¦ í›„)
ALTER TABLE warranties 
  MODIFY COLUMN token_pk INT NOT NULL;

-- 2-4. ìƒˆ FK ì¶”ê°€ (token_pk ê¸°ë°˜) - âš ï¸ RESTRICTë¡œ ê³ ì •
ALTER TABLE warranties
  ADD CONSTRAINT fk_warranties_token_pk 
  FOREIGN KEY (token_pk) REFERENCES token_master(token_pk) 
  ON DELETE RESTRICT;  -- âœ… SET NULL â†’ RESTRICT (token_master ì‚­ì œ ê¸ˆì§€)

-- 2-5. ê¸°ì¡´ token FKëŠ” ì´ë¯¸ ì œê±°ë¨ (Phase 1-2ì—ì„œ)
-- token ì»¬ëŸ¼ì€ deprecatedë¡œ í‘œì‹œ (ë˜ëŠ” ìœ ì§€)
ALTER TABLE warranties 
  MODIFY COLUMN token VARCHAR(20) COMMENT 'DEPRECATED: Use token_pk instead. Keep for backward compatibility.';
```

**Phase 3: ë‹¤ë¥¸ í…Œì´ë¸” FK ì „í™˜ (í•„ìš” ì‹œ)**
```sql
-- stock_units, order_item_units ë“± tokenì„ ì°¸ì¡°í•˜ëŠ” ë‹¤ë¥¸ í…Œì´ë¸”ë„ ë™ì¼í•˜ê²Œ ì²˜ë¦¬
-- ê° í…Œì´ë¸”ë§ˆë‹¤ Phase 2ì™€ ë™ì¼í•œ ìˆœì„œë¡œ ì§„í–‰
```

**ê¶Œì¥**: ì ì§„ì  ë§ˆì´ê·¸ë ˆì´ì…˜
- **ì •ì‹ ë£¨íŠ¸**: ì˜µì…˜ A (í…Œì´ë¸” ì¬ìƒì„± ìŠ¤ì™‘) - ìš´ì˜ ì•ˆì •ì„± ìµœìš°ì„ 
- **ë¶€ë¡/ì°¸ê³ **: ì˜µì…˜ B (ALTER TABLE) - ì‹¤ë¬´ ì ìš© ì „ ê²€ì¦ í•„ìˆ˜
- Phase 1: `token_master` PK êµì²´ (ë°±ì—… í•„ìˆ˜, ì˜µì…˜ A ê¶Œì¥)
- Phase 2: `warranties` FK ì „í™˜
- Phase 3: ë‹¤ë¥¸ í…Œì´ë¸” FK ì „í™˜
- Phase 4: ê¸°ì¡´ ì½”ë“œ ì ì§„ì  ì „í™˜ (`token` â†’ `token_pk`)
- Phase 5: `token` ì»¬ëŸ¼ deprecated (ì„ íƒ)

**ê²€ì¦ ì²´í¬ (ì˜µì…˜ A/B ëª¨ë‘ í•„ìˆ˜)**:
- ì‚¬ì „ ê²€ì¦: token ì¤‘ë³µ 0ê±´, token_pk NULL 0ê±´
- ì‚¬í›„ ê²€ì¦: token_pk NULL 0ê±´, token UNIQUE í™•ì¸, ì°¸ì¡° ë¬´ê²°ì„± í™•ì¸

### 2. owner_key ë°©ì‹ì˜ NULL ì²˜ë¦¬ âš ï¸

#### ë¬¸ì œ
**ìŠ¤í™ ì œì•ˆ**:
```
owner_key = u:<user_id> ë˜ëŠ” g:<guest_session_id>
UNIQUE(owner_key, idem_key)
```

**í˜„ì¬ ì‹œìŠ¤í…œ**:
```sql
UNIQUE(user_id, idem_key)  -- user_idê°€ NULLì´ë©´ ë¬¸ì œ
```

#### í•´ê²° ë°©ë²•
```sql
-- ì˜µì…˜ A: owner_key ë°©ì‹ (ìŠ¤í™ ì œì•ˆ)
owner_key VARCHAR(100) NOT NULL,  -- u:123 ë˜ëŠ” g:abcdef
idem_key VARCHAR(64) NOT NULL,
UNIQUE(owner_key, idem_key)

-- ì˜µì…˜ B: NULL í—ˆìš© (ê¸°ì¡´ ë°©ì‹ ìœ ì§€)
user_id INT NULL,
guest_id VARCHAR(100) NULL,
idem_key VARCHAR(64) NOT NULL,
UNIQUE(COALESCE(user_id, guest_id), idem_key)  -- âŒ MySQL ë¯¸ì§€ì›

-- ì˜µì…˜ C: ë³„ë„ í…Œì´ë¸” ë¶„ë¦¬
-- order_idempotency_members (user_id)
-- order_idempotency_guests (guest_id)
```

**ê¶Œì¥**: ì˜µì…˜ A (owner_key ë°©ì‹)
- ì´ìœ : ë‹¨ìˆœí•˜ê³  ëª…í™•í•¨
- NULL ì²˜ë¦¬ ë¬¸ì œ ì—†ìŒ

### 3. SKIP LOCKED ë¯¸ì§€ì› ì‹œ ì§ë ¬í™” ë²”ìœ„ ëª…í™•í™” âš ï¸

#### ë¬¸ì œ
**ìŠ¤í™ ì œì•ˆ**:
```
SKIP LOCKED ì‚¬ìš© ì—¬ë¶€(MySQL 8 í™•ì •ì´ë©´ ê°€ëŠ¥, ì•„ë‹ˆë©´ ì§ë ¬í™”)
```

**í˜„ì¬ ì‹œìŠ¤í…œ**:
- MySQL ë²„ì „ í™•ì¸ í•„ìš”

#### âš ï¸ ì¤‘ìš”: ì§ë ¬í™” ë²”ìœ„ ëª…í™•í™” í•„ìš”
**ì£¼ë¬¸ ë‹¨ìœ„ ì§ë ¬í™”(ê°™ì€ order_idë§Œ ì§ë ¬)ë¡œëŠ” ì¬ê³  ê²½ìŸì´ ì™„ì „íˆ í•´ê²°ë˜ì§€ ì•Šì„ ìˆ˜ ìˆìŒ**. ì—¬ëŸ¬ ì£¼ë¬¸ì´ ê°™ì€ ìƒí’ˆ ì¬ê³ ë¥¼ ë™ì‹œì— ì¡ìœ¼ë ¤ëŠ” ê²½ìš° ë°ë“œë½/ê²½í•©ì´ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

#### í•´ê²° ë°©ë²• (íƒ1 í™•ì •)

**ì˜µì…˜ A: SKIP LOCKED ì‚¬ìš© (MySQL 8.0+)**
```javascript
// MySQL 8.0+ ì§€ì› ì‹œ
const [stockUnits] = await connection.execute(
  `SELECT stock_unit_id, token_pk 
   FROM stock_units 
   WHERE product_id = ? AND status = 'in_stock' 
   ORDER BY stock_unit_id 
   LIMIT ? 
   FOR UPDATE SKIP LOCKED`,
  [productId, quantity]
);
```

**ì˜µì…˜ B: paid ì²˜ë¦¬ ì›Œì»¤ ë‹¨ì¼í™” (ê°€ì¥ ì•ˆì „)**
```javascript
// paid ì²˜ë¦¬ ì›Œì»¤ëŠ” 1ê°œë§Œ ìš´ì˜(ì§ë ¬)
// í ì‹œìŠ¤í…œ ì‚¬ìš© (ì˜ˆ: Bull, RabbitMQ ë“±)
// ë˜ëŠ” ë‹¨ì¼ í”„ë¡œì„¸ìŠ¤ì—ì„œ ìˆœì°¨ ì²˜ë¦¬
```

**ì˜µì…˜ C: product_id ê¸°ì¤€ ë½ ìˆœì„œ ê°•ì œ (ì ˆì¶©ì•ˆ)**
```javascript
// ìƒí’ˆ ì¬ê³  ë°°ì • ì‹œ product_id ê¸°ì¤€ìœ¼ë¡œ í•­ìƒ ê°™ì€ ë½ ìˆœì„œ/ì¿¼ë¦¬ ìˆœì„œë¥¼ ìœ ì§€
// ë°ë“œë½/ê²½í•© ìµœì†Œí™”

// 1. product_idë¡œ ì •ë ¬í•˜ì—¬ ë½ íšë“ ìˆœì„œ ê³ ì •
const [stockUnits] = await connection.execute(
  `SELECT stock_unit_id, token_pk 
   FROM stock_units 
   WHERE product_id = ? AND status = 'in_stock' 
   ORDER BY product_id, stock_unit_id  -- í•­ìƒ ê°™ì€ ìˆœì„œ
   LIMIT ? 
   FOR UPDATE`,
  [productId, quantity]
);

// 2. ì—¬ëŸ¬ ìƒí’ˆ ë™ì‹œ ì²˜ë¦¬ ì‹œ product_id ìˆœì„œë¡œ ë½ íšë“
const productIds = orderItems.map(item => item.product_id).sort();
for (const productId of productIds) {
  // ì¬ê³  ë°°ì • (í•­ìƒ ê°™ì€ ìˆœì„œ)
}
```

**ì˜µì…˜ D: orders í–‰ ì ê¸ˆ + product_id ìˆœì„œ (MySQL 8 ë¯¸ë§Œ)**
```javascript
// 1. orders í–‰ ì ê¸ˆìœ¼ë¡œ ì£¼ë¬¸ ë‹¨ìœ„ ì§ë ¬í™”
await connection.execute(
  'SELECT * FROM orders WHERE order_id = ? FOR UPDATE',
  [orderId]
);

// 2. product_id ìˆœì„œë¡œ ì¬ê³  ì„ íƒ (ë°ë“œë½ ë°©ì§€)
const productIds = orderItems.map(item => item.product_id).sort();
for (const productId of productIds) {
  const [stockUnits] = await connection.execute(
    `SELECT stock_unit_id, token_pk 
     FROM stock_units 
     WHERE product_id = ? AND status = 'in_stock' 
     ORDER BY stock_unit_id 
     LIMIT ? 
     FOR UPDATE`,
    [productId, quantity]
  );
}
```

**ê¶Œì¥**: 
- MySQL 8.0+: ì˜µì…˜ A (SKIP LOCKED)
- MySQL 5.7 + ì•ˆì •ì„± ìµœìš°ì„ : ì˜µì…˜ B (ì›Œì»¤ ë‹¨ì¼í™”)
- MySQL 5.7 + ì„±ëŠ¥ ê³ ë ¤: ì˜µì…˜ C ë˜ëŠ” D (ë½ ìˆœì„œ ê°•ì œ)

### 4. reserved ì¬ê³  í•´ì œ ê·œì¹™ ë³µì¡ì„± âš ï¸

#### ë¬¸ì œ
**ìŠ¤í™ ì œì•ˆ**:
```
reserved í•´ì œ ê·œì¹™(í•„ìˆ˜):
- ê²°ì œ ì‹¤íŒ¨/ì·¨ì†Œ ì´ë²¤íŠ¸ ìˆ˜ì‹  ì‹œ ì¦‰ì‹œ í•´ì œ
- ë˜ëŠ” reserved_at ê¸°ë°˜ ë§Œë£Œ(ì˜ˆ: 30ë¶„/1ì‹œê°„) í›„ ë°°ì¹˜ ì‘ì—…ìœ¼ë¡œ í•´ì œ
```

**í˜„ì¬ ì‹œìŠ¤í…œ**:
- ì¬ê³  ê´€ë¦¬ ì‹œìŠ¤í…œ ì—†ìŒ

#### âš ï¸ ì¤‘ìš”: SSOT ì›ì¹™ ì¤€ìˆ˜
**`orders.status`ëŠ” ì§‘ê³„/í‘œì‹œìš©ì´ë¯€ë¡œ íŒì •ì— ì‚¬ìš© ê¸ˆì§€**. ë°°ì¹˜ í•´ì œ ì¡°ê±´ì—ì„œ `o.status != 'paid'`ë¥¼ ì‚¬ìš©í•˜ë©´ SSOT ì›ì¹™ê³¼ ì¶©ëŒí•©ë‹ˆë‹¤. ì§‘ê³„ ìƒíƒœê°’ì´ ë°”ë€Œê±°ë‚˜ `partial_*`ê°€ ìƒê¸¸ ë•Œ í•´ì œê°€ ê¼¬ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

#### í•´ê²° ë°©ë²• (SSOT ì›ì¹™ ì¤€ìˆ˜)

**ì˜µì…˜ A: ì´ë²¤íŠ¸ ê¸°ë°˜ í•´ì œ (ê¶Œì¥)**
```javascript
// ê²°ì œ ì‹¤íŒ¨/ì·¨ì†Œ ì´ë²¤íŠ¸ ìˆ˜ì‹  ì‹œ ì¦‰ì‹œ í•´ì œ
router.post('/payments/cancel', async (req, res) => {
  const { order_id } = req.body;
  
  await connection.execute(
    `UPDATE stock_units 
     SET status = 'in_stock', 
         reserved_at = NULL, 
         reserved_by_order_id = NULL
     WHERE reserved_by_order_id = ? AND status = 'reserved'`,
    [order_id]
  );
});
```

**ì˜µì…˜ B: ë°°ì¹˜ ì‘ì—… (ë°±ì—…) - SSOT ì›ì¹™ ì¤€ìˆ˜**
```javascript
// cron job ë˜ëŠ” scheduled task
async function releaseExpiredReservations() {
  const expiredTime = new Date(Date.now() - 30 * 60 * 1000); // 30ë¶„ ì „
  
  // SSOT ì›ì¹™: orders.statusê°€ ì•„ë‹Œ paid_events/paid_at ê¸°ì¤€ìœ¼ë¡œ íŒì •
  await connection.execute(
    `UPDATE stock_units su
     LEFT JOIN orders o ON su.reserved_by_order_id = o.order_id
     LEFT JOIN paid_events pe ON o.order_id = pe.order_id
     SET su.status = 'in_stock',
         su.reserved_at = NULL,
         su.reserved_by_order_id = NULL
     WHERE su.status = 'reserved'
       AND su.reserved_at < ?
       AND (pe.order_id IS NULL OR o.paid_at IS NULL)`,  -- âœ… paid_events/paid_at ê¸°ì¤€
    [expiredTime]
  );
}
```

**ê¶Œì¥**: ì˜µì…˜ A + ì˜µì…˜ B ë³‘í–‰
- ì´ë²¤íŠ¸ ê¸°ë°˜ í•´ì œê°€ ì£¼ ë°©ì‹
- ë°°ì¹˜ ì‘ì—…ì€ ë°±ì—…/ì•ˆì „ë§
- **ë°˜ë“œì‹œ `paid_events` ì¡´ì¬ ì—¬ë¶€ ë˜ëŠ” `paid_at` ê¸°ì¤€ìœ¼ë¡œ íŒì •** (orders.status ì‚¬ìš© ê¸ˆì§€)

### 5. ë¶€ë¶„ë°°ì†¡ ì‹œ orders.status ì§‘ê³„ ë³µì¡ì„± âš ï¸

#### ë¬¸ì œ
**ìŠ¤í™ ì œì•ˆ**:
```
partial_shipped(ì„ íƒ): ì¼ë¶€ unit shipped ì´ìƒ, ì¼ë¶€ëŠ” reserved
shipped: ëª¨ë“  unit shipped ì´ìƒ
```

**í˜„ì¬ ì‹œìŠ¤í…œ**:
- ë¶€ë¶„ë°°ì†¡ ì§€ì› ì—†ìŒ

#### í•´ê²° ë°©ë²•
```javascript
// ì§‘ê³„ í•¨ìˆ˜ (íŠ¸ë¦¬ê±° ë˜ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ ë ˆë²¨)
async function updateOrderStatus(orderId) {
  const [units] = await connection.execute(
    `SELECT 
       COUNT(*) as total,
       SUM(CASE WHEN unit_status IN ('shipped', 'delivered') THEN 1 ELSE 0 END) as shipped_count,
       SUM(CASE WHEN unit_status = 'delivered' THEN 1 ELSE 0 END) as delivered_count,
       SUM(CASE WHEN unit_status LIKE 'refunded%' THEN 1 ELSE 0 END) as refunded_count
     FROM order_item_units oiu
     JOIN order_items oi ON oiu.order_item_id = oi.order_item_id
     WHERE oi.order_id = ?`,
    [orderId]
  );
  
  const stats = units[0];
  let newStatus;
  
  if (stats.refunded_count === stats.total) {
    newStatus = 'refunded';
  } else if (stats.delivered_count === stats.total) {
    newStatus = 'delivered';
  } else if (stats.delivered_count > 0) {
    newStatus = 'partial_delivered';
  } else if (stats.shipped_count === stats.total) {
    newStatus = 'shipped';
  } else if (stats.shipped_count > 0) {
    newStatus = 'partial_shipped';
  } else {
    newStatus = 'paid';
  }
  
  await connection.execute(
    'UPDATE orders SET status = ? WHERE order_id = ?',
    [newStatus, orderId]
  );
}
```

**ê¶Œì¥**: ì• í”Œë¦¬ì¼€ì´ì…˜ ë ˆë²¨ ì§‘ê³„
- ì´ìœ : ìœ ì—°ì„± ë†’ìŒ
- íŠ¸ë¦¬ê±°ëŠ” ë””ë²„ê¹… ì–´ë ¤ì›€

### 6. warranty_events ê°ì‚¬ ë¡œê·¸ ì„±ëŠ¥ ë° ì¦ê±°ì„± âš ï¸

#### ë¬¸ì œ
**ìŠ¤í™ ì œì•ˆ**:
```
warranty_events(ê°ì‚¬ ë¡œê·¸: ê¶Œì¥, ì‚¬ì‹¤ìƒ í•„ìˆ˜)
ëª¨ë“  ì „ì´ëŠ” warranty_eventsì— ê¸°ë¡
```

**í˜„ì¬ ì‹œìŠ¤í…œ**:
- ê°ì‚¬ ë¡œê·¸ ì‹œìŠ¤í…œ ì—†ìŒ

#### âš ï¸ ì¤‘ìš”: ë¡œê·¸ì˜ ì¦ê±°ì„± ë³´ì¥
**ìš´ì˜ì—ì„œ ë¡œê·¸ëŠ” "ì¦ê±°"ì´ë¯€ë¡œ, ìƒíƒœ ì „ì´ì™€ ë¡œê·¸ê°€ ë¶„ë¦¬ë˜ë©´ ë¬¸ì œê°€ ìƒê¹ë‹ˆë‹¤**:
- ìƒíƒœëŠ” ë°”ë€Œì—ˆëŠ”ë° ë¡œê·¸ê°€ ëˆ„ë½ (ì¥ì• /íƒ€ì„ì•„ì›ƒ/í ì ì²´)
- ë¶„ìŸ ì‹œ ì¦ê±°ê°€ ëŠê¹€

**ì•ˆì „í•œ ì ˆì¶©ì•ˆ (ì‹¤ë¬´ì—ì„œ í”í•¨)**:
- íŠ¸ëœì­ì…˜ ì•ˆì—ëŠ” "ìµœì†Œ ì¦ê±°(outbox/event row)"ë§Œ ë‚¨ê¹€ (ê°€ë³ê²Œ)
- ìƒì„¸ ë¡œê·¸/ì™¸ë¶€ ì „ì†¡ì€ ë¹„ë™ê¸°ë¡œ í™•ì¥

#### í•´ê²° ë°©ë²• (Outbox íŒ¨í„´)

**ì˜µì…˜ A: Outbox íŒ¨í„´ (ê¶Œì¥)**
```sql
-- warranty_events í…Œì´ë¸” (íŠ¸ëœì­ì…˜ ë‚´ ìµœì†Œ ì´ë²¤íŠ¸ ê¸°ë¡)
CREATE TABLE warranty_events (
  event_id BIGINT PRIMARY KEY AUTO_INCREMENT,
  event_type VARCHAR(50) NOT NULL,
  target_type VARCHAR(50) NOT NULL,
  target_id INT NOT NULL,
  actor_type ENUM('system', 'admin', 'user') NOT NULL,
  actor_id INT NULL,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  metadata JSON,
  processed_at DATETIME NULL,  -- ë¹„ë™ê¸° ì²˜ë¦¬ ì™„ë£Œ ì‹œê°
  INDEX idx_target (target_type, target_id),
  INDEX idx_created_at (created_at),
  INDEX idx_unprocessed (processed_at)  -- ë¯¸ì²˜ë¦¬ ì´ë²¤íŠ¸ ì¡°íšŒìš©
);

-- warranty_transfers í…Œì´ë¸” (ì–‘ë„ ìš”ì²­/ìˆ˜ë½ ê´€ë¦¬)
CREATE TABLE warranty_transfers (
  transfer_id BIGINT PRIMARY KEY AUTO_INCREMENT,
  warranty_id INT NOT NULL,
  from_user_id INT NOT NULL COMMENT 'ì–‘ë„ ìš”ì²­ì (í˜„ì¬ ì†Œìœ ì)',
  to_email VARCHAR(255) NOT NULL COMMENT 'ìˆ˜ë ¹ì ì´ë©”ì¼',
  to_user_id INT NULL COMMENT 'ìˆ˜ë ¹ì user_id (ìˆ˜ë½ ì‹œì ì— ì„¤ì •)',
  transfer_code VARCHAR(7) NOT NULL UNIQUE COMMENT 'ëœë¤ 7ì ì½”ë“œ',
  status ENUM('requested', 'accepted', 'completed', 'cancelled', 'expired') DEFAULT 'requested',
  expires_at DATETIME NOT NULL COMMENT '72ì‹œê°„ í›„ ë§Œë£Œ ì‹œê°',
  requested_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  accepted_at DATETIME NULL,
  completed_at DATETIME NULL,
  cancelled_at DATETIME NULL,
  cancelled_by_user_id INT NULL COMMENT 'ì·¨ì†Œí•œ ì‚¬ìš©ì (ìš”ì²­ì ë˜ëŠ” ìˆ˜ë ¹ì)',
  FOREIGN KEY (warranty_id) REFERENCES warranties(warranty_id) ON DELETE RESTRICT,
  FOREIGN KEY (from_user_id) REFERENCES users(user_id) ON DELETE RESTRICT,
  FOREIGN KEY (to_user_id) REFERENCES users(user_id) ON DELETE SET NULL,
  INDEX idx_warranty_id (warranty_id),
  INDEX idx_from_user_id (from_user_id),
  INDEX idx_to_email (to_email),
  INDEX idx_transfer_code (transfer_code),
  INDEX idx_status (status),
  INDEX idx_expires_at (expires_at)  -- ë§Œë£Œ ë°°ì¹˜ ì‘ì—…ìš©
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

```javascript
// íŠ¸ëœì­ì…˜ ë‚´ ìµœì†Œ ì´ë²¤íŠ¸ ê¸°ë¡ (í•„ìˆ˜) - âš ï¸ í™•ì • ê·œì¹™: ì´ë²¤íŠ¸ row INSERT ì‹¤íŒ¨ â†’ ì „ì´ë„ ë¡¤ë°±
async function updateWarrantyStatus(warrantyId, newStatus, actor) {
  const connection = await mysql.createConnection(dbConfig);
  await connection.beginTransaction();
  
  try {
    // 1. í˜„ì¬ ìƒíƒœ ì¡°íšŒ ë° ì ê¸ˆ (FOR UPDATE)
    const [warranties] = await connection.execute(
      'SELECT status FROM warranties WHERE warranty_id = ? FOR UPDATE',
      [warrantyId]
    );
    
    if (warranties.length === 0) {
      throw new Error('ë³´ì¦ì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }
    
    const oldStatus = warranties[0].status;
    
    // 2. ìƒíƒœ ì „ì´
    await connection.execute(
      'UPDATE warranties SET status = ? WHERE warranty_id = ?',
      [newStatus, warrantyId]
    );
    
    // 3. ìµœì†Œ ì´ë²¤íŠ¸ ê¸°ë¡ (íŠ¸ëœì­ì…˜ ë‚´, ê°€ë³ê²Œ) - âš ï¸ í•„ìˆ˜: ì‹¤íŒ¨ ì‹œ ì „ì´ë„ ë¡¤ë°±
    const [eventResult] = await connection.execute(
      `INSERT INTO warranty_events 
       (event_type, target_type, target_id, actor_type, actor_id, metadata, created_at)
       VALUES (?, 'warranty', ?, ?, ?, ?, NOW())`,
      [
        'status_changed',
        warrantyId,
        actor.type,
        actor.id,
        JSON.stringify({ from: oldStatus, to: newStatus })
      ]
    );
    
    const eventId = eventResult.insertId;
    
    await connection.commit();
    
    // 4. ìƒì„¸ ë¡œê·¸/ì™¸ë¶€ ì „ì†¡ì€ ë¹„ë™ê¸°ë¡œ (íŠ¸ëœì­ì…˜ ì™¸ë¶€)
    // íì— ì¶”ê°€í•˜ê±°ë‚˜ ë³„ë„ ì›Œì»¤ì—ì„œ ì²˜ë¦¬
    await queueEventProcessing(eventId);
    
  } catch (error) {
    await connection.rollback();  // ì´ë²¤íŠ¸ INSERT ì‹¤íŒ¨ ì‹œ ì „ì´ë„ ë¡¤ë°±
    throw error;
  } finally {
    await connection.end();
  }
}

// ë¹„ë™ê¸° ì´ë²¤íŠ¸ ì²˜ë¦¬ (ì›Œì»¤)
async function processEventQueue() {
  const [events] = await connection.execute(
    'SELECT * FROM warranty_events WHERE processed_at IS NULL ORDER BY created_at LIMIT 100'
  );
  
  for (const event of events) {
    // ìƒì„¸ ë¡œê·¸ ê¸°ë¡
    // ì™¸ë¶€ ì‹œìŠ¤í…œ ì „ì†¡
    // ì•Œë¦¼ ë°œì†¡ ë“±
    
    await connection.execute(
      'UPDATE warranty_events SET processed_at = NOW() WHERE event_id = ?',
      [event.event_id]
    );
  }
}
```

**ì˜µì…˜ B: ë™ê¸° ë¡œê¹… (ê°„ë‹¨í•˜ì§€ë§Œ ì„±ëŠ¥ ì €í•˜ ê°€ëŠ¥)**
```javascript
// ëª¨ë“  ë¡œê·¸ë¥¼ íŠ¸ëœì­ì…˜ ë‚´ì—ì„œ ê¸°ë¡
// ì„±ëŠ¥ ì €í•˜ ê°€ëŠ¥ì„± ìˆìŒ
```

**ê¶Œì¥**: ì˜µì…˜ A (Outbox íŒ¨í„´)
- ì´ìœ : ì¦ê±°ì„± ë³´ì¥ + ì„±ëŠ¥ ìµœì í™”
- íŠ¸ëœì­ì…˜ ë‚´ ìµœì†Œ ì´ë²¤íŠ¸ ê¸°ë¡ì€ í•„ìˆ˜
- ìƒì„¸/í™•ì¥ì€ ë¹„ë™ê¸°ë¡œ ì²˜ë¦¬

### 7. ë¹„íšŒì› í† í° ë§Œë£Œ/ì¬ë°œê¸‰ ì •ì±… ë¯¸ëª…ì‹œ âš ï¸

#### ë¬¸ì œ
**ìŠ¤í™ ì œì•ˆ**:
```
guest_order_access_token
ë§Œë£Œ/ì¬ë°œê¸‰/íšŒìˆ˜ ì •ì±… ì •ì˜
```

**êµ¬ì²´ì  ì •ì±… ë¯¸ëª…ì‹œ**

#### í•´ê²° ë°©ë²•
```javascript
// ê¶Œì¥ ì •ì±…
const GUEST_TOKEN_POLICY = {
  access_token: {
    expires_in: 90 * 24 * 60 * 60 * 1000, // 90ì¼
    max_reissue: 3, // ìµœëŒ€ 3íšŒ ì¬ë°œê¸‰
    revoke_on_claim: true // claim ì‹œ ìë™ íšŒìˆ˜
  },
  claim_token: {
    expires_in: 15 * 60 * 1000, // 15ë¶„
    max_reissue: 1, // ìµœëŒ€ 1íšŒ ì¬ë°œê¸‰
    revoke_on_use: true // ì‚¬ìš© ì‹œ ìë™ íšŒìˆ˜
  }
};

// ì¬ë°œê¸‰ API
router.post('/guest/tokens/:access_token/reissue', async (req, res) => {
  const { access_token } = req.params;
  
  // 1. ê¸°ì¡´ í† í° ì¡°íšŒ
  const [tokens] = await connection.execute(
    'SELECT * FROM guest_order_access_tokens WHERE token = ?',
    [access_token]
  );
  
  if (tokens.length === 0) {
    return res.status(404).json({ success: false, message: 'í† í°ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' });
  }
  
  const token = tokens[0];
  
  // 2. ì¬ë°œê¸‰ íšŸìˆ˜ í™•ì¸
  if (token.reissue_count >= GUEST_TOKEN_POLICY.access_token.max_reissue) {
    return res.status(400).json({ success: false, message: 'ì¬ë°œê¸‰ íšŸìˆ˜ ì´ˆê³¼' });
  }
  
  // 3. ê¸°ì¡´ í† í° íšŒìˆ˜
  await connection.execute(
    'UPDATE guest_order_access_tokens SET revoked_at = NOW() WHERE token = ?',
    [access_token]
  );
  
  // 4. ìƒˆ í† í° ë°œê¸‰
  const newToken = generateRandomToken();
  await connection.execute(
    `INSERT INTO guest_order_access_tokens 
     (order_id, token, expires_at, reissue_count, created_at)
     VALUES (?, ?, ?, ?, NOW())`,
    [token.order_id, newToken, new Date(Date.now() + GUEST_TOKEN_POLICY.access_token.expires_in), token.reissue_count + 1]
  );
  
  return res.json({ success: true, token: newToken });
});
```

**ê¶Œì¥**: ì •ì±… ëª…ì‹œ í•„ìš”

---

## ğŸ” í˜„ì¬ ì‹œìŠ¤í…œê³¼ì˜ í˜¸í™˜ì„± ë¶„ì„

### 1. ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ í˜¸í™˜ì„±

#### âœ… í˜¸í™˜ ê°€ëŠ¥í•œ ë¶€ë¶„
1. **orders í…Œì´ë¸”**: ê¸°ë³¸ êµ¬ì¡° ì¡´ì¬
2. **order_items í…Œì´ë¸”**: ê¸°ë³¸ êµ¬ì¡° ì¡´ì¬
3. **warranties í…Œì´ë¸”**: ê¸°ë³¸ êµ¬ì¡° ì¡´ì¬ (ë§ˆì´ê·¸ë ˆì´ì…˜ í•„ìš”)
4. **token_master í…Œì´ë¸”**: ê¸°ë³¸ êµ¬ì¡° ì¡´ì¬ (token_pk ì¶”ê°€ í•„ìš”)
5. **order_idempotency í…Œì´ë¸”**: ê¸°ë³¸ êµ¬ì¡° ì¡´ì¬ (owner_key ë°©ì‹ìœ¼ë¡œ ë³€ê²½ í•„ìš”, í…Œì´ë¸”ëª… í™•ì •: `order_idempotency`)

#### âŒ ì‹ ê·œ ìƒì„± í•„ìš”í•œ ë¶€ë¶„
1. **order_item_units í…Œì´ë¸”**: ì™„ì „ ì‹ ê·œ (ê·¼ê±°: `backend/migrations/` ë””ë ‰í† ë¦¬ ê²€ìƒ‰ ê²°ê³¼ í•´ë‹¹ í…Œì´ë¸” DDL ì—†ìŒ)
2. **stock_units í…Œì´ë¸”**: ì™„ì „ ì‹ ê·œ (ê·¼ê±°: `backend/migrations/` ë””ë ‰í† ë¦¬ ê²€ìƒ‰ ê²°ê³¼ í•´ë‹¹ í…Œì´ë¸” DDL ì—†ìŒ)
3. **paid_events í…Œì´ë¸”**: ì™„ì „ ì‹ ê·œ (ê·¼ê±°: `backend/migrations/` ë””ë ‰í† ë¦¬ ê²€ìƒ‰ ê²°ê³¼ í•´ë‹¹ í…Œì´ë¸” DDL ì—†ìŒ)
4. **shipments í…Œì´ë¸”**: ì™„ì „ ì‹ ê·œ (ê·¼ê±°: `backend/migrations/` ë””ë ‰í† ë¦¬ ê²€ìƒ‰ ê²°ê³¼ í•´ë‹¹ í…Œì´ë¸” DDL ì—†ìŒ)
5. **shipment_units í…Œì´ë¸”**: ì™„ì „ ì‹ ê·œ (ê·¼ê±°: `backend/migrations/` ë””ë ‰í† ë¦¬ ê²€ìƒ‰ ê²°ê³¼ í•´ë‹¹ í…Œì´ë¸” DDL ì—†ìŒ)
6. **refund_requests í…Œì´ë¸”**: ì™„ì „ ì‹ ê·œ (ê·¼ê±°: `backend/migrations/` ë””ë ‰í† ë¦¬ ê²€ìƒ‰ ê²°ê³¼ í•´ë‹¹ í…Œì´ë¸” DDL ì—†ìŒ)
7. **warranty_events í…Œì´ë¸”**: ì™„ì „ ì‹ ê·œ (ê·¼ê±°: `backend/migrations/` ë””ë ‰í† ë¦¬ ê²€ìƒ‰ ê²°ê³¼ í•´ë‹¹ í…Œì´ë¸” DDL ì—†ìŒ)
8. **guest_order_access_tokens í…Œì´ë¸”**: ì™„ì „ ì‹ ê·œ (ê·¼ê±°: `backend/migrations/` ë””ë ‰í† ë¦¬ ê²€ìƒ‰ ê²°ê³¼ í•´ë‹¹ í…Œì´ë¸” DDL ì—†ìŒ)
9. **claim_tokens í…Œì´ë¸”**: ì™„ì „ ì‹ ê·œ (ê·¼ê±°: `backend/migrations/` ë””ë ‰í† ë¦¬ ê²€ìƒ‰ ê²°ê³¼ í•´ë‹¹ í…Œì´ë¸” DDL ì—†ìŒ)

### 2. ë°±ì—”ë“œ ë¡œì§ í˜¸í™˜ì„±

#### âœ… ì¬ì‚¬ìš© ê°€ëŠ¥í•œ ë¶€ë¶„
1. **ì£¼ë¬¸ë²ˆí˜¸ ìƒì„± ë¡œì§**: `generateOrderNumber()` ê·¸ëŒ€ë¡œ ì‚¬ìš© ê°€ëŠ¥
2. **í† ìŠ¤ API í˜¸ì¶œ ë¡œì§**: ê·¸ëŒ€ë¡œ ì‚¬ìš© ê°€ëŠ¥
3. **QR ì½”ë“œ í† í° ê²€ì¦ ë¡œì§**: ê·¸ëŒ€ë¡œ ì‚¬ìš© ê°€ëŠ¥ (token â†’ token_pk ì¡°íšŒë§Œ ì¶”ê°€)
4. **ë¡œê·¸ì¸ ì²´í¬**: `requireAuthForHTML` ê·¸ëŒ€ë¡œ ì‚¬ìš© ê°€ëŠ¥

#### âš ï¸ ìˆ˜ì • í•„ìš”í•œ ë¶€ë¶„
1. **ì£¼ë¬¸ ìƒì„± ë¡œì§**: (ê·¼ê±°: `backend/order-routes.js` 367ì¤„) `owner_key` ë°©ì‹ìœ¼ë¡œ ë³€ê²½ í•„ìš”
2. **ê²°ì œ í™•ì¸ ë¡œì§**: (ê·¼ê±°: `backend/payments-routes.js` 64-386ì¤„) `processPaidOrder()` í•¨ìˆ˜ ì¶”ê°€ í•„ìš”
3. **QR ìŠ¤ìº” ë¡œì§**: (ê·¼ê±°: `backend/auth-routes.js` 247-292ì¤„, 621-624ì¤„) warranty ìƒì„± ì œê±°, ì¡°íšŒë§Œ ìˆ˜í–‰
4. **Idempotency ì²˜ë¦¬**: (ê·¼ê±°: `backend/order-routes.js` 405-408ì¤„) `owner_key` ë°©ì‹ìœ¼ë¡œ ë³€ê²½ í•„ìš”
5. **ê´€ë¦¬ì ìƒíƒœ ë³€ê²½ API**: (ê·¼ê±°: `backend/index.js` 1599-1671ì¤„) `PUT /api/admin/orders/:orderId/status` ì œê±° ë˜ëŠ” ì§‘ê³„ í•¨ìˆ˜ë¡œ ëŒ€ì²´ í•„ìš”

#### âŒ ì‹ ê·œ êµ¬í˜„ í•„ìš”í•œ ë¶€ë¶„
1. **processPaidOrder() í•¨ìˆ˜**: ì™„ì „ ì‹ ê·œ
2. **í™œì„±í™” API**: ì™„ì „ ì‹ ê·œ
3. **claim API**: ì™„ì „ ì‹ ê·œ
4. **í™˜ë¶ˆ ì²˜ë¦¬ API (ê´€ë¦¬ì ì „ìš©)**: ì™„ì „ ì‹ ê·œ (ê³ ê° ì§ì ‘ ìš”ì²­ ë¶ˆê°€, ë¬¸ì˜ ì‹œìŠ¤í…œìœ¼ë¡œë§Œ ì ‘ìˆ˜)
5. **ì–‘ë„ ìš”ì²­ API (ì‚¬ìš©ì)**: ì™„ì „ ì‹ ê·œ (ìˆ˜ë ¹ì ì´ë©”ì¼ ì…ë ¥, ëœë¤ 7ì ì½”ë“œ ìƒì„±, ì´ë©”ì¼ ë°œì†¡)
6. **ì–‘ë„ ìˆ˜ë½ API (ìˆ˜ë ¹ì)**: ì™„ì „ ì‹ ê·œ (ëœë¤ 7ì ì½”ë“œ ê²€ì¦, ë¡œê·¸ì¸ í•„ìˆ˜)
7. **ì†¡ì¥ ì²˜ë¦¬ API**: ì™„ì „ ì‹ ê·œ
8. **ë¹„íšŒì› ì£¼ë¬¸ ì¡°íšŒ API**: ì™„ì „ ì‹ ê·œ
9. **ì£¼ë¬¸ ìƒì„¸ ì‹œë¦¬ì–¼ ë„˜ë²„ ì¡°íšŒ**: `order_item_units` ì¡°íšŒ ê¸°ëŠ¥

---

## ğŸ“‹ êµ¬í˜„ ì²´í¬ë¦¬ìŠ¤íŠ¸ (ìš°ì„ ìˆœìœ„ë³„)

### Phase 1: í•µì‹¬ ì¸í”„ë¼ (í•„ìˆ˜)
- [ ] `token_pk` ë§ˆì´ê·¸ë ˆì´ì…˜ (token_master, warranties)
- [ ] `owner_key` ë°©ì‹ìœ¼ë¡œ ë³€ê²½ (`order_idempotency` í…Œì´ë¸”ëª… í™•ì •)
- [ ] `order_item_units` í…Œì´ë¸” ìƒì„±
- [ ] `stock_units` í…Œì´ë¸” ìƒì„±
- [ ] `paid_events` í…Œì´ë¸” ìƒì„±
- [ ] `warranties.status` ì»¬ëŸ¼ ì¶”ê°€
- [ ] `warranties.owner_user_id` ì»¬ëŸ¼ ì¶”ê°€
- [ ] `warranties.source_order_item_unit_id` ì»¬ëŸ¼ ì¶”ê°€

### Phase 2: ë¹„íšŒì› ì§€ì› (í•„ìˆ˜)
- [ ] `guest_order_access_tokens` í…Œì´ë¸” ìƒì„±
- [ ] `claim_tokens` í…Œì´ë¸” ìƒì„±
- [ ] `orders.guest_id` ì»¬ëŸ¼ ì¶”ê°€
- [ ] `guest_session_id` ì¿ í‚¤ ê´€ë¦¬ ë¡œì§
- [ ] `optionalAuth` ë¯¸ë“¤ì›¨ì–´ ìƒì„±
- [ ] ë¹„íšŒì› ì£¼ë¬¸ ìƒì„± ë¡œì§
- [ ] ë¹„íšŒì› ì£¼ë¬¸ ì¡°íšŒ API

### Phase 3: paid ì²˜ë¦¬ (í•„ìˆ˜)
- [ ] `processPaidOrder()` í•¨ìˆ˜ êµ¬í˜„ (Aì•ˆ: ìˆœì°¨ INSERT)
- [ ] ì¬ê³  ë°°ì • ë¡œì§
- [ ] `order_item_units` ìƒì„± ë¡œì§
- [ ] `warranties` ìƒì„± ë¡œì§ (paid ì‹œì )
- [ ] `POST /api/payments/confirm`ì— í˜¸ì¶œ ì¶”ê°€
- [ ] `POST /api/payments/webhook`ì— í˜¸ì¶œ ì¶”ê°€

### Phase 4: í™œì„±í™”/claim (í•„ìˆ˜)
- [ ] í™œì„±í™” API êµ¬í˜„ (ë²„íŠ¼ ë™ì˜í˜•)
- [ ] claim API êµ¬í˜„
- [ ] QR ìŠ¤ìº” ë¡œì§ ìˆ˜ì • (warranty ìƒì„± ì œê±°)

### Phase 5: í™˜ë¶ˆ/ì–‘ë„ (í•„ìˆ˜)
- [ ] `refund_requests` í…Œì´ë¸” ìƒì„± (ê³ ê° ë¬¸ì˜ ê¸°ë°˜ í™˜ë¶ˆ ìš”ì²­ ê¸°ë¡ìš©)
- [ ] **í™˜ë¶ˆ ìš”ì²­ API ì œê±°** (ê³ ê° ì§ì ‘ ìš”ì²­ ë¶ˆê°€, ë¬¸ì˜ ì‹œìŠ¤í…œìœ¼ë¡œë§Œ ì ‘ìˆ˜)
- [ ] **í™˜ë¶ˆ ì²˜ë¦¬ API (ê´€ë¦¬ì ì „ìš©)**: ê´€ë¦¬ì í˜ì´ì§€ì—ì„œ ìˆ˜ë™ìœ¼ë¡œ í™˜ë¶ˆ ì²˜ë¦¬
- [ ] í™˜ë¶ˆ ì²˜ë¦¬ ì‹œ `warranties.status` â†’ `revoked` ì „ì´
- [ ] í™˜ë¶ˆ ì²˜ë¦¬ ì‹œ `order_item_units.unit_status` ì—…ë°ì´íŠ¸
- [ ] `warranty_transfers` í…Œì´ë¸” ìƒì„± (ì–‘ë„ ìš”ì²­/ìˆ˜ë½ ê´€ë¦¬)
- [ ] **ì–‘ë„ ìš”ì²­ API (ì‚¬ìš©ì)**: `POST /api/warranties/:warrantyId/transfer` (ìˆ˜ë ¹ì ì´ë©”ì¼ ì…ë ¥, ëœë¤ 7ì ì½”ë“œ ìƒì„±, ì´ë©”ì¼ ë°œì†¡)
- [ ] **ì–‘ë„ ìˆ˜ë½ API (ìˆ˜ë ¹ì)**: `POST /api/warranties/transfer/accept` (ëœë¤ 7ì ì½”ë“œ ê²€ì¦, ë¡œê·¸ì¸ í•„ìˆ˜, ìˆ˜ë½ ì²˜ë¦¬)
- [ ] ì–‘ë„ ìš”ì²­ ì·¨ì†Œ API: `POST /api/warranties/transfer/:transferId/cancel`
- [ ] ì–‘ë„ ë§Œë£Œ ë°°ì¹˜ ì‘ì—… (72ì‹œê°„ ì´ˆê³¼ ìš”ì²­ ìë™ ë§Œë£Œ)

### Phase 6: ë°°ì†¡/ì†¡ì¥ (í•„ìˆ˜)
- [ ] `shipments` í…Œì´ë¸” ìƒì„±
- [ ] `shipment_units` í…Œì´ë¸” ìƒì„±
- [ ] ì†¡ì¥ ìƒì„± API
- [ ] ë°°ì†¡ ì™„ë£Œ ì²˜ë¦¬ API
- [ ] `orders.status` ì§‘ê³„ í•¨ìˆ˜

### Phase 7: ê°ì‚¬ ë¡œê·¸ (ê¶Œì¥)
- [ ] `warranty_events` í…Œì´ë¸” ìƒì„±
- [ ] ì´ë²¤íŠ¸ ë¡œê¹… ë¡œì§
- [ ] ê´€ë¦¬ì íƒ€ì„ë¼ì¸ ì¡°íšŒ API

### Phase 8: ì¬ê³  í•´ì œ (í•„ìˆ˜)
- [ ] ê²°ì œ ì‹¤íŒ¨ ì‹œ ì¬ê³  í•´ì œ ë¡œì§
- [ ] ë°°ì¹˜ ì‘ì—… (ë§Œë£Œëœ reserved í•´ì œ)

### Phase 9: ê´€ë¦¬ì í˜ì´ì§€ (í•„ìˆ˜)
- [ ] ì£¼ë¬¸ ëª©ë¡ API (ê²€ìƒ‰/í•„í„°)
- [ ] **ì£¼ë¬¸ ìƒì„¸ API (3ë‹¨ êµ¬ì¡°)**: ì£¼ë¬¸ë³„ ì‹œë¦¬ì–¼ ë„˜ë²„ í™•ì¸ ê¸°ëŠ¥ (`order_item_units`)
  - **1ë‹¨: ì£¼ë¬¸ ì •ë³´** (`orders`): ì£¼ë¬¸ë²ˆí˜¸, ê³ ê° ì •ë³´, ì£¼ë¬¸ ìƒíƒœ, ê²°ì œ ì •ë³´ ë“±
  - **2ë‹¨: ì£¼ë¬¸ í•­ëª©** (`order_items`): ì œí’ˆëª…, ìˆ˜ëŸ‰, ê°€ê²© ë“±
  - **3ë‹¨: ì£¼ë¬¸ í•­ëª© ë‹¨ìœ„** (`order_item_units`): ì‹œë¦¬ì–¼ ë„˜ë²„, í† í° ì •ë³´ (`token_master.token`), ë°°ì†¡ ìƒíƒœ, ë³´ì¦ì„œ ìƒíƒœ ë“±
  - **ê´€ë¦¬ìê°€ í•„ìš”í•œ ì •ë³´**: ê° ì œí’ˆì˜ ì‹œë¦¬ì–¼ ë„˜ë²„ì™€ í† í°(ë‚œìˆ˜ 20ì)ì„ í™•ì¸í•˜ì—¬ í˜„ì‹¤ì—ì„œ í•´ë‹¹ ì œí’ˆì„ ì°¾ì•„ ë°°ì†¡/í™˜ë¶ˆ ì²˜ë¦¬
- [ ] **ë°°ì†¡ ì²˜ë¦¬ í˜ì´ì§€**: ì†¡ì¥ ìƒì„±, ë°°ì†¡ ìƒíƒœ ì—…ë°ì´íŠ¸
- [ ] **í™˜ë¶ˆ ì²˜ë¦¬ í˜ì´ì§€**: ê³ ê° ë¬¸ì˜ ê¸°ë°˜ í™˜ë¶ˆ ìš”ì²­ í™•ì¸ ë° ìˆ˜ë™ ì²˜ë¦¬
- [ ] **í™˜ë¶ˆ ì²˜ë¦¬ API (ê´€ë¦¬ì ì „ìš©)**: `POST /api/admin/refunds/process` (ê³ ê° ì§ì ‘ ìš”ì²­ ë¶ˆê°€)
  - ê´€ë¦¬ìê°€ ì£¼ë¬¸ ìƒì„¸ì—ì„œ ì‹œë¦¬ì–¼ ë„˜ë²„ì™€ í† í°ì„ í™•ì¸í•˜ì—¬ í™˜ë¶ˆ ì²˜ë¦¬
- [ ] ê´€ë¦¬ì ì•¡ì…˜ API

---

## ğŸ¯ ìµœì¢… ê²€í†  ê²°ë¡ 

### âœ… ìŠ¤í™ì˜ ìš°ìˆ˜ì„±
1. **SSOT 3ì¤‘ ë¶„ë¦¬**: ë§¤ìš° ìš°ìˆ˜
2. **ë©±ë“±ì„± DB ì œì•½**: ë§¤ìš° ìš°ìˆ˜
3. **ì›ìí™” ë³´ì¥**: ë§¤ìš° ìš°ìˆ˜
4. **token_pk ë¶„ë¦¬**: ë§¤ìš° ìš°ìˆ˜
5. **ë¶€ë¶„ë°°ì†¡ ì§€ì›**: ë§¤ìš° ìš°ìˆ˜

### âš ï¸ ì£¼ì˜ì‚¬í•­
1. **token_pk ë§ˆì´ê·¸ë ˆì´ì…˜**: PK êµì²´/ê¸°ì¡´ FK ì œê±°/ì¬ì—°ê²° ìˆœì„œ í•„ìˆ˜ (ë‹¨ìˆœ ADD ë¶ˆê°€)
2. **owner_key ë°©ì‹**: NULL ì²˜ë¦¬ ë¬¸ì œ í•´ê²°ë¨
3. **SKIP LOCKED**: MySQL ë²„ì „ í™•ì¸ í•„ìš”, ë¯¸ì§€ì› ì‹œ ì›Œì»¤ ë‹¨ì¼í™” ë˜ëŠ” ë½ ìˆœì„œ ê°•ì œ
4. **ì¬ê³  í•´ì œ**: ì´ë²¤íŠ¸ + ë°°ì¹˜ ë³‘í–‰ ê¶Œì¥, **ë°˜ë“œì‹œ `paid_events`/`paid_at` ê¸°ì¤€** (orders.status ì‚¬ìš© ê¸ˆì§€)
5. **ì§‘ê³„ í•¨ìˆ˜**: ì• í”Œë¦¬ì¼€ì´ì…˜ ë ˆë²¨ êµ¬í˜„ ê¶Œì¥
6. **ê°ì‚¬ ë¡œê·¸**: íŠ¸ëœì­ì…˜ ë‚´ ìµœì†Œ ì´ë²¤íŠ¸ ê¸°ë¡ í•„ìˆ˜, ìƒì„¸/í™•ì¥ì€ ë¹„ë™ê¸° (Outbox íŒ¨í„´)

### ğŸ’¡ ê°œì„  ì œì•ˆ
1. **ë¹„íšŒì› í† í° ì •ì±…**: êµ¬ì²´ì  ì •ì±… ëª…ì‹œ í•„ìš”
2. **ì§‘ê³„ í•¨ìˆ˜**: íŠ¸ë¦¬ê±° ëŒ€ì‹  ì• í”Œë¦¬ì¼€ì´ì…˜ ë ˆë²¨ ê¶Œì¥
3. **ê°ì‚¬ ë¡œê·¸**: ë¹„ë™ê¸° ë¡œê¹…ìœ¼ë¡œ ì„±ëŠ¥ ìµœì í™”
4. **ì¬ê³  í•´ì œ**: ì´ë²¤íŠ¸ ê¸°ë°˜ + ë°°ì¹˜ ì‘ì—… ë³‘í–‰

### ğŸ“Š êµ¬í˜„ ë‚œì´ë„ ë° ì™„ë£Œ ì¡°ê±´
- **êµ¬í˜„ ë‚œì´ë„**: ì¤‘ê°„-ë†’ìŒ (ì‹ ê·œ í…Œì´ë¸”/ë¡œì§ ë§ìŒ)
- **Phase ê²Œì´íŠ¸ ì¡°ê±´ (ì™„ë£Œ ì •ì˜)**:
  - **Phase 1 ì™„ë£Œ ì¡°ê±´**: 
    - token_pk ì „í™˜ ì™„ë£Œ (PK êµì²´ + FK ì „í™˜)
    - paid_events UNIQUE ì œì•½ í™•ì¸
    - processPaidOrder ì›ìí™” í†µê³¼ (íŠ¸ëœì­ì…˜ í…ŒìŠ¤íŠ¸)
    - ë™ì‹œì„± í…ŒìŠ¤íŠ¸ í†µê³¼ (ì¬ê³  ê²½í•© ì—†ìŒ)
  - **Phase 2 ì™„ë£Œ ì¡°ê±´**:
    - ë¹„íšŒì› ì£¼ë¬¸ ìƒì„±/ì¡°íšŒ í†µê³¼
    - claim API ë™ì‘ í™•ì¸
    - guest_session_id ì¿ í‚¤ ê´€ë¦¬ ì •ìƒ
  - **Phase 3 ì™„ë£Œ ì¡°ê±´**:
    - paid ì²˜ë¦¬ íŠ¸ëœì­ì…˜ í†µê³¼
    - ì¬ê³  ë°°ì • ì •ìƒ
    - order_item_units/warranties ìƒì„± ì •ìƒ
  - **Phase 4-9 ì™„ë£Œ ì¡°ê±´**:
    - ê° ê¸°ëŠ¥ë³„ í†µí•© í…ŒìŠ¤íŠ¸ í†µê³¼
    - SSOT ì›ì¹™ ì¤€ìˆ˜ í™•ì¸
    - ë©±ë“±ì„± í…ŒìŠ¤íŠ¸ í†µê³¼

### âœ… ìµœì¢… í‰ê°€
**ìŠ¤í™ì€ ë§¤ìš° ìš°ìˆ˜í•˜ë©°, í˜„ì¬ ì‹œìŠ¤í…œê³¼ì˜ í˜¸í™˜ì„±ë„ ì¢‹ìŠµë‹ˆë‹¤.**

**êµ¬í˜„ ê°€ëŠ¥ì„±**: ë†’ìŒ
**ì•ˆì •ì„±**: ë†’ìŒ (ì›ìí™” ë³´ì¥)
**í™•ì¥ì„±**: ë†’ìŒ (ë¶€ë¶„ë°°ì†¡ ì§€ì›)
**ìœ ì§€ë³´ìˆ˜ì„±**: ë†’ìŒ (SSOT ë¶„ë¦¬)

**ì´ ìŠ¤í™ëŒ€ë¡œ êµ¬í˜„í•˜ë©´**:
- âœ… êµ¬í˜„ì ë°”ë€Œì–´ë„ ê¸°ì¤€ì´ í”ë“¤ë¦¬ì§€ ì•ŠìŒ
- âœ… ì •ì±… ë°”ë€Œì–´ë„ ê¸°ì¤€ì´ í”ë“¤ë¦¬ì§€ ì•ŠìŒ
- âœ… ë¶„ìŸ ìƒê²¨ë„ ê¸°ì¤€ì´ í”ë“¤ë¦¬ì§€ ì•ŠìŒ

**âš ï¸ ì •í•©ì„± ê·œì¹™ (í•µì‹¬ ì›ì¹™)**:
**ìœ„ ë³´ì™„ì•ˆë“¤ì€ ê¸°ëŠ¥ ì¶”ê°€ê°€ ì•„ë‹ˆë¼, ë™ì‹œì„±/ì¬ì‹œë„/ë¶€ë¶„ì²˜ë¦¬(ë¶€ë¶„í™˜ë¶ˆÂ·ë¶€ë¶„ë°°ì†¡Â·ì¬íŒë§¤Â·ì–‘ë„)ì—ì„œ ì‹œìŠ¤í…œ SSOTë¥¼ ê¹¨ì§€ ì•Šê¸° ìœ„í•œ ì •í•©ì„± ê·œì¹™ì´ë‹¤.**

---

## ğŸ“ ì¶”ê°€ ê¶Œì¥ì‚¬í•­

### 1. ë¬¸ì„œí™”
- [ ] API ëª…ì„¸ì„œ ì‘ì„± (OpenAPI/Swagger)
- [ ] ìƒíƒœ ì „ì´í‘œ ë¬¸ì„œí™”
- [ ] ì§‘ê³„ ê·œì¹™ ë¬¸ì„œí™”
- [ ] ì—ëŸ¬ ì½”ë“œ ë¬¸ì„œí™”

### 2. í…ŒìŠ¤íŠ¸
- [ ] ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ (ê° í•¨ìˆ˜)
- [ ] í†µí•© í…ŒìŠ¤íŠ¸ (ì „ì²´ íë¦„)
- [ ] ë©±ë“±ì„± í…ŒìŠ¤íŠ¸
- [ ] ë™ì‹œì„± í…ŒìŠ¤íŠ¸

### 3. ëª¨ë‹ˆí„°ë§
- [ ] paid ì²˜ë¦¬ ì‹œê°„ ëª¨ë‹ˆí„°ë§
- [ ] ì¬ê³  ë°°ì • ì‹œê°„ ëª¨ë‹ˆí„°ë§
- [ ] íŠ¸ëœì­ì…˜ íƒ€ì„ì•„ì›ƒ ëª¨ë‹ˆí„°ë§
- [ ] ì¬ê³  í•´ì œ ë°°ì¹˜ ì‘ì—… ëª¨ë‹ˆí„°ë§

### 4. ë°±ì—…/ë³µêµ¬
- [ ] ë§ˆì´ê·¸ë ˆì´ì…˜ ì „ ë°±ì—…
- [ ] ë¡¤ë°± ê³„íš ìˆ˜ë¦½
- [ ] ë°ì´í„° ê²€ì¦ ìŠ¤í¬ë¦½íŠ¸

---

---

## ğŸ›¡ï¸ ìš´ì˜ ë‹¨ê³„ì—ì„œ ë°˜ë“œì‹œ ë³´ê°•í•´ì•¼ í•  ìœ„í—˜ ì§€ì 

### âš ï¸ 1. ì¬íŒë§¤ ì‹œ ë™ì‹œì„± ë¬¸ì œ (ì¤‘ìš”)

**ìƒí™©**: `stock_units`ê°€ `in_stock` ìƒíƒœì¼ ë•Œ, ë™ì‹œì— ë‘ ì£¼ë¬¸ì´ paid ì²˜ë¦¬ë¡œ ì§„ì…í•˜ë©´ ê°™ì€ ì¬ê³ ë¥¼ ì¡ì„ ìˆ˜ ìˆìŒ

**ë³´ê°• ê¶Œì¥**:
```sql
SELECT stock_unit_id, token_pk
FROM stock_units
WHERE status = 'in_stock' AND product_id = ?
FOR UPDATE SKIP LOCKED
LIMIT 1
```

**í•µì‹¬ ì •ì±…**: ì¬íŒë§¤ ë¡œì§ì€ ë°˜ë“œì‹œ ë‹¤ìŒ 3ê°œê°€ í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ì´ì–´ì•¼ í•¨:
1. `stock_units` ë½ (FOR UPDATE SKIP LOCKED)
2. `order_item_units` ìƒì„±
3. `warranties` ì—…ë°ì´íŠ¸

**âš ï¸ ë½ íšë“ ìˆœì„œ ê³ ì • (ë°ë“œë½ ë°©ì§€)**:
> **"ë½ íšë“ ìˆœì„œ: `stock_units`(ë¬¼ë¦¬) â†’ `orders`(ê²°ì œ) â†’ `warranties`(ê¶Œë¦¬) ìˆœìœ¼ë¡œ ê³ ì •"**

ì´ ìˆœì„œë¥¼ ë¬¸ì„œì— ê³ ì •í•˜ë©´, ë‚˜ì¤‘ì— ê¸°ëŠ¥ì´ ëŠ˜ì–´ë„ ë°ë“œë½ ìœ„í—˜ì´ í¬ê²Œ ì¤„ì–´ë“ ë‹¤.

**êµ¬í˜„ ì˜ˆì‹œ (ë½ ìˆœì„œ ê³ ì •)**:
```javascript
await connection.beginTransaction();
try {
  // âš ï¸ ë½ ìˆœì„œ: stock_units(ë¬¼ë¦¬) â†’ orders(ê²°ì œ) â†’ warranties(ê¶Œë¦¬)
  
  // 1. stock_units ë½ íšë“ (ë¬¼ë¦¬ì  ì¬ê³ )
  const [stockUnits] = await connection.execute(
    `SELECT stock_unit_id, token_pk
     FROM stock_units
     WHERE status = 'in_stock' AND product_id = ?
     FOR UPDATE SKIP LOCKED
     LIMIT 1`,
    [productId]
  );
  
  if (stockUnits.length === 0) {
    throw new Error('ì¬ê³  ë¶€ì¡±');
  }
  
  const stockUnit = stockUnits[0];
  
  // 2. orders ë½ íšë“ (ê²°ì œ ì •ë³´)
  await connection.execute(
    'SELECT * FROM orders WHERE order_id = ? FOR UPDATE',
    [orderId]
  );
  
  // 3. order_item_units ìƒì„±
  const [unitResult] = await connection.execute(
    `INSERT INTO order_item_units 
     (order_item_id, unit_seq, stock_unit_id, token_pk, unit_status)
     VALUES (?, ?, ?, ?, 'reserved')`,
    [orderItemId, unitSeq, stockUnit.stock_unit_id, stockUnit.token_pk]
  );
  
  // 4. warranties ì—…ë°ì´íŠ¸ (ê¶Œë¦¬, ì¬íŒë§¤ì¸ ê²½ìš°)
  const [updateResult] = await connection.execute(
    `UPDATE warranties
     SET status = ?,
         source_order_item_unit_id = ?,
         owner_user_id = ?
     WHERE token_pk = ? AND status = 'revoked'`,
    [newStatus, unitResult.insertId, ownerUserId, stockUnit.token_pk]
  );
  
  // âš ï¸ ì›ìì  ì¡°ê±´ ê²€ì¦
  if (updateResult.affectedRows !== 1) {
    throw new Error(
      `warranties ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: affectedRows=${updateResult.affectedRows}`
    );
  }
  
  await connection.commit();
} catch (error) {
  await connection.rollback();
  throw error;
}
```

### âš ï¸ 2. Claim ì´í›„ guest_id ì²˜ë¦¬ ì •ì±… ëª…í™•í™”

**í˜„ì¬ ë¬¸ì„œ**: `guest_id` ìœ ì§€ ë˜ëŠ” NULL

**ê¶Œì¥ ì •ì±… (ìš´ì˜ ê·œì¹™ ê³ ì •)**:
- `orders.user_id` ì„¤ì • ì™„ë£Œ ì‹œ `guest_id`ëŠ” **ìœ ì§€**
- `guest_order_access_token`ë§Œ revoke

**ì´ìœ **:
- ê°ì‚¬ ë¡œê·¸: "ì–´ë–¤ ê²½ë¡œë¡œ ìƒì„±ëœ ì£¼ë¬¸ì¸ì§€" ì¶”ì  ê°€ëŠ¥
- CS ë¶„ìŸ ì‹œ: ë¹„íšŒì› ì£¼ë¬¸ì´ì—ˆëŠ”ì§€ í™•ì¸ ê°€ëŠ¥

**êµ¬í˜„ ì˜ˆì‹œ**:
```javascript
// Claim ì²˜ë¦¬
await connection.execute(
  'UPDATE orders SET user_id = ? WHERE order_id = ?',
  [userId, orderId]
);
// guest_idëŠ” ìœ ì§€ (NULLë¡œ ë³€ê²½í•˜ì§€ ì•ŠìŒ)

// guest_order_access_tokenë§Œ revoke
await connection.execute(
  'UPDATE guest_order_access_tokens SET revoked_at = NOW() WHERE order_id = ?',
  [orderId]
);
```

### âš ï¸ 3. revoked â†’ issued ì „ì´ ì¡°ê±´ ëª…ë¬¸í™”

**ê¶Œì¥ ê·œì¹™**:
- `revoked` â†’ `issued` ì „ì´ëŠ” **ìƒˆë¡œìš´ `paid_events`ê°€ ìƒì„±ëœ ê²½ìš°ë§Œ í—ˆìš©**
- ê´€ë¦¬ì ìˆ˜ë™ ë³€ê²½ âŒ

**ì´ìœ **: ê´€ë¦¬ì ì‹¤ìˆ˜ë¡œ ê¶Œë¦¬ ë¶€í™œ ì‚¬ê³  ë°©ì§€

**êµ¬í˜„ ê²€ì¦ (ì›ìì  ì¡°ê±´ í¬í•¨)**:
```javascript
// ì¬íŒë§¤ ì‹œ warranties ì—…ë°ì´íŠ¸ (paid ì²˜ë¦¬ íŠ¸ëœì­ì…˜ ë‚´ì—ì„œë§Œ)
const [paidEvents] = await connection.execute(
  'SELECT * FROM paid_events WHERE order_id = ?',
  [orderId]
);

if (paidEvents.length === 0) {
  throw new Error('paid_eventsê°€ ì—†ìœ¼ë©´ revoked â†’ issued ì „ì´ ë¶ˆê°€');
}

// warranties ì—…ë°ì´íŠ¸ (ì›ìì  ì¡°ê±´ ê²€ì¦)
const [updateResult] = await connection.execute(
  `UPDATE warranties
   SET status = ?,
       source_order_item_unit_id = ?,
       owner_user_id = ?
   WHERE token_pk = ? AND status = 'revoked'`,
  [newStatus, orderItemUnitId, ownerUserId, tokenPk]
);

// âš ï¸ ì›ìì  ì¡°ê±´ ê²€ì¦: affected rowsê°€ ì •í™•íˆ 1ì´ì–´ì•¼ í•¨
if (updateResult.affectedRows !== 1) {
  await connection.rollback();
  throw new Error(
    `warranties ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: affectedRows=${updateResult.affectedRows}, ` +
    `token_pk=${tokenPk}. ` +
    `ì´ë¯¸ issued/activeì¸ í† í°ì´ê±°ë‚˜ ë™ì‹œì„± ê²½í•©ì´ ë°œìƒí–ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`
  );
}
```

**ì›ìì  ì¡°ê±´ì˜ ì´ì **:
- ì´ë¯¸ `issued`/`active`ì¸ í† í°ì„ ì‹¤ìˆ˜ë¡œ ë®ì–´ì”Œìš°ëŠ” ì‚¬ê³  ì°¨ë‹¨
- ë™ì‹œì„± ê²½í•©ì—ì„œ "ëˆ„ê°€ ë¨¼ì € reviveí–ˆëŠ”ì§€"ê°€ DB ê²°ê³¼ë¡œ í™•ì •ë¨
- `affectedRows !== 1`ì´ë©´ íŠ¸ëœì­ì…˜ ë¡¤ë°±ìœ¼ë¡œ ë°ì´í„° ë¬´ê²°ì„± ë³´ì¥

**ê´€ë¦¬ì APIì—ì„œ ê¸ˆì§€**:
```javascript
// âŒ ê´€ë¦¬ì APIì—ì„œ ì§ì ‘ ì „ì´ ê¸ˆì§€
router.put('/admin/warranties/:id/status', async (req, res) => {
  const { status } = req.body;
  
  if (status === 'issued' && currentStatus === 'revoked') {
    return res.status(403).json({
      message: 'revoked â†’ issued ì „ì´ëŠ” paid_events ìƒì„± ì‹œì—ë§Œ í—ˆìš©ë©ë‹ˆë‹¤.'
    });
  }
});
```

---

## ğŸ“‹ ìš´ì˜ ë‹¨ê³„ì—ì„œ ì¶”ê°€í•˜ë©´ ì¢‹ì€ ê·œì¹™ (ê¶Œì¥)

### â‘  warranties UNIQUE ì œì•½ (active_key íŒ¨í„´)

**ëª©ì **: "ìœ íš¨ ë³´ì¦ì„œëŠ” í•­ìƒ 1ê°œ"ë¥¼ DB ë ˆë²¨ì—ì„œ ë³´ì¥

**ì „ì œ ì¡°ê±´ (ì„¤ê³„ ì›ì¹™ ê³ ì •)**:
> **"token_pk ë‹¹ warranties ë ˆì½”ë“œëŠ” ì •í™•íˆ 1ê°œë§Œ ì¡´ì¬í•˜ë©°, ì¬íŒë§¤/í™˜ë¶ˆ/ì–‘ë„/ì œì¬ëŠ” ë™ì¼ ë ˆì½”ë“œë¥¼ ìƒíƒœ ì „ì´ë¡œ ì²˜ë¦¬í•œë‹¤."**

**âš ï¸ ì¤‘ìš”**: ì´ ì „ì œ ì¡°ê±´ì´ ì—†ìœ¼ë©´, ë‚˜ì¤‘ì— ëˆ„êµ°ê°€ "ì´ë ¥ ë³´ê´€ìš©ìœ¼ë¡œ ìƒˆ ë ˆì½”ë“œ ë§Œë“¤ì"ë¥¼ ì‰½ê²Œ ì‹œë„í•˜ë‹¤ê°€ UNIQUEì— ê±¸ë ¤ì„œ ì„¤ê³„ê°€ í”ë“¤ë¦°ë‹¤.

**âš ï¸ í•µì‹¬ ë¬¸ì œ**: `UNIQUE(token_pk)`ë§Œ ì‚¬ìš©í•˜ë©´ `revoked` ìƒíƒœë„ í¬í•¨ë˜ì–´ ì¬íŒë§¤ ì‹œ ì¶©ëŒ ë°œìƒ

**ê¶Œì¥: active_key íŒ¨í„´ (shipmentsì™€ ë™ì¼)**
```sql
-- active_key: ìœ íš¨ ë³´ì¦ì„œë§Œ UNIQUE ì œì•½
ALTER TABLE warranties
  ADD COLUMN active_key VARCHAR(50) GENERATED ALWAYS AS (
    CASE WHEN status IN ('issued', 'issued_unassigned', 'active', 'suspended') 
         THEN CONCAT('token_', token_pk) 
         ELSE NULL 
    END
  ) VIRTUAL;

CREATE UNIQUE INDEX uk_warranties_active_key ON warranties(active_key);
```

**ìƒíƒœ ì „ì´ ê·œì¹™ (DB ì—…ë°ì´íŠ¸ ì¡°ê±´ìœ¼ë¡œ ê°•ì œ)**:
- **í™œì„±í™”**: `issued` â†’ `active` ë§Œ í—ˆìš© (ë‹¤ë¥¸ ìƒíƒœì—ì„œ í™œì„±í™” ë¶ˆê°€)
- **ì •ì§€/í•´ì œ**: `active` â†” `suspended` ë§Œ í—ˆìš©
- **í™˜ë¶ˆ/íšŒìˆ˜**: `active`/`suspended`/`issued` â†’ `revoked` í—ˆìš©
- **ì¬íŒë§¤**: `revoked` â†’ `issued`(ë˜ëŠ” `issued_unassigned`)ë§Œ í—ˆìš©

**ëª¨ë“  ìƒíƒœ ë³€ê²½ UPDATEëŠ” ë‹¤ìŒ ì›ì¹™ì„ ë”°ë¼ì•¼ í•¨**:
```sql
-- âœ… ì˜¬ë°”ë¥¸ íŒ¨í„´
UPDATE warranties 
SET status = ?, ...
WHERE warranty_id = ? AND status IN (?, ?, ...)  -- í˜„ì¬ ìƒíƒœ ì¡°ê±´ í¬í•¨
-- affectedRows=1 ê²€ì¦ í•„ìˆ˜
```

**ì˜µì…˜ B: ì „ì²´ UNIQUE (ë¹„ê¶Œì¥)**
```sql
ALTER TABLE warranties
ADD CONSTRAINT uk_warranties_token_pk UNIQUE (token_pk);
```
- âŒ ë¬¸ì œ: `revoked` ìƒíƒœë„ í¬í•¨ë˜ì–´ ì¬íŒë§¤ ì‹œ ì¶©ëŒ ë°œìƒ

**ê¶Œì¥**: active_key íŒ¨í„´
- ì´ìœ : ì¬íŒë§¤ ì‹œ `revoked` â†’ `issued` ì „ì´ê°€ ê°€ëŠ¥
- `revoked` ìƒíƒœëŠ” `active_key`ê°€ NULLì´ë¯€ë¡œ UNIQUE ì œì•½ì—ì„œ ì œì™¸ë¨
- ì „ì œ ì¡°ê±´ì— ë”°ë¼ ì´ë ¥ ë³´ê´€ì€ `warranty_events` í…Œì´ë¸”ë¡œ ì²˜ë¦¬

### â‘¡ warranty_eventsëŠ” ë°˜ë“œì‹œ ëª¨ë“  ìƒíƒœ ë³€ê²½ì—ì„œ ê¸°ë¡

**ëª©ì **: ë²•ì  ë¶„ìŸ ëŒ€ë¹„ìš© ë¡œê·¸

**ê¸°ë¡ ëŒ€ìƒ ì „ì´** (ëª¨ë‘ í•„ìˆ˜):
- `issued_unassigned` â†’ `issued` (claim) - `event_type: 'status_changed'`
- `issued` â†’ `active` (í™œì„±í™”) - `event_type: 'status_changed'`
- `active` â†’ `revoked` (í™˜ë¶ˆ) - `event_type: 'status_changed'`
- `revoked` â†’ `issued` (ì¬íŒë§¤) âš ï¸ **ì¤‘ìš”** - `event_type: 'status_changed'`
- `active` â†’ `suspended` (ì œì¬) - `event_type: 'status_changed'`
- `suspended` â†’ `issued` (ì œì¬ í•´ì œ) - `event_type: 'status_changed'`
- `active` â†’ `active` (ì–‘ë„, ì†Œìœ ìë§Œ ë³€ê²½) - `event_type: 'ownership_transferred'` âš ï¸ **íƒ€ì… ë¶„ë¦¬**

**êµ¬í˜„ ì˜ˆì‹œ**:
```javascript
// ìƒíƒœ ë³€ê²½ ì´ë²¤íŠ¸ ê¸°ë¡
async function recordWarrantyEvent(warrantyId, fromStatus, toStatus, actorType, actorId, metadata = {}) {
  await connection.execute(
    `INSERT INTO warranty_events
     (event_type, target_type, target_id, actor_type, actor_id, metadata, created_at)
     VALUES ('status_changed', 'warranty', ?, ?, ?, ?, NOW())`,
    [
      warrantyId,
      actorType,
      actorId,
      JSON.stringify({
        from: fromStatus,
        to: toStatus,
        ...metadata
      })
    ]
  );
}

// ì–‘ë„ ì´ë²¤íŠ¸ ê¸°ë¡ (ì´ë²¤íŠ¸ íƒ€ì… ë¶„ë¦¬)
async function recordOwnershipTransfer(warrantyId, fromUserId, toUserId, transferId, actorType, actorId) {
  await connection.execute(
    `INSERT INTO warranty_events
     (event_type, target_type, target_id, actor_type, actor_id, metadata, created_at)
     VALUES ('ownership_transferred', 'warranty', ?, ?, ?, ?, NOW())`,
    [
      warrantyId,
      actorType,
      actorId,
      JSON.stringify({
        from_user_id: fromUserId,
        to_user_id: toUserId,
        transfer_id: transferId,
        status: 'active'  // ìƒíƒœëŠ” active ìœ ì§€
      })
    ]
  );
}

// ì‚¬ìš© ì˜ˆì‹œ
// ìƒíƒœ ë³€ê²½ ì‹œ
await recordWarrantyEvent(
  warrantyId,
  'revoked',
  'issued',
  'system',
  orderId,
  { reason: 'resale', order_id: orderId }
);

// ì–‘ë„ ì‹œ (ì´ë²¤íŠ¸ íƒ€ì… ë¶„ë¦¬)
await recordOwnershipTransfer(
  warrantyId,
  fromUserId,
  toUserId,
  transferId,
  'user',
  fromUserId
);
```

**ì´ë²¤íŠ¸ íƒ€ì… ë¶„ë¦¬ì˜ ì´ì **:
- ìƒíƒœ ì „ì´ì™€ ê¶Œë¦¬ ì´ì „ì´ ì„ì´ì§€ ì•ŠìŒ
- "ì™œ activeì¸ë° ì ‘ê·¼ê¶Œì´ ë°”ë€Œì—ˆì§€?"ë¥¼ íƒ€ì„ë¼ì¸ë§Œ ë³´ê³ ë„ ì„¤ëª… ê°€ëŠ¥
- `event_type`ìœ¼ë¡œ í•„í„°ë§í•˜ì—¬ ì–‘ë„ ì´ë ¥ë§Œ ì¡°íšŒ ê°€ëŠ¥

**ê²€ì¦ ì²´í¬ë¦¬ìŠ¤íŠ¸**:
- [ ] `issued_unassigned` â†’ `issued` ì „ì´ ì‹œ ì´ë²¤íŠ¸ ê¸°ë¡ (`event_type: 'status_changed'`)
- [ ] `issued` â†’ `active` ì „ì´ ì‹œ ì´ë²¤íŠ¸ ê¸°ë¡ (`event_type: 'status_changed'`)
- [ ] `active` â†’ `revoked` ì „ì´ ì‹œ ì´ë²¤íŠ¸ ê¸°ë¡ (`event_type: 'status_changed'`)
- [ ] `revoked` â†’ `issued` ì „ì´ ì‹œ ì´ë²¤íŠ¸ ê¸°ë¡ (`event_type: 'status_changed'`) âš ï¸ **ì¬íŒë§¤ ì‹œ í•„ìˆ˜**
- [ ] `active` â†’ `suspended` ì „ì´ ì‹œ ì´ë²¤íŠ¸ ê¸°ë¡ (`event_type: 'status_changed'`)
- [ ] `suspended` â†’ `issued` ì „ì´ ì‹œ ì´ë²¤íŠ¸ ê¸°ë¡ (`event_type: 'status_changed'`)
- [ ] ì–‘ë„ ì‹œ ì´ë²¤íŠ¸ ê¸°ë¡ (`event_type: 'ownership_transferred'`) âš ï¸ **ì´ë²¤íŠ¸ íƒ€ì… ë¶„ë¦¬ í•„ìˆ˜**

---

## ğŸ”’ DB ë ˆë²¨ ìµœì†Œ ì œì•½ (ìš´ì˜ í•«í”½ìŠ¤/ìˆ˜ë™ SQL ë°©ì§€)

### âš ï¸ 1. ìƒíƒœ ì „ì´ ë¶ˆê°€ë¥¼ ë§‰ëŠ” ìµœì†Œ ì œì•½ 2ê°œ

**ë¬¸ì œ**: ì „ì´ ê·œì¹™ì´ ë¬¸ì„œ+ì½”ë“œì—ë§Œ ìˆìœ¼ë©´, "ìš´ì˜ í•«í”½ìŠ¤"ë‚˜ "ê´€ë¦¬ì ìˆ˜ë™ SQL"ë¡œ ê¹¨ì§ˆ ìˆ˜ ìˆìŒ

**ê¶Œì¥ DB ì œì•½ (ìµœì†Œ 2ê°œë§Œ)**:

#### â‘  warranties.status CHECK ì œì•½

**ëª©ì **: ì •ì˜ë˜ì§€ ì•Šì€ ìƒíƒœê°’ì´ ì ˆëŒ€ ë“¤ì–´ê°€ì§€ ì•Šê²Œ í•¨

**êµ¬í˜„**:
```sql
-- MySQL 8.0.16+ CHECK ì œì•½ ì§€ì›
ALTER TABLE warranties
ADD CONSTRAINT chk_warranties_status 
CHECK (status IN ('issued_unassigned', 'issued', 'active', 'suspended', 'revoked'));

-- ë˜ëŠ” ENUM ì‚¬ìš© (ì´ë¯¸ enumì´ë©´ ì¶©ë¶„)
ALTER TABLE warranties
MODIFY COLUMN status ENUM('issued_unassigned', 'issued', 'active', 'suspended', 'revoked') NOT NULL;
```

**MySQL ë²„ì „ë³„ ëŒ€ì‘**:
- MySQL 8.0.16+: CHECK ì œì•½ ì‚¬ìš©
- MySQL 5.7: ENUM ì‚¬ìš© (ì´ë¯¸ enumì´ë©´ ì¶©ë¶„)
- MySQL 5.6 ì´í•˜: íŠ¸ë¦¬ê±° ë˜ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ ê°€ë“œë¡œ ê°•ì œ

**ë¬¸ì„œ ê³ ì • ë¬¸êµ¬**:
> "DBê°€ CHECKë¥¼ ì§€ì›í•˜ë©´ CHECKë¡œ ê°•ì œ, ì•„ë‹ˆë©´ íŠ¸ë¦¬ê±° ë˜ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ ê°€ë“œë¡œ ê°•ì œ"
> (ì¤‘ìš”í•œ ê±´ 'ê°•ì œ ê³„ì¸µì´ ì¡´ì¬í•œë‹¤'ëŠ” ì )

#### â‘¡ warranties.owner_user_id ì¡°ê±´ë¶€ NOT NULL ê·œì¹™

**ëª©ì **: `issued_unassigned` ìƒíƒœì—ì„œë§Œ `owner_user_id` NULL í—ˆìš©, ë‚˜ë¨¸ì§€ëŠ” NOT NULL

**êµ¬í˜„**:
```sql
-- MySQLì€ ì™„ì „í•œ conditional CHECKë¥¼ ì§€ì›í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ
-- ì• í”Œë¦¬ì¼€ì´ì…˜ ë ˆë²¨ ê°€ë“œë¡œ ê°•ì œ

-- 1. ì»¬ëŸ¼ ì •ì˜ (NULL í—ˆìš©)
ALTER TABLE warranties
MODIFY COLUMN owner_user_id INT NULL;

-- 2. ì• í”Œë¦¬ì¼€ì´ì…˜ ê°€ë“œ (í•„ìˆ˜)
-- INSERT/UPDATE ì‹œ ê²€ì¦:
-- - status = 'issued_unassigned' â†’ owner_user_id NULL í—ˆìš©
-- - status IN ('issued', 'active', 'suspended') â†’ owner_user_id NOT NULL í•„ìˆ˜
-- - status = 'revoked' â†’ owner_user_idëŠ” NULL ê°€ëŠ¥ (ì´ì „ ì†Œìœ ì ì •ë³´ ìœ ì§€)
```

**ê²€ì¦ ë¡œì§ (ì• í”Œë¦¬ì¼€ì´ì…˜ ê°€ë“œ)**:
```javascript
function validateWarrantyStatusAndOwner(status, ownerUserId) {
  if (status === 'issued_unassigned') {
    // NULL í—ˆìš©
    return { valid: true };
  }
  
  if (status === 'revoked') {
    // NULL ê°€ëŠ¥ (ì´ì „ ì†Œìœ ì ì •ë³´ ìœ ì§€)
    return { valid: true };
  }
  
  if (status === 'issued' || status === 'active' || status === 'suspended') {
    if (!ownerUserId) {
      return { 
        valid: false, 
        reason: `${status} ìƒíƒœì—ì„œëŠ” owner_user_idê°€ í•„ìˆ˜ì…ë‹ˆë‹¤.` 
      };
    }
    return { valid: true };
  }
  
  return { valid: false, reason: 'ì•Œ ìˆ˜ ì—†ëŠ” ìƒíƒœì…ë‹ˆë‹¤.' };
}
```

**ë¬¸ì„œ ê³ ì • ë¬¸êµ¬**:
> "DBê°€ CHECKë¥¼ ì§€ì›í•˜ë©´ CHECKë¡œ ê°•ì œ, ì•„ë‹ˆë©´ íŠ¸ë¦¬ê±° ë˜ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ ê°€ë“œë¡œ ê°•ì œ"
> (ì¤‘ìš”í•œ ê±´ 'ê°•ì œ ê³„ì¸µì´ ì¡´ì¬í•œë‹¤'ëŠ” ì )

---

## ğŸ›¡ï¸ ê¶Œë¦¬ í–‰ìœ„ API ê³µí†µ ê°€ë“œ (í‘œì¤€í™”)

### âš ï¸ 2. actor/ownership ê²€ì¦ì˜ í‘œì¤€í™”

**ë¬¸ì œ**: í™œì„±í™”/ì–‘ë„/í™˜ë¶ˆ/ì¬íŒë§¤ ê°ê°ì—ì„œ ê²€ì¦ì„ í•˜ë©´, ì‹œê°„ì´ ì§€ë‚˜ë©´ êµ¬í˜„ì´ ë¯¸ë¬˜í•˜ê²Œ ê°ˆë¼ì§

**ê¶Œì¥ ìš´ì˜ ê·œì¹™ (ë¬¸ì„œ ê³ ì •)**:

> **ê¶Œë¦¬ í–‰ìœ„(activate, transfer, suspend/unsuspend, refund, resell)ëŠ” ëª¨ë‘ ë‹¤ìŒ ê³µí†µ ê²€ì¦ì„ í†µê³¼í•´ì•¼ í•œë‹¤.**

**ê³µí†µ ê²€ì¦ ìˆœì„œ (ë°˜ë“œì‹œ ë™ì¼ ìˆœì„œë¡œ ê²€ì¦)**:

1. **ëŒ€ìƒ warranties rowë¥¼ FOR UPDATEë¡œ ì ê¸ˆ**
   ```sql
   SELECT * FROM warranties WHERE warranty_id = ? FOR UPDATE
   ```

2. **í˜„ì¬ ìƒíƒœê°€ í—ˆìš©ëœ ìƒíƒœì¸ì§€ í™•ì¸**
   - ì „ì´í‘œ ê¸°ë°˜ ê²€ì¦
   - ì‹¤íŒ¨ ì‹œ: `ERR_STATUS_INVALID` (ì´ìœ  ì½”ë“œ í‘œì¤€í™”)

3. **actorê°€ ê¶Œí•œì„ ê°–ëŠ”ì§€ í™•ì¸**
   - **ì‚¬ìš©ì**: `owner_user_id` ì¼ì¹˜ í™•ì¸
   - **ê´€ë¦¬ì**: role ê¸°ë°˜ í™•ì¸
   - ì‹¤íŒ¨ ì‹œ: `ERR_OWNER_MISMATCH` ë˜ëŠ” `ERR_PERMISSION_DENIED`

4. **ì¶”ê°€ ì¡°ê±´ ê²€ì¦** (ê° APIë³„)
   - í™œì„±í™”: ì¸ë³´ì´ìŠ¤ ì—°ë™ í™•ì¸, ë™ì˜ ì²´í¬
   - ì–‘ë„: transfer ìƒíƒœ í™•ì¸, ë§Œë£Œ í™•ì¸
   - í™˜ë¶ˆ: `active` ìƒíƒœ ì•„ë‹˜ í™•ì¸
   - ì¬íŒë§¤: `paid_events` ì¡´ì¬ í™•ì¸

**ì´ìœ  ì½”ë“œ í‘œì¤€í™”**:
```javascript
const ERROR_CODES = {
  ERR_STATUS_INVALID: 'í˜„ì¬ ìƒíƒœì—ì„œ ì´ ì‘ì—…ì„ ìˆ˜í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.',
  ERR_OWNER_MISMATCH: 'ë³´ì¦ì„œ ì†Œìœ ìì™€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.',
  ERR_PERMISSION_DENIED: 'ì´ ì‘ì—…ì„ ìˆ˜í–‰í•  ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.',
  ERR_EXPIRED: 'ìš”ì²­ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.',
  ERR_ALREADY_PROCESSED: 'ì´ë¯¸ ì²˜ë¦¬ëœ ìš”ì²­ì…ë‹ˆë‹¤.',
  ERR_INVOICE_NOT_LINKED: 'ì¸ë³´ì´ìŠ¤ê°€ ê³„ì •ì— ì—°ë™ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.',
  ERR_REFUNDED_ORDER: 'í™˜ë¶ˆëœ ì£¼ë¬¸ì˜ ë³´ì¦ì„œëŠ” í™œì„±í™”í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
};
```

**êµ¬í˜„ ì˜ˆì‹œ (ê³µí†µ í•¨ìˆ˜)**:
```javascript
async function validateWarrantyAction(warrantyId, requiredStatus, actorType, actorId, additionalChecks = []) {
  const connection = await mysql.createConnection(dbConfig);
  await connection.beginTransaction();
  
  try {
    // 1. FOR UPDATEë¡œ ì ê¸ˆ
    const [warranties] = await connection.execute(
      'SELECT * FROM warranties WHERE warranty_id = ? FOR UPDATE',
      [warrantyId]
    );
    
    if (warranties.length === 0) {
      return { valid: false, error: 'ERR_NOT_FOUND', message: 'ë³´ì¦ì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' };
    }
    
    const warranty = warranties[0];
    
    // 2. ìƒíƒœ ê²€ì¦
    if (warranty.status !== requiredStatus) {
      return { 
        valid: false, 
        error: 'ERR_STATUS_INVALID', 
        message: `í˜„ì¬ ìƒíƒœ(${warranty.status})ì—ì„œ ì´ ì‘ì—…ì„ ìˆ˜í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.` 
      };
    }
    
    // 3. ê¶Œí•œ ê²€ì¦
    if (actorType === 'user') {
      if (warranty.owner_user_id !== actorId) {
        return { 
          valid: false, 
          error: 'ERR_OWNER_MISMATCH', 
          message: 'ë³´ì¦ì„œ ì†Œìœ ìì™€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.' 
        };
      }
    } else if (actorType === 'admin') {
      // ê´€ë¦¬ì role í™•ì¸ (ë³„ë„ í•¨ìˆ˜)
      const hasPermission = await checkAdminPermission(actorId, 'warranty_manage');
      if (!hasPermission) {
        return { 
          valid: false, 
          error: 'ERR_PERMISSION_DENIED', 
          message: 'ì´ ì‘ì—…ì„ ìˆ˜í–‰í•  ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.' 
        };
      }
    }
    
    // 4. ì¶”ê°€ ì¡°ê±´ ê²€ì¦
    for (const check of additionalChecks) {
      const result = await check(warranty, connection);
      if (!result.valid) {
        return result;
      }
    }
    
    return { valid: true, warranty, connection };
  } catch (error) {
    await connection.rollback();
    throw error;
  }
}
```

**íš¨ê³¼**:
- êµ¬í˜„ ì¼ê´€ì„± ë³´ì¥ (ì‹œê°„ì´ ì§€ë‚˜ë„ ë™ì¼í•œ ê²€ì¦ ìˆœì„œ)
- QAê°€ ê¹¨ì§„ êµ¬í˜„ì„ ì¡ì•„ë‚¼ ìˆ˜ ìˆìŒ (í‘œì¤€í™”ëœ ê²€ì¦ ìˆœì„œ)
- ì—ëŸ¬ ì½”ë“œ í‘œì¤€í™”ë¡œ í´ë¼ì´ì–¸íŠ¸ ì²˜ë¦¬ ìš©ì´

---

## ğŸ”„ ë©±ë“±ì„± ê³„ì¸µí‘œ (ì¬ì‹œë„/ì¤‘ë³µ ì›¹í›… ëŒ€ì‘)

### âš ï¸ 3. ì¥ì• /ì¬ì‹œë„/ì¤‘ë³µ ì›¹í›…ê¹Œì§€ í¬í•¨í•œ ë©±ë“±ì„± ê³„ì¸µí‘œ

**ë¬¸ì œ**: ìš´ì˜ì—ì„œ ì œì¼ ìì£¼ í„°ì§€ëŠ” ê²Œ "ì¬ì‹œë„"ë‹¤. ê° ë‹¨ê³„ê°€ ì¤‘ë³µ í˜¸ì¶œë¼ë„ ê²°ê³¼ê°€ 1ë²ˆë§Œ ë°˜ì˜ë˜ì–´ì•¼ í•¨

**ë©±ë“±ì„± ê³„ì¸µí‘œ (í•œ ì¥ìœ¼ë¡œ ê³ ì •)**:

| ë‹¨ê³„ | ë©±ë“±ì„± ë©”ì»¤ë‹ˆì¦˜ | ê²€ì¦ ë°©ë²• | ì‹¤íŒ¨ ì‹œ ì²˜ë¦¬ |
|------|---------------|----------|------------|
| **ì£¼ë¬¸ Paid ì²˜ë¦¬** | `paid_events` UNIQUE(`order_id`, `payment_key`) | INSERT ì‹œ ì¤‘ë³µ ì²´í¬, ì´ë¯¸ ìˆìœ¼ë©´ ì¦‰ì‹œ ì¢…ë£Œ | ì´ë¯¸ ì²˜ë¦¬ë¨ ì‘ë‹µ ë°˜í™˜ |
| **ì¬ê³  ë°°ì •** | `stock_units.status` ê¸°ë°˜ + `FOR UPDATE SKIP LOCKED` | `status = 'in_stock'`ì¸ ê²ƒë§Œ ì„ íƒ, ë½ìœ¼ë¡œ ë™ì‹œì„± ì œì–´ | ì¬ê³  ë¶€ì¡± ì—ëŸ¬ |
| **unit ìƒì„±** | `order_item_units`ì— UNIQUE(`order_item_id`, `unit_seq`) ë˜ëŠ” `stock_unit_id` UNIQUE | INSERT ì‹œ ì¤‘ë³µ ì²´í¬ | ì¤‘ë³µ ì—ëŸ¬ (ì´ë¯¸ ìƒì„±ë¨) |
| **ë³´ì¦ì„œ revive** | `UPDATE ... WHERE status='revoked'` + `affectedRows=1` | ì¡°ê±´ë¶€ UPDATE, affectedRows ê²€ì¦ | affectedRows !== 1ì´ë©´ ì‹¤íŒ¨ |
| **ì–‘ë„ ìˆ˜ë½** | `UPDATE transfers WHERE status='requested' ...` + `affectedRows=1` | ì¡°ê±´ë¶€ UPDATE, affectedRows ê²€ì¦ | affectedRows !== 1ì´ë©´ ì‹¤íŒ¨ |
| **ë³´ì¦ì„œ í™œì„±í™”** | `UPDATE ... WHERE status='issued'` + `affectedRows=1` | ì¡°ê±´ë¶€ UPDATE, affectedRows ê²€ì¦ | affectedRows !== 1ì´ë©´ ì‹¤íŒ¨ |
| **í™˜ë¶ˆ ì²˜ë¦¬** | `UPDATE ... WHERE status IN ('issued', 'issued_unassigned')` + `affectedRows=1` | ì¡°ê±´ë¶€ UPDATE, affectedRows ê²€ì¦ | affectedRows !== 1ì´ë©´ ì‹¤íŒ¨ |

**í•µì‹¬ ì›ì¹™**:
> **"ê° ë‹¨ê³„ê°€ ì¤‘ë³µ í˜¸ì¶œë¼ë„ ê²°ê³¼ê°€ 1ë²ˆë§Œ ë°˜ì˜"ë˜ëŠ” ê³„ì¸µì„ ë¬¸ì„œì— ë°•ì•„ë‘ëŠ” ê²ƒ**

**êµ¬í˜„ ì˜ˆì‹œ (paid ì²˜ë¦¬ ë©±ë“±ì„± + ê¸ˆì•¡ ê²€ì¦)**:
```javascript
async function processPaidOrder(orderId, paymentKey, amount, currency, rawPayload) {
  const connection = await mysql.createConnection(dbConfig);
  await connection.beginTransaction();
  
  try {
    // 1. ì£¼ë¬¸ ì ê¸ˆ ë° ê¸ˆì•¡ í™•ì • (ì„œë²„ì—ì„œ í™•ì •í•œ ê°’ ì‚¬ìš©)
    const [orders] = await connection.execute(
      'SELECT order_id, total_price, currency, status FROM orders WHERE order_id = ? FOR UPDATE',
      [orderId]
    );
    
    if (orders.length === 0) {
      throw new Error('ì£¼ë¬¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }
    
    const order = orders[0];
    
    // âš ï¸ ê²°ì œ ê¸ˆì•¡/í†µí™” ê²€ì¦ (ì„œë²„ í™•ì •ê°’ê³¼ ì¼ì¹˜ í™•ì¸)
    if (parseFloat(order.total_price) != parseFloat(amount)) {
      // ë¶ˆì¼ì¹˜ ì‹œ paid_eventsëŠ” ê¸°ë¡í•˜ë˜(ì¦ê±°), ì£¼ë¬¸ ì²˜ë¦¬ëŠ” ì¤‘ë‹¨
      await connection.execute(
        'INSERT INTO paid_events (order_id, payment_key, amount, currency, raw_payload_json, event_source, created_at) VALUES (?, ?, ?, ?, ?, ?, NOW())',
        [orderId, paymentKey, amount, currency, JSON.stringify(rawPayload), 'webhook']
      );
      await connection.commit();
      throw new Error(`ê²°ì œ ê¸ˆì•¡ ë¶ˆì¼ì¹˜: ì£¼ë¬¸=${order.total_price}, ê²°ì œ=${amount}`);
    }
    
    if (order.currency !== currency) {
      await connection.execute(
        'INSERT INTO paid_events (order_id, payment_key, amount, currency, raw_payload_json, event_source, created_at) VALUES (?, ?, ?, ?, ?, ?, NOW())',
        [orderId, paymentKey, amount, currency, JSON.stringify(rawPayload), 'webhook']
      );
      await connection.commit();
      throw new Error(`í†µí™” ë¶ˆì¼ì¹˜: ì£¼ë¬¸=${order.currency}, ê²°ì œ=${currency}`);
    }
    
    // 2. ë©±ë“±ì„± ì²´í¬ (paid_events)
    try {
      await connection.execute(
        'INSERT INTO paid_events (order_id, payment_key, amount, currency, raw_payload_json, event_source, confirmed_at, created_at) VALUES (?, ?, ?, ?, ?, ?, NOW(), NOW())',
        [orderId, paymentKey, amount, currency, JSON.stringify(rawPayload), 'webhook']
      );
    } catch (error) {
      if (error.code === 'ER_DUP_ENTRY') {
        // ì´ë¯¸ ì²˜ë¦¬ë¨
        await connection.rollback();
        return { 
          success: true, 
          message: 'ì´ë¯¸ ì²˜ë¦¬ëœ ì£¼ë¬¸ì…ë‹ˆë‹¤.', 
          alreadyProcessed: true 
        };
      }
      throw error;
    }
    
    // 3. ì¬ê³  ë°°ì • (FOR UPDATE SKIP LOCKED)
    // ... (ì´ë¯¸ ì²˜ë¦¬ëœ ê²½ìš° ì¬ê³ ëŠ” ì´ë¯¸ ë°°ì •ë¨)
    
    // 4. order_item_units ìƒì„± (UNIQUE ì œì•½ìœ¼ë¡œ ì¤‘ë³µ ë°©ì§€)
    // ... (ì´ë¯¸ ìƒì„±ëœ ê²½ìš° ì¤‘ë³µ ì—ëŸ¬)
    
    // 5. warranties ìƒì„±/ì—…ë°ì´íŠ¸ (reviveì¸ ê²½ìš° affectedRows ê²€ì¦)
    // ... (ì´ë¯¸ ì²˜ë¦¬ëœ ê²½ìš° affectedRows = 0)
    
    await connection.commit();
    return { success: true, message: 'ì²˜ë¦¬ ì™„ë£Œ' };
  } catch (error) {
    await connection.rollback();
    throw error;
  }
}
```

**ì¬ì‹œë„ ì‹œë‚˜ë¦¬ì˜¤ ëŒ€ì‘**:
- **ì›¹í›… ì¬ì „ì†¡**: `paid_events` UNIQUEë¡œ ì¤‘ë³µ ì²˜ë¦¬ ë°©ì§€
- **ë„¤íŠ¸ì›Œí¬ íƒ€ì„ì•„ì›ƒ í›„ ì¬ì‹œë„**: ê° ë‹¨ê³„ì˜ ë©±ë“±ì„± ë©”ì»¤ë‹ˆì¦˜ìœ¼ë¡œ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
- **ë™ì‹œ ìš”ì²­**: `FOR UPDATE SKIP LOCKED`ë¡œ ë™ì‹œì„± ì œì–´

**íš¨ê³¼**:
- ì¬ì‹œë„/ì¤‘ë³µ ì›¹í›… ë¬¸ì œ í•´ê²°
- ì¥ì•  ë³µêµ¬ ì‹œ ì•ˆì „í•œ ì¬ì²˜ë¦¬ ê°€ëŠ¥
- ê° ë‹¨ê³„ë³„ ë©±ë“±ì„± ë³´ì¥

---

**ì´ ìŠ¤í™ì€ êµ¬í˜„ ê°€ëŠ¥í•˜ë©°, ì•ˆì •ì ì´ê³  í™•ì¥ ê°€ëŠ¥í•œ ì‹œìŠ¤í…œì„ êµ¬ì¶•í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.**

