# 관리자 페이지 QR/보증서/인보이스 기능 일관성 검토 보고서

## 📋 검토 목적

제시된 관리자 UI 구조(`ADMIN_UI_STRUCTURE_REVIEW.md`)와 시스템 흐름 문서(`SYSTEM_FLOW_DETAILED.md`, `FINAL_EXECUTION_SPEC_REVIEW.md`) 간의 **QR 코드, 디지털 보증서, 인보이스** 관련 관리자 기능 일관성을 검토합니다.

---

## ✅ 일치하는 부분

### 1. 토큰 정보 표시 (주문 상세) ✅

**SYSTEM_FLOW_DETAILED.md (8-3절)**:
- **3단: 주문 항목 단위** (`order_item_units`): **토큰 정보**: `token_master.token` (난수 20자) - **현실에서 제품을 찾기 위한 핵심 정보**

**FINAL_EXECUTION_SPEC_REVIEW.md (3절)**:
- **3단: 주문 항목 단위** (`order_item_units`) - **시리얼 넘버와 토큰(난수 20자) 확인 필수**
- **핵심**: 관리자는 각 제품의 시리얼 넘버와 토큰(난수 20자)을 확인하여 현실에서 해당 제품을 찾아 배송/환불 처리할 수 있어야 함

**제시된 구조 (ADMIN_UI_STRUCTURE_REVIEW.md - 2-2절)**:
- **출고/배송 유닛 테이블** 컬럼: **내부 코드 / 토큰**

**결론**: ✅ **완전히 일치함**. 주문 상세 화면에서 토큰 정보 표시는 필수이며, 모든 문서에서 일관됨.

---

## ⚠️ 모순되거나 누락된 부분

### 1. QR 코드 다운로드 기능 위치 불명확 ⚠️

**현재 구현**:
- `admin-qhf25za8/orders.html`에 "📥 QR 코드 다운로드" 버튼이 **주문 관리 화면**에 있음
- `backend/qrcode-download-routes.js`에 QR 코드 다운로드 API 구현됨
- `QR_CODE_CUSTOMIZATION_GUIDE.md`, `QR_GENERATOR_GUIDE.md` 문서 존재

**SYSTEM_FLOW_DETAILED.md**:
- QR 코드 관련 관리자 기능 **명시적으로 언급되지 않음**
- "실물 보증서에는 QR 코드가 인쇄되어 있음 (토큰 정보 포함)" 정도만 언급

**FINAL_EXECUTION_SPEC_REVIEW.md**:
- QR 코드 관련 관리자 기능 **명시적으로 언급되지 않음**

**제시된 구조 (ADMIN_UI_STRUCTURE_REVIEW.md)**:
- **QR 코드 다운로드 기능에 대한 언급이 없음**
- 어느 관점(재고/주문/보증서/정정)에 속해야 하는지 불명확

**문제점**:
1. **위치 불명확**: QR 코드 다운로드는 "어느 관점"에 속해야 하는가?
   - **재고 관점**: QR 코드는 `token_master`와 연결되어 있으므로 재고 화면에서 관리?
   - **주문 관점**: 현재처럼 주문 관리 화면에서 다운로드?
   - **보증서/토큰 관점**: 토큰 관리 화면에서 다운로드?
   - **정정/운영 관점**: QR 코드 생성/재생성은 운영 작업?

2. **4개 관점 분리 원칙 위배 가능성**: 
   - 제시된 구조: "4개가 섞이면 반드시 사고 난다"
   - 현재 구현: 주문 관리 화면에 QR 코드 다운로드 버튼이 있음
   - QR 코드 다운로드는 "주문 처리"와 직접 관련이 없음

**권장 해결책**:

**옵션 A (권장): 보증서/토큰 관리 화면으로 이동**
- **이유**: QR 코드는 `token_master`와 직접 연결되어 있고, 보증서/토큰 관점에서 관리하는 것이 SSOT 원칙에 맞음
- **위치**: "3. 보증서/토큰 관리 UI (권리 관점)" → 토큰 상세 화면 또는 별도 QR 코드 관리 섹션
- **구현**: 
  - `admin-qhf25za8/orders.html`에서 QR 코드 다운로드 버튼 제거
  - 보증서/토큰 관리 화면(향후 구현)에 QR 코드 다운로드 기능 추가

**옵션 B (부가 기능): 정정/운영 화면에 유지**
- **이유**: QR 코드 생성/재생성은 "운영 작업"에 가까움
- **위치**: "4. 정정/운영 UI (감사 관점)" → QR 코드 관리 섹션
- **단점**: 현재는 정정/운영 UI가 미구현 상태

**옵션 C (현재 위치 유지 - 비권장)**:
- **이유**: 주문 관리 화면에서 빠르게 접근 가능
- **단점**: 4개 관점 분리 원칙과 충돌, "주문 처리"와 직접 관련 없음

**최종 권장**: **옵션 A (보증서/토큰 관리 화면으로 이동)** - SSOT 원칙 준수 및 논리적 일관성

---

### 2. 인보이스 조회 기능 누락 ⚠️

**SYSTEM_FLOW_DETAILED.md**:
- **인보이스 생성**: Paid 처리 시 자동 생성 (`invoices` 테이블)
- **인보이스 이메일 발송**: Paid 처리 완료 후 이메일로 발송
- **인보이스 정보**: 주문 상세 페이지에서 표시 (비회원 Claim 흐름)

**FINAL_EXECUTION_SPEC_REVIEW.md**:
- **인보이스 정의**: "문서(스냅샷)이며, '권리 판단 기준'이 아니라 '증빙/조회' 역할"
- **관리자 페이지 기능**: 인보이스 관련 기능 **명시적으로 언급되지 않음**

**제시된 구조 (ADMIN_UI_STRUCTURE_REVIEW.md)**:
- **인보이스 관련 기능 언급 없음**
- 주문 상세 화면에 인보이스 정보 표시 여부 불명확

**문제점**:
1. **관리자가 인보이스를 조회할 수 있는 기능이 없는가?**
   - 주문 상세 화면에서 인보이스 정보를 표시해야 하는지 불명확
   - 인보이스 번호, 발급일시, 금액 등은 관리자가 확인해야 할 정보일 수 있음

2. **인보이스가 어느 관점에 속해야 하는가?**
   - **주문 관점**: 주문 상세 화면에 인보이스 정보 표시 (증빙/조회 목적)
   - **정정/운영 관점**: 인보이스 재발급, 수정 등 운영 작업
   - **문서 관점**: 별도 인보이스 관리 화면?

**권장 해결책**:

**옵션 A (권장): 주문 상세 화면에 인보이스 정보 추가**
- **위치**: "2. 주문 관리 UI (출고·배송 관점)" → 주문 상세 화면 → 1단: 주문 정보 카드에 인보이스 섹션 추가
- **표시 정보**:
  - 인보이스 번호 (`invoice_number`)
  - 발급일시 (`issued_at`)
  - 총액 (`total_amount`)
  - 인보이스 링크 (고객에게 발송된 링크와 동일, 관리자도 확인 가능)
- **이유**: 
  - 인보이스는 "증빙/조회" 역할이므로 주문 정보와 함께 확인하는 것이 자연스러움
  - 배송/환불 처리 시 인보이스 확인이 필요할 수 있음

**옵션 B (선택): 별도 인보이스 관리 화면**
- **위치**: 새로운 화면 또는 정정/운영 UI
- **표시 정보**: 인보이스 목록, 검색, 상세 조회, 재발급 등
- **단점**: 현재는 필요성이 낮음 (주문과 밀접하게 연결되어 있음)

**최종 권장**: **옵션 A (주문 상세 화면에 인보이스 정보 추가)** - 실용성 및 접근성

---

### 3. 보증서/토큰 관리 UI에서 토큰 정보 표시 방식 불명확 ⚠️

**SYSTEM_FLOW_DETAILED.md (8-3절)**:
- **3단: 주문 항목 단위**에서 토큰 정보 표시: **토큰 정보**: `token_master.token` (난수 20자)

**FINAL_EXECUTION_SPEC_REVIEW.md (3절, 175-203줄)**:
- **⚠️ 토큰 노출 범위 정책 (보안 필수)**: 
  - **목록 화면**: 토큰 마스킹 (예: 앞 4자/뒤 4자만 표시) - 예: `ABC1...5678`
  - **상세 화면**: 전체 토큰 표시 (배송/환불 처리 시 필요)
  - **접근권한 분리**: "전체 토큰 보기" 권한을 별도로 관리 (가능하면 베스트)

**제시된 구조 (ADMIN_UI_STRUCTURE_REVIEW.md - 3-1절)**:
- **토큰 검색 화면**:
  - 검색 기준: 토큰, 내부 코드, 시리얼 넘버, ROT 코드, 보증서 하단 코드
  - 결과 리스트: 토큰, 상품명, 소유자, 상태
- **토큰 상세 화면**:
  - 표시 정보: 식별 코드들, 현재 소유자, 연결 주문/재고
  - **토큰 마스킹 여부 불명확**

**문제점**:
1. **토큰 마스킹 정책 불일치**:
   - `FINAL_EXECUTION_SPEC_REVIEW.md`: "목록 화면: 토큰 마스킹, 상세 화면: 전체 토큰 표시"
   - 제시된 구조: 토큰 마스킹 여부 명시되지 않음

2. **보증서/토큰 관리 UI와 주문 관리 UI 간 정책 일관성**:
   - 주문 관리 UI (출고/배송 관점): 전체 토큰 표시 필요 (배송/환불 처리 시)
   - 보증서/토큰 관리 UI (권리 관점): 전체 토큰 표시가 항상 필요한가?
   - **SSOT 원칙**: 동일한 토큰 정보는 어느 화면에서나 동일한 정책을 적용해야 하는가?

**권장 해결책**:

**토큰 노출 범위 정책 통일**:
1. **목록 화면 (모든 관리자 화면 공통)**:
   - 토큰 마스킹: `ABC1...5678` (앞 4자 + 뒤 4자)
   - 보안 효과: 내부자 실수/스크린샷 유출 리스크 감소

2. **상세 화면 (화면별 정책)**:
   - **주문 상세 화면 (출고/배송 관점)**: 전체 토큰 표시 (배송/환불 처리 시 필요)
   - **토큰 상세 화면 (권리 관점)**: 전체 토큰 표시 (토큰 조회가 주요 목적)
   - **재고 상세 화면 (창고 관점)**: 전체 토큰 표시 (재고 확인 시 필요)

3. **접근권한 분리 (선택, 권장)**:
   - "전체 토큰 보기" 권한을 별도로 관리
   - 권한이 없는 관리자는 목록/상세 모두 마스킹
   - 권한이 있는 관리자만 전체 토큰 확인 가능

**문서화 필요**:
- `ADMIN_UI_STRUCTURE_REVIEW.md`에 토큰 마스킹 정책 추가
- `SYSTEM_FLOW_DETAILED.md`에 토큰 노출 범위 정책 반영 (현재는 `FINAL_EXECUTION_SPEC_REVIEW.md`에만 있음)

---

### 4. 시리얼 넘버 표시 방식 불일치 ⚠️

**SYSTEM_FLOW_DETAILED.md (8-3절)**:
- **3단: 주문 항목 단위**에서 시리얼 넘버 표시: **시리얼 넘버**: `order_item_unit_id` 또는 별도 시리얼 넘버

**FINAL_EXECUTION_SPEC_REVIEW.md (3절)**:
- **3단: 주문 항목 단위** (`order_item_units`) - **시리얼 넘버와 토큰(난수 20자) 확인 필수**
- **관리자가 필요한 정보**: 각 제품의 시리얼 넘버와 토큰(난수 20자)을 확인하여 현실에서 해당 제품을 찾아 배송/환불 처리

**제시된 구조 (ADMIN_UI_STRUCTURE_REVIEW.md - 2-2절)**:
- **출고/배송 유닛 테이블** 컬럼: **유닛 ID** (시리얼 넘버와 동일한지 불명확)
- **토큰 상세 화면 (3-2절)**: 시리얼 넘버 표시 (어디서 가져오는지 불명확)

**문제점**:
1. **시리얼 넘버 출처 불명확**:
   - `order_item_unit_id`를 시리얼 넘버로 사용하는가?
   - `token_master.serial_number`를 시리얼 넘버로 사용하는가?
   - 두 값이 다른가? (일반적으로 `order_item_unit_id`는 DB 내부 ID이고, `token_master.serial_number`는 실제 제품 시리얼 넘버)

2. **관리자가 현실에서 제품을 찾기 위한 정보**:
   - `SYSTEM_FLOW_DETAILED.md`: "시리얼 넘버 또는 토큰으로" 현실에서 제품 찾기
   - `token_master.serial_number`가 실제 제품 시리얼 넘버라면, 이것을 표시해야 함
   - `order_item_unit_id`는 DB 내부 ID일 뿐, 실제 제품 식별자와는 다를 수 있음

**권장 해결책**:

**시리얼 넘버 명확화**:
1. **실제 제품 시리얼 넘버**: `token_master.serial_number` (또는 `stock_units`를 통해 조회)
2. **DB 내부 ID**: `order_item_unit_id` (참조용, 표시는 선택)

**주문 상세 화면 (출고/배송 유닛 테이블)** 컬럼 수정:
- **시리얼 넘버**: `token_master.serial_number` 표시 (실제 제품 식별자)
- **유닛 ID**: `order_item_unit_id` (참조용, 작게 표시 또는 상세 화면에서만)
- **토큰**: `token_master.token` (난수 20자, 마스킹 또는 전체 표시는 정책에 따라)

**문서화 필요**:
- `ADMIN_UI_STRUCTURE_REVIEW.md`에서 "시리얼 넘버" 정의 명확화
- `SYSTEM_FLOW_DETAILED.md`에서 시리얼 넘버 출처 명시 (`token_master.serial_number`)

---

### 5. 디지털 보증서 조회 기능 누락 ⚠️

**SYSTEM_FLOW_DETAILED.md**:
- **실물 보증서 발송**: Paid 처리 완료 후 실물 보증서 발송 (배송 시 함께 발송)
- **실물 보증서에는 QR 코드가 인쇄되어 있음** (토큰 정보 포함)
- **보증서 상태**: `warranties.status` (`issued`, `issued_unassigned`, `active`, `revoked` 등)

**FINAL_EXECUTION_SPEC_REVIEW.md**:
- **보증서 활성화**: 첫 활성화 시 인보이스 연동 확인
- **보증서 양도**: 활성화된 보증서만 양도 가능
- **보증서 환불**: `warranties.status` 기준으로 판정

**제시된 구조 (ADMIN_UI_STRUCTURE_REVIEW.md - 3-1절, 3-2절)**:
- **토큰 검색 화면**: 토큰, 내부 코드, 시리얼 넘버, ROT 코드, 보증서 하단 코드로 검색
- **토큰 상세 화면**: 
  - 표시 정보: 식별 코드들, 현재 소유자, 연결 주문/재고
  - 액션: 상태 변경, 정정(로그 필수)

**문제점**:
1. **"디지털 보증서" 조회 기능 불명확**:
   - 제시된 구조: "토큰" 검색/상세 화면
   - 실제로는 "보증서(warranty)"를 검색하는 것이 맞는가?
   - 토큰(`token_master`)과 보증서(`warranties`)는 1:1 관계이지만, "보증서 상태"를 확인하려면 `warranties` 테이블을 조회해야 함

2. **보증서 상세 정보 누락**:
   - 제시된 구조: "현재 소유자, 연결 주문/재고" 표시
   - 누락된 정보:
     - 보증서 상태 (`warranties.status`)
     - 활성화 일시 (`warranties.activated_at`)
     - 환불 일시 (`warranties.revoked_at`)
     - 보증서 이력 (`warranty_events`)

**권장 해결책**:

**토큰 상세 화면 → 보증서 상세 화면으로 명확화**:
1. **화면명 변경**: "토큰 상세 화면" → "보증서 상세 화면" (또는 "토큰/보증서 상세 화면")
2. **표시 정보 추가**:
   - **보증서 상태 카드**:
     - 현재 상태 (`warranties.status`) [색상 뱃지]
     - 활성화 일시 (`warranties.activated_at`)
     - 환불 일시 (`warranties.revoked_at`)
   - **소유자 정보 카드**:
     - 현재 소유자 (`warranties.owner_user_id` → `users.email`, `users.name`)
     - 소유자 변경 이력 (`warranty_events` WHERE `event_type = 'ownership_transferred'`)
   - **연결 정보 카드**:
     - 연결 주문 (`warranties.source_order_item_unit_id` → `order_item_units` → `orders`)
     - 연결 재고 (`warranties.token_pk` → `token_master` → `stock_units`)
   - **보증서 이력 타임라인**:
     - `warranty_events` 테이블에서 모든 이벤트 조회
     - 누가, 언제, 왜 상태를 변경했는지 표시

**문서화 필요**:
- `ADMIN_UI_STRUCTURE_REVIEW.md`에서 "보증서 상세 화면" 표시 정보 보완
- 보증서 상태, 이력 정보를 명시적으로 추가

---

### 6. 인보이스와 보증서 연동 관계 불명확 ⚠️

**SYSTEM_FLOW_DETAILED.md (4-1절, 활성화 흐름)**:
- **핵심 검증: 인보이스 연동 확인**
  ```sql
  SELECT o.user_id, o.status, oiu.unit_status
  FROM warranties w
  JOIN order_item_units oiu ON w.source_order_item_unit_id = oiu.order_item_unit_id
  JOIN order_items oi ON oiu.order_item_id = oi.order_item_id
  JOIN orders o ON oi.order_id = o.order_id
  WHERE w.warranty_id = ?
  ```
  - `orders.user_id = 현재 로그인한 user_id` 확인 (인보이스가 계정에 연동되어 있는지)
  - `orders.status != 'refunded'` 확인 (환불된 주문이 아닌지)

**FINAL_EXECUTION_SPEC_REVIEW.md (6절, 보증서 활성화 정책)**:
- **핵심 조건 (첫 활성화 시에만 적용)**: 첫 활성화 시 해당 보증서가 속한 주문(인보이스)이 계정에 연동되어 있고 정상 상태여야 함
- **인보이스 연동 확인**이 환불 후 QR 코드 악용 방지의 핵심 방어 메커니즘

**제시된 구조 (ADMIN_UI_STRUCTURE_REVIEW.md)**:
- **보증서 상세 화면**: "연결 주문/재고" 표시
- **인보이스 정보 표시 여부 불명확**

**문제점**:
1. **관리자가 보증서 상세 화면에서 인보이스를 확인할 수 있는가?**
   - 보증서 → 주문 → 인보이스 연결 관계를 확인할 수 있어야 함
   - 관리자가 "이 보증서가 어떤 주문의 인보이스에 연결되어 있는지" 확인 필요

2. **인보이스와 보증서 연동 상태 표시**:
   - "인보이스 연동 확인"이 활성화 시 핵심 검증이므로, 관리자 화면에서도 이 정보를 표시해야 함
   - 예: "인보이스 연동됨" / "인보이스 미연동" / "인보이스 환불됨" 상태 표시

**권장 해결책**:

**보증서 상세 화면에 인보이스 정보 추가**:
1. **연결 주문 정보 카드 확장**:
   - 주문번호 (`orders.order_number`)
   - 주문 상태 (`orders.status`)
   - **인보이스 정보** (새로 추가):
     - 인보이스 번호 (`invoices.invoice_number`)
     - 인보이스 발급일시 (`invoices.issued_at`)
     - 인보이스 총액 (`invoices.total_amount`)
     - **인보이스 연동 상태**: 
       - `orders.user_id IS NOT NULL` → "연동됨"
       - `orders.user_id IS NULL` → "미연동 (비회원)"
       - `orders.status = 'refunded'` → "환불됨"

2. **인보이스 상태 뱃지**:
   - 정상 연동: 초록색 뱃지 "인보이스 연동됨"
   - 미연동: 주황색 뱃지 "인보이스 미연동"
   - 환불됨: 빨간색 뱃지 "인보이스 환불됨"

**문서화 필요**:
- `ADMIN_UI_STRUCTURE_REVIEW.md`에서 보증서 상세 화면에 인보이스 정보 표시 추가
- 인보이스 연동 상태 표시 방법 명시

---

## 🔍 추가 발견 사항

### 1. QR 코드 생성 vs 다운로드 구분 불명확

**현재 구현**:
- `QR_CODE_CUSTOMIZATION_GUIDE.md`: QR 코드 생성 방법 (CLI 실행)
- `backend/qrcode-download-routes.js`: QR 코드 다운로드 API (관리자 전용)

**문제점**:
- **QR 코드 생성**: CLI로 실행 (`node generate-qr-codes.js`)
- **QR 코드 다운로드**: 관리자 화면에서 버튼 클릭
- 생성과 다운로드가 분리되어 있는데, 관리자 화면에서 QR 코드를 "재생성"할 수 있는 기능은 없는가?

**권장 해결책**:
- **옵션 A**: QR 코드 생성은 CLI로 유지, 다운로드만 관리자 화면에서
- **옵션 B**: 관리자 화면에서 QR 코드 재생성 버튼 추가 (정정/운영 UI)
- **현재는 옵션 A 유지 권장** (생성은 드물게 수행, 다운로드는 자주 필요)

---

### 2. 디지털 인보이스 vs 실물 보증서 구분

**SYSTEM_FLOW_DETAILED.md**:
- **실물 보증서**: Paid 처리 완료 후 실물 보증서 발송 (배송 시 함께 발송)
- **인보이스**: Paid 처리 완료 후 인보이스 생성 및 이메일 발송

**문제점**:
- "디지털 보증서"라는 용어가 문서에서 명확히 정의되지 않음
- 실물 보증서(QR 코드 인쇄)와 디지털 보증서(온라인 조회)의 구분이 불명확
- 관리자 화면에서 "디지털 보증서 조회" 기능이 필요한가?

**권장 해결책**:
- **명확화**: 
  - **실물 보증서**: QR 코드가 인쇄된 종이 보증서 (배송 시 함께 발송)
  - **디지털 보증서**: 온라인에서 QR 스캔으로 조회하는 보증서 정보 (웹 페이지)
- 관리자 화면에서는 "보증서 상태 조회"로 통일 (실물/디지털 구분 불필요)
- 보증서 상세 화면에서 보증서 정보를 조회할 수 있으면 충분

---

## 📋 수정 권장 사항 요약

### 1. 즉시 수정 필요 (문서 일관성) ⚠️

1. **`ADMIN_UI_STRUCTURE_REVIEW.md`에 추가**:
   - QR 코드 다운로드 기능 위치 명시 (보증서/토큰 관리 화면으로 이동 권장)
   - 토큰 마스킹 정책 추가 (목록: 마스킹, 상세: 전체 표시)
   - 시리얼 넘버 출처 명확화 (`token_master.serial_number`)
   - 보증서 상세 화면에 보증서 상태, 이력 정보 추가
   - 보증서 상세 화면에 인보이스 정보 추가 (연동 상태 포함)
   - 주문 상세 화면에 인보이스 정보 추가 (1단: 주문 정보 카드)

### 2. 향후 구현 시 반영 필요 ⚠️

1. **보증서/토큰 관리 UI 구현 시**:
   - QR 코드 다운로드 기능 포함
   - 보증서 상세 화면에 보증서 상태, 이력, 인보이스 정보 표시

2. **주문 관리 UI 개선 시**:
   - 주문 상세 화면에 인보이스 정보 추가
   - 시리얼 넘버를 `token_master.serial_number`로 표시

3. **공통 정책 적용**:
   - 모든 관리자 화면에서 토큰 마스킹 정책 통일
   - 접근권한 분리 (전체 토큰 보기 권한)

---

## 🎯 최종 결론

### ✅ 일치하는 부분
- 토큰 정보 표시 (주문 상세): 모든 문서에서 일관됨

### ⚠️ 모순되거나 누락된 부분
1. **QR 코드 다운로드 기능 위치 불명확** - 보증서/토큰 관리 화면으로 이동 권장
2. **인보이스 조회 기능 누락** - 주문 상세 화면에 인보이스 정보 추가 권장
3. **토큰 마스킹 정책 불명확** - 제시된 구조에 정책 추가 필요
4. **시리얼 넘버 출처 불명확** - `token_master.serial_number` 명시 필요
5. **보증서 상세 정보 누락** - 보증서 상태, 이력, 인보이스 정보 추가 필요

### 📝 문서화 필요 사항
- `ADMIN_UI_STRUCTURE_REVIEW.md`에 위 항목들 반영
- `SYSTEM_FLOW_DETAILED.md`에 토큰 노출 범위 정책 반영 (현재는 `FINAL_EXECUTION_SPEC_REVIEW.md`에만 있음)

---

**문서 버전**: 1.0  
**검토일**: 2026-01-11  
**검토 기준**: `ADMIN_UI_STRUCTURE_REVIEW.md` + `SYSTEM_FLOW_DETAILED.md` + `FINAL_EXECUTION_SPEC_REVIEW.md` + 현재 구현 상태
