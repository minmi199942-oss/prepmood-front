# 구현 우선순위 최종 정리 (GPT 검증 완료)

**최종 업데이트**: 2026-01-16  
**검증**: GPT 검증 완료, 우선순위 및 분석 정확성 확인  
**기준 문서**: `SYSTEM_FLOW_DETAILED.md`, `FINAL_EXECUTION_SPEC_REVIEW.md`

---

## ✅ 검증 결과 요약

### 원래 제안 (내 분석)
- ✅ **정확**: 우선순위 판단 정확
- ✅ **정확**: 작업 목록 적절
- ✅ **정확**: 예상 소요 시간 현실적

### GPT 보완 사항
1. **`optionalAuth` 미들웨어 개선**: `req.authType` 플래그 추가 (명시적 구분)
2. **프론트엔드 토큰 저장**: localStorage vs sessionStorage 명확화
3. **QR 스캔 로직 역할 명확화**: 조회 + 접근 제어만 (생성/변경 금지)
4. **보증서 활성화 검증**: `guest_claimed` 상태 정책 확인 필요

---

## 📋 최종 우선순위 (검증 완료)

### 0️⃣ 전제 검증 (핵심 불변식)

**SYSTEM_FLOW_DETAILED.md 핵심 원칙**:
> **Warranty는 QR 스캔이 아니라 "결제 확정(processPaidOrder)"에서만 생성된다**

**현재 상태**:
- ✅ `processPaidOrder()`에서 warranty 생성 → **정상**
- ❌ QR 스캔 로직에 warranty 생성 흔적 존재 → **제거 대상**
- ❌ 주문 생성 API가 비회원 흐름을 막고 있음 → **가장 치명적**

**결론**: **주문 생성 → 결제 → warranty 생성** 이 축이 먼저 완성되어야 한다.

---

### 1️⃣ Phase 1: 비회원 주문 생성 API (최우선) ✅

#### 왜 최우선인가?
1. **모든 흐름의 시작점**: 이후 단계(조회, QR, claim, activation, transfer) 전부 여기에 의존
2. **현재 상태로는 "비회원 주문"이 논리적으로 불완전**
3. **가장 치명적인 블로커**: 지금 상태로는 비회원 주문이 불가능

#### 작업 목록 (GPT 보완 반영)

**백엔드**:
- ✅ `authenticateToken` → `optionalAuth` 변경
- ✅ `guest_id` 생성 로직 추가
- ✅ `owner_key` 기반 idempotency 처리
- ✅ **보완**: `req.authType` 플래그 추가 (`'user' | 'anonymous'`)

**프론트엔드**:
- ✅ `checkout.html` / `checkout-script.js` 비회원 분기
- ✅ **보완**: Guest Access Token 저장 위치 명확화 (localStorage 권장)

**예상 소요**: 4-6시간 → **현실적인 추정**

**상세 계획**: `PHASE_1_IMPLEMENTATION_PLAN.md` 참조

---

### 2️⃣ Phase 2: 비회원 주문 조회 API (1단계 완료 후 필수)

#### 왜 1단계 후인가?
- 1단계 없이는 의미 없음 → **판단 정확**
- **핵심 포인트**: 조회 권한 기준은 `user_id`가 아니라 `guest_access_token`
- URL 기반 접근은 지양, **토큰 교환 → 세션화 구조**가 맞음
- **보안 사고 방지**: 여기서 잘못 만들면 보안 사고 난다

#### 작업 목록
1. 세션 토큰 교환 API (`GET /api/guest/orders/session?token=xxx`)
2. 비회원 주문 상세 API (`GET /api/guest/orders/:orderNumber`)
3. 프론트엔드: 비회원 주문 상세 페이지

**예상 소요**: 3-4시간

---

### 3️⃣ Phase 3: QR 스캔 로직 수정 (지금이라도 해야 할 것)

#### 독립성 확인
- ✅ **"독립적"이라고 한 판단도 맞다** (다른 단계와 의존성 없음)
- ⚠️ **하지만 지금이라도 제거해야 함**: warranty 생성 로직이 남아있으면 시스템 불일치 발생

#### 반드시 제거해야 하는 것
- ❌ QR 스캔 시 warranty 생성
- ❌ QR 스캔 시 상태 변경 (side-effect)

#### QR의 역할 (명확화)
- ✅ **조회 + 접근 제어만**
  - `revoked` → 차단
  - `not_found` → 404
  - `inactive` → 안내
  - `active` → 조회

**예상 소요**: 2-3시간 → **맞음**

---

### 4️⃣ Phase 4: 보증서 활성화 API 검증 (순서 적절)

#### 역할
- 이건 **"기능 구현"이 아니라 정합성 확인 단계**다

#### 확인 포인트
1. `refund` → `activation` 불가 확인
2. `invoice linkage` 상태 정확히 반영 확인
3. **보완**: `guest_claimed` 상태에서도 활성화 허용 여부 정책 확인
   - 비회원 주문 → Claim → 활성화 흐름 검증 필요

**예상 소요**: 1-2시간 → **OK**

---

### 5️⃣ Phase 5: 양도 시스템 (마지막에 하는 게 맞음)

#### 왜 마지막인가?
- **owner 개념이 비회원/회원/클레임 전부 정리된 뒤에야 안전**
- 지금 붙이면 거의 다시 뜯게 됨

#### 작업 목록
1. 양도 요청 API (`POST /api/warranties/:id/transfer`)
2. 양도 수락 API (`POST /api/warranty/transfer/accept`)
3. 양도 취소 API
4. 양도 UI (프론트엔드)

**예상 소요**: 5-6시간 → **현실적**

---

## 📊 우선순위 요약표 (최종)

| 순서 | 작업 | 우선순위 | 예상 소요 | 의존성 | GPT 검증 |
|------|------|---------|----------|--------|---------|
| 1 | 비회원 주문 생성 API | 🔴 최우선 | 4-6시간 | 없음 | ✅ 정확 |
| 2 | 비회원 주문 조회 API | 🔴 최우선 | 3-4시간 | 1단계 완료 후 | ✅ 정확 |
| 3 | QR 스캔 로직 수정 | 🟡 높음 | 2-3시간 | 없음 (독립적) | ✅ 정확 |
| 4 | 보증서 활성화 API 검증 | 🟡 높음 | 1-2시간 | 없음 (이미 구현) | ✅ 정확 |
| 5 | 양도 시스템 구현 | 🟢 중간 | 5-6시간 | 4단계 완료 후 | ✅ 정확 |

---

## 🎯 최종 실행 판단

### 선택지 판단

**Option A (순차 진행)** → **✅ 권장**
- **안정성 최우선, 리스크 최소**
- 지금 시스템의 "근본 미완성"은 주문 생성 흐름이다
- 순차 진행이 가장 안전

**Option B (1단계 + 3단계 병렬)** → ⚠️ 가능은 하나
- 컨텍스트 스위칭 비용 큼
- 1단계가 완료되면 2단계가 바로 필요하므로 병렬 이점 적음

### 최종 결론

**✅ 내 분석: 정확**  
**✅ 우선순위: 옳음**  
**✅ 다음 액션: 1단계(비회원 주문 생성 API)부터 바로 착수**

---

## 📝 GPT 보완 사항 상세

### 1. `optionalAuth` 미들웨어 개선

**추가 사항**:
```javascript
// req.authType 플래그 추가
req.authType = 'user' | 'anonymous'; // 향후 'guest' 세션 타입 추가 가능
```

**이점**:
- 명시적 구분 가능
- 디버깅 및 로깅 용이
- 향후 확장 용이

### 2. 프론트엔드 토큰 저장 위치

**명확화**:
- ✅ **권장: localStorage** (90일 유효기간과 일치)
- ⚠️ **명확한 네이밍**: `guest_order_token_{orderNumber}` 형식
- ⚠️ **만료 처리**: 90일 경과 시 자동 삭제 로직 추가 (선택사항)

### 3. QR 스캔 로직 역할 명확화

**역할**:
- ✅ 조회 + 접근 제어만
- ❌ 생성/변경 금지

**상태별 처리**:
- `revoked` → 차단
- `not_found` → 404
- `inactive` → 안내
- `active` → 조회

### 4. 보증서 활성화 검증 보완

**추가 확인 사항**:
- `guest_claimed` 상태에서도 활성화 허용 여부 정책 확인
- 비회원 주문 → Claim → 활성화 흐름 검증 필요

---

## 🔚 다음 액션

**즉시 착수**: **Phase 1 (비회원 주문 생성 API)**  
**상세 계획**: `PHASE_1_IMPLEMENTATION_PLAN.md` 참조
