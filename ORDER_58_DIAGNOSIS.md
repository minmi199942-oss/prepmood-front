# ì£¼ë¬¸ 58 ë¬¸ì œ ì§„ë‹¨ ê°€ì´ë“œ

## ğŸ” ë¬¸ì œ ìš”ì•½

1. **ê²°ì œ í™•ì¸ ì¤‘ ì‹œê°„ì´ ë„ˆë¬´ ì˜¤ë˜ ê±¸ë¦¼** (1ë¶„ ì •ë„)
2. **`paid_events`ê°€ ìƒì„±ë˜ì§€ ì•ŠìŒ**
3. **`order_item_units`, `warranties`, `invoices`ê°€ ìƒì„±ë˜ì§€ ì•ŠìŒ**
4. **`orders.paid_at`ì´ NULL**
5. **ì¬ê³  ìƒíƒœê°€ ë³€ë™ë˜ì§€ ì•ŠìŒ**

---

## ğŸ“Š ì§„ë‹¨ ìˆœì„œ

### 1ë‹¨ê³„: ì£¼ë¬¸ ë° ê²°ì œ ìƒíƒœ í™•ì¸

VPSì—ì„œ ì‹¤í–‰:
```bash
cd /var/www/html/backend
mysql -u prepmood_user -p prepmood < scripts/check_order_58_status.sql
```

**í™•ì¸í•  ë‚´ìš©**:
- `payments` í…Œì´ë¸”ì— ê²°ì œ ê¸°ë¡ì´ ìˆëŠ”ì§€
- `paid_events`ê°€ ìƒì„±ë˜ì—ˆëŠ”ì§€
- `paid_event_processing` ìƒíƒœëŠ” ë¬´ì—‡ì¸ì§€

---

### 2ë‹¨ê³„: ë°±ì—”ë“œ ë¡œê·¸ í™•ì¸

VPSì—ì„œ ì‹¤í–‰:
```bash
pm2 logs prepmood-backend --lines 200 | grep -E "orderId: 58|order_id: 58|order_number.*ORD-20260115-322539|payments.*confirm|PAID|paid_events"
```

**í™•ì¸í•  ë‚´ìš©**:
- `POST /api/payments/confirm` APIê°€ í˜¸ì¶œë˜ì—ˆëŠ”ì§€
- ì—ëŸ¬ ë©”ì‹œì§€ê°€ ìˆëŠ”ì§€
- `createPaidEvent()`ê°€ ì‹¤í–‰ë˜ì—ˆëŠ”ì§€
- `processPaidOrder()`ê°€ ì‹¤í–‰ë˜ì—ˆëŠ”ì§€

---

### 3ë‹¨ê³„: í”„ë¡ íŠ¸ì—”ë“œ ì½˜ì†” í™•ì¸

ë¸Œë¼ìš°ì € ê°œë°œì ë„êµ¬ ì½˜ì†”ì—ì„œ í™•ì¸:
- `âŒ ê²°ì œ í™•ì¸ ì‹¤íŒ¨` ì—ëŸ¬ê°€ ìˆëŠ”ì§€
- ë„¤íŠ¸ì›Œí¬ íƒ­ì—ì„œ `POST /api/payments/confirm` ìš”ì²­ ìƒíƒœ í™•ì¸
  - 200 OKì¸ì§€
  - 400/500 ì—ëŸ¬ì¸ì§€
  - íƒ€ì„ì•„ì›ƒì¸ì§€

---

## ğŸ”§ ì˜ˆìƒ ì›ì¸ ë° í•´ê²°ì±…

### ì›ì¸ 1: `POST /api/payments/confirm` APIê°€ í˜¸ì¶œë˜ì§€ ì•ŠìŒ

**ì¦ìƒ**:
- ë°±ì—”ë“œ ë¡œê·¸ì— `[payments][confirm]` ë¡œê·¸ê°€ ì—†ìŒ
- í”„ë¡ íŠ¸ì—”ë“œ ì½˜ì†”ì— ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬

**í•´ê²°ì±…**:
- URL íŒŒë¼ë¯¸í„° í™•ì¸ (`paymentKey`, `orderId`, `amount`)
- `order-complete.html`ì—ì„œ `handleTossPaymentSuccess()` í˜¸ì¶œ í™•ì¸

---

### ì›ì¸ 2: API í˜¸ì¶œì€ ë˜ì—ˆì§€ë§Œ ì—ëŸ¬ ë°œìƒ

**ì¦ìƒ**:
- ë°±ì—”ë“œ ë¡œê·¸ì— ì—ëŸ¬ ë©”ì‹œì§€
- `paid_events`ëŠ” ìƒì„±ë˜ì§€ ì•ŠìŒ

**í•´ê²°ì±…**:
- ì—ëŸ¬ ë©”ì‹œì§€ í™•ì¸
- ì¸ì¦/CSRF í† í° ë¬¸ì œì¸ì§€ í™•ì¸
- ì£¼ë¬¸ ê¸ˆì•¡ ë¶ˆì¼ì¹˜ì¸ì§€ í™•ì¸

---

### ì›ì¸ 3: API íƒ€ì„ì•„ì›ƒ

**ì¦ìƒ**:
- 60ì´ˆ í›„ íƒ€ì„ì•„ì›ƒ
- ë°±ì—”ë“œ ë¡œê·¸ì— `processPaidOrder()` ì‹¤í–‰ ì¤‘ì´ì§€ë§Œ ì™„ë£Œë˜ì§€ ì•ŠìŒ

**í•´ê²°ì±…**:
- `processPaidOrder()` ì„±ëŠ¥ ìµœì í™”
- íƒ€ì„ì•„ì›ƒ ì‹œê°„ ì¦ê°€ (ì„ì‹œ ì¡°ì¹˜)
- ë¹„ë™ê¸° ì²˜ë¦¬ë¡œ ë³€ê²½ (ì¥ê¸° ì¡°ì¹˜)

---

### ì›ì¸ 4: ì¬ê³  ë¶€ì¡±

**ì¦ìƒ**:
- `paid_events`ëŠ” ìƒì„±ë˜ì—ˆì§€ë§Œ
- `processPaidOrder()`ì—ì„œ ì¬ê³  ë¶€ì¡± ì—ëŸ¬
- `order_item_units`ê°€ ìƒì„±ë˜ì§€ ì•ŠìŒ

**í•´ê²°ì±…**:
- ì¬ê³  í™•ì¸
- ì¬ê³  ë¶€ì¡± ì‹œ `order_stock_issues` í…Œì´ë¸” í™•ì¸

---

## ğŸ“ ë‹¤ìŒ ë‹¨ê³„

1. **1ë‹¨ê³„ ì‹¤í–‰**: `check_order_58_status.sql` ì‹¤í–‰ ê²°ê³¼ ê³µìœ 
2. **2ë‹¨ê³„ ì‹¤í–‰**: ë°±ì—”ë“œ ë¡œê·¸ í™•ì¸ ê²°ê³¼ ê³µìœ 
3. **3ë‹¨ê³„ í™•ì¸**: ë¸Œë¼ìš°ì € ì½˜ì†”/ë„¤íŠ¸ì›Œí¬ íƒ­ í™•ì¸ ê²°ê³¼ ê³µìœ 

ê²°ê³¼ë¥¼ ê³µìœ í•´ì£¼ì‹œë©´ ì •í™•í•œ ì›ì¸ì„ íŒŒì•…í•˜ê³  í•´ê²°ì±…ì„ ì œì‹œí•˜ê² ìŠµë‹ˆë‹¤.
