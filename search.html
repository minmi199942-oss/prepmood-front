<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ê²€ìƒ‰ ê²°ê³¼ - Pre.p Mood Store</title>
  <link rel="stylesheet" href="assets/css/global.css">
  <link rel="stylesheet" href="assets/css/page.css">
  <link rel="stylesheet" href="assets/css/responsive.css">
  <script src="catalog-data.js"></script>
  <script src="product-data.js"></script>
  <script src="header-loader.js" defer></script>
  <script src="header-scroll.js" defer></script>
  <script src="footer-loader.js" defer></script>
</head>
<body>

  <!-- í—¤ë”ê°€ ì‚½ì…ë  ì˜ì—­ -->
  <div id="header-container"></div>

  <!-- ê²€ìƒ‰ ê²°ê³¼ ë©”ì¸ ì»¨í…Œì´ë„ˆ -->
  <div class="search-page-container">
    <!-- ì™¼ìª½ í•„í„° ì‚¬ì´ë“œë°” -->
    <aside class="search-sidebar">
      <div class="sidebar-header">
        <h3>í•„í„°</h3>
        <button class="clear-filters-btn" id="clear-filters">ì´ˆê¸°í™”</button>
      </div>
      

      <!-- ì¹´í…Œê³ ë¦¬ í•„í„° -->
      <div class="filter-section">
        <div class="filter-toggle">
          <h4>ì¹´í…Œê³ ë¦¬</h4>
          <span class="toggle-icon">â–¼</span>
        </div>
        <div class="filter-content">
          <label class="filter-option">
            <input type="checkbox" name="category" value="tops">
            <span>ìƒì˜</span>
          </label>
          <label class="filter-option">
            <input type="checkbox" name="category" value="bottoms">
            <span>í•˜ì˜</span>
          </label>
          <label class="filter-option">
            <input type="checkbox" name="category" value="bags">
            <span>ê°€ë°©</span>
          </label>
          <label class="filter-option">
            <input type="checkbox" name="category" value="outer">
            <span>ì•„ìš°í„°</span>
          </label>
          <label class="filter-option">
            <input type="checkbox" name="category" value="accessories">
            <span>ì•¡ì„¸ì„œë¦¬</span>
          </label>
        </div>
      </div>

      <!-- ê°€ê²©ëŒ€ í•„í„° -->
      <div class="filter-section">
        <div class="filter-toggle">
          <h4>ê°€ê²©ëŒ€</h4>
          <span class="toggle-icon">â–¼</span>
        </div>
        <div class="filter-content">
          <label class="filter-option">
            <input type="radio" name="price" value="">
            <span>ì „ì²´</span>
          </label>
          <label class="filter-option">
            <input type="radio" name="price" value="0-50000">
            <span>5ë§Œì› ì´í•˜</span>
          </label>
          <label class="filter-option">
            <input type="radio" name="price" value="50000-100000">
            <span>5ë§Œì› ~ 10ë§Œì›</span>
          </label>
          <label class="filter-option">
            <input type="radio" name="price" value="100000-200000">
            <span>10ë§Œì› ~ 20ë§Œì›</span>
          </label>
          <label class="filter-option">
            <input type="radio" name="price" value="200000-">
            <span>20ë§Œì› ì´ìƒ</span>
          </label>
        </div>
      </div>

      <!-- ìƒ‰ìƒ í•„í„° -->
      <div class="filter-section">
        <div class="filter-toggle">
          <h4>ìƒ‰ìƒ</h4>
          <span class="toggle-icon">â–¼</span>
        </div>
        <div class="filter-content">
          <div class="color-options">
            <div class="color-option" data-color="black" style="background-color: #000;"></div>
            <div class="color-option" data-color="white" style="background-color: #fff; border: 1px solid #ddd;"></div>
            <div class="color-option" data-color="gray" style="background-color: #666;"></div>
            <div class="color-option" data-color="brown" style="background-color: #8B4513;"></div>
            <div class="color-option" data-color="navy" style="background-color: #000080;"></div>
          </div>
        </div>
      </div>

    </aside>

    <!-- ë©”ì¸ ì½˜í…ì¸  ì˜ì—­ -->
    <main class="search-main-content">
      <!-- ê²€ìƒ‰ ì…ë ¥ì°½ -->
      <div class="search-input-section">
        <div class="search-input-container">
          <input type="text" id="search-input-main" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." autocomplete="off">
          <button id="search-btn-main" class="search-button-main">ê²€ìƒ‰</button>
        </div>
      </div>

      <!-- ê²€ìƒ‰ ê²°ê³¼ í—¤ë” -->
      <div class="search-results-header">
        <div class="search-info">
          <h2 id="search-query">ê²€ìƒ‰ ê²°ê³¼</h2>
          <span class="results-count" id="results-count">0ê°œ ìƒí’ˆ</span>
        </div>
        <div class="sort-options">
          <select id="sort-select">
            <option value="name">ìƒí’ˆëª…ìˆœ</option>
            <option value="price-low">ë‚®ì€ ê°€ê²©ìˆœ</option>
            <option value="price-high">ë†’ì€ ê°€ê²©ìˆœ</option>
            <option value="newest">ìµœì‹ ìˆœ</option>
          </select>
        </div>
      </div>

      <!-- ê²€ìƒ‰ ê²°ê³¼ ê·¸ë¦¬ë“œ -->
      <div class="products-grid" id="products-grid">
        <!-- ê²€ìƒ‰ ê²°ê³¼ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤ -->
      </div>

      <!-- ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ -->
      <div class="no-results" id="no-results" style="display: none;">
        <div class="no-results-content">
          <h3>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
          <p>ë‹¤ë¥¸ ê²€ìƒ‰ì–´ë‚˜ í•„í„°ë¥¼ ì‹œë„í•´ë³´ì„¸ìš”.</p>
          <button class="reset-search-btn" onclick="resetSearch()">ê²€ìƒ‰ ì´ˆê¸°í™”</button>
        </div>
      </div>
    </main>
  </div>

  <!-- ê²€ìƒ‰ ê¸°ëŠ¥ JavaScript -->
  <script>
    let currentSearchQuery = '';
    let allProducts = [];
    let filteredProducts = [];

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', function() {
      // ì´ˆê¸°í™” í•¨ìˆ˜ë“¤ ë¨¼ì € ì‹¤í–‰
      initializeSearch();
      setupFilters();
      
      // product-data.jsì—ì„œ ë°ì´í„° ë¡œë“œ ì™„ë£Œë¥¼ ê¸°ë‹¤ë¦¼
      if (window.productsLoaded) {
        // ì´ë¯¸ ë¡œë“œëœ ê²½ìš°
        loadProducts();
      } else {
        // productsLoaded ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        window.addEventListener('productsLoaded', function() {
          loadProducts();
        });
        
        // íƒ€ì„ì•„ì›ƒ ì„¤ì • (5ì´ˆ í›„ì—ë„ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì—ëŸ¬ í‘œì‹œ)
        setTimeout(function() {
          if (allProducts.length === 0 && typeof window.CATALOG_DATA !== 'undefined') {
            // CATALOG_DATAê°€ ìˆìœ¼ë©´ ì‹œë„
            loadProducts();
          } else if (typeof window.CATALOG_DATA === 'undefined') {
            showError('ìƒí’ˆ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          }
        }, 5000);
      }
    });


    // ì—ëŸ¬ í‘œì‹œ
    function showError(message) {
      document.getElementById('products-grid').innerHTML = 
        `<div class="no-results">
          <div class="no-results-content">
            <h3>ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</h3>
            <p>${message}</p>
            <button class="reset-search-btn" onclick="location.reload()">í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨</button>
          </div>
        </div>`;
    }

    // URL íŒŒë¼ë¯¸í„°ì—ì„œ ê²€ìƒ‰ì–´ ê°€ì ¸ì˜¤ê¸°
    function initializeSearch() {
      const urlParams = new URLSearchParams(window.location.search);
      const query = urlParams.get('q');
      
      if (query) {
        currentSearchQuery = decodeURIComponent(query);
        document.getElementById('search-query').textContent = `"${currentSearchQuery}" ê²€ìƒ‰ ê²°ê³¼`;
        
        // ê²€ìƒ‰ì°½ì— í˜„ì¬ ê²€ìƒ‰ì–´ í‘œì‹œ
        const searchInput = document.getElementById('search-input-main');
        if (searchInput) {
          searchInput.value = currentSearchQuery;
        }
        
        performSearch();
      } else {
        // ê²€ìƒ‰ì–´ê°€ ì—†ìœ¼ë©´ ì „ì²´ ìƒí’ˆ í‘œì‹œ
        document.getElementById('search-query').textContent = 'ì „ì²´ ìƒí’ˆ';
      }
    }

    // ëª¨ë“  ìƒí’ˆ ë°ì´í„° ë¡œë“œ
    function loadProducts() {
      if (typeof window.CATALOG_DATA === 'undefined') {
        console.error('âŒ CATALOG_DATAê°€ ì •ì˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        showError('ìƒí’ˆ ë°ì´í„°ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        return;
      }

      const catalogData = window.CATALOG_DATA;
      console.log('ğŸ“¦ loadProducts ì‹œì‘ - CATALOG_DATA:', catalogData);
      allProducts = [];

      // ì‹¤ì œ ë°ì´í„° êµ¬ì¡°ì— ë§ê²Œ ìˆ˜ì •: { tops: { shirts: [] }, bottoms: { pants: [] } }
      Object.keys(catalogData).forEach(mainCategory => {
        const subCategories = catalogData[mainCategory];
        
        if (subCategories && typeof subCategories === 'object') {
          Object.keys(subCategories).forEach(subCategory => {
            const products = subCategories[subCategory];
            
            if (Array.isArray(products)) {
              console.log(`  ğŸ“‹ ${mainCategory}.${subCategory}: ${products.length}ê°œ ì œí’ˆ`);
              products.forEach(product => {
                allProducts.push({
                  ...product,
                  mainCategory: mainCategory, // tops, bottoms, outer ë“±
                  subCategory: subCategory,   // shirts, pants, skirts ë“±
                  category: mainCategory      // í•„í„°ì—ì„œ ì‚¬ìš©í•  í•„ë“œ
                });
              });
            }
          });
        }
      });

      console.log('âœ… loadProducts ì™„ë£Œ - ì „ì²´ ìƒí’ˆ ìˆ˜:', allProducts.length);
      if (allProducts.length > 0) {
        console.log('  ì²« ë²ˆì§¸ ìƒí’ˆ ì˜ˆì‹œ:', allProducts[0]);
      }

      // í•„í„° ì ìš© (ê²€ìƒ‰ì–´ í¬í•¨)
      applyFilters();
    }

    // ê²€ìƒ‰ ì‹¤í–‰ (ê²€ìƒ‰ì–´ë§Œ ì²˜ë¦¬, í•„í„°ëŠ” applyFiltersì—ì„œ ì²˜ë¦¬)
    function performSearch() {
      // ê²€ìƒ‰ì–´ê°€ ìˆë“  ì—†ë“  í•„í„°ë¥¼ ì ìš© (í•„í„°ê°€ ê²€ìƒ‰ì–´ë„ í•¨ê»˜ ì²˜ë¦¬í•¨)
      applyFilters();
    }

    // ìƒí’ˆ í‘œì‹œ
    function displayProducts(products) {
      const grid = document.getElementById('products-grid');
      const noResults = document.getElementById('no-results');
      const resultsCount = document.getElementById('results-count');

      if (!products || products.length === 0) {
        grid.style.display = 'none';
        noResults.style.display = 'block';
        resultsCount.textContent = '0ê°œ ìƒí’ˆ';
        return;
      }

      grid.style.display = 'grid';
      noResults.style.display = 'none';
      resultsCount.textContent = `${products.length}ê°œ ìƒí’ˆ`;

      const productsHtml = products.map(product => {
        // ì´ë¯¸ì§€ ê²½ë¡œ ìˆ˜ì •: APIì—ì„œ ë°›ì€ ê²½ë¡œ ì²˜ë¦¬
        let imagePath = product.image || '';
        // ë£¨íŠ¸ ê²½ë¡œ(/)ë¡œ ì‹œì‘í•˜ë©´ ì œê±°
        if (imagePath.startsWith('/')) {
          imagePath = imagePath.substring(1);
        }
        // image/ ì ‘ë‘ì‚¬ê°€ ì—†ìœ¼ë©´ ì¶”ê°€
        if (imagePath && !imagePath.startsWith('image/')) {
          imagePath = `image/${imagePath}`;
        }
        
        return `
          <div class="product-card" onclick="goToProduct('${product.id}', '${product.mainCategory}', '${product.subCategory}')">
            <div class="product-image">
              <img src="${imagePath}" alt="${product.name || 'ìƒí’ˆ ì´ë¯¸ì§€'}" loading="lazy" 
                   onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjgwIiBoZWlnaHQ9IjI4MCIgdmlld0JveD0iMCAwIDI4MCAyODAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyODAiIGhlaWdodD0iMjgwIiBmaWxsPSIjRjhGOUZBIi8+CjxwYXRoIGQ9Ik0xNDAgMTIwSDgwdjQwaDgwVjEyMFoiIGZpbGw9IiNEOUQ5RDkiLz4KPHN2Zz4K'">
            </div>
            <div class="product-info">
              <h3 class="product-name">${product.name || 'ìƒí’ˆëª…'}</h3>
              <p class="product-price">â‚©${(product.price || 0).toLocaleString()}</p>
              <p class="product-category">${product.mainCategory || ''}</p>
            </div>
          </div>
        `;
      }).join('');

      grid.innerHTML = productsHtml;
    }

    // ìƒí’ˆ ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™
    function goToProduct(productId, mainCategory, subCategory) {
      // buy.htmlë¡œ ì§ì ‘ ì´ë™ (ID ê¸°ë°˜)
      const url = `buy.html?id=${productId}`;
      window.location.href = url;
    }

    // í•„í„° ì„¤ì •
    function setupFilters() {
      // í•„í„° í† ê¸€ ê¸°ëŠ¥
      document.querySelectorAll('.filter-toggle').forEach(toggle => {
        toggle.addEventListener('click', function() {
          const content = this.nextElementSibling;
          const icon = this.querySelector('.toggle-icon');
          
          if (content.style.display === 'none') {
            content.style.display = 'block';
            icon.textContent = 'â–¼';
          } else {
            content.style.display = 'none';
            icon.textContent = 'â–¶';
          }
        });
      });

      // í•„í„° ë³€ê²½ ì´ë²¤íŠ¸
      document.querySelectorAll('input[type="radio"], input[type="checkbox"]').forEach(input => {
        input.addEventListener('change', applyFilters);
      });

      // ìƒ‰ìƒ í•„í„° ì´ë²¤íŠ¸
      document.querySelectorAll('.color-option').forEach(colorOption => {
        colorOption.addEventListener('click', function() {
          this.classList.toggle('selected');
          applyFilters();
        });
      });

      // ì •ë ¬ ì˜µì…˜
      document.getElementById('sort-select').addEventListener('change', applySorting);

      // í•„í„° ì´ˆê¸°í™”
      document.getElementById('clear-filters').addEventListener('click', clearFilters);

      // ê²€ìƒ‰ì°½ ì´ë²¤íŠ¸ ì„¤ì •
      setupSearchInput();
    }

    // ê²€ìƒ‰ì°½ ì´ë²¤íŠ¸ ì„¤ì •
    function setupSearchInput() {
      const searchInput = document.getElementById('search-input-main');
      const searchBtn = document.getElementById('search-btn-main');

      if (searchInput && searchBtn) {
        // ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­
        searchBtn.addEventListener('click', function() {
          performNewSearch();
        });

        // ì—”í„°í‚¤ë¡œ ê²€ìƒ‰
        searchInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            performNewSearch();
          }
        });

        // ê²€ìƒ‰ì–´ ë³€ê²½ ì‹œ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ (ì„ íƒì‚¬í•­)
        searchInput.addEventListener('input', function() {
          // ì‹¤ì‹œê°„ ê²€ìƒ‰ì„ ì›í•œë‹¤ë©´ ì£¼ì„ í•´ì œ
          // performNewSearch();
        });
      }
    }

    // ìƒˆë¡œìš´ ê²€ìƒ‰ ì‹¤í–‰
    function performNewSearch() {
      const searchInput = document.getElementById('search-input-main');
      if (!searchInput) return;

      const newQuery = searchInput.value.trim();

      // í˜„ì¬ ê²€ìƒ‰ì–´ ì—…ë°ì´íŠ¸
      currentSearchQuery = newQuery;
      
      if (!newQuery) {
        document.getElementById('search-query').textContent = 'ì „ì²´ ìƒí’ˆ';
      } else {
        document.getElementById('search-query').textContent = `"${currentSearchQuery}" ê²€ìƒ‰ ê²°ê³¼`;
      }

      // í•„í„° ì ìš© (ê²€ìƒ‰ì–´ í¬í•¨)
      applyFilters();

      // URL ì—…ë°ì´íŠ¸ (ì„ íƒì‚¬í•­ - íˆìŠ¤í† ë¦¬ ê´€ë¦¬)
      const newUrl = `search.html?q=${encodeURIComponent(currentSearchQuery)}`;
      window.history.pushState({}, '', newUrl);
    }

    // í•„í„° ì ìš©
    function applyFilters() {
      // ìƒí’ˆ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ í•„í„° ì ìš©í•˜ì§€ ì•ŠìŒ
      if (!allProducts || allProducts.length === 0) {
        return;
      }

      const categories = Array.from(document.querySelectorAll('input[name="category"]:checked')).map(cb => cb.value);
      const priceElement = document.querySelector('input[name="price"]:checked');
      const price = priceElement ? priceElement.value : '';

      // í•­ìƒ ì „ì²´ ìƒí’ˆì—ì„œ ì‹œì‘
      let filtered = [...allProducts];

      // ê²€ìƒ‰ì–´ í•„í„° (ê°€ì¥ ë¨¼ì € ì ìš©)
      if (currentSearchQuery) {
        filtered = filtered.filter(product => 
          product.name.toLowerCase().includes(currentSearchQuery.toLowerCase())
        );
      }

      // ì¹´í…Œê³ ë¦¬ í•„í„°
      if (categories.length > 0) {
        filtered = filtered.filter(product => {
          // product.category ë˜ëŠ” product.mainCategory ì‚¬ìš©
          const productCategory = product.category || product.mainCategory;
          return categories.includes(productCategory);
        });
      }

      // ê°€ê²© í•„í„°
      if (price) {
        const priceRange = price.split('-');
        const min = parseInt(priceRange[0]) || 0;
        let max;
        
        if (priceRange[1] === undefined || priceRange[1] === '') {
          // "200000-" ê°™ì€ ê²½ìš°: ìµœì†Œê°’ ì´ìƒ (ë¬´ì œí•œ)
          max = Infinity;
        } else {
          // "0-50000" ê°™ì€ ê²½ìš°: ìµœì†Œê°’ ì´ìƒ ìµœëŒ€ê°’ ì´í•˜
          max = parseInt(priceRange[1]);
        }
        
        filtered = filtered.filter(product => {
          if (max === Infinity) {
            return product.price >= min;
          } else {
            return product.price >= min && product.price <= max;
          }
        });
      }

      // ìƒ‰ìƒ í•„í„°
      const selectedColors = Array.from(document.querySelectorAll('.color-option.selected')).map(el => el.dataset.color);
      if (selectedColors.length > 0) {
        filtered = filtered.filter(product => {
          // ìƒí’ˆëª…ì´ë‚˜ ì„¤ëª…ì—ì„œ ìƒ‰ìƒ í‚¤ì›Œë“œ ê²€ìƒ‰
          // ë˜ëŠ” ìƒí’ˆ ë°ì´í„°ì— color í•„ë“œê°€ ìˆë‹¤ë©´ ì‚¬ìš©
          const productText = (product.name + ' ' + (product.description || '')).toLowerCase();
          return selectedColors.some(color => {
            const colorKeywords = {
              'black': ['black', 'ë¸”ë™', 'ê²€ì •'],
              'white': ['white', 'í™”ì´íŠ¸', 'í°ìƒ‰'],
              'gray': ['gray', 'grey', 'ê·¸ë ˆì´', 'íšŒìƒ‰'],
              'brown': ['brown', 'ë¸Œë¼ìš´', 'ê°ˆìƒ‰'],
              'navy': ['navy', 'ë„¤ì´ë¹„', 'ë‚¨ìƒ‰']
            };
            const keywords = colorKeywords[color] || [color];
            return keywords.some(keyword => productText.includes(keyword));
          });
        });
      }

      filteredProducts = filtered;
      applySorting();
    }

    // ì •ë ¬ ì ìš©
    function applySorting() {
      const sortBy = document.getElementById('sort-select').value;

      switch (sortBy) {
        case 'name':
          filteredProducts.sort((a, b) => a.name.localeCompare(b.name));
          break;
        case 'price-low':
          filteredProducts.sort((a, b) => a.price - b.price);
          break;
        case 'price-high':
          filteredProducts.sort((a, b) => b.price - a.price);
          break;
        case 'newest':
          // ìµœì‹ ìˆœì€ ID ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬ (ë†’ì€ IDê°€ ìµœì‹ )
          filteredProducts.sort((a, b) => b.id.localeCompare(a.id));
          break;
      }

      displayProducts(filteredProducts);
    }

    // í•„í„° ì´ˆê¸°í™”
    function clearFilters() {
      // ê°€ê²© í•„í„° ì´ˆê¸°í™” (ì „ì²´ ì„ íƒ)
      document.querySelectorAll('input[name="price"]').forEach(input => {
        input.checked = (input.value === '');
      });
      
      // ì¹´í…Œê³ ë¦¬ í•„í„° ì´ˆê¸°í™”
      document.querySelectorAll('input[name="category"]').forEach(input => {
        input.checked = false;
      });

      // ìƒ‰ìƒ í•„í„° ì´ˆê¸°í™”
      document.querySelectorAll('.color-option').forEach(colorOption => {
        colorOption.classList.remove('selected');
      });

      // ê²€ìƒ‰ì–´ëŠ” ìœ ì§€í•˜ê³  í•„í„°ë§Œ ì´ˆê¸°í™”
      applyFilters();
    }

    // ê²€ìƒ‰ ì´ˆê¸°í™”
    function resetSearch() {
      window.location.href = 'index.html';
    }

    // ê²€ìƒ‰ì–´ ì„¤ì • í•¨ìˆ˜ (ì™¸ë¶€ì—ì„œ í˜¸ì¶œìš©)
    function setSearchQuery(query) {
      currentSearchQuery = query;
      document.getElementById('search-query').textContent = `"${query}" ê²€ìƒ‰ ê²°ê³¼`;
      applyFilters();
    }

  </script>

  <!-- í‘¸í„° ì»¨í…Œì´ë„ˆ -->
  <div id="footer-container"></div>
</body>
</html>
