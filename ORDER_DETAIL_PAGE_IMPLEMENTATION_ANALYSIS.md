# í†µí•© ì£¼ë¬¸ ìƒì„¸ í˜ì´ì§€ êµ¬í˜„ ë¶„ì„ ë¬¸ì„œ

## ğŸ“‹ í˜„ì¬ ì‹œìŠ¤í…œ êµ¬ì¡° ë¶„ì„

### 1. ì´ë©”ì¼ ë°œì†¡ êµ¬ì¡°

#### í˜„ì¬ êµ¬í˜„ (`backend/payments-routes.js`)
- **í•¨ìˆ˜**: `sendOrderConfirmationEmail` (ë¹„íšŒì›/íšŒì› êµ¬ë¶„ ì—†ì´ ë™ì¼í•œ ì´ë©”ì¼ ë‚´ìš©)
- **Secure ë§í¬ ìƒì„±**:
  - ë¹„íšŒì›: `${baseUrl}/api/guest/orders/session?token=${guest_access_token}`
  - íšŒì›: `${baseUrl}/my-orders.html`
- **í˜¸ì¶œ ìœ„ì¹˜**: `backend/payments-routes.js` (3ê³³)
  1. `POST /api/payments/confirm` (696-704ì¤„)
  2. `POST /api/payments/inicis/confirm` (1394-1402ì¤„)
  3. `POST /api/payments/webhook` (1969-1977ì¤„)

#### ì´ë©”ì¼ ë‚´ìš© (`backend/mailer.js`)
- ì£¼ë¬¸ë²ˆí˜¸, ì£¼ë¬¸ì¼ì‹œ, ê³ ê° ì´ë¦„
- "Order Reference" ì„¹ì…˜
- "Digital Records" ì„¹ì…˜ (Digital Invoice, Digital Warranty ì²´í¬)
- Secure ë§í¬ ({{Secure Link}} í…ìŠ¤íŠ¸ì— ë§í¬ ì ìš©)
- ë°°ì†¡ ì•ˆë‚´, ì—°ë½ì²˜ ì •ë³´

---

### 2. ë¹„íšŒì› ì£¼ë¬¸ ì¡°íšŒ êµ¬ì¡°

#### ì„¸ì…˜ í† í° êµí™˜ ë°©ì‹ (`backend/order-routes.js`)
- **ì—”ë“œí¬ì¸íŠ¸**: `GET /api/guest/orders/session?token=xxx`
- **ì²˜ë¦¬ íë¦„**:
  1. `guest_order_access_token` ê²€ì¦
  2. ì„¸ì…˜ í† í° ë°œê¸‰ (24ì‹œê°„ TTL)
  3. `guest_order_sessions` í…Œì´ë¸”ì— ì €ì¥
  4. httpOnly Cookie ì„¤ì • (`guest_session_token`)
  5. 302 Redirect â†’ `/guest/orders.html?order=ORD-...`
- **âš ï¸ í˜„ì¬ ë¬¸ì œì **: `orders.user_id IS NOT NULL`ë¡œ Claim ì™„ë£Œ ì£¼ë¬¸ ì°¨ë‹¨ (1460-1468ì¤„)

#### ì£¼ë¬¸ ì¡°íšŒ API (`GET /api/guest/orders/:orderNumber`)
- **ì¸ì¦**: httpOnly Cookie (`guest_session_token`)
- **ê²€ì¦**:
  - ì„¸ì…˜ í† í° ê²€ì¦
  - ì„¸ì…˜ ë§Œë£Œ í™•ì¸
  - ìˆ˜í‰ ê¶Œí•œìƒìŠ¹ ë°©ì§€ (ì„¸ì…˜ `order_number` == ìš”ì²­ `order_number`)
  - Claim ì™„ë£Œ í™•ì¸ (`orders.user_id IS NOT NULL`)
  - í† í° íšŒìˆ˜ í™•ì¸ (`revoked_at`)
- **ì‘ë‹µ ë°ì´í„°**:
  - `order`: order_id, order_number, order_date, total_price, status, paid_at
  - `payment`: gateway, method, amount, currency, status, created_at
  - `shipping`: name, email, phone, address, city, postal_code, country
  - `items`: product_id, product_name, quantity, price, size, color, product_image
  - `shipments`: carrier_code, carrier_name, tracking_number, shipped_at, delivered_at

#### í”„ë¡ íŠ¸ì—”ë“œ (`guest/orders.html`, `guest/orders.js`)
- ì„¸ì…˜ í† í° ê¸°ë°˜ ì ‘ê·¼ (ì¿ í‚¤ ìë™ ì „ì†¡)
- ì£¼ë¬¸ ì •ë³´, ê²°ì œ ì •ë³´, ë°°ì†¡ì§€ ì •ë³´, ì£¼ë¬¸ í•­ëª©, ë°°ì†¡ ì •ë³´ í‘œì‹œ
- "ë‚´ ê³„ì •ì— ì—°ë™í•˜ê¸°" ë²„íŠ¼ (Claim ê¸°ëŠ¥)

---

### 3. íšŒì› ì£¼ë¬¸ ì¡°íšŒ êµ¬ì¡°

#### íšŒì› ì£¼ë¬¸ ëª©ë¡ (`my-orders.html`, `my-orders.js`)
- **ì¸ì¦**: JWT (httpOnly Cookie)
- **API**: íšŒì› ì „ìš© ì£¼ë¬¸ ëª©ë¡ API (í™•ì¸ í•„ìš”)

#### íšŒì› ì¸ë³´ì´ìŠ¤ ìƒì„¸ (`invoice-detail.html`, `invoice-detail.js`)
- **ì¸ì¦**: JWT (httpOnly Cookie)
- **API**: `GET /api/invoices/:invoiceId` (íšŒì› ì „ìš©, `authenticateToken` í•„ìˆ˜)
- **í‘œì‹œ ë‚´ìš©**:
  - INVOICE í—¤ë” (ë²ˆí˜¸, ë°œê¸‰ì¼)
  - DESCRIPTION ì„¹ì…˜ (ìƒí’ˆëª…, ìˆ˜ëŸ‰, ê¸ˆì•¡)
  - Financial Summary (Subtotal, Tax, Payment Method, Total)
  - Footer (PRE.PMOOD íšŒì‚¬ ì •ë³´, CUSTOMER ì •ë³´)
  - ë³´ì¦ì„œ ë³´ê¸° ë²„íŠ¼ (ê° ìƒí’ˆ í•­ëª© ì˜†ì— ë°°ì¹˜)

---

### 4. ë°ì´í„°ë² ì´ìŠ¤ êµ¬ì¡°

#### í•µì‹¬ í…Œì´ë¸”

**orders**:
- `order_id` (PK)
- `user_id` (NULL í—ˆìš© - ë¹„íšŒì› ì§€ì›)
- `guest_id` (varchar(20), NULL í—ˆìš©)
- `order_number` (UNIQUE)
- `order_date`, `total_price`, `status`, `paid_at`
- `shipping_name`, `shipping_email`, `shipping_phone`, `shipping_address`, `shipping_city`, `shipping_postal_code`, `shipping_country`

**invoices**:
- `invoice_id` (PK)
- `order_id` (FK)
- `invoice_number` (UNIQUE)
- `type` (invoice/credit_note)
- `status` (issued/void/refunded)
- `total_amount`, `tax_amount`, `net_amount`
- `billing_name`, `billing_email`, `billing_phone`, `billing_address_json`
- `shipping_name`, `shipping_email`, `shipping_phone`, `shipping_address_json`
- `payload_json` (ìŠ¤ëƒ…ìƒ· - items í¬í•¨)
- `issued_at`, `emailed_at`

**warranties**:
- `id` (PK)
- `status` (issued_unassigned/issued/active/suspended/revoked)
- `public_id` (UNIQUE, UUID)
- `owner_user_id` (NULL í—ˆìš© - ë¹„íšŒì› ì§€ì›)
- `source_order_item_unit_id` (FK)
- `token_pk` (FK, token_master ì°¸ì¡°)
- `activated_at`, `revoked_at`, `created_at`

**order_items**:
- `order_item_id` (PK)
- `order_id` (FK)
- `product_id`, `product_name`, `product_image`
- `size`, `color`
- `quantity`, `unit_price`, `subtotal`

**order_item_units**:
- `order_item_unit_id` (PK)
- `order_item_id` (FK)
- `order_id` (FK)
- `unit_seq`
- `stock_unit_id` (FK)
- `token_pk` (FK)
- `unit_status` (reserved/shipped/delivered/refunded)
- `carrier_code`, `tracking_number`
- `shipped_at`, `delivered_at`
- `current_shipment_id` (FK)

**payments**:
- `payment_id` (PK)
- `order_number` (FK)
- `gateway` (toss/card/virtual/bank/mobile)
- `payment_key` (UNIQUE)
- `status` (initiated/authorized/captured/failed/cancelled/refunded)
- `amount`, `currency`
- `created_at`

**shipments**:
- `shipment_id` (PK)
- `order_id` (FK)
- `carrier_code` (FK)
- `tracking_number`
- `shipped_at`
- `voided_at`

**guest_order_access_tokens**:
- `token_id` (PK)
- `order_id` (FK)
- `token` (UNIQUE, 90ì¼ ìœ íš¨)
- `expires_at`
- `revoked_at`
- `created_at`

**guest_order_sessions**:
- `session_id` (PK)
- `order_id` (FK)
- `session_token` (UNIQUE, 24ì‹œê°„ ìœ íš¨)
- `access_token_id` (FK, guest_order_access_tokens ì°¸ì¡°)
- `expires_at`
- `last_access_at`
- `created_at`

**users**:
- `user_id` (PK)
- `email` (UNIQUE)
- `name`
- `membership_id` (UNIQUE, PM.{ë…„ë„}.{ëœë¤6ì})
- `phone`

---

## ğŸ¯ í†µí•© ì£¼ë¬¸ ìƒì„¸ í˜ì´ì§€ êµ¬í˜„ ê³„íš

### ëª©í‘œ
- ë¹„íšŒì›/íšŒì› êµ¬ë¶„ ì—†ì´ ë™ì¼í•œ í˜ì´ì§€ (`order-detail.html`)
- ë¡œê·¸ì¸ í•„ìˆ˜ ì•„ë‹˜ (í† í° ê¸°ë°˜ ì ‘ê·¼)
- 7ê°œ ì„¹ì…˜ êµ¬í˜„

### ì ‘ê·¼ ë°©ì‹

#### ì˜µì…˜ A: ê¸°ì¡´ í˜ì´ì§€ í™œìš©
- `guest/orders.html`ì„ í™•ì¥í•˜ì—¬ í†µí•© í˜ì´ì§€ë¡œ ë³€ê²½
- íšŒì›ë„ ë™ì¼í•œ í˜ì´ì§€ ì‚¬ìš©

#### ì˜µì…˜ B: ìƒˆ í˜ì´ì§€ ìƒì„± (ê¶Œì¥)
- `order-detail.html` ìƒˆë¡œ ìƒì„±
- ê¸°ì¡´ `guest/orders.html`ì€ ìœ ì§€ (í•˜ìœ„ í˜¸í™˜ì„±)
- íšŒì›/ë¹„íšŒì› ëª¨ë‘ ìƒˆ í˜ì´ì§€ ì‚¬ìš©

**ê¶Œì¥**: ì˜µì…˜ B (ìƒˆ í˜ì´ì§€ ìƒì„±)

---

## ğŸ” GPT ì œì•ˆ ë¶„ì„ ë° ìµœì¢… ì •ì±… í™•ì •

### GPT ì œì•ˆ ìš”ì•½

GPTëŠ” ë‹¤ìŒê³¼ ê°™ì€ ì ‘ê·¼ ë°©ì‹ì„ ì œì•ˆí–ˆìŠµë‹ˆë‹¤:

1. **íšŒì›/ë¹„íšŒì› ëª¨ë‘ ë™ì¼í•œ í† í° ë°œê¸‰**: `guest_order_access_token`ì„ íšŒì› ì£¼ë¬¸ì—ë„ ë°œê¸‰í•˜ì—¬ ì´ë©”ì¼ ë§í¬ í†µì¼
2. **í†µí•© ì„¸ì…˜ êµí™˜ ì—”ë“œí¬ì¸íŠ¸**: `/api/orders/session?token=...` (íšŒì›/ë¹„íšŒì› êµ¬ë¶„ ì—†ìŒ)
3. **í†µí•© ì£¼ë¬¸ ì¡°íšŒ API**: `GET /api/orders/detail?order=...` (JWT ë˜ëŠ” ì„¸ì…˜ ì¿ í‚¤ë¡œ ì ‘ê·¼)
4. **ì„¸ì…˜ ì¿ í‚¤ ì´ë¦„ ìœ ì§€**: `guest_session_token` (í•˜ìœ„ í˜¸í™˜ì„±)
5. **URLì— token ë…¸ì¶œ ì•ˆ í•¨**: ì„¸ì…˜ êµí™˜ ë°©ì‹ ìœ ì§€ (ì´ë¯¸ êµ¬í˜„ë¨)

---

### âš ï¸ ì¹˜ëª…ì ì¸ ì„¤ê³„ ì˜¤ë¥˜ ë°œê²¬

#### ë¬¸ì œì : Claim ì™„ë£Œ ì£¼ë¬¸ ì°¨ë‹¨ ë¡œì§

**í˜„ì¬ ì½”ë“œ** (`backend/order-routes.js` 1460-1468ì¤„):
```javascript
// 4. orders.user_id IS NULL í™•ì¸ (Claim ì™„ë£Œëœ ì£¼ë¬¸ ì°¨ë‹¨)
if (tokenData.user_id !== null) {
    await connection.end();
    return res.status(410).json({
        success: false,
        message: 'ì´ë¯¸ íšŒì› ê³„ì •ì— ì—°ë™ëœ ì£¼ë¬¸ì…ë‹ˆë‹¤.',
        code: 'ORDER_CLAIMED'
    });
}
```

**ì¶©ëŒ ì´ìœ **:
1. **ìš”êµ¬ì‚¬í•­**: íšŒì›ë„ ì´ë©”ì¼ ë§í¬ë¡œ ë¡œê·¸ì¸ ì—†ì´ ì£¼ë¬¸ì„œë¥¼ ë´ì•¼ í•¨
2. **í˜„ì¬ ë¡œì§**: `orders.user_id IS NOT NULL`ì´ë©´ ì„¸ì…˜ êµí™˜ ì°¨ë‹¨
3. **ê²°ê³¼**: íšŒì› ì£¼ë¬¸ì˜ ì´ë©”ì¼ ë§í¬ê°€ ì „ë¶€ ë§‰í˜ âŒ

**í•´ê²° ë°©ì•ˆ**:
- **`orders.user_id IS NOT NULL` ì°¨ë‹¨ ë¡œì§ ì œê±°**
- ì°¨ë‹¨ ì¡°ê±´ì€ **3ì¢… ì°¨ë‹¨**ë§Œ ì ìš©: token ì—†ìŒ / `expires_at < NOW()` / `revoked_at IS NOT NULL`

---

### ğŸ“‹ ìµœì¢… ì •ì±… í™•ì • (6ê°€ì§€ í•µì‹¬ ê·œì¹™)

#### 1. ì´ë©”ì¼ ë§í¬ í†µì¼
- **ê·œì¹™**: íšŒì›/ë¹„íšŒì› ëª¨ë‘ `/api/orders/session?token=...`ë¡œ í†µì¼
- **êµ¬í˜„**: `processPaidOrder()`ì—ì„œ íšŒì› ì£¼ë¬¸ì—ë„ `guest_order_access_tokens` ìƒì„±
- **ì´ìœ **: ì´ë©”ì¼ í…œí”Œë¦¿ ë‹¨ìˆœí™”, ìœ ì§€ë³´ìˆ˜ ìš©ì´

#### 2. ì„¸ì…˜ êµí™˜ ë°©ì‹ ìœ ì§€
- **ê·œì¹™**: tokenì€ URLì— ë‚¨ê¸°ì§€ ì•Šê³ , session êµí™˜ í›„ `/order-detail.html?order=ORD-...`ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
- **êµ¬í˜„**: ê¸°ì¡´ ì„¸ì…˜ êµí™˜ ë¡œì§ ìœ ì§€
- **ì´ìœ **: ë³´ì•ˆì„± í–¥ìƒ (URLì— í† í° ë…¸ì¶œ ë°©ì§€)

#### 3. Claim ì™„ë£Œ ì£¼ë¬¸ ì°¨ë‹¨ ì œê±°
- **ê·œì¹™**: `orders.user_id IS NOT NULL`ë¡œ ì°¨ë‹¨í•˜ì§€ ì•ŠëŠ”ë‹¤
- **êµ¬í˜„**: ì„¸ì…˜ êµí™˜ ì—”ë“œí¬ì¸íŠ¸ì—ì„œ í•´ë‹¹ ê²€ì¦ ì œê±°
- **ì´ìœ **: íšŒì› ì£¼ë¬¸ë„ ì´ë©”ì¼ ë§í¬ë¡œ ì ‘ê·¼ ê°€ëŠ¥í•´ì•¼ í•¨

#### 4. í†µí•© ì£¼ë¬¸ ì¡°íšŒ API (JWT ìš°ì„ , í´ë°± ì—†ìŒ)
- **ê·œì¹™**: `GET /api/orders/detail?order=...`ëŠ” ë‘ ì¸ì¦ ë°©ì‹ ì¤‘ í•˜ë‚˜ë¥¼ ì§€ì›í•œë‹¤
  - **ìš”ì²­ì— `accessToken` ì¿ í‚¤(JWT)ê°€ ì¡´ì¬í•˜ë©´**:
    - JWT ê²€ì¦ ì„±ê³µ + ì£¼ë¬¸ ê¶Œí•œ OK â†’ í†µê³¼
    - JWT ê²€ì¦ ì„±ê³µì¸ë° ì£¼ë¬¸ ê¶Œí•œ ì—†ìŒ â†’ 401/403 (ì„¸ì…˜ ì¿ í‚¤ê°€ ìˆì–´ë„ ë¬´ì‹œ)
    - JWT ê²€ì¦ ì‹¤íŒ¨ â†’ 401 (ì„¸ì…˜ ì¿ í‚¤ ë¬´ì‹œ)
  - **ìš”ì²­ì— JWT ì¿ í‚¤ê°€ ì—†ì„ ë•Œë§Œ** ì„¸ì…˜ ê¸°ë°˜ ì¸ì¦ì„ í—ˆìš©í•œë‹¤
- **êµ¬í˜„**: `optionalAuth` ë¯¸ë“¤ì›¨ì–´ ì‚¬ìš© (JWT ì¿ í‚¤ ì¡´ì¬ ì‹œ ê²€ì¦ ì‹¤íŒ¨í•˜ë©´ ì¦‰ì‹œ 401)
- **ì´ìœ **: ë‹¨ì¼ APIë¡œ í†µí•©, ìˆ˜í‰ ê¶Œí•œìƒìŠ¹ ë°©ì§€, ë³´ì•ˆ ê°•í™”

#### 5. (ê·œì¹™ 4ì— í†µí•©ë¨)

#### 5. Claim ì‹œ í† í° ìë™ íšŒìˆ˜ ì•ˆ í•¨
- **ê·œì¹™**: Claimì€ "ê³„ì • ì—°ê²°"ë§Œ ìˆ˜í–‰í•˜ë©°, ì´ë©”ì¼ ì ‘ê·¼ í† í°ì„ ìë™ íšŒìˆ˜í•˜ì§€ ì•ŠëŠ”ë‹¤ (ë§Œë£Œë¡œ ìì—° ì†Œë©¸)
- **êµ¬í˜„**: Claim APIì—ì„œ `revoked_at` ì„¤ì •í•˜ì§€ ì•ŠìŒ
- **ì´ìœ **: ë°°ì†¡ ì¤‘ ì¬í™•ì¸, CS ë¬¸ì˜, ê°€ì¡±ì´ ëŒ€ì‹  í™•ì¸ ë“± ì‹¤ì œ ì¼€ì´ìŠ¤ ì§€ì›

---

### ğŸ¯ ì •ì±… ëª…í™•í™” í•„ìš” ì‚¬í•­

#### A. Claim ì´í›„ í† í° ìœ íš¨ì„± ì •ì±…

**í˜„ì¬ ë¬¸ì„œ** (`SYSTEM_FLOW_DETAILED.md` 346ì¤„):
- Claim ì™„ë£Œ ì‹œ `guest_order_access_token` íšŒìˆ˜ (`revoked_at` ì„¤ì •)

**GPT ì œì•ˆ**:
- Claim ì™„ë£Œ í›„ì—ë„ í† í°ì€ ìœ íš¨ (ë§Œë£Œ ì „ê¹Œì§€)
- í™”ë©´ì—ì„œ "ì´ë¯¸ ë‚´ ê³„ì •ì— ë“±ë¡ëœ ì¸ë³´ì´ìŠ¤" / "ë“±ë¡í•˜ê¸°" CTAë§Œ ë°”ë€œ

**ê¶Œì¥ ì •ì±…**:
- âœ… **í† í° ìœ íš¨ì„± ìœ ì§€**: Claim ì™„ë£Œ í›„ì—ë„ í† í°ì€ ë§Œë£Œ ì „ê¹Œì§€ ìœ íš¨
- âœ… **UI ë³€ê²½**: í™”ë©´ì—ì„œ "ì´ë¯¸ ë“±ë¡ëœ ì¸ë³´ì´ìŠ¤" ë©”ì‹œì§€ í‘œì‹œ
- âœ… **í† í° íšŒìˆ˜ ì•ˆ í•¨**: `revoked_at` ì„¤ì •í•˜ì§€ ì•ŠìŒ

**ì´ìœ **:
- ë°°ì†¡ ì¤‘ ì¬í™•ì¸, CS ë¬¸ì˜, ê°€ì¡±ì´ ëŒ€ì‹  í™•ì¸ ê°™ì€ ì‹¤ì œ ì¼€ì´ìŠ¤ ì§€ì›
- ì´ë©”ì¼ ì ‘ê·¼ í† í°ì€ "ì´ë©”ì¼ì„ ê°€ì§„ ì‚¬ëŒ"ì´ ì£¼ë¬¸ì„œë¥¼ ë³¼ ìˆ˜ ìˆê²Œ í•˜ëŠ” ê¶Œí•œ
- Claimì€ "ê³„ì • ì†Œìœ ê¶Œ ì—°ê²°"ì¼ ë¿, ì´ë©”ì¼ ë§í¬ ì—´ëŒ ê¶Œí•œì„ ì—†ì•¨ ì´ìœ ê°€ ì—†ìŒ

#### B. JWT + ì„¸ì…˜ ë™ì‹œ ì¡´ì¬ ì‹œ ìš°ì„ ìˆœìœ„

**í˜„ì¬ ë¬¸ì„œ**: "JWT ìš°ì„ "ë§Œ ëª…ì‹œ

**GPT ì œì•ˆ**: ë” ê°•í•˜ê²Œ ëª…í™•í™” í•„ìš”

**ê¶Œì¥ ê·œì¹™**:
1. **JWTê°€ ìˆê³ , ê·¸ JWTê°€ ìš”ì²­ orderì— ëŒ€í•´ ê¶Œí•œì´ ìˆìœ¼ë©´** â†’ JWTë¡œ ì²˜ë¦¬
2. **JWTê°€ ìˆì§€ë§Œ ê¶Œí•œì´ ì—†ìœ¼ë©´** â†’ ì„¸ì…˜ìœ¼ë¡œ í´ë°±í•˜ì§€ ë§ê³  ê±°ë¶€ (401)
3. **JWTê°€ ì—†ìœ¼ë©´** â†’ ì„¸ì…˜ìœ¼ë¡œë§Œ ì²˜ë¦¬

**ì´ìœ **:
- í´ë°± í—ˆìš©í•˜ë©´ "ë¡œê·¸ì¸í•œ ê³„ì •ì´ ê¶Œí•œ ì—†ëŠ”ë°ë„, ì„¸ì…˜ ì¿ í‚¤ë¡œ ìš°íšŒ ì ‘ê·¼" ê°™ì€ ê¼¬ì„ ë°œìƒ
- JWT ì¡´ì¬ ì‹œì—” "ë” ê°•í•œ ì •ì²´ì„±"ì´ë¯€ë¡œ, ì‹¤íŒ¨í•˜ë©´ ì‹¤íŒ¨ë¡œ ëë‚´ëŠ” ê²Œ ë§ìŒ

---

### ğŸ”§ ë¶ˆí•„ìš”í•œ ë³µì¡ë„ ì œê±°

#### A. í…Œì´ë¸” ë¦¬ë„¤ì„ì€ ì„ íƒì‚¬í•­ìœ¼ë¡œ ë¯¸ë£¨ê¸°

**í˜„ì¬**: `guest_order_access_tokens`ì— íšŒì› í† í°ì„ ë„£ëŠ” ì˜ë¯¸ë¡ ì  ëª¨ìˆœ

**GPT ì œì•ˆ**: ë‹¹ì¥ ë¦¬ë„¤ì„ X

**ê¶Œì¥**:
- âœ… **í…Œì´ë¸” ì´ë¦„ ìœ ì§€**: `guest_order_access_tokens` ê·¸ëŒ€ë¡œ ì‚¬ìš©
- âœ… **ì½”ë“œ/ì£¼ì„ ëª…í™•í™”**: ì—­í• ì„ "EMAIL_ORDER_ACCESS_TOKEN"ìœ¼ë¡œ ëª…í™•í™”
- âœ… **ë‚˜ì¤‘ì— ì •ë¦¬**: ì•ˆì •í™” ì´í›„ì— í…Œì´ë¸” ë¦¬ë„¤ì„/ì •ë¦¬

**ì´ìœ **:
- ì§€ê¸ˆ ëª©í‘œê°€ "í†µí•© ì£¼ë¬¸ì„œ í˜ì´ì§€ ëŸ°ì¹­"ì´ë¼ë©´ ë§ˆì´ê·¸ë ˆì´ì…˜ìœ¼ë¡œ ìœ„í—˜ì„ í‚¤ìš°ì§€ ì•ŠëŠ” ê²Œ ë‚«ë‹¤
- ì˜ë¯¸ë¡ ì  ëª¨ìˆœì€ ìˆì§€ë§Œ, ê¸°ëŠ¥ì ìœ¼ë¡œëŠ” ë¬¸ì œ ì—†ìŒ

#### B. ì¿ í‚¤ ì´ë¦„ ë³€ê²½ë„ ì¦‰ì‹œëŠ” ë¹„ì¶”

**í˜„ì¬**: `guest_session_token`
**GPT ì œì•ˆ**: `order_session_token` ë³€ê²½ì€ ëª…ë¶„ì€ ìˆì§€ë§Œ í•˜ìœ„ í˜¸í™˜ ë•Œë¬¸ì— ì´ì¤‘ì§€ì› ì½”ë“œ í•„ìš”

**ê¶Œì¥**:
- âœ… **ì¿ í‚¤ ì´ë¦„ ìœ ì§€**: `guest_session_token` ê·¸ëŒ€ë¡œ ì‚¬ìš©
- âœ… **ìƒˆ í˜ì´ì§€ì—ì„œë„ ë™ì¼ ì¿ í‚¤ ì‚¬ìš©**: `order-detail.html`ì—ì„œë„ `guest_session_token` ì‚¬ìš©
- âœ… **ë‚˜ì¤‘ì— ì •ë¦¬**: "ìƒˆ ì¿ í‚¤ ì¶”ê°€ + êµ¬ ì¿ í‚¤ fallback" í˜•íƒœë¡œ ì ì§„ ë§ˆì´ê·¸ë ˆì´ì…˜

**ì´ìœ **:
- í•˜ìœ„ í˜¸í™˜ ë•Œë¬¸ì— ì–´ì°¨í”¼ ì´ì¤‘ì§€ì› ì½”ë“œë¥¼ ë„£ê²Œ ë¨
- ì§€ê¸ˆì€ ë‹¨ìˆœí•˜ê²Œ ìœ ì§€í•˜ëŠ” ê²Œ ë‚«ë‹¤

---

### ğŸ“Š ìµœì¢… êµ¬í˜„ ê³„íš

#### Phase 1: ì¹˜ëª…ì  ì˜¤ë¥˜ ìˆ˜ì • (ìµœìš°ì„ )

1. **ì„¸ì…˜ êµí™˜ ì—”ë“œí¬ì¸íŠ¸ ìˆ˜ì •** (`GET /api/guest/orders/session` ë˜ëŠ” `/api/orders/session`)
   - `orders.user_id IS NOT NULL` ì°¨ë‹¨ ë¡œì§ ì œê±°
   - `revoked_at IS NOT NULL`ë¡œë§Œ ì°¨ë‹¨

2. **íšŒì› ì£¼ë¬¸ í† í° ë°œê¸‰ ì¶”ê°€** (`processPaidOrder()`)
   - íšŒì› ì£¼ë¬¸(`order.user_id IS NOT NULL`)ì—ë„ `guest_order_access_tokens` ìƒì„±
   - ì—­í• ì„ "ì´ë©”ì¼ ì ‘ê·¼ í† í°"ìœ¼ë¡œ ëª…í™•í™”

#### Phase 2: í†µí•© ì—”ë“œí¬ì¸íŠ¸ ìƒì„±

1. **í†µí•© ì„¸ì…˜ êµí™˜ ì—”ë“œí¬ì¸íŠ¸** (`GET /api/orders/session`)
   - ê¸°ì¡´ `/api/guest/orders/session` ë¡œì§ ì¬ì‚¬ìš©
   - íšŒì›/ë¹„íšŒì› ëª¨ë‘ í—ˆìš©
   - `guest_session_token` ì¿ í‚¤ ì„¤ì •
   - Redirect: `/order-detail.html?order=ORD-...`

2. **í†µí•© ì£¼ë¬¸ ì¡°íšŒ API** (`GET /api/orders/detail`)
   - `optionalAuth` ë¯¸ë“¤ì›¨ì–´ ì‚¬ìš©
   - JWT ìš°ì„  ê²€ì¦ (í´ë°± ì—†ìŒ)
   - ì„¸ì…˜ í† í° ê²€ì¦ (JWT ì—†ì„ ë•Œë§Œ)
   - ìˆ˜í‰ ê¶Œí•œìƒìŠ¹ ë°©ì§€ ë¡œì§ ìœ ì§€

#### Phase 3: í†µí•© í˜ì´ì§€ ìƒì„±

1. **`order-detail.html` ìƒì„±**
   - í—¤ë”/ì‚¬ì´ë“œë°”/í‘¸í„° ì—†ìŒ (ë…ë¦½ í˜ì´ì§€)
   - 7ê°œ ì„¹ì…˜ êµ¬í˜„

2. **`order-detail.js` ìƒì„±**
   - URL íŒŒë¼ë¯¸í„°: `order=ORD-...`
   - API í˜¸ì¶œ: `GET /api/orders/detail?order=...`
   - ì„¸ì…˜ ì¿ í‚¤ ìë™ ì „ì†¡

#### Phase 4: ì´ë©”ì¼ ë§í¬ ì—…ë°ì´íŠ¸

1. **`sendOrderConfirmationEmail` ìˆ˜ì •**
   - íšŒì›/ë¹„íšŒì› ëª¨ë‘ `/api/orders/session?token=xxx` ë§í¬ ì‚¬ìš©
   - ì´ë©”ì¼ í…œí”Œë¦¿ì—ì„œ ë¶„ê¸° ë¡œì§ ì œê±°

2. **`processPaidOrder()` ìˆ˜ì •**
   - íšŒì› ì£¼ë¬¸ì—ë„ í† í° ìƒì„±
   - `guest_access_token` ë°˜í™˜

#### Phase 5: Claim ì •ì±… ì—…ë°ì´íŠ¸

1. **Claim API ìˆ˜ì •** (`POST /api/orders/:orderId/claim`)
   - `guest_order_access_token` íšŒìˆ˜ ë¡œì§ ì œê±°
   - `revoked_at` ì„¤ì •í•˜ì§€ ì•ŠìŒ

2. **UI ì—…ë°ì´íŠ¸**
   - Claim ì™„ë£Œ í›„ "ì´ë¯¸ ë“±ë¡ëœ ì¸ë³´ì´ìŠ¤" ë©”ì‹œì§€ í‘œì‹œ
   - í† í°ì€ ê³„ì† ìœ íš¨í•˜ë¯€ë¡œ ì´ë©”ì¼ ë§í¬ë¡œ ì¬ì ‘ê·¼ ê°€ëŠ¥

---

### âš ï¸ ì£¼ì˜ ì‚¬í•­

1. **í•˜ìœ„ í˜¸í™˜ì„±**: ê¸°ì¡´ `guest/orders.html`ê³¼ `GET /api/guest/orders/:orderNumber`ëŠ” ìœ ì§€
2. **ì ì§„ì  ë§ˆì´ê·¸ë ˆì´ì…˜**: ìƒˆ ê¸°ëŠ¥ ì¶”ê°€ í›„ ê¸°ì¡´ ê¸°ëŠ¥ì€ ë‹¨ê³„ì ìœ¼ë¡œ deprecated
3. **í…Œì´ë¸” ì´ë¦„**: ì˜ë¯¸ë¡ ì  ì •í™•ì„±ì„ ìœ„í•´ ë‚˜ì¤‘ì— `order_access_tokens`ë¡œ ë³€ê²½ ê°€ëŠ¥ (ì„ íƒì‚¬í•­)
4. **ì¿ í‚¤ ì´ë¦„**: ë‚˜ì¤‘ì— `order_session_token`ìœ¼ë¡œ ë³€ê²½ ê°€ëŠ¥ (ì„ íƒì‚¬í•­)
5. **ë ˆê±°ì‹œ ì—”ë“œí¬ì¸íŠ¸ ì •ì±… (ì¤‘ìš”)**:
   - **Claim ì´í›„ ì´ë©”ì¼ ë§í¬ ì¡°íšŒëŠ” `/api/orders/session` â†’ `/order-detail.html` â†’ `/api/orders/detail`ë¡œë§Œ ë³´ì¥í•œë‹¤**
   - **ë ˆê±°ì‹œ `/api/guest/orders/:orderNumber`ëŠ” Claim ì´í›„ ì°¨ë‹¨ë  ìˆ˜ ìˆìœ¼ë©°, ì´ëŠ” ì˜ë„ëœ í•˜ìœ„í˜¸í™˜ ì •ì±…ì´ë‹¤ (Aì•ˆ)**
   - ì˜ë¯¸: "ìƒˆ íë¦„ì´ ì •ë‹µ, ë ˆê±°ì‹œëŠ” ì˜› ì •ì±… ìœ ì§€(í•˜ìœ„í˜¸í™˜)"

---

### âœ… ìµœì¢… í‰ê°€

**GPT ì œì•ˆì˜ ê°€ì¹˜**: â­â­â­â­â­ (5/5)
- ì´ë©”ì¼ ë§í¬ í†µì¼: ë§¤ìš° ì¢‹ìŒ âœ…
- ë‹¨ì¼ í˜ì´ì§€ êµ¬ì¡°: ìš”êµ¬ì‚¬í•­ê³¼ ì¼ì¹˜ âœ…
- ë³´ì•ˆì„±: ì´ë¯¸ êµ¬í˜„ë¨ âœ…
- ì¹˜ëª…ì  ì˜¤ë¥˜ ë°œê²¬: ë§¤ìš° ì¤‘ìš” âœ…
- ì •ì±… ëª…í™•í™”: êµ¬í˜„ ì•ˆì •ì„± í–¥ìƒ âœ…

**ê¶Œì¥**: GPT ì œì•ˆì„ **ì „ë©´ ìˆ˜ìš©**í•˜ë˜, ìœ„ì˜ 6ê°€ì§€ í•µì‹¬ ê·œì¹™ì„ ë°˜ë“œì‹œ ì¤€ìˆ˜í•˜ì—¬ êµ¬í˜„

---

## ğŸ“ ë‹¤ìŒ ë‹¨ê³„

1. **ì¦‰ì‹œ ìˆ˜ì •**: `GET /api/guest/orders/session`ì—ì„œ `orders.user_id IS NOT NULL` ì°¨ë‹¨ ë¡œì§ ì œê±°
2. **Phase 1ë¶€í„° ìˆœì°¨ì ìœ¼ë¡œ êµ¬í˜„**
3. **5ê°€ì§€ í•µì‹¬ ê·œì¹™ ì¤€ìˆ˜** (ê·œì¹™ 4ì™€ 5 í†µí•©)
4. **Phase 1 í•„ìˆ˜ ì²´í¬ë¦¬ìŠ¤íŠ¸ 5ê°€ì§€ ë°˜ì˜**

---

## ğŸ¯ ìµœì¢… ì •ì±… ëª…í™•í™” (ìš´ì˜ê¸‰ ì™„ì„±)

### 1. í†µí•© ì£¼ë¬¸ ì¡°íšŒ API ì¸ì¦ ê·œì¹™ (ëª…í™•í™”)

**ë¬¸ì„œ ëª…ì‹œ**:
- `/api/orders/detail`ì€ "ë‘ ì¸ì¦ ë°©ì‹ ì¤‘ í•˜ë‚˜"ë¥¼ ì§€ì›í•œë‹¤
- **ë‹¨, ìš”ì²­ì— `accessToken` ì¿ í‚¤(JWT)ê°€ ì¡´ì¬í•˜ë©´**:
  - JWT ê²€ì¦ ì„±ê³µ + ì£¼ë¬¸ ê¶Œí•œ OK â†’ í†µê³¼
  - JWT ê²€ì¦ ì„±ê³µì¸ë° ì£¼ë¬¸ ê¶Œí•œ ì—†ìŒ â†’ 401/403 (ì„¸ì…˜ ì¿ í‚¤ê°€ ìˆì–´ë„ ë¬´ì‹œ)
  - JWT ê²€ì¦ ì‹¤íŒ¨ â†’ 401 (ì„¸ì…˜ ì¿ í‚¤ ë¬´ì‹œ)
- **ìš”ì²­ì— JWT ì¿ í‚¤ê°€ ì—†ì„ ë•Œë§Œ** ì„¸ì…˜ ê¸°ë°˜ ì¸ì¦ì„ í—ˆìš©í•œë‹¤

**ì´ìœ **: ì´ ë¬¸ì¥ì´ ì—†ìœ¼ë©´, ê°œë°œìê°€ ë‚˜ì¤‘ì— "ë‘˜ ë‹¤ ìˆìœ¼ë©´ ì„¸ì…˜ìœ¼ë¡œë„ ë˜ê²Œ" ê°™ì€ ìˆ˜ì •ì„ ì‰½ê²Œ í•´ë²„ë¦°ë‹¤.

### 2. ì„¸ì…˜ êµí™˜ ì°¨ë‹¨ ì¡°ê±´ (3ì¢… ì°¨ë‹¨)

**ë¬¸ì„œ ìš©ì–´ ê³ ì •**:
- ì„¸ì…˜ êµí™˜ ì°¨ë‹¨ ì¡°ê±´ì€ í•­ìƒ **3ì¢…**:
  1. token not found (í† í° ì—†ìŒ)
  2. `expires_at < NOW()` (ë§Œë£Œ)
  3. `revoked_at IS NOT NULL` (íšŒìˆ˜)
- `user_id` ì¡´ì¬ ì—¬ë¶€ëŠ” ì°¨ë‹¨ ì¡°ê±´ì—ì„œ ì œì™¸

**ì´ìœ **: "revoked_atë§Œ ì°¨ë‹¨"ì´ë¼ê³  ì¨ë‘ë©´, ë‚˜ì¤‘ì— ëˆ„êµ°ê°€ refactor í•˜ë‹¤ê°€ expires ì²´í¬ë¥¼ ë¹¼ë²„ë ¤ë„ ë¬¸ì„œê°€ ì˜¤íˆë ¤ ë©´ì£„ë¶€ê°€ ëœë‹¤.

### 3. Claim ë©±ë“± ë¡œì§ (ê²½í•© ì•ˆì „ íŒ¨í„´)

**ê¶Œì¥ íŒ¨í„´**:
- **UPDATE ë¨¼ì € ì‹œë„** (`WHERE user_id IS NULL`)
- `affectedRows === 1` â†’ ì„±ê³µ
- `affectedRows === 0` â†’ ê·¸ë•Œ SELECTë¡œ í˜„ì¬ `user_id`ë¥¼ ë‹¤ì‹œ ì½ê³ 
  - ê°™ìœ¼ë©´ 200 (already_claimed: true)
  - ë‹¤ë¥´ë©´ 409

**ì´ìœ **: orderë¥¼ ë¨¼ì € SELECT í•´ë†“ê³  `updateResult.affectedRows === 0`ì¼ ë•Œ ê·¸ `order.user_id`ë¥¼ ë¹„êµí•˜ë©´, ê·¸ orderëŠ” "ì—…ë°ì´íŠ¸ ì´ì „ ìƒíƒœ"ì¼ ìˆ˜ ìˆë‹¤.

### 4. íšŒì› ì£¼ë¬¸ í† í° ë°œê¸‰ ì •ì±… (ë ˆì´ìŠ¤ ì•ˆì „)

**ì •ì±… ë³€ê²½**: "ì£¼ë¬¸ë‹¹ ìœ íš¨ í† í° 1ê°œ" â†’ **"ì£¼ë¬¸ë‹¹ ëŒ€í‘œ í† í° 1ê°œ(ìµœì‹  í† í°)"**

**Aì•ˆ (ê¶Œì¥)**:
- ì—¬ëŸ¬ ê°œê°€ ìƒê¸¸ ìˆ˜ëŠ” ìˆìœ¼ë‚˜, í•­ìƒ ìµœì‹  1ê°œë§Œ ì‚¬ìš©
- ì¡°íšŒëŠ” `ORDER BY created_at DESC LIMIT 1`ë¡œ í†µì¼
- ì´ë©”ì¼ ë°œì†¡ë„ "ì„ íƒëœ í† í°"ë§Œ ì‚¬ìš©
- ì¥ì : êµ¬í˜„ ë‹¨ìˆœ, ë§ˆì´ê·¸ë ˆì´ì…˜ ì—†ìŒ
- ë‹¨ì : DBì— í† í°ì´ ëˆ„ì ë  ìˆ˜ ìˆìŒ (í•˜ì§€ë§Œ `expires_at`ìœ¼ë¡œ ìì—° ì†Œë©¸ + ìš´ì˜ìƒ í° ë¬¸ì œëŠ” ì ìŒ)

**Bì•ˆ (ì°¸ê³ )**:
- ì •ë§ '1ê°œ'ë§Œ ê°•ì œ (ìŠ¤í‚¤ë§ˆ ë³€ê²½ í•„ìš”)
- ì¥ì : ì •ì±…ì„ DBê°€ ê°•ì œ
- ë‹¨ì : ë§ˆì´ê·¸ë ˆì´ì…˜/ë³µì¡ë„ ì¦ê°€

**í˜„ì¬ ë¬¸ì„œ íë¦„("ë§ˆì´ê·¸ë ˆì´ì…˜ ìµœì†Œí™”")ì—ì„  Aì•ˆì´ ë” ì¼ì¹˜í•œë‹¤.**

---

### âœ… ìµœì¢… í‰ê°€

**GPT ì¶”ê°€ í”¼ë“œë°±ì˜ ê°€ì¹˜**: â­â­â­â­â­ (5/5)
- í‘œí˜„ ëª¨ìˆœ í•´ê²°: ë§¤ìš° ì¤‘ìš” âœ…
- ê²½í•© ì•ˆì „ íŒ¨í„´: ì‹¤ì œ ìš´ì˜ í•„ìˆ˜ âœ…
- ë ˆì´ìŠ¤ ì¡°ê±´ ëŒ€ë¹„: ìš´ì˜ ì•ˆì •ì„± í–¥ìƒ âœ…
- ë¬¸ì„œ ìš©ì–´ ê³ ì •: êµ¬í˜„ ì¼ê´€ì„± ë³´ì¥ âœ…

**ê¶Œì¥**: ìœ„ì˜ 4ê°€ì§€ ì •ì±… ëª…í™•í™”ë¥¼ **ë°˜ë“œì‹œ ë°˜ì˜**í•œ í›„ Phase 1ë¶€í„° ì§„í–‰

---

## ğŸ”§ GPT ì¶”ê°€ í”¼ë“œë°± ë¶„ì„ ë° êµ¬í˜„ ë³´ì™„ ì‚¬í•­

### GPT ì¶”ê°€ í”¼ë“œë°± ìš”ì•½

GPTëŠ” êµ¬í˜„ ì „ì— ë°˜ë“œì‹œ í™•ì¸í•´ì•¼ í•  5ê°€ì§€ ë³´ì™„ ì‚¬í•­ì„ ì œì‹œí–ˆìŠµë‹ˆë‹¤:

1. **ì„¸ì…˜ êµí™˜ ì°¨ë‹¨ ì¡°ê±´ ë³´ì™„**: ì°¨ë‹¨ ì¡°ê±´ì€ í•­ìƒ **3ì¢… ì°¨ë‹¨** (token ì—†ìŒ / expires_at ë§Œë£Œ / revoked_at íšŒìˆ˜)
2. **Claim API ë©±ë“±ì„± ê°•í™”**: í† í° íšŒìˆ˜ ì•ˆ í•˜ë©´ ì¬ì ‘ê·¼ ê°€ëŠ¥í•˜ë¯€ë¡œ ë©±ë“±ì„± ë³´ì¥ í•„ìˆ˜
3. **optionalAuth êµ¬í˜„ ìˆ˜ì •**: JWT ì¿ í‚¤ ì¡´ì¬ + ê²€ì¦ ì‹¤íŒ¨ ì‹œ ì¦‰ì‹œ 401 (í´ë°± ê¸ˆì§€)
4. **ì—”ë“œí¬ì¸íŠ¸ í†µí•© ë°©ì‹**: í•˜ìœ„ í˜¸í™˜ì„ ìœ„í•´ ë‘ ì—”ë“œí¬ì¸íŠ¸ ëª¨ë‘ ìœ ì§€í•˜ë˜ ë‚´ë¶€ ë¡œì§ ì¬ì‚¬ìš©
5. **íšŒì› ì£¼ë¬¸ í† í° ë°œê¸‰ ì •ì±…**: ì£¼ë¬¸ë‹¹ ìœ íš¨ í† í° 1ê°œ ì¬ì‚¬ìš© ì •ì±…

---

### âš ï¸ ë°œê²¬ëœ êµ¬í˜„ ëˆ„ë½ ì‚¬í•­

#### 1. ì„¸ì…˜ êµí™˜ ì°¨ë‹¨ ì¡°ê±´ ë¶ˆì™„ì „

**í˜„ì¬ ë¬¸ì„œ**: "ì°¨ë‹¨ ì¡°ê±´ì€ 3ì¢… ì°¨ë‹¨"

**GPT ì§€ì **: `expires_at` ì²´í¬ë„ í•„ìˆ˜

**í˜„ì¬ ì½”ë“œ í™•ì¸** (`backend/order-routes.js` 1440-1458ì¤„):
```javascript
// 2. expires_at í™•ì¸ âœ… (ì´ë¯¸ ìˆìŒ)
if (new Date(tokenData.expires_at) < new Date()) {
    return res.status(410).json({ ... });
}

// 3. revoked_at í™•ì¸ âœ… (ì´ë¯¸ ìˆìŒ)
if (tokenData.revoked_at !== null) {
    return res.status(410).json({ ... });
}

// 4. orders.user_id IS NULL í™•ì¸ âŒ (ì œê±° í•„ìš”)
if (tokenData.user_id !== null) {
    return res.status(410).json({ ... });
}
```

**ë³´ì™„ ì‚¬í•­**:
- âœ… `expires_at` ì²´í¬ëŠ” ì´ë¯¸ êµ¬í˜„ë˜ì–´ ìˆìŒ
- âŒ `orders.user_id IS NOT NULL` ì°¨ë‹¨ ë¡œì§ë§Œ ì œê±°í•˜ë©´ ë¨
- **ì°¨ë‹¨ ì¡°ê±´ì€ í•­ìƒ 3ì¢… ì°¨ë‹¨**:
  1. token not found (í† í° ì—†ìŒ)
  2. `expires_at < NOW()` (ë§Œë£Œ)
  3. `revoked_at IS NOT NULL` (íšŒìˆ˜)
- **ì°¨ë‹¨ ì¡°ê±´ì—ì„œ ì œì™¸**: `user_id` ì¡´ì¬ ì—¬ë¶€ëŠ” ì°¨ë‹¨ ì¡°ê±´ì—ì„œ ì œì™¸

#### 2. optionalAuth êµ¬í˜„ ë¬¸ì œ

**í˜„ì¬ ì½”ë“œ** (`backend/auth-middleware.js` 94-121ì¤„):
```javascript
function optionalAuth(req, res, next) {
    const token = req.cookies?.accessToken;
    
    if (!token) {
        req.user = null;
        req.authType = 'anonymous';
        return next();
    }

    try {
        const decoded = jwt.verify(token, process.env.JWT_SECRET);
        req.user = { ... };
        req.authType = 'user';
    } catch (error) {
        // âš ï¸ ë¬¸ì œ: í† í°ì´ ìœ íš¨í•˜ì§€ ì•Šì•„ë„ ì—ëŸ¬ ì—†ì´ ì§„í–‰
        req.user = null;
        req.authType = 'anonymous';
    }
    
    next();
}
```

**GPT ì§€ì **: JWT ì¿ í‚¤ê°€ ìˆìœ¼ë©´ ê²€ì¦ ì‹¤íŒ¨ ì‹œ ì¦‰ì‹œ 401 ë°˜í™˜í•´ì•¼ í•¨ (ì„¸ì…˜ í´ë°± ê¸ˆì§€)

**ë¬¸ì œì **:
- í˜„ì¬ëŠ” JWT ê²€ì¦ ì‹¤íŒ¨ ì‹œ `req.user = null`ë¡œ ì„¤ì •í•˜ê³  í†µê³¼
- ì´ë ‡ê²Œ ë˜ë©´ ì„¸ì…˜ ì¿ í‚¤ë¡œ í´ë°±ë˜ì–´ "JWT ìš°ì„  + í´ë°± ì—†ìŒ" ì •ì±… ìœ„ë°˜

**ìˆ˜ì • ë°©ì•ˆ**:
```javascript
function optionalAuth(req, res, next) {
    const token = req.cookies?.accessToken;
    
    if (!token) {
        // í† í° ì—†ìŒ - ì„¸ì…˜ ê²½ë¡œ ê°€ëŠ¥
        req.user = null;
        req.authType = 'anonymous';
        return next();
    }

    try {
        const decoded = jwt.verify(token, process.env.JWT_SECRET);
        req.user = {
            userId: decoded.userId,
            email: decoded.email,
            name: decoded.name
        };
        req.authType = 'user';
        return next();
    } catch (error) {
        // âš ï¸ ìˆ˜ì •: JWT ì¿ í‚¤ê°€ ìˆìœ¼ë©´ ê²€ì¦ ì‹¤íŒ¨ ì‹œ ì¦‰ì‹œ 401
        return res.status(401).json({
            success: false,
            message: 'ì¸ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.',
            code: 'AUTH_FAILED'
        });
    }
}
```

#### 3. Claim API ë©±ë“±ì„± ë¶€ì¡±

**í˜„ì¬ ì½”ë“œ** (`backend/order-routes.js` 1149-1156ì¤„):
```javascript
// ì´ë¯¸ íšŒì› ê³„ì •ì— ì—°ë™ëœ ì£¼ë¬¸ì¸ì§€ í™•ì¸
if (order.user_id !== null) {
    await connection.rollback();
    await connection.end();
    return res.status(400).json({
        success: false,
        message: 'ì´ë¯¸ íšŒì› ê³„ì •ì— ì—°ë™ëœ ì£¼ë¬¸ì…ë‹ˆë‹¤.'
    });
}
```

**GPT ì§€ì **: 
- ê°™ì€ ì‚¬ìš©ìê°€ ì¬ìš”ì²­í•˜ë©´ "ì´ë¯¸ ì—°ê²°ë¨"ìœ¼ë¡œ 200 OK (ë©±ë“±)
- ë‹¤ë¥¸ ì‚¬ìš©ìê°€ ìš”ì²­í•˜ë©´ 409/403ìœ¼ë¡œ "ë‹¤ë¥¸ ê³„ì •ì— ì—°ê²°ë¨"
- DB ë ˆë²¨ì—ì„œ `UPDATE ... WHERE user_id IS NULL`ë¡œ ê²½í•© ë°©ì§€

**í˜„ì¬ ë¬¸ì œì **:
- `order.user_id !== null`ì´ë©´ ë¬´ì¡°ê±´ 400 ë°˜í™˜
- ê°™ì€ ì‚¬ìš©ì/ë‹¤ë¥¸ ì‚¬ìš©ì êµ¬ë¶„ ì—†ìŒ
- `UPDATE ... WHERE user_id IS NULL` íŒ¨í„´ ì‚¬ìš© ì•ˆ í•¨

**ìˆ˜ì • ë°©ì•ˆ (ê¶Œì¥ íŒ¨í„´ - ê²½í•© ì•ˆì „)**:
```javascript
// âš ï¸ ì¤‘ìš”: UPDATEë¥¼ ë¨¼ì € ì‹œë„ (SELECT ë¨¼ì € í•˜ë©´ stale ìƒíƒœ ê°€ëŠ¥)
// 1. DB ë ˆë²¨ì—ì„œ ì›ìì  ì—…ë°ì´íŠ¸ (ê²½í•© ë°©ì§€)
const [updateResult] = await connection.execute(
    `UPDATE orders 
     SET user_id = ? 
     WHERE order_id = ? 
       AND user_id IS NULL`,
    [userId, orderId]
);

if (updateResult.affectedRows === 1) {
    // âœ… Claim ì„±ê³µ
    // ì´í›„ warranties ì—…ë°ì´íŠ¸ ë“± ê³„ì† ì§„í–‰
} else if (updateResult.affectedRows === 0) {
    // ì´ë¯¸ ì—°ê²°ëœ ì£¼ë¬¸
    // 2. affectedRows === 0ì¼ ë•Œë§Œ í˜„ì¬ ìƒíƒœë¥¼ ë‹¤ì‹œ ì½ì–´ì„œ í™•ì¸
    const [currentOrder] = await connection.execute(
        'SELECT user_id FROM orders WHERE order_id = ?',
        [orderId]
    );
    
    if (currentOrder.length === 0) {
        // ì£¼ë¬¸ì´ ì—†ìŒ (ì´ìƒ ì¼€ì´ìŠ¤)
        await connection.rollback();
        await connection.end();
        return res.status(404).json({ ... });
    }
    
    if (currentOrder[0].user_id === userId) {
        // ë©±ë“±: ê°™ì€ ì‚¬ìš©ìê°€ ì¬ìš”ì²­
        await connection.rollback();
        await connection.end();
        return res.json({
            success: true,
            message: 'ì´ë¯¸ ì—°ê²°ëœ ì£¼ë¬¸ì…ë‹ˆë‹¤.',
            already_claimed: true
        });
    } else {
        // ë‹¤ë¥¸ ì‚¬ìš©ìê°€ ìš”ì²­
        await connection.rollback();
        await connection.end();
        return res.status(409).json({
            success: false,
            message: 'ì´ ì£¼ë¬¸ì€ ë‹¤ë¥¸ ê³„ì •ì— ì—°ê²°ë˜ì–´ ìˆìŠµë‹ˆë‹¤.',
            code: 'ALREADY_CLAIMED_BY_OTHER'
        });
    }
}
```

#### 4. ì—”ë“œí¬ì¸íŠ¸ í†µí•© ë°©ì‹

**í˜„ì¬ ë¬¸ì„œ**: "í†µí•© ì„¸ì…˜ êµí™˜ ì—”ë“œí¬ì¸íŠ¸ ìƒì„±"

**GPT ì œì•ˆ**: í•˜ìœ„ í˜¸í™˜ì„ ìœ„í•´ ë‘ ì—”ë“œí¬ì¸íŠ¸ ëª¨ë‘ ìœ ì§€í•˜ë˜ ë‚´ë¶€ ë¡œì§ ì¬ì‚¬ìš©

**ê¶Œì¥ ë°©ì‹**:
```javascript
// ë‚´ë¶€ í•¨ìˆ˜ë¡œ ë¡œì§ ë¶„ë¦¬
async function handleOrderSessionExchange(req, res) {
    // ì„¸ì…˜ êµí™˜ ë¡œì§ (ê¸°ì¡´ /api/guest/orders/session ë¡œì§)
    // ...
    res.redirect(302, `/order-detail.html?order=${encodeURIComponent(orderNumber)}`);
}

// ê¸°ì¡´ ì—”ë“œí¬ì¸íŠ¸ (í•˜ìœ„ í˜¸í™˜)
router.get('/guest/orders/session', handleOrderSessionExchange);

// ì‹ ê·œ í†µí•© ì—”ë“œí¬ì¸íŠ¸
router.get('/orders/session', handleOrderSessionExchange);
```

**ì´ìœ **:
- ê¸°ì¡´ ì´ë©”ì¼ ë§í¬ê°€ `/api/guest/orders/session`ì„ ì‚¬ìš© ì¤‘ì¼ ìˆ˜ ìˆìŒ
- ë¦¬ë‹¤ì´ë ‰íŠ¸ëŠ” í† í°ì´ URLì— ìˆì–´ ë¡œê·¸/ë¶„ì„ ë„êµ¬ì— ë‚¨ì„ ìˆ˜ ìˆìŒ
- ë‚´ë¶€ í•¨ìˆ˜ ì¬ì‚¬ìš©ì´ ê°€ì¥ ì•ˆì „

#### 5. íšŒì› ì£¼ë¬¸ í† í° ë°œê¸‰ ì •ì±…

**í˜„ì¬ ì½”ë“œ** (`backend/utils/paid-order-processor.js` 605ì¤„):
```javascript
if (order.guest_id && !order.user_id) {
    // ë¹„íšŒì›ë§Œ í† í° ìƒì„±
    // ...
}
```

**GPT ì§€ì **: íšŒì› ì£¼ë¬¸ì—ë„ í† í° ë°œê¸‰í•˜ë˜, "ì£¼ë¬¸ë‹¹ ìœ íš¨ í† í° 1ê°œ" ì •ì±… í•„ìš”

**ë¬¸ì œì **:
- ê²°ì œ confirm/webhookì´ ì¤‘ë³µ í˜¸ì¶œë  ìˆ˜ ìˆì–´ í† í°ì´ ì—¬ëŸ¬ ê°œ ìƒì„±ë  ìˆ˜ ìˆìŒ
- ì–´ë–¤ í† í°ì„ ì´ë©”ì¼ì— ë„£ì—ˆëŠ”ì§€ ì¶”ì  ì–´ë ¤ì›€

**ìˆ˜ì • ë°©ì•ˆ (Aì•ˆ ê¶Œì¥ - ë ˆì´ìŠ¤ ì•ˆì „)**:

**ì •ì±… ë³€ê²½**: "ì£¼ë¬¸ë‹¹ ìœ íš¨ í† í° 1ê°œ" â†’ **"ì£¼ë¬¸ë‹¹ ëŒ€í‘œ í† í° 1ê°œ(ìµœì‹  í† í°)"**

**ì´ìœ **: 
- ì¤‘ë³µ ê²°ì œ confirm/webhookì—ì„œ ë™ì‹œ ìš”ì²­ ì‹œ ë ˆì´ìŠ¤ ì¡°ê±´ ë°œìƒ ê°€ëŠ¥
- ì—¬ëŸ¬ í† í°ì´ ìƒì„±ë  ìˆ˜ ìˆìœ¼ë‚˜, í•­ìƒ ìµœì‹  1ê°œë§Œ ì‚¬ìš©í•˜ëŠ” ì •ì±…ìœ¼ë¡œ ìì—°ìŠ¤ëŸ½ê²Œ í¡ìˆ˜

**êµ¬í˜„**:
```javascript
// íšŒì›/ë¹„íšŒì› ëª¨ë‘ í† í° ë°œê¸‰
let guestAccessToken = null;

try {
    // 1. ê¸°ì¡´ ìœ íš¨ í† í° í™•ì¸ (ë§Œë£Œ ì „, revoked ì•„ë‹˜) - ìµœì‹  ê²ƒë§Œ ì„ íƒ
    const [existingTokens] = await connection.execute(
        `SELECT token 
         FROM guest_order_access_tokens 
         WHERE order_id = ? 
           AND expires_at > NOW() 
           AND revoked_at IS NULL 
         ORDER BY created_at DESC 
         LIMIT 1`,
        [orderId]
    );

    if (existingTokens.length > 0) {
        // ê¸°ì¡´ ìµœì‹  í† í° ì¬ì‚¬ìš©
        guestAccessToken = existingTokens[0].token;
        Logger.log('[PAID_PROCESSOR] ê¸°ì¡´ í† í° ì¬ì‚¬ìš©', {
            orderId,
            tokenPrefix: guestAccessToken.substring(0, 8) + '...'
        });
    } else {
        // ìƒˆ í† í° ìƒì„±
        // âš ï¸ ë ˆì´ìŠ¤ ì¡°ê±´: ë™ì‹œ ìš”ì²­ ì‹œ ì—¬ëŸ¬ í† í°ì´ ìƒì„±ë  ìˆ˜ ìˆìœ¼ë‚˜,
        // ë‹¤ìŒ ì¡°íšŒ ì‹œ ORDER BY created_at DESC LIMIT 1ë¡œ ìµœì‹  ê²ƒë§Œ ì‚¬ìš©
        const accessToken = crypto.randomBytes(32).toString('hex');
        const expiresAt = new Date(Date.now() + 90 * 24 * 60 * 60 * 1000);

        await connection.execute(
            `INSERT INTO guest_order_access_tokens 
             (order_id, token, expires_at) 
             VALUES (?, ?, ?)`,
            [orderId, accessToken, expiresAt]
        );

        guestAccessToken = accessToken;
        Logger.log('[PAID_PROCESSOR] ìƒˆ í† í° ìƒì„±', {
            orderId,
            tokenPrefix: accessToken.substring(0, 8) + '...'
        });
    }
    
    // 2. ì´ë©”ì¼ ë°œì†¡ ì§ì „ì— í•­ìƒ "ëŒ€í‘œ í† í°(ìµœì‹ )"ì„ ë‹¤ì‹œ ì¡°íšŒí•´ì„œ ê·¸ í† í°ìœ¼ë¡œ ë°œì†¡
    // âš ï¸ ì¤‘ìš”: ìƒì„±/ì¬ì‚¬ìš© íŒë‹¨ ë¡œì§ê³¼ "ì´ë©”ì¼ì— ë„£ëŠ” í† í° ì„ íƒ"ì„ ë¶„ë¦¬
    // ë ˆì´ìŠ¤ ì¡°ê±´ ëŒ€ë¹„: ì´ë©”ì¼ì€ í•­ìƒ ìµœì¢… SELECT ê²°ê³¼ 1ê°œë§Œ ì‚¬ìš©
    const [finalToken] = await connection.execute(
        `SELECT token 
         FROM guest_order_access_tokens 
         WHERE order_id = ? 
           AND expires_at > NOW() 
           AND revoked_at IS NULL 
         ORDER BY created_at DESC 
         LIMIT 1`,
        [orderId]
    );
    
    if (finalToken.length > 0) {
        guestAccessToken = finalToken[0].token; // ì´ë©”ì¼ ë°œì†¡ìš© ìµœì¢… í† í°
        Logger.log('[PAID_PROCESSOR] ì´ë©”ì¼ ë°œì†¡ìš© ìµœì‹  í† í° ì„ ì •', {
            orderId,
            tokenPrefix: guestAccessToken.substring(0, 8) + '...'
        });
    }
    
} catch (error) {
    // í† í° ìƒì„± ì‹¤íŒ¨ëŠ” ë¡œê¹…ë§Œ (ê²°ì œ ì„±ê³µì€ ìœ ì§€)
    Logger.error('[PAID_PROCESSOR] í† í° ì²˜ë¦¬ ì‹¤íŒ¨ (ê²°ì œëŠ” ì„±ê³µ)', {
        orderId,
        error: error.message
    });
}
```

**Aì•ˆì˜ ì¥ì **:
- âœ… êµ¬í˜„ ë‹¨ìˆœ, ë§ˆì´ê·¸ë ˆì´ì…˜ ì—†ìŒ
- âœ… ë ˆì´ìŠ¤ ì¡°ê±´ì„ ìì—°ìŠ¤ëŸ½ê²Œ í¡ìˆ˜
- âœ… DBì— í† í°ì´ ëˆ„ì ë  ìˆ˜ ìˆìœ¼ë‚˜ `expires_at`ìœ¼ë¡œ ìì—° ì†Œë©¸
- âœ… ìš´ì˜ìƒ í° ë¬¸ì œ ì—†ìŒ

**Bì•ˆ (ì •ë§ '1ê°œ'ë§Œ ê°•ì œ) - ì°¸ê³ ìš©**:
- ìŠ¤í‚¤ë§ˆ ë³€ê²½ í•„ìš” (active í”Œë˜ê·¸ ë˜ëŠ” ë³„ë„ current_token ì»¬ëŸ¼)
- DBê°€ ì •ì±…ì„ ê°•ì œí•˜ì§€ë§Œ ë§ˆì´ê·¸ë ˆì´ì…˜/ë³µì¡ë„ ì¦ê°€
- í˜„ì¬ ë¬¸ì„œ íë¦„("ë§ˆì´ê·¸ë ˆì´ì…˜ ìµœì†Œí™”")ê³¼ ë¶ˆì¼ì¹˜

---

### ğŸ“‹ Phase 1 í•„ìˆ˜ ì²´í¬ë¦¬ìŠ¤íŠ¸ (GPT ì œì•ˆ)

êµ¬í˜„ ì „ì— ë°˜ë“œì‹œ í™•ì¸í•´ì•¼ í•  5ê°€ì§€:

#### âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸ 1: ì„¸ì…˜ êµí™˜ ì°¨ë‹¨ ì¡°ê±´ (3ì¢… ì°¨ë‹¨)
- [ ] `orders.user_id IS NOT NULL` ì°¨ë‹¨ ë¡œì§ ì œê±°
- [ ] ì°¨ë‹¨ ì¡°ê±´ (3ì¢…):
  1. token not found (í† í° ì—†ìŒ)
  2. `expires_at < NOW()` (ë§Œë£Œ)
  3. `revoked_at IS NOT NULL` (íšŒìˆ˜)
- [ ] `user_id` ì¡´ì¬ ì—¬ë¶€ëŠ” ì°¨ë‹¨ ì¡°ê±´ì—ì„œ ì œì™¸

#### âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸ 2: optionalAuth êµ¬í˜„ ìˆ˜ì •
- [ ] JWT ì¿ í‚¤ê°€ ìˆìœ¼ë©´ ê²€ì¦ ì‹¤íŒ¨ ì‹œ ì¦‰ì‹œ 401 ë°˜í™˜
- [ ] ì„¸ì…˜ìœ¼ë¡œ í´ë°±í•˜ì§€ ì•ŠìŒ

#### âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸ 3: Claim API ë©±ë“±ì„± (ê²½í•© ì•ˆì „)
- [ ] `UPDATE orders SET user_id=? WHERE order_id=? AND user_id IS NULL` íŒ¨í„´ ì‚¬ìš©
- [ ] **UPDATE ë¨¼ì € ì‹œë„** (SELECT ë¨¼ì € í•˜ë©´ stale ìƒíƒœ ê°€ëŠ¥)
- [ ] `affectedRows === 0`ì¼ ë•Œë§Œ SELECTë¡œ í˜„ì¬ ìƒíƒœ ì¬í™•ì¸
- [ ] ê°™ì€ ì‚¬ìš©ì: 200 OK (ë©±ë“±)
- [ ] ë‹¤ë¥¸ ì‚¬ìš©ì: 409 Conflict

#### âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸ 4: ì—”ë“œí¬ì¸íŠ¸ í†µí•©
- [ ] `/api/guest/orders/session` ìœ ì§€ (í•˜ìœ„ í˜¸í™˜)
- [ ] `/api/orders/session` ì‹ ê·œ ìƒì„±
- [ ] ë‚´ë¶€ í•¨ìˆ˜ë¡œ ë¡œì§ ì¬ì‚¬ìš©

#### âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸ 5: íšŒì› ì£¼ë¬¸ í† í° ë°œê¸‰ (ë ˆì´ìŠ¤ ì•ˆì „)
- [ ] íšŒì› ì£¼ë¬¸ì—ë„ í† í° ìƒì„±
- [ ] **ì •ì±…**: "ì£¼ë¬¸ë‹¹ ëŒ€í‘œ í† í° 1ê°œ(ìµœì‹  í† í°)" (Aì•ˆ ê¶Œì¥)
- [ ] ê¸°ì¡´ ìœ íš¨ í† í° ìˆìœ¼ë©´ ì¬ì‚¬ìš©, ì—†ìœ¼ë©´ ìƒì„±
- [ ] ì¡°íšŒëŠ” í•­ìƒ `ORDER BY created_at DESC LIMIT 1`ë¡œ ìµœì‹  í† í°ë§Œ ì‚¬ìš©
- [ ] **ì´ë©”ì¼ ë°œì†¡ ì§ì „ì— í•­ìƒ ìµœì‹  í† í° ì¬ì¡°íšŒ** (ìƒì„±/ì¬ì‚¬ìš© ë¡œì§ê³¼ ë¶„ë¦¬)
- [ ] ì´ë©”ì¼ì€ í•­ìƒ ìµœì¢… SELECT ê²°ê³¼ 1ê°œë§Œ ì‚¬ìš©

---

### ğŸ¯ ìµœì¢… êµ¬í˜„ ê³„íš (ë³´ì™„ ë°˜ì˜)

#### Phase 1: ì¹˜ëª…ì  ì˜¤ë¥˜ ìˆ˜ì • ë° ë³´ì™„ (ìµœìš°ì„ )

1. **ì„¸ì…˜ êµí™˜ ì—”ë“œí¬ì¸íŠ¸ ìˆ˜ì •** (`GET /api/guest/orders/session`)
   - âœ… `orders.user_id IS NOT NULL` ì°¨ë‹¨ ë¡œì§ ì œê±°
   - âœ… ì°¨ë‹¨ ì¡°ê±´: **3ì¢… ì°¨ë‹¨** (token ì—†ìŒ / expires_at ë§Œë£Œ / revoked_at íšŒìˆ˜)

2. **optionalAuth ë¯¸ë“¤ì›¨ì–´ ìˆ˜ì •** (`backend/auth-middleware.js`)
   - âœ… JWT ì¿ í‚¤ ì¡´ì¬ + ê²€ì¦ ì‹¤íŒ¨ ì‹œ ì¦‰ì‹œ 401 ë°˜í™˜
   - âœ… ì„¸ì…˜ í´ë°± ê¸ˆì§€

3. **Claim API ë©±ë“±ì„± ê°•í™”** (`POST /api/orders/:orderId/claim`)
   - âœ… `UPDATE ... WHERE user_id IS NULL` íŒ¨í„´ ì‚¬ìš©
   - âœ… ê°™ì€ ì‚¬ìš©ì ì¬ìš”ì²­: 200 OK (ë©±ë“±)
   - âœ… ë‹¤ë¥¸ ì‚¬ìš©ì ìš”ì²­: 409 Conflict

4. **íšŒì› ì£¼ë¬¸ í† í° ë°œê¸‰ ì¶”ê°€** (`processPaidOrder()`)
   - âœ… íšŒì› ì£¼ë¬¸ì—ë„ í† í° ìƒì„±
   - âœ… "ì£¼ë¬¸ë‹¹ ëŒ€í‘œ í† í° 1ê°œ(ìµœì‹  í† í°)" ì •ì±… ì ìš© (Aì•ˆ)
   - âœ… ê¸°ì¡´ ìœ íš¨ í† í° ìˆìœ¼ë©´ ì¬ì‚¬ìš©, ì—†ìœ¼ë©´ ìƒì„±
   - âœ… **ì´ë©”ì¼ ë°œì†¡ ì§ì „ì— í•­ìƒ ìµœì‹  í† í° ì¬ì¡°íšŒ** (ìƒì„±/ì¬ì‚¬ìš© ë¡œì§ê³¼ ë¶„ë¦¬)
   - âœ… ì¡°íšŒëŠ” í•­ìƒ ìµœì‹  í† í°ë§Œ ì‚¬ìš© (ë ˆì´ìŠ¤ ì•ˆì „)

#### Phase 2: í†µí•© ì—”ë“œí¬ì¸íŠ¸ ìƒì„±

1. **í†µí•© ì„¸ì…˜ êµí™˜ ì—”ë“œí¬ì¸íŠ¸** (`GET /api/orders/session`)
   - âœ… ë‚´ë¶€ í•¨ìˆ˜ë¡œ ë¡œì§ ë¶„ë¦¬
   - âœ… `/api/guest/orders/session`ë„ ë™ì¼ í•¨ìˆ˜ ì‚¬ìš© (í•˜ìœ„ í˜¸í™˜)
   - âœ… Redirect: `/order-detail.html?order=ORD-...`

2. **í†µí•© ì£¼ë¬¸ ì¡°íšŒ API** (`GET /api/orders/detail`)
   - âœ… ìˆ˜ì •ëœ `optionalAuth` ë¯¸ë“¤ì›¨ì–´ ì‚¬ìš©
   - âœ… JWT ì¿ í‚¤ ì¡´ì¬ ì‹œ: ê²€ì¦ ì„±ê³µ + ê¶Œí•œ OK â†’ í†µê³¼, ì‹¤íŒ¨ â†’ 401 (ì„¸ì…˜ ë¬´ì‹œ)
   - âœ… JWT ì¿ í‚¤ ì—†ì„ ë•Œë§Œ: ì„¸ì…˜ í† í° ê²€ì¦

#### Phase 3-5: (ê¸°ì¡´ ê³„íš ë™ì¼)

---

### âœ… ìµœì¢… í‰ê°€

**GPT ì¶”ê°€ í”¼ë“œë°±ì˜ ê°€ì¹˜**: â­â­â­â­â­ (5/5)
- êµ¬í˜„ ëˆ„ë½ ì‚¬í•­ ë°œê²¬: ë§¤ìš° ì¤‘ìš” âœ…
- optionalAuth ë¬¸ì œ: ì¹˜ëª…ì  ë³´ì•ˆ ì´ìŠˆ âœ…
- Claim ë©±ë“±ì„±: ê²½í•© ë°©ì§€ í•„ìˆ˜ âœ…
- í† í° ë°œê¸‰ ì •ì±…: ìš´ì˜ ì•ˆì •ì„± í–¥ìƒ âœ…
- í•˜ìœ„ í˜¸í™˜ì„±: ì‹¤ì œ ìš´ì˜ ê³ ë ¤ âœ…

**ê¶Œì¥**: GPTì˜ 5ê°€ì§€ ì²´í¬ë¦¬ìŠ¤íŠ¸ë¥¼ **ë°˜ë“œì‹œ ë°˜ì˜**í•œ í›„ Phase 1ë¶€í„° ì§„í–‰

---

## ğŸš€ Phase 1 ì‹¤í–‰ ì²´í¬ë¦¬ìŠ¤íŠ¸ (êµ¬í˜„ ìˆœì„œ)

### 1. ì„¸ì…˜ êµí™˜ ì—”ë“œí¬ì¸íŠ¸ ìˆ˜ì •

**íŒŒì¼**: `backend/order-routes.js` (`GET /api/guest/orders/session`)

**ìˆ˜ì • ì‚¬í•­**:
- [ ] `orders.user_id IS NOT NULL` ì°¨ë‹¨ ë¡œì§ ì œê±° (1460-1468ì¤„)
- [ ] ì°¨ë‹¨ ì¡°ê±´ì€ **3ì¢… ì°¨ë‹¨**ë§Œ ìœ ì§€:
  1. token not found
  2. `expires_at < NOW()`
  3. `revoked_at IS NOT NULL`
- [ ] Redirect ëŒ€ìƒ í™•ì¸: `/guest/orders.html` â†’ `/order-detail.html`ë¡œ ë³€ê²½ (ìµœì¢… ëª©í‘œ)

**í…ŒìŠ¤íŠ¸**:
- [ ] Claim ì™„ë£Œëœ ì£¼ë¬¸ë„ ì„¸ì…˜ êµí™˜ ì„±ê³µ
- [ ] ë§Œë£Œëœ í† í°ì€ ì°¨ë‹¨
- [ ] íšŒìˆ˜ëœ í† í°ì€ ì°¨ë‹¨

---

### 2. optionalAuth ë¯¸ë“¤ì›¨ì–´ ìˆ˜ì •

**íŒŒì¼**: `backend/auth-middleware.js`

**ìˆ˜ì • ì‚¬í•­**:
- [ ] JWT ì¿ í‚¤(`accessToken`)ê°€ ìˆìœ¼ë©´:
  - ê²€ì¦ ì„±ê³µ â†’ `req.user` ì„¤ì •, `next()`
  - ê²€ì¦ ì‹¤íŒ¨ â†’ ì¦‰ì‹œ 401 ë°˜í™˜ (ì„¸ì…˜ í´ë°± ê¸ˆì§€)
- [ ] JWT ì¿ í‚¤ê°€ ì—†ìœ¼ë©´:
  - `req.user = null`, `req.authType = 'anonymous'`, `next()`

**í…ŒìŠ¤íŠ¸**:
- [ ] JWT ìœ íš¨ + ê¶Œí•œ ìˆìŒ â†’ í†µê³¼
- [ ] JWT ìœ íš¨ + ê¶Œí•œ ì—†ìŒ â†’ 401
- [ ] JWT ë¬´íš¨ â†’ 401 (ì„¸ì…˜ ì¿ í‚¤ ìˆì–´ë„ ë¬´ì‹œ)
- [ ] JWT ì—†ìŒ + ì„¸ì…˜ ìˆìŒ â†’ ì„¸ì…˜ìœ¼ë¡œ ì²˜ë¦¬

---

### 3. Claim API ë©±ë“±ì„± ê°•í™”

**íŒŒì¼**: `backend/order-routes.js` (`POST /api/orders/:orderId/claim`)

**ìˆ˜ì • ì‚¬í•­**:
- [ ] `UPDATE orders SET user_id=? WHERE order_id=? AND user_id IS NULL` íŒ¨í„´ ì‚¬ìš©
- [ ] **UPDATE ë¨¼ì € ì‹œë„** (SELECT ë¨¼ì € í•˜ì§€ ì•ŠìŒ)
- [ ] `affectedRows === 1` â†’ Claim ì„±ê³µ
- [ ] `affectedRows === 0` â†’ ê·¸ë•Œë§Œ SELECTë¡œ í˜„ì¬ `user_id` ì¬í™•ì¸
  - ê°™ì€ ì‚¬ìš©ì â†’ 200 OK (ë©±ë“±)
  - ë‹¤ë¥¸ ì‚¬ìš©ì â†’ 409 Conflict

**í…ŒìŠ¤íŠ¸**:
- [ ] Claim ì „ ì£¼ë¬¸ â†’ ì„±ê³µ
- [ ] ê°™ì€ ì‚¬ìš©ì ì¬ìš”ì²­ â†’ 200 OK (ë©±ë“±)
- [ ] ë‹¤ë¥¸ ì‚¬ìš©ì ìš”ì²­ â†’ 409 Conflict
- [ ] ë™ì‹œ Claim ìš”ì²­ â†’ ê²½í•© ì•ˆì „ (1ê°œë§Œ ì„±ê³µ)

---

### 4. paid-order-processor í† í° ë°œê¸‰ ìˆ˜ì •

**íŒŒì¼**: `backend/utils/paid-order-processor.js`

**ìˆ˜ì • ì‚¬í•­**:
- [ ] íšŒì› ì£¼ë¬¸(`order.user_id IS NOT NULL`)ì—ë„ í† í° ìƒì„±
- [ ] ê¸°ì¡´ ìœ íš¨ í† í° í™•ì¸ (ë§Œë£Œ ì „, revoked ì•„ë‹˜)
- [ ] ìˆìœ¼ë©´ ì¬ì‚¬ìš©, ì—†ìœ¼ë©´ ìƒì„±
- [ ] **ì´ë©”ì¼ ë°œì†¡ ì§ì „ì— í•­ìƒ ìµœì‹  í† í° ì¬ì¡°íšŒ** (ìƒì„±/ì¬ì‚¬ìš© ë¡œì§ê³¼ ë¶„ë¦¬)
- [ ] ì´ë©”ì¼ì€ ìµœì¢… SELECT ê²°ê³¼ 1ê°œë§Œ ì‚¬ìš©

**í…ŒìŠ¤íŠ¸**:
- [ ] íšŒì› ì£¼ë¬¸ì—ë„ í† í° ìƒì„±
- [ ] ë¹„íšŒì› ì£¼ë¬¸ì—ë„ í† í° ìƒì„±
- [ ] ì¤‘ë³µ confirm/webhook â†’ ìµœì‹  í† í°ë§Œ ì´ë©”ì¼ì— í¬í•¨
- [ ] ë ˆì´ìŠ¤ ì¡°ê±´ì—ì„œë„ ì´ë©”ì¼ í† í°ì´ ìµœì‹ ì„ì„ ë³´ì¥

---

### 5. í†µí•© ì—”ë“œí¬ì¸íŠ¸ ìƒì„± (Phase 2ë¡œ ì´ë™ ê°€ëŠ¥)

**íŒŒì¼**: `backend/order-routes.js`

**ì‹ ê·œ ì—”ë“œí¬ì¸íŠ¸**:
- [ ] `GET /api/orders/session` ìƒì„±
- [ ] ë‚´ë¶€ í•¨ìˆ˜ë¡œ ë¡œì§ ë¶„ë¦¬ (ê¸°ì¡´ `/api/guest/orders/session`ê³¼ ê³µìœ )
- [ ] Redirect: `/order-detail.html?order=ORD-...`
- [ ] `GET /api/orders/detail` ìƒì„±
- [ ] ìˆ˜ì •ëœ `optionalAuth` ë¯¸ë“¤ì›¨ì–´ ì‚¬ìš©
- [ ] JWT ìš°ì„  ê²€ì¦ (í´ë°± ì—†ìŒ)
- [ ] ì„¸ì…˜ í† í° ê²€ì¦ (JWT ì—†ì„ ë•Œë§Œ)

---

### 6. í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ ìµœì†Œ ì„¸íŠ¸

**ì¸ì¦ ì¡°í•©**:
- [ ] JWT ìœ íš¨ + ì„¸ì…˜ ìœ íš¨
- [ ] JWT ìœ íš¨ + ì„¸ì…˜ ë¬´íš¨
- [ ] JWT ë¬´íš¨ + ì„¸ì…˜ ìœ íš¨
- [ ] JWT ì—†ìŒ + ì„¸ì…˜ ìœ íš¨
- [ ] JWT ì—†ìŒ + ì„¸ì…˜ ì—†ìŒ

**Claim ìƒíƒœ**:
- [ ] Claim ì „ ì£¼ë¬¸ ì¡°íšŒ
- [ ] Claim í›„ ì£¼ë¬¸ ì¡°íšŒ (ì´ë©”ì¼ ë§í¬)
- [ ] Claim í›„ ì£¼ë¬¸ ì¡°íšŒ (ë ˆê±°ì‹œ API - ì°¨ë‹¨ë˜ì–´ì•¼ í•¨)

**í† í° ìƒíƒœ**:
- [ ] í† í° ë§Œë£Œ
- [ ] í† í° íšŒìˆ˜
- [ ] í† í° ì •ìƒ

**ì¤‘ë³µ ìš”ì²­**:
- [ ] ì¤‘ë³µ confirm/webhook ìƒí™©ì—ì„œ ì´ë©”ì¼ ë§í¬ ë™ì‘
- [ ] ë ˆì´ìŠ¤ ì¡°ê±´ì—ì„œ ì´ë©”ì¼ í† í°ì´ ìµœì‹ ì„ì„ ë³´ì¥

---

## ğŸ“‹ ë ˆê±°ì‹œ ì—”ë“œí¬ì¸íŠ¸ ì •ì±… ëª…ì‹œ

### Aì•ˆ (ê¶Œì¥, ë³´ìˆ˜ì /ì•ˆì •í™” ìš°ì„ )

**ì •ì±…**:
- ë ˆê±°ì‹œ `/api/guest/orders/:orderNumber`ëŠ” ê¸°ì¡´ì²˜ëŸ¼ Claim ì™„ë£Œë©´ ì°¨ë‹¨ ìœ ì§€
- ìƒˆ `/api/orders/detail` + `/order-detail.html`ë§Œ Claim ì´í›„ë„ ì ‘ê·¼ í—ˆìš©
- ì˜ë¯¸: "ìƒˆ íë¦„ì´ ì •ë‹µ, ë ˆê±°ì‹œëŠ” ì˜› ì •ì±… ìœ ì§€(í•˜ìœ„í˜¸í™˜)"

**ë¬¸ì„œ ëª…ì‹œ**:
- **Claim ì´í›„ ì´ë©”ì¼ ë§í¬ ì¡°íšŒëŠ” `/api/orders/session` â†’ `/order-detail.html` â†’ `/api/orders/detail`ë¡œë§Œ ë³´ì¥í•œë‹¤**
- **ë ˆê±°ì‹œ `/api/guest/orders/:orderNumber`ëŠ” Claim ì´í›„ ì°¨ë‹¨ë  ìˆ˜ ìˆìœ¼ë©°, ì´ëŠ” ì˜ë„ëœ í•˜ìœ„í˜¸í™˜ ì •ì±…ì´ë‹¤**

**ì´ìœ **:
- ì´ í•œ ì¤„ì´ ì—†ìœ¼ë©´ ìš´ì˜ ì¤‘ CSì—ì„œ "ì–´ë–¤ ë§í¬ëŠ” ë˜ê³  ì–´ë–¤ ë§í¬ëŠ” ë§‰íŒë‹¤"ê°€ ë²„ê·¸ì²˜ëŸ¼ ë³´ì¼ ìˆ˜ ìˆë‹¤
- í•˜ìœ„ í˜¸í™˜ ìœ ì§€ë¥¼ ê°•ì¡°í•˜ëŠ” ë¬¸ì„œ íë¦„ê³¼ ì¼ì¹˜

### Bì•ˆ (ì¼ê´€ì„± ìš°ì„ ) - ì°¸ê³ ìš©

**ì •ì±…**:
- ë ˆê±°ì‹œ `/api/guest/orders/:orderNumber`ì—ì„œë„ Claim ì™„ë£Œ ì°¨ë‹¨ì„ ì œê±°
- ì˜ë¯¸: "ì–´ë–¤ ê²½ë¡œë¡œ ë³´ë“  Claim ì´í›„ ì¡°íšŒëŠ” ë™ì¼í•˜ê²Œ í—ˆìš©"

**ë¹„ê³ **: í˜„ì¬ ë¬¸ì„œê°€ "í•˜ìœ„í˜¸í™˜ ìœ ì§€"ë¥¼ ê°•ì¡°í•˜ê³  ìˆìœ¼ë‹ˆ Aì•ˆì´ ë” ìì—°ìŠ¤ëŸ½ë‹¤.

---

## ğŸ“‹ ì´ë©”ì¼ ë°œì†¡ í† í° ì„ ì • ê·œì¹™ (ë ˆì´ìŠ¤ ì•ˆì „)

### ê·œì¹™ (ê¶Œì¥)

**ì´ë©”ì¼ ë°œì†¡ ì§ì „ì— í•­ìƒ "ëŒ€í‘œ í† í°(ìµœì‹ )"ì„ ë‹¤ì‹œ ì¡°íšŒí•´ì„œ ê·¸ í† í°ìœ¼ë¡œ ë°œì†¡í•œë‹¤**

**êµ¬í˜„**:
- ìƒì„±/ì¬ì‚¬ìš© íŒë‹¨ ë¡œì§ê³¼ "ì´ë©”ì¼ì— ë„£ëŠ” í† í° ì„ íƒ"ì„ ë¶„ë¦¬
- ì´ë©”ì¼ì€ í•­ìƒ ìµœì¢… SELECT ê²°ê³¼ 1ê°œë§Œ ì‚¬ìš©

**ì´ìœ **:
- ë ˆì´ìŠ¤ê°€ ë‚˜ë©´ í† í°ì´ 2ê°œ ìƒê¸¸ ìˆ˜ ìˆê³ , ê·¸ ìˆœê°„ ì–´ë–¤ ìš”ì²­ì´ ì´ë©”ì¼ì„ ë³´ë‚´ëŠëƒì— ë”°ë¼ ì´ë©”ì¼ì— ì‹¤ë¦° í† í°ì´ 'ìµœì‹ 'ì´ ì•„ë‹ ìˆ˜ë„ ìˆë‹¤
- ì¡°íšŒë¥¼ ìµœì‹ ìœ¼ë¡œ í†µì¼í•œë‹¤ê³  í–ˆì§€ë§Œ, "ë³´ë‚´ëŠ” ì‹œì "ì´ í•­ìƒ ìµœì‹ ì„ ë³´ì¥í•˜ì§„ ì•ŠìŒ
- ì´ë©”ì¼ ë°œì†¡ ì§ì „ ì¬ì¡°íšŒë¡œ ìµœì‹  í† í° ë³´ì¥

### ëŒ€ì•ˆ (ë‹¨ìˆœ) - ë¹„ì¶”

**ê·œì¹™**: "ìµœì´ˆ ë°œì†¡ í† í°ì´ ëŒ€í‘œ í† í°" (ëŒ€í‘œì„±ì€ created_atì´ ì•„ë‹ˆë¼ emailed_at/selected_at ê°™ì€ ê°œë…ìœ¼ë¡œ ê³ ì •)

**ë¹„ê³ **: ìŠ¤í‚¤ë§ˆ/ë¡œê¹…ì´ í•„ìš”í•´ì§ˆ ê°€ëŠ¥ì„±ì´ ì»¤ì„œ, ì§€ê¸ˆ ë‹¨ê³„ì—” ë¹„ì¶”. "ë§ˆì´ê·¸ë ˆì´ì…˜ ìµœì†Œí™”" ì² í•™ê³¼ ë¶ˆì¼ì¹˜.

---

## âœ… ìµœì¢… ë¬¸ì„œ ì™„ì„±ë„

**ë¬¸ì„œ ìƒíƒœ**: â­â­â­â­â­ (5/5) - ìš´ì˜ê¸‰ ì™„ì„±

**í™•ì¸ ì‚¬í•­**:
- âœ… ì •ì±…-êµ¬í˜„-ìš´ì˜ ë¦¬ìŠ¤í¬ê°€ ëª¨ìˆœ ì—†ì´ ì •ë¦¬ë¨
- âœ… JWT ì¡´ì¬ ì‹œ ì‹¤íŒ¨ ì¦‰ì‹œ 401 + ì„¸ì…˜ ë¬´ì‹œ (í´ë°± ê¸ˆì§€)
- âœ… "3ì¢… ì°¨ë‹¨" ìš©ì–´ ê³ ì • (ë¬¸ì„œ ì „ë°˜ í†µì¼)
- âœ… Claim ë©±ë“± (UPDATE-first + 0ì¼ ë•Œë§Œ SELECT)
- âœ… "ëŒ€í‘œ í† í°(ìµœì‹  1ê°œ)"ë¡œ ë ˆì´ìŠ¤ í¡ìˆ˜
- âœ… ë ˆê±°ì‹œ ì—”ë“œí¬ì¸íŠ¸ ì •ì±… ëª…ì‹œ
- âœ… ì´ë©”ì¼ ë°œì†¡ í† í° ì„ ì • ê·œì¹™ ëª…í™•í™”
- âœ… ì‹¤í–‰ ì²´í¬ë¦¬ìŠ¤íŠ¸ ì œê³µ

**ê¶Œì¥**: ìœ„ì˜ ì‹¤í–‰ ì²´í¬ë¦¬ìŠ¤íŠ¸ë¥¼ ë”°ë¼ Phase 1ë¶€í„° ì§„í–‰
