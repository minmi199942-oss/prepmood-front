# ì¢…í•© êµ¬í˜„ ë¡œë“œë§µ: QR/ë””ì§€í„¸ ë³´ì¦ì„œ/ì¸ë³´ì´ìŠ¤ ì™„ì „ êµ¬í˜„ ê°€ì´ë“œ

## âš ï¸ SSOT ì„ ì–¸ (ë‹¨ì¼ ì§„ì‹¤ ì›ì²œ) - í•„ìˆ˜ ê³ ì •

**ì´ ë¬¸ì„œëŠ” QR ì½”ë“œ, ë””ì§€í„¸ ë³´ì¦ì„œ, ì¸ë³´ì´ìŠ¤ ê´€ë ¨ ëª¨ë“  êµ¬í˜„ì˜ ë‹¨ì¼ ì§„ì‹¤ ì›ì²œ(SSOT)ì…ë‹ˆë‹¤.**

**ğŸš€ ì‘ì—… ì‹œì‘**: ì‘ì—…í•  ë•ŒëŠ” **`START_HERE.md`**ë¥¼ ë¨¼ì € ë³´ì„¸ìš”. ì´ ë¬¸ì„œëŠ” ì‘ì—… ëª©ë¡ê³¼ ìƒì„¸ ë‚´ìš©ì„ ë‹´ê³  ìˆìŠµë‹ˆë‹¤.

**âš ï¸ ì¤‘ìš”**: ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ êµ¬ì¡°ëŠ” `SCHEMA_SSOT.md`ê°€ ìµœì¢… ê¸°ì¤€ì…ë‹ˆë‹¤. ì´ ë¬¸ì„œì˜ Phase 2 ìŠ¤í™ì€ "ì´ìƒì  ëª©í‘œ"ì´ë©°, ì‹¤ì œ êµ¬ì¡°ì™€ ë‹¤ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**ğŸ“‹ ë¬¸ì„œ ì¼ê´€ì„±**: ì´ ë¬¸ì„œëŠ” `FINAL_EXECUTION_SPEC_REVIEW.md`ì™€ `SYSTEM_FLOW_DETAILED.md`ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤. í•µì‹¬ ì •ì±…(SSOT ê·œì¹™, ìƒíƒœ ì „ì´í‘œ, ì§‘ê³„ ê·œì¹™, í™˜ë¶ˆ/ì–‘ë„/í™œì„±í™” ì •ì±…, ë©±ë“±ì„± ê³„ì¸µí‘œ)ì€ ì™„ì „ ì¼ì¹˜í•©ë‹ˆë‹¤. í…Œì´ë¸” êµ¬ì¡° ì°¨ì´ëŠ” "ì´ìƒì  ëª©í‘œ" vs "ì‹¤ì œ êµ¬ì¡°"ë¡œ, ì‹¤ì œ êµ¬ì¡°ëŠ” `SCHEMA_SSOT.md`ë¥¼ ê¸°ì¤€ìœ¼ë¡œ í•©ë‹ˆë‹¤.

**ê¸°ì¤€ ë¬¸ì„œ**:
- `START_HERE.md`: **ì‘ì—… ì‹œì‘ ê°€ì´ë“œ (ì´ ë¬¸ì„œ í•˜ë‚˜ë§Œ ë³´ì„¸ìš”)**
- `SCHEMA_SSOT.md`: **ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ ì‹¤ì œ êµ¬ì¡° (ìµœì¢… ê¸°ì¤€)**
- `SYSTEM_FLOW_DETAILED.md`: ì‹œìŠ¤í…œ ì „ì²´ íë¦„ ìƒì„¸ ê°€ì´ë“œ
- `FINAL_EXECUTION_SPEC_REVIEW.md`: ìµœì¢… ì‹¤í–‰ ìŠ¤í™ ê²€í†  ë³´ê³ ì„œ
- `ADMIN_QR_WARRANTY_INVOICE_CONSISTENCY_CHECK.md`: ê´€ë¦¬ì í˜ì´ì§€ ê¸°ëŠ¥ ì¼ê´€ì„± ê²€í† 

### í•µì‹¬ SSOT ê·œì¹™ (FINAL_EXECUTION_SPEC_REVIEW.md ê¸°ì¤€)

1. **`orders.status`ëŠ” ì§‘ê³„ ê²°ê³¼(ë·°/í‘œì‹œìš©)ì´ë©°, ì§ì ‘ ì •ì±… íŒë‹¨ ê¸°ì¤€ìœ¼ë¡œ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤.**
   - í™˜ë¶ˆ/ì–‘ë„/ì œì¬ íŒë‹¨ì€ `warranties.status`ë¥¼ ê¸°ì¤€ìœ¼ë¡œ í•œë‹¤.
   - `orders.status`ëŠ” ì§‘ê³„ í•¨ìˆ˜ë¡œë§Œ ê°±ì‹ ë˜ë©°, ê´€ë¦¬ì ìˆ˜ë™ ìˆ˜ì • ê¸ˆì§€.

2. **`order_item_units.unit_status`ëŠ” ë¬¼ë¥˜ ë‹¨ìœ„ ìƒíƒœ(ë°°ì†¡/ì¬ê³  íë¦„)ì˜ ì§„ì‹¤ ì›ì²œì´ë‹¤.**
   - ë°°ì†¡ ìƒíƒœ íŒë‹¨ì€ `unit_status`ë¥¼ ê¸°ì¤€ìœ¼ë¡œ í•œë‹¤.
   - `orders.status`ëŠ” `unit_status` ì§‘ê³„ ê²°ê³¼ì¼ ë¿ì´ë‹¤.

3. **`stock_units.status`ëŠ” ì‹¤ë¬¼ ì¬ê³  ìƒíƒœì˜ ì§„ì‹¤ ì›ì²œì´ë‹¤.**
   - **ì±…ì„ ê²½ê³„:** ì¬íŒë§¤ ê°€ëŠ¥ ì—¬ë¶€ì˜ ìµœì¢… ê²Œì´íŠ¸ëŠ” **`stock_units.status = 'in_stock'`** ì´ë‹¤. (Paid íŠ¸ëœì­ì…˜ì€ ì˜¤ì§ ì´ ì¡°ê±´ë§Œ ë³¸ë‹¤).

4. **`warranties.status`ëŠ” ê¶Œë¦¬/ì •ì±… ìƒíƒœ(í™œì„±í™”/ì–‘ë„/í™˜ë¶ˆ ê°€ëŠ¥ ì—¬ë¶€)ì˜ ì§„ì‹¤ ì›ì²œì´ë‹¤.**
   - í™˜ë¶ˆ ê°€ëŠ¥ ì—¬ë¶€ íŒì •ì€ `warranties.status`ë§Œ ë³¸ë‹¤.
   - í™œì„±í™” ê°€ëŠ¥ ì—¬ë¶€ íŒì •ì€ `warranties.status`ë¥¼ 1ì°¨ ê¸°ì¤€ìœ¼ë¡œ í•˜ë˜, **ì£¼ë¬¸ ê·€ì† ê²€ì¦(`orders.user_id`)**ê³¼ **Refunded ì—¬ë¶€**ë¥¼ í•¨ê»˜ í™•ì¸í•œë‹¤.

5. **`invoices`ëŠ” ë¬¸ì„œ(ìŠ¤ëƒ…ìƒ·)ì´ë©°, "ê¶Œë¦¬ íŒë‹¨ ê¸°ì¤€"ì´ ì•„ë‹ˆë¼ "ì¦ë¹™/ì¡°íšŒ" ì—­í• ì´ë‹¤.**
   - í™œì„±í™”/í™˜ë¶ˆ íŒì •ì— `invoices`ë¥¼ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤.
   - `invoices`ëŠ” ë°œê¸‰ ì‹œì ì˜ ì£¼ë¬¸ ì •ë³´ë¥¼ ê³ ì • ì €ì¥í•˜ëŠ” ìŠ¤ëƒ…ìƒ·ì¼ ë¿ì´ë‹¤.

### ì „ì—­ ì •í•©ì„± ê·œì¹™

1. **ì „ì—­ ë½ ìˆœì„œ(í•„ìˆ˜):** `stock_units`(ë¬¼ë¦¬) â†’ `orders`(ê²°ì œ) â†’ `warranties`(ê¶Œë¦¬) â†’ `invoices`(ë¬¸ì„œ)

2. **ì „ì—­ ì›ìì„± ê·œì¹™(í•„ìˆ˜):** ìƒíƒœ ì „ì´ëŠ” `UPDATE ... WHERE ì¡°ê±´`ìœ¼ë¡œë§Œ ìˆ˜í–‰í•˜ë©° `affectedRows=1` ê²€ì¦ í•„ìˆ˜.

3. **ì „ì—­ ìœ ë‹ˆí¬ ì œì•½(í•„ìˆ˜ - DB ë ˆë²¨ ê°•ì œ):**
   - `order_idempotency`: `UNIQUE(owner_key, idem_key)`
   - `paid_events`: `UNIQUE(order_id, payment_key)`
   - **`order_item_units` (ì´ì¤‘ íŒë§¤ ë°©ì§€ - MySQL íŒ¨í„´):**
     - **`UNIQUE(stock_unit_id, active_lock)`**
     - **`active_lock` ì •ì˜:** `CASE WHEN unit_status IN ('reserved', 'shipped', 'delivered') THEN 1 ELSE NULL END`
   - `warranties`: `UNIQUE(token_pk)` (í† í°ë‹¹ ë ˆì½”ë“œ 1ê°œ ê°•ì œ)
   - `invoices`: `UNIQUE(invoice_number)`, `UNIQUE(invoice_group_id, invoice_part_no)`

4. **í† í° ì²´ê³„(í•„ìˆ˜):** ë¹„íšŒì› ì¡°íšŒëŠ” `guest_order_access_token`(90ì¼), Claimì€ `claim_token`(ë‹¨ê¸°)ìœ¼ë¡œ ì² ì €íˆ ë¶„ë¦¬.

5. **ì–‘ë„ ìš”ì²­ ë‹¨ì¼í™”(í•„ìˆ˜):** `warranty_id`ë‹¹ `requested` ìƒíƒœëŠ” 1ê°œë§Œ ìœ ì§€ (ì·¨ì†Œ í›„ ì¬ìƒì„±).

---

## ğŸ“Š í˜„ì¬ êµ¬í˜„ ìƒíƒœ (2026-01-16 ê¸°ì¤€)

### âœ… ì™„ë£Œëœ ë¶€ë¶„

#### 1. ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ
- âœ… `orders` í…Œì´ë¸” (guest_id í¬í•¨)
- âœ… `orders.status` ì²´í¬ ì œì•½ ìˆ˜ì • (079_fix_orders_status_check_constraint.sql)
  - `paid`, `partial_shipped`, `partial_delivered` ìƒíƒœ ì¶”ê°€ ì™„ë£Œ
- âœ… `order_items` í…Œì´ë¸”
- âœ… `warranties` í…Œì´ë¸” (ê¸°ë³¸ êµ¬ì¡°)
- âœ… `token_master` í…Œì´ë¸” (tokenì´ PK, token_pk ë§ˆì´ê·¸ë ˆì´ì…˜ í•„ìš”)
- âœ… `invoices` í…Œì´ë¸” (021_create_invoices_table.sql)
- âœ… `order_idempotency` í…Œì´ë¸” (owner_key ë°©ì‹)
- âœ… `stock_units` í…Œì´ë¸” (size, color í¬í•¨)
- âœ… `order_item_units` í…Œì´ë¸” (027_create_order_item_units_table.sql)
- âœ… `paid_events` í…Œì´ë¸” (024_create_paid_events_table.sql)
- âœ… `product_options` í…Œì´ë¸” (Phase 15-1 ì™„ë£Œ)

#### 2. ë°±ì—”ë“œ ë¡œì§
- âœ… `processPaidOrder()` í•¨ìˆ˜ êµ¬í˜„ (`backend/utils/paid-order-processor.js`)
  - Paid ì‹œì ì— ì¬ê³  ì˜ˆì•½ (reserved)
  - `order_item_units` ìƒì„±
  - `warranties` ìƒì„± (íšŒì›: issued, ë¹„íšŒì›: issued_unassigned)
  - ì¬íŒë§¤ ì²˜ë¦¬ (revoked â†’ issued ì „ì´)
  - ì¸ë³´ì´ìŠ¤ ìƒì„±
- âœ… `orders.status` ì§‘ê³„ í•¨ìˆ˜ êµ¬í˜„ (`backend/utils/order-status-aggregator.js`)
  - `paid_events` ê¸°ë°˜ ì§‘ê³„
  - `partial_shipped`, `partial_delivered` ì§€ì›
- âœ… ì˜µì…˜ API (`GET /api/products/options?product_id=...`)
  - querystring ë°©ì‹ (ìŠ¬ë˜ì‹œ ì•ˆì „)
  - product_options ê¸°ë°˜ (Phase 15-2 ì™„ë£Œ)
  - ì¬ê³  ìƒíƒœ í¬í•¨ (available: true/false)
- âœ… QR ì½”ë“œ ë‹¤ìš´ë¡œë“œ API (`backend/qrcode-download-routes.js`)
- âœ… ì¸ë³´ì´ìŠ¤ ìƒì„± ë¡œì§ (`backend/utils/invoice-creator.js`)
- âœ… ë³´ì¦ì„œ í™œì„±í™” API (`POST /api/warranties/:warrantyId/activate`) (Phase 5 ì™„ë£Œ)
  - ì¸ë³´ì´ìŠ¤ ì—°ë™ í™•ì¸ (í™˜ë¶ˆ í›„ QR ì½”ë“œ ì•…ìš© ë°©ì§€)
  - warranty_events ì´ë²¤íŠ¸ ê¸°ë¡
- âœ… Claim API (`POST /api/orders/:orderId/claim-token`, `POST /api/orders/:orderId/claim`) (Phase 6 ì™„ë£Œ)
  - 3-Factor Atomic Check
  - warranties ìƒíƒœ ì „ì´ (issued_unassigned â†’ issued)
  - guest_order_access_token íšŒìˆ˜

#### 3. í”„ë¡ íŠ¸ì—”ë“œ
- âœ… ìƒí’ˆ ìƒì„¸ í˜ì´ì§€ (`buy.html`, `buy-script.js`)
  - ì˜µì…˜ API í˜¸ì¶œ
  - ì‚¬ì´ì¦ˆ/ìƒ‰ìƒ ì„ íƒ UI
  - ì¬ê³  ì—†ëŠ” ì˜µì…˜ "(í’ˆì ˆ)" í‘œì‹œ

### âŒ ë¯¸ì™„ì„± ë¶€ë¶„

#### 1. ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ
- âŒ `token_pk` ë§ˆì´ê·¸ë ˆì´ì…˜ (token_master PK êµì²´) - **âš ï¸ ë³µì¡, ì‹ ì¤‘í•˜ê²Œ ì§„í–‰ í•„ìš”**
- âœ… `warranties.status` ì»¬ëŸ¼ (issued/active/revoked ë“±) - Phase 2 ì™„ë£Œ
- âœ… `warranties.owner_user_id` ì»¬ëŸ¼ - Phase 2 ì™„ë£Œ
- âœ… `warranties.source_order_item_unit_id` ì»¬ëŸ¼ - Phase 2 ì™„ë£Œ
- âœ… `warranties.activated_at`, `warranties.revoked_at` ì»¬ëŸ¼ - Phase 2 ì™„ë£Œ
- âœ… `shipments` í…Œì´ë¸” - Phase 2 ì™„ë£Œ
- âŒ `shipment_units` í…Œì´ë¸”
- âŒ `warranty_events` í…Œì´ë¸”
- âŒ `warranty_transfers` í…Œì´ë¸”
- âŒ `guest_order_access_tokens` í…Œì´ë¸”
- âŒ `claim_tokens` í…Œì´ë¸”
- âœ… `product_options` í…Œì´ë¸” (Phase 15-1 ì™„ë£Œ)

#### 2. ë°±ì—”ë“œ ë¡œì§
- âš ï¸ **`orders.status` ì§ì ‘ ì—…ë°ì´íŠ¸ ìœ„ë°˜** (ì¦‰ì‹œ ìˆ˜ì • í•„ìš”)
  - `backend/payments-routes.js` 1434-1438ì¤„: webhookì—ì„œ ì§ì ‘ ì—…ë°ì´íŠ¸
  - `backend/index.js` 1675-1715ì¤„: ê´€ë¦¬ì APIë¡œ ì§ì ‘ ìˆ˜ì • ê°€ëŠ¥
- âŒ ì„ ì˜ˆì•½í˜• ì¬ê³  ê´€ë¦¬ (ì£¼ë¬¸ ìƒì„± ì‹œ ì¬ê³  ì˜ˆì•½)
- âœ… ì˜µì…˜ API ê°œì„  (product_options ê¸°ë°˜, ì¬ê³  ì—†ëŠ” ì˜µì…˜ë„ í‘œì‹œ - Phase 15-2 ì™„ë£Œ)
- âœ… ìƒ‰ìƒ ë°ì´í„° ì†ŒìŠ¤ ê°œì„  (product_options ê¸°ë°˜ SSOT - Phase 15-2 ì™„ë£Œ)
- âœ… ë³´ì¦ì„œ í™œì„±í™” API (`POST /api/warranties/:warrantyId/activate`) - Phase 5 ì™„ë£Œ
- âœ… Claim API (`POST /api/orders/:orderId/claim-token`, `POST /api/orders/:orderId/claim`) - Phase 6 ì™„ë£Œ
- âœ… QR ìŠ¤ìº” ë¡œì§ ìˆ˜ì • (warranty ìƒì„± ì œê±°, ì¡°íšŒë§Œ) - Phase 7 ì™„ë£Œ
- âœ… ì–‘ë„ ìš”ì²­/ìˆ˜ë½ API - Phase 8-1, 8-2 ì™„ë£Œ
- âœ… í™˜ë¶ˆ ì²˜ë¦¬ API (ê´€ë¦¬ì ì „ìš©) - Phase 9 ì™„ë£Œ
- âœ… ë°°ì†¡/ì†¡ì¥ ê´€ë¦¬ API - Phase 12 ì™„ë£Œ
- âŒ ë¹„íšŒì› ì£¼ë¬¸ ì¡°íšŒ API

#### 3. í”„ë¡ íŠ¸ì—”ë“œ
- âŒ ë³´ì¦ì„œ í™œì„±í™” í˜ì´ì§€
- âŒ ë³´ì¦ì„œ ìƒì„¸ í˜ì´ì§€ (í™œì„±í™”, ì–‘ë„ ê¸°ëŠ¥)
- âŒ ë¹„íšŒì› ì£¼ë¬¸ ì¡°íšŒ í˜ì´ì§€
- âŒ Claim í˜ì´ì§€
- âŒ ê´€ë¦¬ì í˜ì´ì§€ ê°œì„  (ì£¼ë¬¸ ìƒì„¸ 3ë‹¨ êµ¬ì¡°, ë³´ì¦ì„œ ìƒì„¸)
- âŒ ê´€ë¦¬ì í˜ì´ì§€ ì˜µì…˜ ê´€ë¦¬ ê¸°ëŠ¥ (Phase 15-3)

---

## ğŸ¯ êµ¬í˜„ ìš°ì„ ìˆœìœ„ ë° ë‹¨ê³„ë³„ ê³„íš

### ğŸ”´ Phase -1: orders.status ì§ì ‘ ì—…ë°ì´íŠ¸ ì œê±° (ì¦‰ì‹œ ìˆ˜ì • í•„ìš”)

**ëª©ì **: ì„¤ê³„ ì›ì¹™ ìœ„ë°˜ ìˆ˜ì • (SSOT ì¤€ìˆ˜)

**âš ï¸ ì‹¬ê°ë„**: ğŸ”´ **ìµœìš°ì„ ** - ì„¤ê³„ ì›ì¹™ ìœ„ë°˜ìœ¼ë¡œ ì‹œìŠ¤í…œ ì¼ê´€ì„± í•´ì¹¨

**ì‘ì—…**:

#### -1-1. payments-routes.js ìˆ˜ì •
**íŒŒì¼**: `backend/payments-routes.js`

**ìœ„ì¹˜**: `handlePaymentStatusChange()` í•¨ìˆ˜ (1434-1438ì¤„)

**í˜„ì¬ ì½”ë“œ** (ìœ„ë°˜):
```javascript
// âŒ ìœ„ë°˜: orders.status ì§ì ‘ ì—…ë°ì´íŠ¸
const [updateResult] = await connection.execute(
    `UPDATE orders 
     SET status = ?, updated_at = NOW() 
     WHERE order_id = ?`,
    [orderStatus, orderIdForPaidProcess]
);
```

**ìˆ˜ì • í›„**:
```javascript
// âœ… ì˜¬ë°”ë¥¸ êµ¬í˜„: ì§‘ê³„ í•¨ìˆ˜ í˜¸ì¶œ
const { updateOrderStatus } = require('./utils/order-status-aggregator');
await updateOrderStatus(connection, orderIdForPaidProcess);
```

**ì˜ˆìƒ ì‘ì—… ì‹œê°„**: 1ì‹œê°„

**ì˜ì¡´ì„±**: ì—†ìŒ (ì´ë¯¸ êµ¬í˜„ëœ `updateOrderStatus` í•¨ìˆ˜ ì‚¬ìš©)

**ì™„ë£Œ ì¡°ê±´**:
- `orderStatus` ë³€ìˆ˜ ì œê±°
- `updateOrderStatus()` í˜¸ì¶œë¡œ ëŒ€ì²´
- webhook ì²˜ë¦¬ í›„ `orders.status`ê°€ ì˜¬ë°”ë¥´ê²Œ ì§‘ê³„ë¨

#### -1-2. ê´€ë¦¬ì API ìˆ˜ì • ë˜ëŠ” ì œê±°
**íŒŒì¼**: `backend/index.js`

**ìœ„ì¹˜**: `PUT /api/admin/orders/:orderId/status` (1675-1715ì¤„)

**ì˜µì…˜ A (ê¶Œì¥)**: API ì œê±°
- ê´€ë¦¬ìëŠ” `orders.status`ë¥¼ ì§ì ‘ ìˆ˜ì •í•  ìˆ˜ ì—†ìŒ
- ìƒíƒœ ë³€ê²½ì€ `order_item_units.unit_status`ë‚˜ `paid_events` ë³€ê²½ìœ¼ë¡œë§Œ ê°€ëŠ¥

**ì˜µì…˜ B**: APIë¥¼ ì§‘ê³„ í•¨ìˆ˜ í˜¸ì¶œë¡œ ë³€ê²½
- ìš”ì²­ëœ `status` ê°’ì´ ì§‘ê³„ ê²°ê³¼ì™€ ì¼ì¹˜í•˜ëŠ”ì§€ ê²€ì¦
- ì¼ì¹˜í•˜ì§€ ì•Šìœ¼ë©´ ì—ëŸ¬ ë°˜í™˜

**ì˜ˆìƒ ì‘ì—… ì‹œê°„**: 1-2ì‹œê°„

**ì˜ì¡´ì„±**: ì—†ìŒ

**ì™„ë£Œ ì¡°ê±´**:
- ì˜µì…˜ A: API ì œê±° ì™„ë£Œ
- ì˜µì…˜ B: ì§‘ê³„ í•¨ìˆ˜ í˜¸ì¶œë¡œ ë³€ê²½ ì™„ë£Œ, ê²€ì¦ ë¡œì§ ì¶”ê°€

---

### Phase 0: ì˜µì…˜ API ê°œì„  (ì™„ë£Œ)

**ëª©ì **: GPT ì œì•ˆ ë°˜ì˜, UX ê°œì„ 

**ì‘ì—…**:
1. **ì˜µì…˜ API ì‘ë‹µ êµ¬ì¡° ê°œì„ ** (`backend/product-routes.js`)
   - `in_stock_qty` ì¶”ê°€ (ê° ì‚¬ì´ì¦ˆ/ìƒ‰ìƒë³„ ì¬ê³  ìˆ˜ëŸ‰)
   - `availability_map` ì¶”ê°€ (ìƒ‰ìƒ-ì‚¬ì´ì¦ˆ ì¡°í•©ë³„ ì¬ê³ )
   - `default_color` ì¶”ê°€ (ê¸°ë³¸ ìƒ‰ìƒ)

2. **í”„ë¡ íŠ¸ì—”ë“œ ê°œì„ ** (`buy-script.js`)
   - `availability_map` ê¸°ë°˜ ë™ì  ì˜µì…˜ í™œì„±í™”
   - ìƒ‰ìƒ ì„ íƒ ì‹œ í•´ë‹¹ ìƒ‰ìƒì˜ ê°€ëŠ¥í•œ ì‚¬ì´ì¦ˆë§Œ í™œì„±í™”
   - ì‚¬ì´ì¦ˆ ì„ íƒ ì‹œ ì¬ê³  ìˆ˜ëŸ‰ í‘œì‹œ

**ì˜ˆìƒ ì‘ì—… ì‹œê°„**: 2-3ì‹œê°„

**ì˜ì¡´ì„±**: ì—†ìŒ (ê¸°ì¡´ APIì™€ í˜¸í™˜)

**ì™„ë£Œ ì¡°ê±´**:
- ì˜µì…˜ API ì‘ë‹µì— `in_stock_qty`, `availability_map`, `default_color` í¬í•¨
- í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ìƒ‰ìƒ ì„ íƒ ì‹œ ì‚¬ì´ì¦ˆ ë™ì  í™œì„±í™”
- ì¬ê³  ìˆ˜ëŸ‰ í‘œì‹œ

---

### Phase 1: ìƒ‰ìƒ ë°ì´í„° ì†ŒìŠ¤ ê°œì„  (ì™„ë£Œ)

**ëª©ì **: product_id íŒŒì‹± ì˜ì¡´ ì œê±°, stock_units ê¸°ë°˜ SSOT

**ì‘ì—…**:
1. **ì˜µì…˜ API ìˆ˜ì •** (`backend/product-routes.js`)
   - `stock_units`ì—ì„œ DISTINCT color ì¡°íšŒ (ì¬ê³  ìƒíƒœ ë¬´ê´€)
   - `product_id` ì¶”ì¶œì€ fallbackìœ¼ë¡œë§Œ ì‚¬ìš©
   - ì¬ê³ ê°€ ì—†ì–´ë„ ìƒí’ˆì´ ì§€ì›í•˜ëŠ” ìƒ‰ìƒ í‘œì‹œ

2. **í”„ë¡ íŠ¸ì—”ë“œ ìˆ˜ì •** (`buy-script.js`)
   - API ì‘ë‹µ êµ¬ì¡° ë³€ê²½ ëŒ€ì‘
   - fallback ë¡œì§ ì œê±° (APIê°€ í•­ìƒ ìƒ‰ìƒ ë°˜í™˜)

**ì˜ˆìƒ ì‘ì—… ì‹œê°„**: 1-2ì‹œê°„

**ì˜ì¡´ì„±**: Phase 0 ì™„ë£Œ ê¶Œì¥ (ê°™ì€ íŒŒì¼ ìˆ˜ì •)

**ì™„ë£Œ ì¡°ê±´**:
- `stock_units`ì—ì„œ ëª¨ë“  ìƒ‰ìƒ ì¡°íšŒ (ì¬ê³  ìƒíƒœ ë¬´ê´€)
- ì¬ê³ ê°€ 0ì¸ ìƒí’ˆë„ ìƒ‰ìƒ í‘œì‹œ
- `product_id` ì¶”ì¶œì€ fallbackìœ¼ë¡œë§Œ ì‚¬ìš©

---

### Phase 2: í•µì‹¬ ì¸í”„ë¼ í…Œì´ë¸” ìƒì„± (ìµœìš°ì„ , ëª¨ë“  ê¸°ëŠ¥ì˜ ê¸°ë°˜)

**ëª©ì **: ë³´ì¦ì„œ/ì¸ë³´ì´ìŠ¤ ê¸°ëŠ¥ì˜ ê¸°ë°˜ í…Œì´ë¸” ì™„ì„±

**ì‘ì—… ìˆœì„œ** (ì˜ì¡´ì„± ê³ ë ¤):

#### 2-1. `warranties` ì»¬ëŸ¼ ì¶”ê°€
**íŒŒì¼**: `backend/migrations/050_add_warranties_status_columns.sql`

**âš ï¸ ì¤‘ìš”**: `warranties.status`ëŠ” ê¶Œë¦¬/ì •ì±… ìƒíƒœì˜ SSOTì…ë‹ˆë‹¤. ëª¨ë“  í™˜ë¶ˆ/ì–‘ë„/í™œì„±í™” íŒì •ì€ ì´ ì»¬ëŸ¼ë§Œ ì‚¬ìš©í•©ë‹ˆë‹¤.

```sql
-- status ì»¬ëŸ¼ ì¶”ê°€
ALTER TABLE warranties
ADD COLUMN status ENUM('issued_unassigned', 'issued', 'active', 'suspended', 'revoked') 
NOT NULL DEFAULT 'issued_unassigned'
COMMENT 'ë³´ì¦ì„œ ìƒíƒœ (SSOT - ê¶Œë¦¬/ì •ì±… ìƒíƒœì˜ ì§„ì‹¤ ì›ì²œ)' 
AFTER warranty_id;

-- owner_user_id ì»¬ëŸ¼ ì¶”ê°€
ALTER TABLE warranties
ADD COLUMN owner_user_id INT NULL
COMMENT 'ë³´ì¦ì„œ ì†Œìœ ì (NULLì´ë©´ issued_unassigned, issued/active/suspendedëŠ” NOT NULL í•„ìˆ˜)'
AFTER status;

-- source_order_item_unit_id ì»¬ëŸ¼ ì¶”ê°€
ALTER TABLE warranties
ADD COLUMN source_order_item_unit_id BIGINT NULL
COMMENT 'ì£¼ë¬¸ í•­ëª© ë‹¨ìœ„ ì—°ê²°'
AFTER owner_user_id;

-- activated_at ì»¬ëŸ¼ ì¶”ê°€
ALTER TABLE warranties
ADD COLUMN activated_at DATETIME NULL
COMMENT 'í™œì„±í™” ì‹œì '
AFTER source_order_item_unit_id;

-- revoked_at ì»¬ëŸ¼ ì¶”ê°€ (Aì•ˆ í™•ì •: ì¬íŒë§¤ ì‹œì—ë„ ìœ ì§€, ì´ë ¥)
ALTER TABLE warranties
ADD COLUMN revoked_at DATETIME NULL
COMMENT 'í™˜ë¶ˆ ì‹œì  (ì¬íŒë§¤ ì‹œì—ë„ ìœ ì§€, ì´ë ¥ - Aì•ˆ í™•ì •)'
AFTER activated_at;

-- ì¸ë±ìŠ¤ ì¶”ê°€
CREATE INDEX idx_warranties_status ON warranties(status);
CREATE INDEX idx_warranties_owner_user_id ON warranties(owner_user_id);
CREATE INDEX idx_warranties_source_order_item_unit_id ON warranties(source_order_item_unit_id);

-- FK ì¶”ê°€ (order_item_units í…Œì´ë¸” ìƒì„± í›„)
ALTER TABLE warranties
ADD CONSTRAINT fk_warranties_source_order_item_unit
FOREIGN KEY (source_order_item_unit_id) REFERENCES order_item_units(order_item_unit_id) ON DELETE RESTRICT;

-- âš ï¸ UNIQUE ì œì•½ ì¶”ê°€ (í† í°ë‹¹ ë ˆì½”ë“œ 1ê°œ ê°•ì œ)
-- active_key íŒ¨í„´ ì‚¬ìš© ê¶Œì¥ (ìœ íš¨ ë³´ì¦ì„œë§Œ UNIQUE)
ALTER TABLE warranties
ADD COLUMN active_key VARCHAR(50) GENERATED ALWAYS AS (
    CASE WHEN status IN ('issued', 'issued_unassigned', 'active', 'suspended') 
         THEN CONCAT('token_', token_pk) 
         ELSE NULL 
    END
) VIRTUAL COMMENT 'ìœ íš¨ ë³´ì¦ì„œ í‚¤ (active_key íŒ¨í„´)';

CREATE UNIQUE INDEX uk_warranties_active_key ON warranties(active_key);
```

**ê¸°ì¡´ ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜**:
```sql
-- ê¸°ì¡´ warranties ë°ì´í„°ì— status ì„¤ì •
UPDATE warranties 
SET status = 'issued_unassigned' 
WHERE status IS NULL OR status = '';

-- âš ï¸ owner_user_id ê²€ì¦ (issued/active/suspendedëŠ” NOT NULL í•„ìˆ˜)
-- ì• í”Œë¦¬ì¼€ì´ì…˜ ë ˆë²¨ ê°€ë“œë¡œ ê°•ì œ (DB CHECKëŠ” MySQL ë²„ì „ì— ë”°ë¼)
```

**ì™„ë£Œ ì¡°ê±´**: 
- ëª¨ë“  ì»¬ëŸ¼ ì¶”ê°€ ì™„ë£Œ
- ê¸°ì¡´ ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ
- FK ì œì•½ ì¶”ê°€ ì™„ë£Œ

#### 2-2. `warranty_events` í…Œì´ë¸” ìƒì„±
**íŒŒì¼**: `backend/migrations/051_create_warranty_events_table.sql`

**âš ï¸ ì¤‘ìš”**: Outbox íŒ¨í„´ ì‚¬ìš© - íŠ¸ëœì­ì…˜ ë‚´ ìµœì†Œ ì´ë²¤íŠ¸ ê¸°ë¡, ìƒì„¸/í™•ì¥ì€ ë¹„ë™ê¸°

```sql
CREATE TABLE warranty_events (
    event_id BIGINT PRIMARY KEY AUTO_INCREMENT,
    event_type VARCHAR(50) NOT NULL COMMENT 'ì´ë²¤íŠ¸ íƒ€ì… (status_changed, ownership_transferred ë“±)',
    target_type VARCHAR(50) NOT NULL DEFAULT 'warranty' COMMENT 'ëŒ€ìƒ íƒ€ì…',
    target_id INT NOT NULL COMMENT 'warranty_id',
    actor_type ENUM('system', 'admin', 'user') NOT NULL COMMENT 'í–‰ìœ„ì íƒ€ì…',
    actor_id INT NULL COMMENT 'í–‰ìœ„ì ID (user_id ë˜ëŠ” admin_user_id)',
    metadata JSON COMMENT 'ì¶”ê°€ ì •ë³´ (from/to ìƒíƒœ, ì´ì „/ìƒˆ ì†Œìœ ì ë“±)',
    processed_at DATETIME NULL COMMENT 'ë¹„ë™ê¸° ì²˜ë¦¬ ì™„ë£Œ ì‹œê° (Outbox íŒ¨í„´)',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_target (target_type, target_id),
    INDEX idx_created_at (created_at),
    INDEX idx_unprocessed (processed_at),
    INDEX idx_event_type (event_type)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

**âš ï¸ Outbox íŒ¨í„´ ê·œì¹™**:
- **íŠ¸ëœì­ì…˜ ë‚´ ìµœì†Œ ì´ë²¤íŠ¸ ê¸°ë¡ í•„ìˆ˜**: ìƒíƒœ ì „ì´ì™€ ë™ì¼ íŠ¸ëœì­ì…˜ì—ì„œ ì´ë²¤íŠ¸ INSERT
- **ì´ë²¤íŠ¸ INSERT ì‹¤íŒ¨ ì‹œ ì „ì´ë„ ë¡¤ë°±**: ì¦ê±°ì„± ë³´ì¥
- **ìƒì„¸ ë¡œê·¸/ì™¸ë¶€ ì „ì†¡ì€ ë¹„ë™ê¸°ë¡œ**: íŠ¸ëœì­ì…˜ ì™¸ë¶€ì—ì„œ ì²˜ë¦¬

**ê¸°ë¡ ëŒ€ìƒ ì „ì´** (ëª¨ë‘ í•„ìˆ˜):
- `issued_unassigned` â†’ `issued` (claim) - `event_type: 'status_changed'`
- `issued` â†’ `active` (í™œì„±í™”) - `event_type: 'status_changed'`
- `active` â†’ `revoked` (í™˜ë¶ˆ) - `event_type: 'status_changed'`
- `revoked` â†’ `issued` (ì¬íŒë§¤) âš ï¸ **ì¤‘ìš”** - `event_type: 'status_changed'`
- `active` â†’ `suspended` (ì œì¬) - `event_type: 'status_changed'`
- `suspended` â†’ `issued` (ì œì¬ í•´ì œ) - `event_type: 'status_changed'`
- `active` â†’ `active` (ì–‘ë„, ì†Œìœ ìë§Œ ë³€ê²½) - `event_type: 'ownership_transferred'` âš ï¸ **íƒ€ì… ë¶„ë¦¬**

**ì™„ë£Œ ì¡°ê±´**: í…Œì´ë¸” ìƒì„± ì™„ë£Œ

#### 2-3. `warranty_transfers` í…Œì´ë¸” ìƒì„±
**íŒŒì¼**: `backend/migrations/052_create_warranty_transfers_table.sql`

```sql
CREATE TABLE warranty_transfers (
    transfer_id BIGINT PRIMARY KEY AUTO_INCREMENT,
    warranty_id INT NOT NULL COMMENT 'ì–‘ë„ ëŒ€ìƒ ë³´ì¦ì„œ',
    from_user_id INT NOT NULL COMMENT 'ì–‘ë„ ìš”ì²­ì (í˜„ì¬ ì†Œìœ ì)',
    to_email VARCHAR(255) NOT NULL COMMENT 'ìˆ˜ë ¹ì ì´ë©”ì¼',
    to_user_id INT NULL COMMENT 'ìˆ˜ë ¹ì user_id (ìˆ˜ë½ ì‹œì ì— ì„¤ì •)',
    transfer_code VARCHAR(7) NOT NULL UNIQUE COMMENT 'ëœë¤ 7ì ì½”ë“œ',
    status ENUM('requested', 'accepted', 'completed', 'cancelled', 'expired') DEFAULT 'requested',
    expires_at DATETIME NOT NULL COMMENT '72ì‹œê°„ í›„ ë§Œë£Œ ì‹œê°',
    requested_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    accepted_at DATETIME NULL,
    completed_at DATETIME NULL,
    cancelled_at DATETIME NULL,
    cancelled_by_user_id INT NULL COMMENT 'ì·¨ì†Œí•œ ì‚¬ìš©ì (ìš”ì²­ì ë˜ëŠ” ìˆ˜ë ¹ì)',
    FOREIGN KEY (warranty_id) REFERENCES warranties(warranty_id) ON DELETE RESTRICT,
    FOREIGN KEY (from_user_id) REFERENCES users(user_id) ON DELETE RESTRICT,
    FOREIGN KEY (to_user_id) REFERENCES users(user_id) ON DELETE SET NULL,
    INDEX idx_warranty_id (warranty_id),
    INDEX idx_from_user_id (from_user_id),
    INDEX idx_to_email (to_email),
    INDEX idx_transfer_code (transfer_code),
    INDEX idx_status (status),
    INDEX idx_expires_at (expires_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

**ì™„ë£Œ ì¡°ê±´**: í…Œì´ë¸” ìƒì„± ì™„ë£Œ

#### 2-4. `guest_order_access_tokens` í…Œì´ë¸” ìƒì„±
**íŒŒì¼**: `backend/migrations/053_create_guest_order_access_tokens_table.sql`

```sql
CREATE TABLE guest_order_access_tokens (
    token_id BIGINT PRIMARY KEY AUTO_INCREMENT,
    order_id INT NOT NULL COMMENT 'ì£¼ë¬¸ ID',
    token VARCHAR(100) NOT NULL UNIQUE COMMENT 'ì ‘ê·¼ í† í° (90ì¼ ìœ íš¨)',
    expires_at DATETIME NOT NULL COMMENT 'ë§Œë£Œ ì‹œê° (90ì¼ í›„)',
    revoked_at DATETIME NULL COMMENT 'íšŒìˆ˜ ì‹œê° (claim ì‹œ íšŒìˆ˜)',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (order_id) REFERENCES orders(order_id) ON DELETE RESTRICT,
    INDEX idx_order_id (order_id),
    INDEX idx_token (token),
    INDEX idx_expires_at (expires_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

**ì™„ë£Œ ì¡°ê±´**: í…Œì´ë¸” ìƒì„± ì™„ë£Œ

#### 2-5. `claim_tokens` í…Œì´ë¸” ìƒì„±
**íŒŒì¼**: `backend/migrations/054_create_claim_tokens_table.sql`

```sql
CREATE TABLE claim_tokens (
    token_id BIGINT PRIMARY KEY AUTO_INCREMENT,
    order_id INT NOT NULL COMMENT 'ì£¼ë¬¸ ID',
    token VARCHAR(100) NOT NULL UNIQUE COMMENT 'claim í† í° (15ë¶„ ìœ íš¨)',
    expires_at DATETIME NOT NULL COMMENT 'ë§Œë£Œ ì‹œê° (15ë¶„ í›„)',
    used_at DATETIME NULL COMMENT 'ì‚¬ìš© ì‹œê° (1íšŒì„±)',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (order_id) REFERENCES orders(order_id) ON DELETE RESTRICT,
    INDEX idx_order_id (order_id),
    INDEX idx_token (token),
    INDEX idx_expires_at (expires_at),
    INDEX idx_used_at (used_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

**ì™„ë£Œ ì¡°ê±´**: í…Œì´ë¸” ìƒì„± ì™„ë£Œ

#### 2-6. `shipments` í…Œì´ë¸” ìƒì„± (active_key íŒ¨í„´)
**íŒŒì¼**: `backend/migrations/055_create_shipments_table.sql`

```sql
CREATE TABLE shipments (
    shipment_id BIGINT PRIMARY KEY AUTO_INCREMENT,
    order_id INT NOT NULL COMMENT 'ì£¼ë¬¸ ID',
    carrier_code VARCHAR(20) NOT NULL COMMENT 'íƒë°°ì‚¬ ì½”ë“œ',
    tracking_number VARCHAR(100) NOT NULL COMMENT 'ì†¡ì¥ë²ˆí˜¸',
    active_key VARCHAR(150) GENERATED ALWAYS AS (
        CASE WHEN voided_at IS NULL THEN CONCAT(carrier_code, ':', tracking_number) ELSE NULL END
    ) VIRTUAL COMMENT 'ìœ íš¨ ì†¡ì¥ í‚¤',
    shipped_at DATETIME NULL COMMENT 'ë°œì†¡ ì‹œê°',
    created_by_admin_id INT NULL COMMENT 'ìƒì„±í•œ ê´€ë¦¬ì ID',
    voided_at DATETIME NULL COMMENT 'ë¬´íš¨í™” ì‹œê°',
    void_reason VARCHAR(500) NULL COMMENT 'ë¬´íš¨í™” ì‚¬ìœ ',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (order_id) REFERENCES orders(order_id) ON DELETE RESTRICT,
    FOREIGN KEY (carrier_code) REFERENCES carriers(code) ON DELETE RESTRICT,
    UNIQUE KEY uk_shipments_active_key (active_key),
    INDEX idx_order_id (order_id),
    INDEX idx_carrier_code (carrier_code),
    INDEX idx_tracking_number (tracking_number),
    INDEX idx_voided_at (voided_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

**ì™„ë£Œ ì¡°ê±´**: í…Œì´ë¸” ìƒì„± ì™„ë£Œ

#### 2-7. `shipment_units` í…Œì´ë¸” ìƒì„±
**íŒŒì¼**: `backend/migrations/056_create_shipment_units_table.sql`

**âš ï¸ ì¤‘ìš”**: Bì•ˆ í™•ì • (ìš´ì˜í˜•) - ì´ë ¥ í—ˆìš©, ë³µí•©í‚¤ ì‚¬ìš©

```sql
CREATE TABLE shipment_units (
    shipment_id BIGINT NOT NULL COMMENT 'ì†¡ì¥ ID',
    order_item_unit_id BIGINT NOT NULL COMMENT 'ì£¼ë¬¸ í•­ëª© ë‹¨ìœ„ ID',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (shipment_id, order_item_unit_id),
    FOREIGN KEY (shipment_id) REFERENCES shipments(shipment_id) ON DELETE RESTRICT,
    FOREIGN KEY (order_item_unit_id) REFERENCES order_item_units(order_item_unit_id) ON DELETE RESTRICT,
    INDEX idx_shipment_id (shipment_id),
    INDEX idx_order_item_unit_id (order_item_unit_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

**Bì•ˆ í™•ì • ê·œì¹™**:
1. **ì†¡ì¥ ìœ ë‹ˆí¬ ì •ì±…**: ìœ íš¨ shipment(`voided_at IS NULL`)ì— ëŒ€í•´ì„œë§Œ `(carrier_code, tracking_number)` ì¤‘ë³µ ê¸ˆì§€
2. **êµ¬í˜„**: generated column `active_key` + `UNIQUE(active_key)`
3. **shipmentsëŠ” ì‚­ì œ ê¸ˆì§€. voidë§Œ í—ˆìš©**
4. **replace(êµì²´)ëŠ” void + ì‹ ê·œ shipment ìƒì„± + shipment_units ì¬ë§¤í•‘ + current_shipment_id ê°±ì‹ ì„ í•œ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ìˆ˜í–‰**
5. **current_shipment_idê°€ NULLì´ ì•„ë‹ˆë©´, shipment_unitsì— `(current_shipment_id, order_item_unit_id)` í–‰ì´ ë°˜ë“œì‹œ ì¡´ì¬í•´ì•¼ í•¨**
6. **current_shipment_idëŠ” ìœ íš¨ shipment(`voided_at IS NULL`)ë§Œ ì°¸ì¡° ê°€ëŠ¥**
7. **delivered ì´í›„ replace ê¸ˆì§€. delivered ì´í›„ resendëŠ” "ì¶”ê°€ shipment ìƒì„±"ë§Œ í—ˆìš©**

**ì™„ë£Œ ì¡°ê±´**: í…Œì´ë¸” ìƒì„± ì™„ë£Œ

#### 2-8. `order_item_units.current_shipment_id` ì»¬ëŸ¼ ì¶”ê°€
**íŒŒì¼**: `backend/migrations/057_add_order_item_units_current_shipment_id.sql`

```sql
ALTER TABLE order_item_units
ADD COLUMN current_shipment_id BIGINT NULL
COMMENT 'í˜„ì¬ ìœ íš¨ ì†¡ì¥ (shipments í…Œì´ë¸” ìƒì„± í›„ FK ì¶”ê°€)'
AFTER unit_status;

ALTER TABLE order_item_units
ADD CONSTRAINT fk_order_item_units_current_shipment
FOREIGN KEY (current_shipment_id) REFERENCES shipments(shipment_id) ON DELETE RESTRICT;

CREATE INDEX idx_current_shipment_id ON order_item_units(current_shipment_id);
```

**ì™„ë£Œ ì¡°ê±´**: ì»¬ëŸ¼ ë° FK ì¶”ê°€ ì™„ë£Œ

#### 2-9. `order_item_units.active_lock` ì»¬ëŸ¼ ì¶”ê°€ (ì´ì¤‘ íŒë§¤ ë°©ì§€)
**íŒŒì¼**: `backend/migrations/058_add_order_item_units_active_lock.sql`

**âš ï¸ ì¤‘ìš”**: MySQL íŒ¨í„´ìœ¼ë¡œ ì´ì¤‘ íŒë§¤ ë°©ì§€

```sql
-- active_lock generated column ì¶”ê°€
ALTER TABLE order_item_units
ADD COLUMN active_lock INT GENERATED ALWAYS AS (
    CASE WHEN unit_status IN ('reserved', 'shipped', 'delivered') THEN 1 ELSE NULL END
) VIRTUAL COMMENT 'í™œì„± ë½ (ì´ì¤‘ íŒë§¤ ë°©ì§€)';

-- UNIQUE ì œì•½ ì¶”ê°€ (ì´ì¤‘ íŒë§¤ ë°©ì§€)
CREATE UNIQUE INDEX uk_order_item_units_stock_active_lock 
ON order_item_units(stock_unit_id, active_lock);
```

**âš ï¸ ìš´ì˜ ê·œì¹™**: ìœ„ ìƒíƒœ ì§‘í•©ì€ ì‹¤ì œ `order_item_units` í…Œì´ë¸”ì˜ ENUMê³¼ ì¼ì¹˜í•´ì•¼ í•˜ë©°, ì‹ ê·œ ìƒíƒœ ì¶”ê°€ ì‹œ `active_lock` ì •ì˜ë¥¼ ê°±ì‹ í•´ì•¼ í•œë‹¤.

**ì™„ë£Œ ì¡°ê±´**: ì»¬ëŸ¼ ë° UNIQUE ì œì•½ ì¶”ê°€ ì™„ë£Œ

#### 2-10. `orders.paid_at` ì»¬ëŸ¼ ì¶”ê°€
**íŒŒì¼**: `backend/migrations/059_add_orders_paid_at.sql`

**âš ï¸ ì¤‘ìš”**: `paid_at`ì€ ìºì‹œ/íŒŒìƒ í•„ë“œì´ë©°, `paid_events` ì¡´ì¬ê°€ SSOTì…ë‹ˆë‹¤.

```sql
ALTER TABLE orders
ADD COLUMN paid_at DATETIME NULL 
COMMENT 'ê²°ì œ ì™„ë£Œ ì‹œì  (paid_events ê¸°ë°˜, ìºì‹œ/íŒŒìƒ í•„ë“œ)' 
AFTER status;

CREATE INDEX idx_paid_at ON orders(paid_at);
```

**ë™ê¸°í™” ê·œì¹™**: `paid_events` ìƒì„± ì‹œ `paid_at`ë„ í•¨ê»˜ ì—…ë°ì´íŠ¸ (ë™ì¼ íŠ¸ëœì­ì…˜)
- **âš ï¸ ê¸ˆì§€**: `paid_events` ì¡´ì¬í•˜ì§€ë§Œ `paid_at`ì´ NULLì¸ ìƒíƒœëŠ” ê¸ˆì§€(ë™ê¸°í™” í•„ìˆ˜)

**ì™„ë£Œ ì¡°ê±´**: ì»¬ëŸ¼ ë° ì¸ë±ìŠ¤ ì¶”ê°€ ì™„ë£Œ

**ì˜ˆìƒ ì‘ì—… ì‹œê°„**: 6-8ì‹œê°„ (ë§ˆì´ê·¸ë ˆì´ì…˜ ì‘ì„± + ì‹¤í–‰ + ê²€ì¦)

**ì˜ì¡´ì„±**: 
- `order_item_units` í…Œì´ë¸” ì¡´ì¬ í•„ìˆ˜ (2-7)
- `carriers` í…Œì´ë¸” ì¡´ì¬ í•„ìˆ˜ (2-6)
- `token_pk` ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ ê¶Œì¥ (warranties FK ì „í™˜ ì‹œ í•„ìš”)

**ì™„ë£Œ ì¡°ê±´**:
- ëª¨ë“  í…Œì´ë¸” ìƒì„± ì™„ë£Œ
- FK ì œì•½ ì¶”ê°€ ì™„ë£Œ
- UNIQUE ì œì•½ ì¶”ê°€ ì™„ë£Œ (active_lock íŒ¨í„´)
- ê¸°ì¡´ ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ

---

### Phase 3: processPaidOrder() í•¨ìˆ˜ ì—…ë°ì´íŠ¸ (warranties ì»¬ëŸ¼ ë°˜ì˜)

**ëª©ì **: Phase 2ì—ì„œ ì¶”ê°€í•œ warranties ì»¬ëŸ¼ì„ processPaidOrder()ì— ë°˜ì˜

**âš ï¸ í•µì‹¬ ì›ì¹™**:
1. **ë½ ìˆœì„œ ì¤€ìˆ˜**: `stock_units`(ë¬¼ë¦¬) â†’ `orders`(ê²°ì œ) â†’ `warranties`(ê¶Œë¦¬) â†’ `invoices`(ë¬¸ì„œ)
2. **ë©±ë“±ì„± ë³´ì¥**: `paid_events` UNIQUE ì œì•½ìœ¼ë¡œ ì¬ì²˜ë¦¬ ë°©ì§€
3. **ì¬ê³  ë°°ì • ê·œì¹™**: ì˜¤ì§ `stock_units.status = 'in_stock'`ë§Œ ë°°ì •
4. **ë³´ì¦ì„œ ìƒì„± ê·œì¹™**: íšŒì›/ë¹„íšŒì› êµ¬ë¶„, `UNIQUE(token_pk)` ì œì•½
5. **ì¬íŒë§¤ ì²˜ë¦¬**: `revoked` ìƒíƒœ warranties ì—…ë°ì´íŠ¸ (ìƒˆ ë ˆì½”ë“œ ìƒì„± ì•ˆ í•¨)

**ì‘ì—…**:
1. **`backend/utils/paid-order-processor.js` ìˆ˜ì •**
   - `warranties` ìƒì„± ì‹œ `status`, `owner_user_id`, `source_order_item_unit_id` ì„¤ì •
   - íšŒì› ì£¼ë¬¸: `status = 'issued'`, `owner_user_id = orders.user_id`
   - ë¹„íšŒì› ì£¼ë¬¸: `status = 'issued_unassigned'`, `owner_user_id = NULL`
   - **ì¬íŒë§¤ ì²˜ë¦¬**: `revoked` ìƒíƒœ warranties ì—…ë°ì´íŠ¸ (ìƒˆ ë ˆì½”ë“œ ìƒì„± ì•ˆ í•¨)
     - `warranties.status` = `'issued'` ë˜ëŠ” `'issued_unassigned'` (ì£¼ë¬¸ì´ íšŒì›/ë¹„íšŒì›ì— ë”°ë¼)
     - `warranties.source_order_item_unit_id` = ìƒˆë¡œìš´ ì£¼ë¬¸ì˜ `order_item_unit_id`
     - `warranties.owner_user_id` = ìƒˆë¡œìš´ ì£¼ë¬¸ì˜ `user_id` (ë˜ëŠ” NULL)
     - **âš ï¸ ì›ìì  ì¡°ê±´**: `WHERE token_pk = ? AND status = 'revoked'` + `affectedRows=1` ê²€ì¦
     - **âš ï¸ revoked_at ìœ ì§€**: ì¬íŒë§¤ ì‹œì—ë„ `revoked_at`ì€ ê·¸ëŒ€ë¡œ ìœ ì§€ (Aì•ˆ í™•ì •, ì´ë ¥)

2. **ê¸ˆì•¡ ê²€ì¦ ì¶”ê°€** (FINAL_EXECUTION_SPEC_REVIEW.md 2088-2125ì¤„ ì°¸ì¡°)
   - ì„œë²„ì—ì„œ í™•ì •í•œ ì£¼ë¬¸ ê¸ˆì•¡ê³¼ ê²°ì œ ê¸ˆì•¡ ì¼ì¹˜ í™•ì¸
   - ë¶ˆì¼ì¹˜ ì‹œ `paid_events`ëŠ” ê¸°ë¡í•˜ë˜ ì£¼ë¬¸ ì²˜ë¦¬ëŠ” ì¤‘ë‹¨

3. **ë©±ë“±ì„± ì²´í¬ ê°•í™”**
   - `paid_events` INSERT ì‹œ `ER_DUP_ENTRY` ì—ëŸ¬ ì²˜ë¦¬
   - ì´ë¯¸ ì²˜ë¦¬ëœ ê²½ìš° ì¦‰ì‹œ ì¢…ë£Œ

**ì˜ˆìƒ ì‘ì—… ì‹œê°„**: 2-3ì‹œê°„

**ì˜ì¡´ì„±**: Phase 2-1 ì™„ë£Œ í•„ìˆ˜

**ì™„ë£Œ ì¡°ê±´**:
- `processPaidOrder()`ì—ì„œ warranties ìƒì„± ì‹œ ëª¨ë“  ì»¬ëŸ¼ ì„¤ì •
- íšŒì›/ë¹„íšŒì› êµ¬ë¶„ ì •ìƒ ë™ì‘
- ì¬íŒë§¤ ì²˜ë¦¬ ì •ìƒ ë™ì‘ (revoked â†’ issued ì „ì´)
- ê¸ˆì•¡ ê²€ì¦ ì •ìƒ ë™ì‘
- ë©±ë“±ì„± ì²´í¬ ì •ìƒ ë™ì‘

---

### Phase 4: ì„ ì˜ˆì•½í˜• ì¬ê³  ê´€ë¦¬ êµ¬í˜„ (GPT ì œì•ˆ ë°˜ì˜)

**ëª©ì **: ê²°ì œ ì§„í–‰ ì¤‘ ì¬ê³  ì˜ˆì•½ (ë” ì•ˆì „í•œ ë°©ì‹)

**í˜„ì¬ ë°©ì‹ (Paid ì‹œì  ì˜ˆì•½)**:
```
1. ì£¼ë¬¸ ìƒì„± (orders í…Œì´ë¸”ì— pending ìƒíƒœë¡œ ì €ì¥)
2. ê²°ì œ ì§„í–‰ (ì¬ê³  ì˜ˆì•½ ì—†ìŒ)
3. Paid ì²˜ë¦¬ ì‹œ â†’ ì¬ê³  ì˜ˆì•½ (reserved)
```

**ì„ ì˜ˆì•½í˜• (ê²°ì œ ì§„í–‰ ì¤‘ ì˜ˆì•½)**:
```
1. ì£¼ë¬¸ ìƒì„± (orders í…Œì´ë¸”ì— pending ìƒíƒœë¡œ ì €ì¥)
2. "ê²°ì œ ì§„í–‰" í´ë¦­ ì‹œ â†’ ì¬ê³  ì˜ˆì•½ (reserved)
3. ê²°ì œ ìŠ¹ì¸ ì„±ê³µ â†’ reserved ìœ ì§€ (ë˜ëŠ” soldë¡œ ì „í™˜)
4. ê²°ì œ ì‹¤íŒ¨/ì·¨ì†Œ/íƒ€ì„ì•„ì›ƒ â†’ reserved â†’ in_stock (ì˜ˆì•½ í•´ì œ)
```

**ì‘ì—…**:

#### 4-1. ì£¼ë¬¸ ìƒì„± ì‹œ ì¬ê³  ì˜ˆì•½ ë¡œì§ ì¶”ê°€
**íŒŒì¼**: `backend/order-routes.js`

**ìˆ˜ì • ìœ„ì¹˜**: `POST /api/orders` ë¼ìš°íŠ¸

**ì¶”ê°€ ë¡œì§**:
```javascript
// ì£¼ë¬¸ ìƒì„± í›„, ì¬ê³  ì˜ˆì•½ (ì„ ì˜ˆì•½í˜•)
async function reserveStockForOrder(connection, orderId, orderItems) {
    await connection.beginTransaction();
    try {
        // ì£¼ë¬¸ ì ê¸ˆ
        await connection.execute(
            'SELECT * FROM orders WHERE order_id = ? FOR UPDATE',
            [orderId]
        );
        
        // ê° order_itemë³„ë¡œ ì¬ê³  ì˜ˆì•½
        for (const item of orderItems) {
            const { product_id, size, color, quantity } = item;
            
            // ì¬ê³  ì„ íƒ ë° ì˜ˆì•½ (FOR UPDATE SKIP LOCKED)
            const [stockUnits] = await connection.execute(
                `SELECT stock_unit_id, token_pk
                 FROM stock_units
                 WHERE product_id = ?
                   AND status = 'in_stock'
                   AND (size = ? OR size IS NULL)
                   AND (color = ? OR color IS NULL)
                 ORDER BY stock_unit_id
                 LIMIT ?
                 FOR UPDATE SKIP LOCKED`,
                [product_id, size, color, quantity]
            );
            
            if (stockUnits.length < quantity) {
                throw new Error(`ì¬ê³  ë¶€ì¡±: ìƒí’ˆ ${product_id}, í•„ìš”: ${quantity}, ê°€ìš©: ${stockUnits.length}`);
            }
            
            // ì¬ê³  ìƒíƒœ ì—…ë°ì´íŠ¸ (reservedë¡œ ë³€ê²½)
            for (const stockUnit of stockUnits) {
                const [updateResult] = await connection.execute(
                    `UPDATE stock_units
                     SET status = 'reserved',
                         reserved_at = NOW(),
                         reserved_by_order_id = ?
                     WHERE stock_unit_id = ?`,
                    [orderId, stockUnit.stock_unit_id]
                );
                
                if (updateResult.affectedRows !== 1) {
                    throw new Error(`ì¬ê³  ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: stock_unit_id=${stockUnit.stock_unit_id}`);
                }
            }
        }
        
        await connection.commit();
    } catch (error) {
        await connection.rollback();
        throw error;
    }
}
```

**ì˜ˆìƒ ì‘ì—… ì‹œê°„**: 3-4ì‹œê°„

**ì˜ì¡´ì„±**: Phase 2 ì™„ë£Œ í•„ìˆ˜

**ì™„ë£Œ ì¡°ê±´**:
- ì£¼ë¬¸ ìƒì„± ì‹œ ì¬ê³  ì˜ˆì•½ ì •ìƒ ë™ì‘
- ì¬ê³  ë¶€ì¡± ì‹œ ì£¼ë¬¸ ìƒì„± ì‹¤íŒ¨
- ë™ì‹œì„± í…ŒìŠ¤íŠ¸ í†µê³¼

#### 4-2. ì˜ˆì•½ í•´ì œ ë¡œì§ êµ¬í˜„
**íŒŒì¼**: `backend/order-routes.js` ë˜ëŠ” `backend/utils/stock-reservation-manager.js`

**âš ï¸ ì¤‘ìš”**: SSOT ì›ì¹™ ì¤€ìˆ˜ - `orders.status`ê°€ ì•„ë‹Œ `paid_events`/`paid_at` ê¸°ì¤€ìœ¼ë¡œ íŒì •

**ì‹œë‚˜ë¦¬ì˜¤**:
1. ê²°ì œ ì‹¤íŒ¨ ì‹œ ì˜ˆì•½ í•´ì œ
2. ê²°ì œ ì·¨ì†Œ ì‹œ ì˜ˆì•½ í•´ì œ
3. ê²°ì œ íƒ€ì„ì•„ì›ƒ ì‹œ ì˜ˆì•½ í•´ì œ (ë°°ì¹˜ ì‘ì—…)

**êµ¬í˜„** (ì´ë²¤íŠ¸ ê¸°ë°˜ í•´ì œ - ê¶Œì¥):
```javascript
// ê²°ì œ ì‹¤íŒ¨/ì·¨ì†Œ ì´ë²¤íŠ¸ ìˆ˜ì‹  ì‹œ ì¦‰ì‹œ í•´ì œ
router.post('/payments/cancel', async (req, res) => {
  const { order_id } = req.body;
  
  await connection.execute(
    `UPDATE stock_units 
     SET status = 'in_stock', 
         reserved_at = NULL, 
         reserved_by_order_id = NULL
     WHERE reserved_by_order_id = ? AND status = 'reserved'`,
    [order_id]
  );
});
```

**êµ¬í˜„** (ë°°ì¹˜ ì‘ì—… - ë°±ì—…, SSOT ì›ì¹™ ì¤€ìˆ˜):
```javascript
// cron job ë˜ëŠ” scheduled task
async function releaseExpiredReservations() {
  const expiredTime = new Date(Date.now() - 30 * 60 * 1000); // 30ë¶„ ì „
  
  // âš ï¸ SSOT ì›ì¹™: orders.statusê°€ ì•„ë‹Œ paid_events/paid_at ê¸°ì¤€ìœ¼ë¡œ íŒì •
  await connection.execute(
    `UPDATE stock_units su
     LEFT JOIN orders o ON su.reserved_by_order_id = o.order_id
     LEFT JOIN paid_events pe ON o.order_id = pe.order_id
     SET su.status = 'in_stock',
         su.reserved_at = NULL,
         su.reserved_by_order_id = NULL
     WHERE su.status = 'reserved'
       AND su.reserved_at < ?
       AND (pe.order_id IS NULL OR o.paid_at IS NULL)`,  -- âœ… paid_events/paid_at ê¸°ì¤€
    [expiredTime]
  );
}
```

**ê¶Œì¥**: ì˜µì…˜ A + ì˜µì…˜ B ë³‘í–‰
- ì´ë²¤íŠ¸ ê¸°ë°˜ í•´ì œê°€ ì£¼ ë°©ì‹
- ë°°ì¹˜ ì‘ì—…ì€ ë°±ì—…/ì•ˆì „ë§
- **ë°˜ë“œì‹œ `paid_events` ì¡´ì¬ ì—¬ë¶€ ë˜ëŠ” `paid_at` ê¸°ì¤€ìœ¼ë¡œ íŒì •** (orders.status ì‚¬ìš© ê¸ˆì§€)

**ì˜ˆìƒ ì‘ì—… ì‹œê°„**: 2-3ì‹œê°„

**ì˜ì¡´ì„±**: Phase 4-1 ì™„ë£Œ í•„ìˆ˜

**ì™„ë£Œ ì¡°ê±´**:
- ê²°ì œ ì‹¤íŒ¨ ì‹œ ì˜ˆì•½ í•´ì œ ì •ìƒ ë™ì‘
- ë°°ì¹˜ ì‘ì—…ìœ¼ë¡œ ë§Œë£Œëœ ì˜ˆì•½ í•´ì œ
- SSOT ì›ì¹™ ì¤€ìˆ˜ í™•ì¸

#### 4-3. processPaidOrder() ìˆ˜ì • (ì„ ì˜ˆì•½í˜• ëŒ€ì‘)
**íŒŒì¼**: `backend/utils/paid-order-processor.js`

**ìˆ˜ì • ë‚´ìš©**:
- ì´ë¯¸ ì˜ˆì•½ëœ ì¬ê³ ë¥¼ ì‚¬ìš© (ìƒˆë¡œ ì˜ˆì•½í•˜ì§€ ì•ŠìŒ)
- `reserved_by_order_id = orderId`ì¸ ì¬ê³ ë§Œ ì‚¬ìš©
- ì˜ˆì•½ë˜ì§€ ì•Šì€ ì¬ê³ ê°€ ìˆìœ¼ë©´ ì—ëŸ¬ (ì´ë¡ ì ìœ¼ë¡œ ë°œìƒí•˜ì§€ ì•Šì•„ì•¼ í•¨)

**ì˜ˆìƒ ì‘ì—… ì‹œê°„**: 1-2ì‹œê°„

**ì˜ì¡´ì„±**: Phase 4-1 ì™„ë£Œ í•„ìˆ˜

**ì™„ë£Œ ì¡°ê±´**:
- ì˜ˆì•½ëœ ì¬ê³ ë§Œ ì‚¬ìš©
- ì˜ˆì•½ë˜ì§€ ì•Šì€ ì¬ê³  ê°ì§€ ì‹œ ì—ëŸ¬ ì²˜ë¦¬

---

### Phase 5: ë³´ì¦ì„œ í™œì„±í™” API êµ¬í˜„

**ëª©ì **: ì²« í™œì„±í™” ì‹œ ì¸ë³´ì´ìŠ¤ ì—°ë™ í™•ì¸ (í•µì‹¬ ë°©ì–´ ë©”ì»¤ë‹ˆì¦˜)

**ì‘ì—…**:

#### 5-1. í™œì„±í™” API êµ¬í˜„
**íŒŒì¼**: `backend/warranty-routes.js` (ì‹ ê·œ ìƒì„± ë˜ëŠ” ê¸°ì¡´ íŒŒì¼ ìˆ˜ì •)

**API ì—”ë“œí¬ì¸íŠ¸**: `POST /api/warranties/:warrantyId/activate`

**ìš”ì²­ ë³¸ë¬¸**:
```json
{
  "agree": true
}
```

**ì²˜ë¦¬ íë¦„** (SYSTEM_FLOW_DETAILED.md 4-1ì ˆ ì°¸ì¡°):
1. **FOR UPDATEë¡œ warranties ì ê¸ˆ**
   ```sql
   SELECT * FROM warranties WHERE warranty_id = ? FOR UPDATE
   ```

2. `warranties.owner_user_id = í˜„ì¬ ë¡œê·¸ì¸í•œ user_id` í™•ì¸
3. `warranties.status = 'issued'` í™•ì¸ (ë‹¤ë¥¸ ìƒíƒœì—ì„œ í™œì„±í™” ë¶ˆê°€)
4. **í•µì‹¬ ê²€ì¦: ì¸ë³´ì´ìŠ¤ ì—°ë™ í™•ì¸** (ì²« í™œì„±í™” ì‹œì—ë§Œ ì ìš©)
   ```sql
   SELECT o.user_id, o.status, oiu.unit_status
   FROM warranties w
   JOIN order_item_units oiu ON w.source_order_item_unit_id = oiu.order_item_unit_id
   JOIN order_items oi ON oiu.order_item_id = oi.order_item_id
   JOIN orders o ON oi.order_id = o.order_id
   WHERE w.warranty_id = ?
   ```
   - `orders.user_id = í˜„ì¬ ë¡œê·¸ì¸í•œ user_id` í™•ì¸ (ì¸ë³´ì´ìŠ¤ê°€ ê³„ì •ì— ì—°ë™ë˜ì–´ ìˆëŠ”ì§€)
   - `orders.status != 'refunded'` í™•ì¸ (í™˜ë¶ˆëœ ì£¼ë¬¸ì´ ì•„ë‹Œì§€)
   - `order_item_units.unit_status != 'refunded'` í™•ì¸
   - **âš ï¸ ì´ê²ƒì´ í™˜ë¶ˆ í›„ QR ì½”ë“œ ì•…ìš© ë°©ì§€ì˜ í•µì‹¬ ë°©ì–´ ë©”ì»¤ë‹ˆì¦˜**

5. ë™ì˜ ì²´í¬ í™•ì¸ (`agree: true`)
6. **ì›ìì  ì¡°ê±´ìœ¼ë¡œ ìƒíƒœ ì „ì´**:
   ```sql
   UPDATE warranties 
   SET status = 'active', activated_at = NOW()
   WHERE warranty_id = ? AND status = 'issued' AND owner_user_id = ?
   ```
   - **âš ï¸ affectedRows=1 ê²€ì¦ í•„ìˆ˜**
7. `warranty_events`ì— í™œì„±í™” ì´ë²¤íŠ¸ ê¸°ë¡ (`event_type: 'status_changed'`)
   - **âš ï¸ ì´ë²¤íŠ¸ INSERT ì‹¤íŒ¨ ì‹œ ì „ì´ë„ ë¡¤ë°± (Outbox íŒ¨í„´)**

**ì˜ˆìƒ ì‘ì—… ì‹œê°„**: 3-4ì‹œê°„

**ì˜ì¡´ì„±**: Phase 2-1, Phase 2-2 ì™„ë£Œ í•„ìˆ˜

**ì™„ë£Œ ì¡°ê±´**:
- í™œì„±í™” API ì •ìƒ ë™ì‘
- ì¸ë³´ì´ìŠ¤ ì—°ë™ í™•ì¸ ì •ìƒ ë™ì‘
- í™˜ë¶ˆëœ ì£¼ë¬¸ì˜ ë³´ì¦ì„œ í™œì„±í™” ì°¨ë‹¨
- ì´ë²¤íŠ¸ ë¡œê¹… ì •ìƒ

---

### Phase 6: Claim API êµ¬í˜„ (ë¹„íšŒì› â†’ íšŒì› ì „í™˜)

**ëª©ì **: ë¹„íšŒì› ì£¼ë¬¸ì„ íšŒì› ê³„ì •ì— ì—°ë™

**ì‘ì—…**:

#### 6-1. Claim Token ë°œê¸‰ API
**íŒŒì¼**: `backend/order-routes.js`

**API ì—”ë“œí¬ì¸íŠ¸**: `POST /api/orders/:orderId/claim-token`

**ì²˜ë¦¬ íë¦„**:
1. `guest_order_access_token` ê²€ì¦ (ì¿ í‚¤ ë˜ëŠ” ì„¸ì…˜)
2. ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
3. `claim_token` ìƒì„± (15ë¶„ ìœ íš¨)
4. `claim_tokens` í…Œì´ë¸”ì— ì €ì¥
5. í† í° ë°˜í™˜

**ì˜ˆìƒ ì‘ì—… ì‹œê°„**: 2ì‹œê°„

**ì˜ì¡´ì„±**: Phase 2-5 ì™„ë£Œ í•„ìˆ˜

**ì™„ë£Œ ì¡°ê±´**:
- Claim token ë°œê¸‰ ì •ìƒ ë™ì‘
- ë§Œë£Œ ì‹œê°„ ì„¤ì • ì •ìƒ

#### 6-2. Claim API êµ¬í˜„
**íŒŒì¼**: `backend/order-routes.js`

**API ì—”ë“œí¬ì¸íŠ¸**: `POST /api/orders/:orderId/claim`

**ìš”ì²­ ë³¸ë¬¸**:
```json
{
  "claim_token": "abc123..."
}
```

**ì²˜ë¦¬ íë¦„** (SYSTEM_FLOW_DETAILED.md 3-2ì ˆ ì°¸ì¡°):
1. **3-Factor Atomic Check**:
   ```sql
   UPDATE claim_tokens
   SET used_at = NOW()
   WHERE token = ?
     AND order_id = ?        -- ë°”ì¸ë”© í™•ì¸
     AND used_at IS NULL     -- 1íšŒì„± í™•ì¸
     AND expires_at > NOW(); -- ë§Œë£Œ í™•ì¸
   ```
   - ë°˜ë“œì‹œ **`affectedRows=1`** í™•ì¸ í›„ ë¡œì§ ì§„í–‰
2. `orders.user_id` = í˜„ì¬ ë¡œê·¸ì¸í•œ `user_id`ë¡œ ì—…ë°ì´íŠ¸
3. `orders.guest_id` = **ìœ ì§€** (ê°ì‚¬ ë¡œê·¸)
4. í•´ë‹¹ ì£¼ë¬¸ì˜ ëª¨ë“  `warranties.status` = `'issued_unassigned'` â†’ `'issued'`ë¡œ ì—…ë°ì´íŠ¸
5. `warranties.owner_user_id` = í˜„ì¬ ë¡œê·¸ì¸í•œ `user_id`ë¡œ ì—…ë°ì´íŠ¸
6. `guest_order_access_token` íšŒìˆ˜ (revoked_at ì„¤ì •)

**ì˜ˆìƒ ì‘ì—… ì‹œê°„**: 3-4ì‹œê°„

**ì˜ì¡´ì„±**: Phase 6-1 ì™„ë£Œ í•„ìˆ˜

**ì™„ë£Œ ì¡°ê±´**:
- Claim API ì •ìƒ ë™ì‘
- 3-Factor Atomic Check ì •ìƒ ë™ì‘
- warranties ìƒíƒœ ì „ì´ ì •ìƒ
- guest_order_access_token íšŒìˆ˜ ì •ìƒ

---

### Phase 7: QR ìŠ¤ìº” ë¡œì§ ìˆ˜ì •

**ëª©ì **: QR ìŠ¤ìº” ì‹œ warranty ìƒì„± ì œê±°, ì¡°íšŒë§Œ ìˆ˜í–‰

**ì‘ì—…**:

#### 7-1. QR ìŠ¤ìº” ë¡œì§ ìˆ˜ì •
**íŒŒì¼**: `backend/auth-routes.js`

**í˜„ì¬ êµ¬í˜„** (COMPREHENSIVE_SPEC_ANALYSIS.md ì°¸ì¡°):
- QR ìŠ¤ìº” ì‹œ warranty ìƒì„± (ì²« ìŠ¤ìº” ì‹œ)

**ìˆ˜ì • í›„**:
- QR ìŠ¤ìº” ì‹œ warranty ì¡°íšŒë§Œ ìˆ˜í–‰
- warrantyê°€ ì—†ìœ¼ë©´ ì—ëŸ¬ (paid ì²˜ë¦¬ ì‹œ ìƒì„±ë˜ì–´ì•¼ í•¨)
- warranty ìƒíƒœ í™•ì¸ (`status = 'revoked'`ë©´ ì ‘ê·¼ ê±°ë¶€)

**ì˜ˆìƒ ì‘ì—… ì‹œê°„**: 2-3ì‹œê°„

**ì˜ì¡´ì„±**: Phase 2-1 ì™„ë£Œ í•„ìˆ˜

**ì™„ë£Œ ì¡°ê±´**:
- QR ìŠ¤ìº” ì‹œ warranty ìƒì„± ì œê±°
- warranty ì¡°íšŒë§Œ ìˆ˜í–‰
- revoked ìƒíƒœ ë³´ì¦ì„œ ì ‘ê·¼ ê±°ë¶€

---

### Phase 8: ì–‘ë„ ì‹œìŠ¤í…œ êµ¬í˜„

**ëª©ì **: í™œì„±í™”ëœ ë³´ì¦ì„œ ì–‘ë„ (ì‚¬ìš©ì ê°„)

**ì‘ì—…**:

#### 8-1. ì–‘ë„ ìš”ì²­ API
**íŒŒì¼**: `backend/warranty-routes.js`

**API ì—”ë“œí¬ì¸íŠ¸**: `POST /api/warranties/:warrantyId/transfer`

**ìš”ì²­ ë³¸ë¬¸**:
```json
{
  "to_email": "recipient@example.com"
}
```

**ì²˜ë¦¬ íë¦„** (SYSTEM_FLOW_DETAILED.md 5-1ì ˆ ì°¸ì¡°):
1. `warranties.owner_user_id = í˜„ì¬ ë¡œê·¸ì¸í•œ user_id` í™•ì¸
2. `warranties.status = 'active'` í™•ì¸
3. ëœë¤ 7ì ì½”ë“œ ìƒì„± (72ì‹œê°„ ìœ íš¨)
4. `warranty_transfers` í…Œì´ë¸”ì— ì–‘ë„ ìš”ì²­ ê¸°ë¡
5. ì–‘ë„ ë§í¬ë¥¼ ì´ë©”ì¼ë¡œ ìˆ˜ë ¹ìì—ê²Œ ì „ì†¡

**ì˜ˆìƒ ì‘ì—… ì‹œê°„**: 4-5ì‹œê°„

**ì˜ì¡´ì„±**: Phase 2-3 ì™„ë£Œ í•„ìˆ˜

**ì™„ë£Œ ì¡°ê±´**:
- ì–‘ë„ ìš”ì²­ API ì •ìƒ ë™ì‘
- ì´ë©”ì¼ ë°œì†¡ ì •ìƒ
- ë§Œë£Œ ì‹œê°„ ì„¤ì • ì •ìƒ

#### 8-2. ì–‘ë„ ìˆ˜ë½ API
**íŒŒì¼**: `backend/warranty-routes.js`

**API ì—”ë“œí¬ì¸íŠ¸**: `POST /api/warranties/transfer/accept`

**ìš”ì²­ ë³¸ë¬¸**:
```json
{
  "transfer_id": 1,
  "transfer_code": "ABC1234"
}
```

**ì²˜ë¦¬ íë¦„** (SYSTEM_FLOW_DETAILED.md 5-1ì ˆ ì°¸ì¡°):
1. **íŠ¸ëœì­ì…˜ ì‹œì‘**
2. **ì›ìì  ì¡°ê±´ ê²€ì¦**:
   - `warranty_transfers.status = 'requested'` AND `expires_at > NOW()` (FOR UPDATEë¡œ ì ê¸ˆ)
   - ì½”ë“œ ê²€ì¦ (`transfer_code` ì¼ì¹˜ í™•ì¸)
   - ì´ë©”ì¼ ì¼ì¹˜ ê²€ì¦ (`to_email` = ë¡œê·¸ì¸í•œ ê³„ì • ì´ë©”ì¼)
   - í˜„ì¬ ì†Œìœ ì ì¼ì¹˜ í™•ì¸ (ìš”ì²­ ìƒì„± ì‹œì ê³¼ ìˆ˜ë½ ì‹œì  ì¼ì¹˜ ê²€ì¦)
3. **warranties ì†Œìœ ì ë³€ê²½ (ì›ìì  ì¡°ê±´)**:
   ```sql
   UPDATE warranties
   SET owner_user_id = ?
   WHERE warranty_id = ? 
   AND owner_user_id = ?
   AND status = 'active'
   ```
   - **âš ï¸ affectedRows=1 ê²€ì¦ í•„ìˆ˜**
4. **transfer ìƒíƒœ ë³€ê²½ (ì›ìì  ì¡°ê±´)**:
   ```sql
   UPDATE warranty_transfers
   SET status = 'completed',
       to_user_id = ?,
       completed_at = NOW()
   WHERE transfer_id = ?
   AND status = 'requested'
   ```
   - **âš ï¸ affectedRows=1 ê²€ì¦ í•„ìˆ˜**
5. **`warranties.status`ëŠ” `'active'` ìƒíƒœë¡œ ìœ ì§€** (ì¬í™œì„±í™” ë¶ˆí•„ìš”)
6. `warranty_events`ì— ì–‘ë„ ì´ë²¤íŠ¸ ê¸°ë¡ (`event_type: 'ownership_transferred'`) âš ï¸ **ì´ë²¤íŠ¸ íƒ€ì… ë¶„ë¦¬**
   - **âš ï¸ ì´ë²¤íŠ¸ INSERT ì‹¤íŒ¨ ì‹œ ì „ì´ë„ ë¡¤ë°± (Outbox íŒ¨í„´)**
7. **COMMIT**

**âš ï¸ ì–‘ë„ í›„ ì†Œìœ ê¶Œ ì •ì±…**:
- **1í† í° = 1ì†Œìœ ì í•„ìˆ˜ ì¡°ê±´**: í•œ í† í°ì€ ë™ì‹œì— í•œ ëª…ì˜ ì†Œìœ ìë§Œ ê°€ì§ˆ ìˆ˜ ìˆìŒ
- **ì–‘ë„ í›„ ì›ë˜ ì†Œìœ ìëŠ” ë” ì´ìƒ ê·¸ ë³´ì¦ì„œì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŒ**
- **ìƒˆ ì†Œìœ ìëŠ” ì¦‰ì‹œ ë³´ì¦ì„œ ì‚¬ìš© ê°€ëŠ¥** (`active` ìƒíƒœ ìœ ì§€, ì¬í™œì„±í™” ë¶ˆí•„ìš”)
- **ì¸ë³´ì´ìŠ¤ ì—°ë™ í™•ì¸ ë¶ˆí•„ìš”**: ì–‘ë„ ë°›ì€ ë³´ì¦ì„œëŠ” ì´ë¯¸ `active` ìƒíƒœì´ë¯€ë¡œ ì¸ë³´ì´ìŠ¤ ì—°ë™ í™•ì¸ ì—†ì´ ë°”ë¡œ ì‚¬ìš© ê°€ëŠ¥

**ì˜ˆìƒ ì‘ì—… ì‹œê°„**: 4-5ì‹œê°„

**ì˜ì¡´ì„±**: Phase 8-1 ì™„ë£Œ í•„ìˆ˜

**ì™„ë£Œ ì¡°ê±´**:
- ì–‘ë„ ìˆ˜ë½ API ì •ìƒ ë™ì‘
- ì›ìì  ì¡°ê±´ ê²€ì¦ ì •ìƒ
- ì´ë²¤íŠ¸ ë¡œê¹… ì •ìƒ

#### 8-3. ì–‘ë„ ë§Œë£Œ ë°°ì¹˜ ì‘ì—…
**íŒŒì¼**: `backend/utils/warranty-transfer-cleanup.js`

**ì‘ì—…**: 72ì‹œê°„ ì´ˆê³¼ ì–‘ë„ ìš”ì²­ ìë™ ë§Œë£Œ

**ì˜ˆìƒ ì‘ì—… ì‹œê°„**: 1-2ì‹œê°„

**ì˜ì¡´ì„±**: Phase 8-1 ì™„ë£Œ í•„ìˆ˜

**ì™„ë£Œ ì¡°ê±´**:
- ë°°ì¹˜ ì‘ì—… ì •ìƒ ë™ì‘
- ë§Œë£Œëœ ìš”ì²­ ìë™ ì²˜ë¦¬

---

### Phase 9: í™˜ë¶ˆ ì²˜ë¦¬ API êµ¬í˜„ (ê´€ë¦¬ì ì „ìš©)

**ëª©ì **: ê´€ë¦¬ìê°€ í™˜ë¶ˆ ì²˜ë¦¬ (ê³ ê° ì§ì ‘ ìš”ì²­ ë¶ˆê°€)

**ì‘ì—…**:

#### 9-1. í™˜ë¶ˆ ì²˜ë¦¬ API
**íŒŒì¼**: `backend/admin-routes.js` ë˜ëŠ” `backend/refund-routes.js`

**API ì—”ë“œí¬ì¸íŠ¸**: `POST /api/admin/refunds/process`

**ìš”ì²­ ë³¸ë¬¸**:
```json
{
  "warranty_id": 1,
  "reason": "ê³ ê° ìš”ì²­"
}
```

**ì²˜ë¦¬ íë¦„** (SYSTEM_FLOW_DETAILED.md 6-2ì ˆ ì°¸ì¡°):
1. **í™˜ë¶ˆ ì ‘ìˆ˜ ë°©ì‹ (í™•ì •)**:
   - âŒ **ê³ ê° ì§ì ‘ í™˜ë¶ˆ ìš”ì²­ ë¶ˆê°€**: ê³ ê°ì´ ë²„íŠ¼ì´ë‚˜ APIë¡œ ì§ì ‘ í™˜ë¶ˆ ìš”ì²­í•  ìˆ˜ ì—†ìŒ
   - âœ… **ë¬¸ì˜ ì‹œìŠ¤í…œìœ¼ë¡œë§Œ ì ‘ìˆ˜**: ê³ ê° ë¬¸ì˜(`inquiries`)ì— í™˜ë¶ˆ ìš”ì²­ì´ ë“¤ì–´ì˜¤ë©´ ê´€ë¦¬ìê°€ í™•ì¸
   - âœ… **ê´€ë¦¬ì ìˆ˜ë™ ì²˜ë¦¬**: ê´€ë¦¬ì í˜ì´ì§€ì—ì„œ í™•ì¸ í›„ ìˆ˜ë™ìœ¼ë¡œ í™˜ë¶ˆ ì²˜ë¦¬

2. **í™˜ë¶ˆ ê°€ëŠ¥ íŒì •**: `warranties.status`ë§Œ ë³¸ë‹¤ (SSOT)
   - `revoked` â†’ ê±°ë¶€ (ì´ë¯¸ í™˜ë¶ˆ ì™„ë£Œ)
   - `active` â†’ ê±°ë¶€ (í™œì„±í™”ëœ ë³´ì¦ì„œëŠ” í™˜ë¶ˆ ë¶ˆê°€)
   - `issued` / `issued_unassigned` â†’ í—ˆìš© (ì •ì±… ë²”ìœ„ ë‚´)
   - âŒ `orders.status`ë¡œ íŒë‹¨ ê¸ˆì§€
   - âŒ `unit_status`ë¡œ íŒë‹¨ ê¸ˆì§€

3. **ì›ìì  ì¡°ê±´ìœ¼ë¡œ ìƒíƒœ ì „ì´**:
   ```sql
   UPDATE warranties 
   SET status = 'revoked', revoked_at = NOW()
   WHERE warranty_id = ? AND status IN ('issued', 'issued_unassigned')
   ```
   - **âš ï¸ affectedRows=1 ê²€ì¦ í•„ìˆ˜**

4. `order_item_units.unit_status` = `'refunded'` ì—…ë°ì´íŠ¸
5. ì¬ê³  ìƒíƒœ: `stock_units.status` â†’ `'in_stock'` (ì¬íŒë§¤ ê°€ëŠ¥)
6. **credit_note ìƒì„±** (`invoices` í…Œì´ë¸”, `type='credit_note'`)
   - `related_invoice_id`: ì›ë³¸ invoice_id
   - `invoice_number`: `PM-CN-YYMMDD-HHmmss-{ëœë¤}` í˜•ì‹ (credit note ë²ˆí˜¸)
   - `payload_json`: í™˜ë¶ˆ ëŒ€ìƒ unit ì‹ë³„ì(`order_item_unit_id` ë¦¬ìŠ¤íŠ¸), í™˜ë¶ˆ ê¸ˆì•¡/ì„¸ê¸ˆ/í†µí™”, í™˜ë¶ˆ ì‚¬ìœ , í™˜ë¶ˆ íŠ¸ëœì­ì…˜ í‚¤(`payment_key`) í¬í•¨
   - `order_snapshot_hash`: `payload_json` í•´ì‹œ (ìœ„ë³€ì¡°/ë™ì¼ë¬¸ì„œ íŒë³„)
   - `version`: ì¸ë³´ì´ìŠ¤ í…œí”Œë¦¿ ë²„ì „ (PDF ì–‘ì‹ ë³€ê²½ ëŒ€ë¹„)
   - **ë¶€ë¶„ í™˜ë¶ˆ ì§€ì›**: ì›ë³¸ 1ì¥ì— ì—¬ëŸ¬ credit_note ê°€ëŠ¥ (`related_invoice_id`ëŠ” 1:N í—ˆìš©)
   - **UNIQUE(invoice_number) ì¶©ëŒ ì‹œ**: ì¬ì‹œë„ 1~2íšŒë¡œ ìƒˆ ë²ˆí˜¸ ì¬ë°œê¸‰, ì‹¤íŒ¨ ì‹œ ì¥ì•  ë³´ê³ 
7. `warranty_events`ì— í™˜ë¶ˆ ì´ë²¤íŠ¸ ê¸°ë¡ (`event_type: 'status_changed'`)
   - **âš ï¸ ì´ë²¤íŠ¸ INSERT ì‹¤íŒ¨ ì‹œ ì „ì´ë„ ë¡¤ë°± (Outbox íŒ¨í„´)**

8. `orders.status` ì§‘ê³„ í•¨ìˆ˜ë¡œ ìë™ ì—…ë°ì´íŠ¸
   - **âš ï¸ ë¶€ë¶„ í™˜ë¶ˆ ì •ì±…**: ì¼ë¶€ unitë§Œ `refunded` â†’ ë°°ì†¡ ìƒíƒœ ìœ ì§€ (`partial_shipped`/`partial_delivered`), ë³„ë„ refund ìƒíƒœ/ê¸ˆì•¡ í‘œì‹œ

**ì˜ˆìƒ ì‘ì—… ì‹œê°„**: 4-5ì‹œê°„

**ì˜ì¡´ì„±**: Phase 2-1, Phase 2-2 ì™„ë£Œ í•„ìˆ˜

**ì™„ë£Œ ì¡°ê±´**:
- í™˜ë¶ˆ ì²˜ë¦¬ API ì •ìƒ ë™ì‘
- í™˜ë¶ˆ ê°€ëŠ¥ íŒì • ì •ìƒ
- credit_note ìƒì„± ì •ìƒ
- ì´ë²¤íŠ¸ ë¡œê¹… ì •ìƒ

---

### Phase 10: ë¹„íšŒì› ì£¼ë¬¸ ì¡°íšŒ API êµ¬í˜„ (ì™„ë£Œ)

**ëª©ì **: ë¹„íšŒì›ì´ ì£¼ë¬¸ ì¡°íšŒ (ì˜µì…˜ B: ì„¸ì…˜ í† í° êµí™˜ ë°©ì‹)

**ì‘ì—…**:

#### 10-1. guest_order_sessions í…Œì´ë¸” ìƒì„±
**íŒŒì¼**: `backend/migrations/080_create_guest_order_sessions_table.sql`

**êµ¬ì¡°**:
- `session_id`: ì„¸ì…˜ ID (PK)
- `order_id`: ì£¼ë¬¸ ID (FK)
- `session_token`: ì„¸ì…˜ í† í° (UNIQUE, 24ì‹œê°„ ìœ íš¨)
- `access_token_id`: ì›ë³¸ ì ‘ê·¼ í† í° ID (FK)
- `expires_at`: ë§Œë£Œ ì‹œê° (24ì‹œê°„ í›„)
- `last_access_at`: ë§ˆì§€ë§‰ ì ‘ê·¼ ì‹œê°

#### 10-2. ì„¸ì…˜ ë°œê¸‰ ì—”ë“œí¬ì¸íŠ¸
**íŒŒì¼**: `backend/order-routes.js`

**API ì—”ë“œí¬ì¸íŠ¸**: `GET /api/guest/orders/session?token=...`

**ì²˜ë¦¬ íë¦„**:
1. `guest_order_access_token` ê²€ì¦ (`expires_at`, `revoked_at`, `orders.user_id IS NULL`)
2. ì„¸ì…˜ í† í° ë°œê¸‰ (24ì‹œê°„ TTL)
3. `guest_order_sessions` í…Œì´ë¸”ì— ì €ì¥
4. httpOnly Cookieë¡œ ì„¸ì…˜ í† í° ì„¤ì • (`Secure`, `SameSite=Lax`)
5. 302 Redirect (`/guest/orders.html?order=ORD-...`)

**ì—ëŸ¬ ì²˜ë¦¬**:
- í† í° ì—†ìŒ: 400
- í† í° ë§Œë£Œ/íšŒìˆ˜/Claim ì™„ë£Œ: 410

#### 10-3. ì£¼ë¬¸ ì¡°íšŒ ì—”ë“œí¬ì¸íŠ¸
**íŒŒì¼**: `backend/order-routes.js`

**API ì—”ë“œí¬ì¸íŠ¸**: `GET /api/guest/orders/:orderNumber`

**ì¸ì¦**: httpOnly Cookie (`guest_session_token`)

**ì²˜ë¦¬ íë¦„**:
1. ì„¸ì…˜ í† í° ê²€ì¦ (`guest_order_sessions`)
2. ì„¸ì…˜ ë§Œë£Œ í™•ì¸
3. ìˆ˜í‰ ê¶Œí•œìƒìŠ¹ ë°©ì§€ (ì„¸ì…˜ `order_number` == ìš”ì²­ `order_number`)
4. Claim ì™„ë£Œ í™•ì¸ (`orders.user_id IS NOT NULL`)
5. `last_access_at` ì—…ë°ì´íŠ¸
6. ì£¼ë¬¸ ì •ë³´ ì¡°íšŒ (ë°°ì†¡ì§€ ì •ë³´ í¬í•¨)
7. ì£¼ë¬¸ í•­ëª© ì¡°íšŒ
8. ë°°ì†¡ ì •ë³´ ì¡°íšŒ (`shipments` ê¸°ë°˜)

**ì‘ë‹µ ë°ì´í„°** (ë°°ì†¡ì§€ ì •ë³´ í¬í•¨):
- `order`: ì£¼ë¬¸ë²ˆí˜¸, ì£¼ë¬¸ì¼ì‹œ, ì´ì•¡, ìƒíƒœ, ê²°ì œì¼ì‹œ
- `shipping`: ë°°ì†¡ì§€ ì •ë³´ (ì´ë¦„, ì´ë©”ì¼, ì „í™”, ì£¼ì†Œ, ë„ì‹œ, ìš°í¸ë²ˆí˜¸, êµ­ê°€)
- `items`: ìƒí’ˆëª…, ìƒí’ˆì½”ë“œ, ìˆ˜ëŸ‰, ê°€ê²©, ì‚¬ì´ì¦ˆ, ìƒ‰ìƒ
- `shipments`: íƒë°°ì‚¬ ì½”ë“œ/ì´ë¦„, ì†¡ì¥ë²ˆí˜¸, ë°œì†¡ì¼ì‹œ, ë°°ì†¡ì™„ë£Œì¼ì‹œ

**ì—ëŸ¬ ì²˜ë¦¬**:
- ì„¸ì…˜ ì—†ìŒ: 401
- ì„¸ì…˜ ë§Œë£Œ/Claim ì™„ë£Œ/í† í° íšŒìˆ˜: 410
- ì£¼ë¬¸ë²ˆí˜¸ ë¶ˆì¼ì¹˜: 403
- ì£¼ë¬¸ ì—†ìŒ: 404

**ì˜ˆìƒ ì‘ì—… ì‹œê°„**: 3-4ì‹œê°„

**ì˜ì¡´ì„±**: Phase 2-4 ì™„ë£Œ í•„ìˆ˜

**ì™„ë£Œ ì¡°ê±´**:
- âœ… `guest_order_sessions` í…Œì´ë¸” ìƒì„± ì™„ë£Œ
- âœ… ì„¸ì…˜ ë°œê¸‰ ì—”ë“œí¬ì¸íŠ¸ êµ¬í˜„ ì™„ë£Œ
- âœ… ì£¼ë¬¸ ì¡°íšŒ ì—”ë“œí¬ì¸íŠ¸ êµ¬í˜„ ì™„ë£Œ
- âœ… ì„¸ì…˜ ê²€ì¦ ë¡œì§ êµ¬í˜„ ì™„ë£Œ
- âœ… ë°°ì†¡ì§€ ì •ë³´ í¬í•¨ ì‘ë‹µ êµ¬í˜„ ì™„ë£Œ

---

### Phase 11: orders.status ì§‘ê³„ í•¨ìˆ˜ êµ¬í˜„ (âœ… ì™„ë£Œ)

**ëª©ì **: `orders.status`ë¥¼ `order_item_units.unit_status` ê¸°ë°˜ìœ¼ë¡œ ìë™ ì§‘ê³„

**âš ï¸ ì¤‘ìš”**: `orders.status`ëŠ” ì§‘ê³„ ê²°ê³¼(ë·°/í‘œì‹œìš©)ì´ë©°, ì§ì ‘ ì •ì±… íŒë‹¨ ê¸°ì¤€ìœ¼ë¡œ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

**êµ¬í˜„ ìƒíƒœ**: âœ… **ì™„ë£Œ** (`backend/utils/order-status-aggregator.js`)

**í™•ì¸ ì‚¬í•­**:
- âœ… `paid_events` ì¡´ì¬ ì—¬ë¶€ í™•ì¸
- âœ… `order_item_units.unit_status` ì§‘ê³„
- âœ… `partial_shipped`, `partial_delivered` ìƒíƒœ ì§€ì›
- âœ… `refunded` ìƒíƒœ ì§‘ê³„
- âœ… `affectedRows=1` ê²€ì¦

**ì‘ì—…** (ì°¸ê³ ìš© - ì´ë¯¸ êµ¬í˜„ë¨):
1. **ì§‘ê³„ í•¨ìˆ˜ êµ¬í˜„** (`backend/utils/order-status-aggregator.js`)
   ```javascript
   async function updateOrderStatus(orderId) {
     const [units] = await connection.execute(
       `SELECT 
          COUNT(*) as total,
          SUM(CASE WHEN unit_status IN ('shipped', 'delivered') THEN 1 ELSE 0 END) as shipped_count,
          SUM(CASE WHEN unit_status = 'delivered' THEN 1 ELSE 0 END) as delivered_count,
          SUM(CASE WHEN unit_status LIKE 'refunded%' THEN 1 ELSE 0 END) as refunded_count
        FROM order_item_units oiu
        JOIN order_items oi ON oiu.order_item_id = oi.order_item_id
        WHERE oi.order_id = ?`,
       [orderId]
     );
     
     const stats = units[0];
     let newStatus;
     
     // paid_events ì¡´ì¬ ì—¬ë¶€ í™•ì¸
     const [paidEvents] = await connection.execute(
       'SELECT * FROM paid_events WHERE order_id = ?',
       [orderId]
     );
     
     if (paidEvents.length === 0) {
       newStatus = 'pending';
     } else if (stats.refunded_count === stats.total) {
       newStatus = 'refunded';
     } else if (stats.delivered_count === stats.total) {
       newStatus = 'delivered';
     } else if (stats.delivered_count > 0) {
       newStatus = 'partial_delivered';
     } else if (stats.shipped_count === stats.total) {
       newStatus = 'shipped';
     } else if (stats.shipped_count > 0) {
       newStatus = 'partial_shipped';
     } else {
       newStatus = 'paid';
     }
     
     await connection.execute(
       'UPDATE orders SET status = ? WHERE order_id = ?',
       [newStatus, orderId]
     );
   }
   ```

2. **íŠ¸ë¦¬ê±° ë˜ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ ë ˆë²¨ í˜¸ì¶œ**
   - `order_item_units.unit_status` ë³€ê²½ ì‹œ í˜¸ì¶œ
   - `paid_events` ìƒì„± ì‹œ í˜¸ì¶œ
   - ë°°ì†¡ ì²˜ë¦¬ APIì—ì„œ í˜¸ì¶œ
   - í™˜ë¶ˆ ì²˜ë¦¬ APIì—ì„œ í˜¸ì¶œ

**ì˜ˆìƒ ì‘ì—… ì‹œê°„**: 2-3ì‹œê°„

**ì˜ì¡´ì„±**: Phase 2 ì™„ë£Œ í•„ìˆ˜

**ì™„ë£Œ ì¡°ê±´**:
- ì§‘ê³„ í•¨ìˆ˜ ì •ìƒ ë™ì‘
- ë¶€ë¶„ë°°ì†¡ ìƒíƒœ ì •ìƒ ì²˜ë¦¬
- `paid_events` ê¸°ì¤€ ì •ìƒ ì²˜ë¦¬

---

### Phase 12: ë°°ì†¡/ì†¡ì¥ ê´€ë¦¬ API êµ¬í˜„

**ëª©ì **: ê´€ë¦¬ìê°€ ì†¡ì¥ ìƒì„± ë° ë°°ì†¡ ìƒíƒœ ê´€ë¦¬

**ì‘ì—…**:

#### 12-1. ì†¡ì¥ ìƒì„± API
**íŒŒì¼**: `backend/admin-routes.js` ë˜ëŠ” `backend/shipment-routes.js`

**API ì—”ë“œí¬ì¸íŠ¸**: `POST /api/admin/orders/:orderId/shipments`

**ìš”ì²­ ë³¸ë¬¸**:
```json
{
  "order_item_unit_ids": [1001, 1002],
  "carrier_code": "CJ",
  "tracking_number": "1234567890"
}
```

**ì²˜ë¦¬ íë¦„** (SYSTEM_FLOW_DETAILED.md 8-4ì ˆ ì°¸ì¡°):
1. ê´€ë¦¬ìê°€ ì£¼ë¬¸ ìƒì„¸ í˜ì´ì§€ì—ì„œ ë°°ì†¡í•  ì œí’ˆ í™•ì¸
2. ê° `order_item_unit`ì˜ ì‹œë¦¬ì–¼ ë„˜ë²„ì™€ í† í° í™•ì¸
3. í˜„ì‹¤ì—ì„œ í•´ë‹¹ ì œí’ˆ ì°¾ê¸° (ì‹œë¦¬ì–¼ ë„˜ë²„ ë˜ëŠ” í† í°ìœ¼ë¡œ)
4. ì†¡ì¥ ìƒì„±:
   - íƒë°°ì‚¬ ì½”ë“œ ì…ë ¥
   - ì†¡ì¥ë²ˆí˜¸ ì…ë ¥
   - `shipments` í…Œì´ë¸”ì— ê¸°ë¡
   - `shipment_units` í…Œì´ë¸”ì— `order_item_unit_id`ì™€ ì—°ê²°
   - `order_item_units.current_shipment_id` ì—…ë°ì´íŠ¸
   - `order_item_units.unit_status` = `'shipped'` ì—…ë°ì´íŠ¸
5. `orders.status` ì§‘ê³„ í•¨ìˆ˜ë¡œ ìë™ ì—…ë°ì´íŠ¸

**âš ï¸ ì†¡ì¥ êµì²´ ì •ì±… (Bì•ˆ í™•ì •)**:
- **êµì²´ íë¦„**: ê¸°ì¡´ shipmentë¥¼ `voided_at` + `void_reason`ìœ¼ë¡œ ë¬´íš¨í™” â†’ ìƒˆ shipment ìƒì„± â†’ `shipment_units`ì— ë™ì¼ unit ì¬ë§¤í•‘ â†’ `order_item_units.current_shipment_id`ë¥¼ ìƒˆ shipmentë¡œ êµì²´
- **í•µì‹¬ ê¸ˆì§€**: "shipment ì—†ì´ `shipped`ë¡œ ë°”ê¾¸ê¸°"ëŠ” ê·¸ëŒ€ë¡œ ê¸ˆì§€ ìœ ì§€
- **delivered ì´í›„ replace ê¸ˆì§€**: delivered ì´í›„ resendëŠ” "ì¶”ê°€ shipment ìƒì„±"ë§Œ í—ˆìš©

**ì˜ˆìƒ ì‘ì—… ì‹œê°„**: 4-5ì‹œê°„

**ì˜ì¡´ì„±**: Phase 2-6, Phase 2-7, Phase 2-8 ì™„ë£Œ í•„ìˆ˜

**ì™„ë£Œ ì¡°ê±´**:
- ì†¡ì¥ ìƒì„± API ì •ìƒ ë™ì‘
- ì†¡ì¥ êµì²´ ì •ìƒ ë™ì‘ (void + ì‹ ê·œ ìƒì„±)
- ì¬ë°œì†¡ ì •ìƒ ë™ì‘

#### 12-2. ë°°ì†¡ ì™„ë£Œ ì²˜ë¦¬ API
**íŒŒì¼**: `backend/admin-routes.js` ë˜ëŠ” `backend/shipment-routes.js`

**API ì—”ë“œí¬ì¸íŠ¸**: `POST /api/admin/orders/:orderId/deliver`

**ìš”ì²­ ë³¸ë¬¸**:
```json
{
  "order_item_unit_ids": [1001, 1002]
}
```

**ì²˜ë¦¬ íë¦„**:
1. ê´€ë¦¬ìê°€ ì£¼ë¬¸ ìƒì„¸ í˜ì´ì§€ì—ì„œ ë°°ì†¡ ì™„ë£Œ ì²˜ë¦¬í•  ì œí’ˆ í™•ì¸
2. ê° `order_item_unit`ì˜ ì‹œë¦¬ì–¼ ë„˜ë²„ì™€ í† í° í™•ì¸
3. `order_item_units.unit_status` = `'delivered'` ì—…ë°ì´íŠ¸
4. `orders.status` ì§‘ê³„ í•¨ìˆ˜ë¡œ ìë™ ì—…ë°ì´íŠ¸
   - **ë¶€ë¶„ë°°ì†¡ ì§€ì›**: ì¼ë¶€ `delivered` ì´ìƒ, ì¼ë¶€ `shipped` â†’ `partial_delivered`
   - ëª¨ë“  `delivered` ì´ìƒ â†’ `delivered`

**ì˜ˆìƒ ì‘ì—… ì‹œê°„**: 2ì‹œê°„

**ì˜ì¡´ì„±**: Phase 12-1 ì™„ë£Œ ê¶Œì¥

**ì™„ë£Œ ì¡°ê±´**:
- ë°°ì†¡ ì™„ë£Œ ì²˜ë¦¬ API ì •ìƒ ë™ì‘
- orders.status ì§‘ê³„ ì •ìƒ

---

### Phase 13: ê´€ë¦¬ì í˜ì´ì§€ ê°œì„ 

**ëª©ì **: ì£¼ë¬¸ ìƒì„¸ 3ë‹¨ êµ¬ì¡°, ë³´ì¦ì„œ ìƒì„¸ í™”ë©´ êµ¬í˜„

**ì‘ì—…**:

#### 13-1. ì£¼ë¬¸ ìƒì„¸ API ê°œì„  (3ë‹¨ êµ¬ì¡°)
**íŒŒì¼**: `backend/admin-routes.js`

**API ì—”ë“œí¬ì¸íŠ¸**: `GET /api/admin/orders/:orderId`

**ì‘ë‹µ êµ¬ì¡°** (SYSTEM_FLOW_DETAILED.md 8-3ì ˆ ì°¸ì¡°):
```json
{
  "order": {
    "order_id": 1,
    "order_number": "ORD-20250101-001",
    "user_id": 123,
    "guest_id": null,
    "status": "paid",
    "paid_at": "2025-01-01 10:05:00",
    "total_amount": 100000,
    "customer_info": {
      "email": "user@example.com",
      "name": "í™ê¸¸ë™",
      "phone": "010-1234-5678"
    }
  },
  "invoice": {
    "invoice_number": "PM-INV-20250101-100500-ABC",
    "issued_at": "2025-01-01 10:05:00",
    "total_amount": 100000
  },
  "order_items": [
    {
      "order_item_id": 1,
      "product_name": "í…Œë‰´ ì†”ë¦¬ë“œ ì…”ì¸ ",
      "quantity": 2,
      "price": 50000,
      "units": [
        {
          "order_item_unit_id": 1001,
          "unit_seq": 1,
          "serial_number": "SN-001",
          "token": "ABC12345678901234567",
          "token_masked": "ABC1...5678",
          "unit_status": "reserved",
          "warranty_status": "issued",
          "current_shipment": {
            "shipment_id": 1,
            "carrier_code": "CJ",
            "tracking_number": "1234567890"
          }
        }
      ]
    }
  ]
}
```

**âš ï¸ í† í° ë…¸ì¶œ ë²”ìœ„ ì •ì±… (ë³´ì•ˆ í•„ìˆ˜)**:
- **ëª©ë¡ í™”ë©´**: í† í° ë§ˆìŠ¤í‚¹ (ì˜ˆ: ì• 4ì/ë’¤ 4ìë§Œ í‘œì‹œ) - `ABC1...5678`
- **ìƒì„¸ í™”ë©´**: ì „ì²´ í† í° í‘œì‹œ (ë°°ì†¡/í™˜ë¶ˆ ì²˜ë¦¬ ì‹œ í•„ìš”)
- **ì ‘ê·¼ê¶Œí•œ ë¶„ë¦¬**: "ì „ì²´ í† í° ë³´ê¸°" ê¶Œí•œì„ ë³„ë„ë¡œ ê´€ë¦¬ (ê°€ëŠ¥í•˜ë©´ ë² ìŠ¤íŠ¸)

**âš ï¸ ì‹œë¦¬ì–¼ ë„˜ë²„ ì¶œì²˜ ëª…í™•í™”**:
- **ì‹¤ì œ ì œí’ˆ ì‹œë¦¬ì–¼ ë„˜ë²„**: `token_master.serial_number` (ë˜ëŠ” `stock_units`ë¥¼ í†µí•´ ì¡°íšŒ)
- **DB ë‚´ë¶€ ID**: `order_item_unit_id` (ì°¸ì¡°ìš©, í‘œì‹œëŠ” ì„ íƒ)

**ì˜ˆìƒ ì‘ì—… ì‹œê°„**: 4-5ì‹œê°„

**ì˜ì¡´ì„±**: Phase 2 ì™„ë£Œ í•„ìˆ˜

**ì™„ë£Œ ì¡°ê±´**:
- ì£¼ë¬¸ ìƒì„¸ API 3ë‹¨ êµ¬ì¡° ì •ìƒ ë™ì‘
- ì¸ë³´ì´ìŠ¤ ì •ë³´ í¬í•¨
- ì‹œë¦¬ì–¼ ë„˜ë²„, í† í° ì •ë³´ í¬í•¨

#### 13-2. ì£¼ë¬¸ ìƒì„¸ í”„ë¡ íŠ¸ì—”ë“œ ê°œì„ 
**íŒŒì¼**: `admin-qhf25za8/orders.html`, `admin-qhf25za8/admin-orders.js`

**ì‘ì—…**:
1. 1ë‹¨: ì£¼ë¬¸ ì •ë³´ ì¹´ë“œ (ì¸ë³´ì´ìŠ¤ ì •ë³´ í¬í•¨)
2. 2ë‹¨: ì£¼ë¬¸ í•­ëª© ë¦¬ìŠ¤íŠ¸
3. 3ë‹¨: ì£¼ë¬¸ í•­ëª© ë‹¨ìœ„ í…Œì´ë¸” (ì‹œë¦¬ì–¼ ë„˜ë²„, í† í°, ë°°ì†¡ ìƒíƒœ, ë³´ì¦ì„œ ìƒíƒœ)
4. ì¶œê³ /ë°°ì†¡ ë²„íŠ¼ (ì²´í¬ë°•ìŠ¤ ì„ íƒ ê¸°ë°˜)

**ì˜ˆìƒ ì‘ì—… ì‹œê°„**: 6-8ì‹œê°„

**ì˜ì¡´ì„±**: Phase 13-1 ì™„ë£Œ í•„ìˆ˜

**ì™„ë£Œ ì¡°ê±´**:
- ì£¼ë¬¸ ìƒì„¸ í™”ë©´ 3ë‹¨ êµ¬ì¡° ì •ìƒ í‘œì‹œ
- ì¶œê³ /ë°°ì†¡ ë²„íŠ¼ ì •ìƒ ë™ì‘

#### 13-3. ë³´ì¦ì„œ ìƒì„¸ í™”ë©´ êµ¬í˜„
**íŒŒì¼**: `admin-qhf25za8/warranties.html` (ì‹ ê·œ), `admin-qhf25za8/admin-warranties.js` (ì‹ ê·œ)

**ì‘ì—…**:
1. ë³´ì¦ì„œ ê²€ìƒ‰ í™”ë©´
   - **ê²€ìƒ‰ í‚¤ (SSOT ê¸°ì¤€)**:
     - í† í° (20ì): `token_master.token` â†’ `token_master.token_pk` â†’ `warranties.token_pk`
     - ë‚´ë¶€ ì½”ë“œ (UUID): `warranties.public_id`
     - ì‹œë¦¬ì–¼ ë„˜ë²„: `token_master.serial_number` â†’ `token_master.token_pk` â†’ `warranties.token_pk`
     - ROT ì½”ë“œ: `token_master.rot_code` â†’ `token_master.token_pk` â†’ `warranties.token_pk`
     - ë³´ì¦ì„œ í•˜ë‹¨ ì½”ë“œ: `token_master.warranty_bottom_code` â†’ `token_master.token_pk` â†’ `warranties.token_pk`
   - **ê²€ìƒ‰ ê²°ê³¼ UX**: ë‹¨ê±´ì´ë©´ ìƒì„¸ ë°”ë¡œ ì´ë™, ë‹¤ê±´ì´ë©´ ë¦¬ìŠ¤íŠ¸ í‘œì‹œ
2. ë³´ì¦ì„œ ìƒì„¸ í™”ë©´:
   - **ë³´ì¦ì„œ ìƒíƒœ ì¹´ë“œ**:
     - ìƒíƒœ: `warranties.status` (issued_unassigned, issued, active, suspended, revoked)
     - í™œì„±í™” ì¼ì‹œ: `warranties.activated_at`
     - í™˜ë¶ˆ ì¼ì‹œ: `warranties.revoked_at` (ì¬íŒë§¤ ì‹œì—ë„ ìœ ì§€, ì´ë ¥ ë³´ì¡´)
     - **ì¬íŒë§¤ ì—¬ë¶€ í‘œì‹œ**: `revoked_at IS NOT NULL AND status != 'revoked'` â†’ "ì¬íŒë§¤ë¨" ë°°ì§€
     - **ì •ì±… ê²½ê³  ë°°ì§€**:
       - `active`: "ì–‘ë„ ê°€ëŠ¥ / í™˜ë¶ˆ ë¶ˆê°€(ì •ì±…)"
       - `issued`: "í™œì„±í™” ì „ / í™˜ë¶ˆ ê°€ëŠ¥"
       - `revoked`: "QR ì ‘ê·¼ ì°¨ë‹¨ ëŒ€ìƒ"
   - **ì†Œìœ ì ì •ë³´ ì¹´ë“œ**:
     - í˜„ì¬ ì†Œìœ ì: `warranties.owner_user_id` â†’ `users.email`, `users.name`
     - ì†Œìœ ì ë³€ê²½ ì´ë ¥: `warranty_events`ì—ì„œ `event_type IN ('owner_change', 'ownership_transferred')` ì¡°íšŒ
   - **ì—°ê²° ì •ë³´ ì¹´ë“œ** (ë‹¨ìœ„ ê¸°ì¤€ ì²´ì¸ í‘œì‹œ):
     - ì—°ê²° ì£¼ë¬¸: `warranties.source_order_item_unit_id` â†’ `order_item_units.order_item_id` â†’ `order_items.order_id` â†’ `orders.order_number`, `orders.order_id`
     - ì—°ê²° ì¬ê³ : `order_item_units.stock_unit_id` â†’ `stock_units` (ì‹œë¦¬ì–¼ ë„˜ë²„, ROT ì½”ë“œ, ë³´ì¦ì„œ í•˜ë‹¨ ì½”ë“œ)
     - ì¸ë³´ì´ìŠ¤ ì •ë³´:
       - ì›ë³¸ invoice: `invoices.type = 'invoice'` AND `invoices.order_id = orders.order_id`
       - Credit note ë¦¬ìŠ¤íŠ¸: `invoices.type = 'credit_note'` AND `invoices.related_invoice_id = ì›ë³¸_invoice_id`
       - ì‹œê°„ í•„ë“œ: `invoices.issued_at` ì‚¬ìš©
   - **ë³´ì¦ì„œ ì´ë ¥ íƒ€ì„ë¼ì¸**:
     - `warranty_events` í…Œì´ë¸” ì¡°íšŒ (ìµœì‹ ìˆœ)
     - ì´ë²¤íŠ¸ íƒ€ì…: `status_change`, `owner_change`, `ownership_transferred`, `suspend`, `unsuspend`, `revoke`
     - ë³€ê²½ ì „/í›„ ê°’, ë³€ê²½ì, ë³€ê²½ ì‚¬ìœ , ë³€ê²½ ì‹œê° í‘œì‹œ
   - **QR ì½”ë“œ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼**:
     - ê¸°ì¡´ QR ì½”ë“œ ë‹¤ìš´ë¡œë“œ API í™œìš© (`/api/admin/qrcode/download`)
     - **ê°ì‚¬ ë¡œê·¸**: ëˆ„ê°€ ì–¸ì œ ì–´ë–¤ warrantyì˜ QRì„ ë‹¤ìš´ë¡œë“œí–ˆëŠ”ì§€ ê¸°ë¡ (ê¶Œì¥)

**ì˜ˆìƒ ì‘ì—… ì‹œê°„**: 8-10ì‹œê°„

**ì˜ì¡´ì„±**: Phase 2 ì™„ë£Œ í•„ìˆ˜, ë§ˆì´ê·¸ë ˆì´ì…˜ 081 ì™„ë£Œ í•„ìˆ˜

**ì™„ë£Œ ì¡°ê±´**:
- ë³´ì¦ì„œ ê²€ìƒ‰ í™”ë©´ ì •ìƒ ë™ì‘ (SSOT ê¸°ì¤€ ê²€ìƒ‰ ê²½ë¡œ)
- ë³´ì¦ì„œ ìƒì„¸ í™”ë©´ ì •ìƒ í‘œì‹œ (ëª¨ë“  ì¹´ë“œ í¬í•¨)
- ì†Œìœ ì ë³€ê²½ ì´ë ¥ ì •ìƒ í‘œì‹œ (`owner_change`, `ownership_transferred` ëª¨ë‘ í¬í•¨)
- ì¸ë³´ì´ìŠ¤ ì •ë³´ êµ¬ë¶„ í‘œì‹œ (ì›ë³¸ invoice / credit_note)
- ì¬íŒë§¤ ì—¬ë¶€ í‘œì‹œ
- QR ì½”ë“œ ë‹¤ìš´ë¡œë“œ ì •ìƒ

---

### Phase 14: í”„ë¡ íŠ¸ì—”ë“œ ì‚¬ìš©ì í˜ì´ì§€ êµ¬í˜„

**ëª©ì **: ì‚¬ìš©ìê°€ ë³´ì¦ì„œ í™œì„±í™”, ì–‘ë„, ì¡°íšŒ ê°€ëŠ¥

**ì‘ì—…**:

#### 14-1. ë³´ì¦ì„œ í™œì„±í™” í˜ì´ì§€
**íŒŒì¼**: `my-warranties.html`, `my-warranties.js`

**ì‘ì—…**:
1. ë³´ì¦ì„œ ëª©ë¡ í‘œì‹œ (`status = 'issued'`ì¸ ë³´ì¦ì„œì— "í™œì„±í™”" ë²„íŠ¼)
2. í™œì„±í™” ë²„íŠ¼ í´ë¦­ ì‹œ ë™ì˜ ë¬¸êµ¬ í™•ì¸
3. í™œì„±í™” API í˜¸ì¶œ
4. ì„±ê³µ/ì‹¤íŒ¨ ë©”ì‹œì§€ í‘œì‹œ

**ì˜ˆìƒ ì‘ì—… ì‹œê°„**: 4-5ì‹œê°„

**ì˜ì¡´ì„±**: Phase 5 ì™„ë£Œ í•„ìˆ˜

**ì™„ë£Œ ì¡°ê±´**:
- ë³´ì¦ì„œ í™œì„±í™” í˜ì´ì§€ ì •ìƒ ë™ì‘
- ë™ì˜ ì²´í¬ ì •ìƒ
- ì—ëŸ¬ ì²˜ë¦¬ ì •ìƒ

#### 14-2. ë³´ì¦ì„œ ì–‘ë„ í˜ì´ì§€
**íŒŒì¼**: `my-warranties.html`, `my-warranties.js`

**ì‘ì—…**:
1. ë³´ì¦ì„œ ìƒì„¸ì—ì„œ "ì–‘ë„í•˜ê¸°" ë²„íŠ¼ (`status = 'active'`ì¸ ê²½ìš°ë§Œ)
2. ìˆ˜ë ¹ì ì´ë©”ì¼ ì…ë ¥ ëª¨ë‹¬
3. ì–‘ë„ ìš”ì²­ API í˜¸ì¶œ
4. ì–‘ë„ ë§í¬ ì´ë©”ì¼ ë°œì†¡ í™•ì¸

**ì˜ˆìƒ ì‘ì—… ì‹œê°„**: 3-4ì‹œê°„

**ì˜ì¡´ì„±**: Phase 8-1 ì™„ë£Œ í•„ìˆ˜

**ì™„ë£Œ ì¡°ê±´**:
- ì–‘ë„ ìš”ì²­ í˜ì´ì§€ ì •ìƒ ë™ì‘
- ì´ë©”ì¼ ì…ë ¥ ì •ìƒ

#### 14-3. ì–‘ë„ ìˆ˜ë½ í˜ì´ì§€
**íŒŒì¼**: `warranty-transfer-accept.html` (ì‹ ê·œ), `warranty-transfer-accept.js` (ì‹ ê·œ)

**ì‘ì—…**:
1. ì–‘ë„ ë§í¬ ì ‘ê·¼ (í† í° ê²€ì¦)
2. ë¡œê·¸ì¸ ìš”êµ¬
3. ëœë¤ 7ì ì½”ë“œ ì…ë ¥
4. ì–‘ë„ ìˆ˜ë½ API í˜¸ì¶œ
5. ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ

**ì˜ˆìƒ ì‘ì—… ì‹œê°„**: 4-5ì‹œê°„

**ì˜ì¡´ì„±**: Phase 8-2 ì™„ë£Œ í•„ìˆ˜

**ì™„ë£Œ ì¡°ê±´**:
- ì–‘ë„ ìˆ˜ë½ í˜ì´ì§€ ì •ìƒ ë™ì‘
- ì½”ë“œ ì…ë ¥ ì •ìƒ
- ì—ëŸ¬ ì²˜ë¦¬ ì •ìƒ

#### 14-4. ë¹„íšŒì› ì£¼ë¬¸ ì¡°íšŒ í˜ì´ì§€
**íŒŒì¼**: `guest-order-detail.html` (ì‹ ê·œ), `guest-order-detail.js` (ì‹ ê·œ)

**ì‘ì—…**:
1. ì¸ë³´ì´ìŠ¤ ë§í¬ ì ‘ê·¼ (í† í° ê²€ì¦)
2. Cookie ì„¤ì • ë° Redirect
3. ì£¼ë¬¸ ìƒì„¸ ì •ë³´ í‘œì‹œ:
   - ì¸ë³´ì´ìŠ¤ ì •ë³´
   - ë°°ì†¡ ìƒíƒœ
   - ì£¼ë¬¸ ì •ë³´
   - ë³´ì¦ì„œ ì •ë³´ (`issued_unassigned` ìƒíƒœ)
4. "ë‚´ ê³„ì •ì— ì—°ë™í•˜ê¸°" ë²„íŠ¼ (ë¹„íšŒì›ì¸ ê²½ìš°)

**ì˜ˆìƒ ì‘ì—… ì‹œê°„**: 5-6ì‹œê°„

**ì˜ì¡´ì„±**: Phase 10-1 ì™„ë£Œ í•„ìˆ˜

**ì™„ë£Œ ì¡°ê±´**:
- ë¹„íšŒì› ì£¼ë¬¸ ì¡°íšŒ í˜ì´ì§€ ì •ìƒ ë™ì‘
- í† í° ê²€ì¦ ì •ìƒ
- Claim ë²„íŠ¼ ì •ìƒ

---

### Phase 15: ì¤‘ê¸° ê°œì„  (product_options í…Œì´ë¸”)

**ëª©ì **: ì¬ê³ ì™€ ë¶„ë¦¬ëœ ì˜µì…˜ ë¼ì¸ì—… ê´€ë¦¬

**ì‘ì—…**:

#### 15-1. `product_options` í…Œì´ë¸” ìƒì„±
**íŒŒì¼**: `backend/migrations/058_create_product_options_table.sql`

```sql
CREATE TABLE product_options (
    option_id BIGINT PRIMARY KEY AUTO_INCREMENT,
    product_id VARCHAR(50) NOT NULL COMMENT 'ìƒí’ˆ ID',
    color_code VARCHAR(50) NULL COMMENT 'ìƒ‰ìƒ ì½”ë“œ (color_standards ì°¸ì¡°)',
    size VARCHAR(10) NULL COMMENT 'ì‚¬ì´ì¦ˆ (S, M, L, XL, XXL, F)',
    is_active TINYINT(1) NOT NULL DEFAULT 1 COMMENT 'í™œì„± ì—¬ë¶€',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (product_id) REFERENCES admin_products(id) ON DELETE CASCADE,
    FOREIGN KEY (color_code) REFERENCES color_standards(color_code) ON DELETE RESTRICT,
    INDEX idx_product_id (product_id),
    INDEX idx_color_code (color_code),
    INDEX idx_is_active (is_active),
    UNIQUE KEY uk_product_color_size (product_id, color_code, size)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

**ì™„ë£Œ ì¡°ê±´**: í…Œì´ë¸” ìƒì„± ì™„ë£Œ

#### 15-2. ì˜µì…˜ API ìˆ˜ì • (product_options ê¸°ë°˜)
**íŒŒì¼**: `backend/product-routes.js`

**ìˆ˜ì • ë‚´ìš©**:
- `product_options` í…Œì´ë¸”ì—ì„œ ì˜µì…˜ ë¼ì¸ì—… ì¡°íšŒ
- `stock_units`ì—ì„œ ì¬ê³  ìƒíƒœë§Œ ì¡°íšŒ
- ë‘ ì •ë³´ë¥¼ ê²°í•©í•˜ì—¬ ì‘ë‹µ

**ì˜ˆìƒ ì‘ì—… ì‹œê°„**: 2-3ì‹œê°„

**ì˜ì¡´ì„±**: Phase 15-1 ì™„ë£Œ í•„ìˆ˜

**ì™„ë£Œ ì¡°ê±´**:
- ì˜µì…˜ APIê°€ product_options ê¸°ë°˜ìœ¼ë¡œ ë™ì‘
- ì¬ê³ ê°€ 0ì¸ ìƒí’ˆë„ ì˜µì…˜ í‘œì‹œ

#### 15-3. ê´€ë¦¬ì í˜ì´ì§€ ì˜µì…˜ ê´€ë¦¬ ê¸°ëŠ¥
**íŒŒì¼**: `admin-qhf25za8/admin-products.js`, `backend/admin-routes.js`

**ì‘ì—…**:
1. **ì˜µì…˜ ì¡°íšŒ API** (`GET /api/admin/products/:productId/options`)
   - `product_options` í…Œì´ë¸”ì—ì„œ í•´ë‹¹ ìƒí’ˆì˜ ëª¨ë“  ì˜µì…˜ ì¡°íšŒ
   - ì¬ê³  ìƒíƒœ í¬í•¨ (ê° ì˜µì…˜ë³„ `in_stock` ìˆ˜ëŸ‰)

2. **ì˜µì…˜ ì¶”ê°€ API** (`POST /api/admin/products/:productId/options`)
   - ìƒˆë¡œìš´ ì˜µì…˜ ì¶”ê°€ (ì‚¬ì´ì¦ˆ/ìƒ‰ìƒ ì¡°í•©)
   - `sort_order` ìë™ ê³„ì‚° ë˜ëŠ” ìˆ˜ë™ ì„¤ì •
   - ì¤‘ë³µ ì²´í¬ (UNIQUE ì œì•½)

3. **ì˜µì…˜ ìˆ˜ì • API** (`PUT /api/admin/products/:productId/options/:optionId`)
   - `is_active` í† ê¸€
   - `sort_order` ìˆ˜ì •

4. **ì˜µì…˜ ì‚­ì œ API** (`DELETE /api/admin/products/:productId/options/:optionId`)
   - ì˜µì…˜ ì‚­ì œ (ë˜ëŠ” `is_active = 0`ìœ¼ë¡œ ë¹„í™œì„±í™”)

5. **ê´€ë¦¬ì í˜ì´ì§€ UI** (`admin-qhf25za8/admin-products.js`)
   - ìƒí’ˆ ìƒì„¸ í˜ì´ì§€ì— "ì˜µì…˜ ê´€ë¦¬" ì„¹ì…˜ ì¶”ê°€
   - ì˜µì…˜ ëª©ë¡ í‘œì‹œ (ì‚¬ì´ì¦ˆ, ìƒ‰ìƒ, ì¬ê³  ìƒíƒœ, ì •ë ¬ ìˆœì„œ)
   - ì˜µì…˜ ì¶”ê°€/ìˆ˜ì •/ì‚­ì œ UI

**ì˜ˆìƒ ì‘ì—… ì‹œê°„**: 4-6ì‹œê°„

**ì˜ì¡´ì„±**: Phase 15-1, Phase 15-2 ì™„ë£Œ í•„ìˆ˜

**ì™„ë£Œ ì¡°ê±´**:
- ê´€ë¦¬ì í˜ì´ì§€ì—ì„œ ì˜µì…˜ ì¡°íšŒ/ì¶”ê°€/ìˆ˜ì •/ì‚­ì œ ê°€ëŠ¥
- ì¬ê³  ìƒíƒœ í™•ì¸ ê°€ëŠ¥
- `sort_order` ìˆ˜ì • ê°€ëŠ¥

---

### Phase 16: Product ID êµ¬ì¡° ê°œì„  (ì‚¬ì´ì¦ˆ/ìƒ‰ìƒ ì½”ë“œ ì œê±°)

**ëª©ì **: ê·¼ë³¸ì ì¸ ì„¤ê³„ ê°œì„  - product_idì—ì„œ ì‚¬ì´ì¦ˆ/ìƒ‰ìƒ ì½”ë“œ ì œê±°

**âš ï¸ ì¤‘ìš”**: 
- ìƒì„¸ ê³„íšì€ `PRODUCT_ID_REFACTORING_PLAN.md` ì°¸ì¡°
- **GPT ì œì•ˆ ë°˜ì˜**: PK ì§ì ‘ UPDATE ìœ„í—˜ íšŒí”¼, ì˜µì…˜ B (ë³‘í–‰ ìš´ì˜) ë°©ì‹ ì±„íƒ

**í˜„ì¬ ë¬¸ì œì **:
1. **URL ë¼ìš°íŒ… ë¬¸ì œ**: `PM-25-SH-Teneu-Solid-LB-S/M/L` í˜•ì‹ì— ìŠ¬ë˜ì‹œ(`/`) í¬í•¨
   - âœ… **í•´ê²°ë¨**: ì˜µì…˜ APIë¥¼ query ë°©ì‹ìœ¼ë¡œ ë³€ê²½ (ì™„ë£Œ)
2. **ì˜µì…˜ ì¶”ì¶œ ì˜ì¡´ì„±**: `extractSizesFromProductId()`, `extractColorFromProductId()` í•¨ìˆ˜ë¡œ product_id íŒŒì‹±
   - âš ï¸ **ë¬¸ì œ**: product_id êµ¬ì¡° ë³€ê²½ ì‹œ íŒŒì‹± ë¡œì§ ì‹¤íŒ¨ ê°€ëŠ¥
3. **ìœ ì—°ì„± ë¶€ì¡±**: ì‚¬ì´ì¦ˆ/ìƒ‰ìƒì´ product_idì— í•˜ë“œì½”ë”©ë˜ì–´ ìˆì–´ ì˜µì…˜ ì¶”ê°€/ë³€ê²½ ì‹œ product_id ë³€ê²½ í•„ìš”
4. **SSOT ì›ì¹™ ìœ„ë°°**: ì‚¬ì´ì¦ˆ/ìƒ‰ìƒ ì •ë³´ê°€ `stock_units`ì™€ `admin_products.id`ì— ì¤‘ë³µ ì €ì¥

**ëª©í‘œ êµ¬ì¡°**:
```
í˜„ì¬: PM-25-SH-Teneu-Solid-LB-S/M/L
Phase 1: PM-25-SH-Teneu-Solid-LB  (ì‚¬ì´ì¦ˆ ì œê±°)
Phase 2: PM-25-SH-Teneu-Solid  (ìƒ‰ìƒë„ ì œê±°, product_options í™œìš©)
```

**ì‘ì—…**:

#### 16-1. ì‹ ê·œ ìƒí’ˆ ê·œì¹™ ì ìš© (ì¦‰ì‹œ ì‹œì‘ ê°€ëŠ¥)
**íŒŒì¼**: `PRODUCT_ID_STANDARD.md` (ì‹ ê·œ), `admin-qhf25za8/admin-products.js`

**ì‘ì—…**:
1. ìƒˆ product_id ê·œì¹™ ì •ì˜ ë¬¸ì„œí™”
2. ê´€ë¦¬ì í˜ì´ì§€ì— ê·œì¹™ ì•ˆë‚´ ì¶”ê°€
3. ìƒí’ˆ ì¶”ê°€ ì‹œ ìœ íš¨ì„± ê²€ì¦ (ìŠ¬ë˜ì‹œ í¬í•¨ ì‹œ ê²½ê³ )
4. ì‹ ê·œ ìƒí’ˆë¶€í„° ì‚¬ì´ì¦ˆ ì œê±°ëœ ID ì‚¬ìš©

**ì˜ˆìƒ ì‘ì—… ì‹œê°„**: 2-3ì‹œê°„

**ì˜ì¡´ì„±**: ì—†ìŒ

**ì™„ë£Œ ì¡°ê±´**:
- ì‹ ê·œ ìƒí’ˆ ì¶”ê°€ ì‹œ ì‚¬ì´ì¦ˆ ì œê±°ëœ ID ì‚¬ìš©
- ê·œì¹™ ë¬¸ì„œí™” ì™„ë£Œ

#### 16-2. ê¸°ì¡´ ìƒí’ˆ ë§ˆì´ê·¸ë ˆì´ì…˜ ì¤€ë¹„
**íŒŒì¼**: `backend/scripts/analyze_product_ids.sql`, `backend/migrations/062_migrate_product_id_remove_sizes.sql`

**ì‘ì—…**:
1. ê¸°ì¡´ product_id íŒ¨í„´ ë¶„ì„
2. ì°¸ì¡° ë¬´ê²°ì„± í™•ì¸ (`stock_units`, `order_items`, `token_master`)
3. ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸ ì‘ì„±
4. í…ŒìŠ¤íŠ¸ í™˜ê²½ì—ì„œ ë§ˆì´ê·¸ë ˆì´ì…˜ í…ŒìŠ¤íŠ¸
5. ë¡¤ë°± ê³„íš ìˆ˜ë¦½

**ì˜ˆìƒ ì‘ì—… ì‹œê°„**: 4-6ì‹œê°„

**ì˜ì¡´ì„±**: Phase 16-1 ì™„ë£Œ ê¶Œì¥

**ì™„ë£Œ ì¡°ê±´**:
- ê¸°ì¡´ ë°ì´í„° ë¶„ì„ ì™„ë£Œ
- ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸ ì‘ì„± ì™„ë£Œ
- í…ŒìŠ¤íŠ¸ í™˜ê²½ ê²€ì¦ ì™„ë£Œ

#### 16-3. ê¸°ì¡´ ìƒí’ˆ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰ (ì‹ ì¤‘í•˜ê²Œ)
**íŒŒì¼**: `backend/migrations/062_migrate_product_id_remove_sizes.sql`

**âš ï¸ ì¤‘ìš”**: ìš´ì˜ í™˜ê²½ì—ì„œ ì‹¤í–‰ ì „ ì¶©ë¶„í•œ í…ŒìŠ¤íŠ¸ í•„ìš”

**ì‘ì—… ìˆœì„œ**:
1. **ë°±ì—…**: ì „ì²´ ë°ì´í„°ë² ì´ìŠ¤ ë°±ì—… í•„ìˆ˜
2. **ë§¤í•‘ í…Œì´ë¸” ìƒì„±**: `product_id_mapping` í…Œì´ë¸” ìƒì„±
3. **ì¤‘ë³µ í™•ì¸**: ìƒˆ ID ì¤‘ë³µ í™•ì¸ ë° í•´ê²°
4. **ë‹¨ê³„ë³„ ë§ˆì´ê·¸ë ˆì´ì…˜**:
   - `admin_products` í…Œì´ë¸” ì—…ë°ì´íŠ¸
   - `stock_units` í…Œì´ë¸” ì—…ë°ì´íŠ¸
   - `order_items` í…Œì´ë¸” ì—…ë°ì´íŠ¸
   - `token_master` í…Œì´ë¸” ì—…ë°ì´íŠ¸
5. **ì°¸ì¡° ë¬´ê²°ì„± í™•ì¸**: ê° ë‹¨ê³„ë³„ í™•ì¸
6. **ì½”ë“œ ìˆ˜ì •**: `extractSizesFromProductId()`, `extractColorFromProductId()` í•¨ìˆ˜ ì œê±°

**ì˜ˆìƒ ì‘ì—… ì‹œê°„**: 6-8ì‹œê°„ (ë°±ì—… + ë§ˆì´ê·¸ë ˆì´ì…˜ + ê²€ì¦)

**ì˜ì¡´ì„±**: Phase 16-2 ì™„ë£Œ í•„ìˆ˜

**ì™„ë£Œ ì¡°ê±´**:
- ëª¨ë“  í…Œì´ë¸” product_id ì—…ë°ì´íŠ¸ ì™„ë£Œ
- ì°¸ì¡° ë¬´ê²°ì„± í™•ì¸ ì™„ë£Œ
- íŒŒì‹± ë¡œì§ ì œê±° ì™„ë£Œ

#### 16-4. ìƒ‰ìƒ ì½”ë“œ ì œê±° (ì„ íƒì , Phase 15 ì™„ë£Œ í›„)
**ëª©ì **: product_idì—ì„œ ìƒ‰ìƒ ì½”ë“œë„ ì œê±°, `product_options` í…Œì´ë¸” í™œìš©

**ì‘ì—…**:
1. `product_options` í…Œì´ë¸” ìƒì„± (Phase 15 ì°¸ì¡°)
2. ìƒ‰ìƒ ì½”ë“œ ì œê±° ë§ˆì´ê·¸ë ˆì´ì…˜ (Phase 16-3ì™€ ë™ì¼í•œ ë°©ì‹)

**ì˜ˆìƒ ì‘ì—… ì‹œê°„**: 4-6ì‹œê°„

**ì˜ì¡´ì„±**: Phase 16-3 ì™„ë£Œ í•„ìˆ˜, Phase 15 ì™„ë£Œ í•„ìˆ˜

**ì™„ë£Œ ì¡°ê±´**:
- product_idì—ì„œ ìƒ‰ìƒ ì½”ë“œ ì œê±° ì™„ë£Œ
- product_options í…Œì´ë¸” ê¸°ë°˜ ì˜µì…˜ ê´€ë¦¬ ì™„ë£Œ

**âš ï¸ ë¦¬ìŠ¤í¬ ê´€ë¦¬**:
- **ë°ì´í„° ì†ì‹¤**: ëª¨ë“  ë‹¨ê³„ ì „ ë°±ì—… í•„ìˆ˜
- **ì¤‘ë³µ ID**: ë§ˆì´ê·¸ë ˆì´ì…˜ ì „ ì¤‘ë³µ í™•ì¸ í•„ìˆ˜
- **ì°¸ì¡° ë¬´ê²°ì„±**: ê° ë‹¨ê³„ë³„ í™•ì¸ í•„ìˆ˜
- **ì½”ë“œ í˜¸í™˜ì„±**: íŒŒì‹± ë¡œì§ ì œê±° ì „ ëŒ€ì²´ ë¡œì§ êµ¬í˜„

**ìƒì„¸ ê³„íš**: `PRODUCT_ID_REFACTORING_PLAN.md` ì°¸ì¡°

---

## ğŸ“… ì‹¤í–‰ ìˆœì„œ ë° ì˜ì¡´ì„± ê·¸ë˜í”„ (2026-01-16 ì—…ë°ì´íŠ¸)

### ğŸ”´ ì¦‰ì‹œ ì‹¤í–‰ í•„ìš” (ì‹¬ê°í•œ ìœ„ë°˜ ìˆ˜ì •)
1. **Phase -1**: `orders.status` ì§ì ‘ ì—…ë°ì´íŠ¸ ì œê±° (1-2ì‹œê°„)
   - `backend/payments-routes.js` ìˆ˜ì •
   - `backend/index.js` ìˆ˜ì • (API ì œê±° ë˜ëŠ” ì§‘ê³„ í•¨ìˆ˜ë¡œ ë³€ê²½)

### âœ… ì™„ë£Œëœ ì‘ì—…
2. **Phase 0**: ì˜µì…˜ API ê°œì„  (ì™„ë£Œ)
3. **Phase 1**: ìƒ‰ìƒ ë°ì´í„° ì†ŒìŠ¤ ê°œì„  (ì™„ë£Œ)
4. **Phase 11**: `orders.status` ì§‘ê³„ í•¨ìˆ˜ (ì™„ë£Œ)
5. **Phase 15-1**: `product_options` í…Œì´ë¸” ìƒì„± (ì™„ë£Œ)
6. **Phase 15-2**: ì˜µì…˜ API ìˆ˜ì • (ì™„ë£Œ)
7. **DB ë§ˆì´ê·¸ë ˆì´ì…˜**: `orders.status` ì²´í¬ ì œì•½ ìˆ˜ì • (079_fix_orders_status_check_constraint.sql ì™„ë£Œ)

### Phase 2 ì™„ë£Œ í›„ ê°€ëŠ¥
8. **Phase 3**: processPaidOrder() ì—…ë°ì´íŠ¸ (warranties ì»¬ëŸ¼ ë°˜ì˜)
9. **Phase 5**: ë³´ì¦ì„œ í™œì„±í™” API (ğŸ”´ ë†’ì€ ìš°ì„ ìˆœìœ„)
10. **Phase 7**: QR ìŠ¤ìº” ë¡œì§ ìˆ˜ì •
11. **Phase 12**: ê´€ë¦¬ì í˜ì´ì§€ ê°œì„ 

### Phase 2 + Phase 3 ì™„ë£Œ í›„ ê°€ëŠ¥
12. **Phase 4**: ì„ ì˜ˆì•½í˜• ì¬ê³  ê´€ë¦¬ (ì„ íƒì , í˜„ì¬ ë°©ì‹ë„ ë™ì‘)

### Phase 2 + Phase 5 ì™„ë£Œ í›„ ê°€ëŠ¥
13. **Phase 6**: Claim API (ğŸ”´ ë†’ì€ ìš°ì„ ìˆœìœ„)
14. **Phase 8**: ì–‘ë„ ì‹œìŠ¤í…œ (ğŸŸ¡ ì¤‘ê°„ ìš°ì„ ìˆœìœ„)
15. **Phase 9**: í™˜ë¶ˆ ì²˜ë¦¬ API (ğŸŸ¡ ì¤‘ê°„ ìš°ì„ ìˆœìœ„)

### Phase 2 + Phase 6 ì™„ë£Œ í›„ ê°€ëŠ¥
16. **Phase 10**: ë¹„íšŒì› ì£¼ë¬¸ ì¡°íšŒ API (ì™„ë£Œ)
17. **Phase 14**: í”„ë¡ íŠ¸ì—”ë“œ ì‚¬ìš©ì í˜ì´ì§€

### Phase 2 + Phase 12 ì™„ë£Œ í›„ ê°€ëŠ¥
18. **Phase 12**: ë°°ì†¡/ì†¡ì¥ ê´€ë¦¬ API

### ì¤‘ê¸° ê°œì„  (ì„ íƒì )
19. **Phase 15-3**: ê´€ë¦¬ì í˜ì´ì§€ ì˜µì…˜ ê´€ë¦¬ ê¸°ëŠ¥

### ì¥ê¸° ë¦¬íŒ©í† ë§ (ì„ íƒì )
20. **Phase 16**: product_id ìŠ¬ë˜ì‹œ ì œê±°

---

## ğŸ”„ ì „ì²´ íë¦„ ê²€ì¦ ì²´í¬ë¦¬ìŠ¤íŠ¸

### QR ì½”ë“œ íë¦„
- [x] Paid ì²˜ë¦¬ ì‹œ warranties ìƒì„± (`status = 'issued'` ë˜ëŠ” `'issued_unassigned'`) - Phase 3 ì™„ë£Œ
- [x] QR ìŠ¤ìº” ì‹œ warranty ì¡°íšŒë§Œ ìˆ˜í–‰ (ìƒì„± ì œê±°) - Phase 7 ì™„ë£Œ
- [x] QR ìŠ¤ìº” ì‹œ revoked ìƒíƒœ ë³´ì¦ì„œ ì ‘ê·¼ ê±°ë¶€ - Phase 7 ì™„ë£Œ
- [x] ê´€ë¦¬ì í˜ì´ì§€ì—ì„œ QR ì½”ë“œ ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥ - Phase 0 ì™„ë£Œ

### ë””ì§€í„¸ ë³´ì¦ì„œ íë¦„
- [x] ë³´ì¦ì„œ í™œì„±í™” API ì •ìƒ ë™ì‘ (ì¸ë³´ì´ìŠ¤ ì—°ë™ í™•ì¸ í¬í•¨) - Phase 5 ì™„ë£Œ
- [x] í™œì„±í™”ëœ ë³´ì¦ì„œë§Œ ì–‘ë„ ê°€ëŠ¥ - Phase 8 ì™„ë£Œ
- [x] ì–‘ë„ ì‹œ ì†Œìœ ìë§Œ ë³€ê²½, ìƒíƒœëŠ” active ìœ ì§€ - Phase 8 ì™„ë£Œ
- [x] í™˜ë¶ˆ ì‹œ warranties.status â†’ revoked ì „ì´ - Phase 9 ì™„ë£Œ
- [ ] ì¬íŒë§¤ ì‹œ ê¸°ì¡´ revoked warranties ì—…ë°ì´íŠ¸
- [ ] ê´€ë¦¬ì í˜ì´ì§€ì—ì„œ ë³´ì¦ì„œ ìƒì„¸ ì¡°íšŒ ê°€ëŠ¥

### ì¸ë³´ì´ìŠ¤ íë¦„
- [ ] Paid ì²˜ë¦¬ ì‹œ ì¸ë³´ì´ìŠ¤ ìƒì„±
- [ ] ì¸ë³´ì´ìŠ¤ ì´ë©”ì¼ ë°œì†¡ (íšŒì›/ë¹„íšŒì› êµ¬ë¶„)
- [ ] ë¹„íšŒì› ì£¼ë¬¸ ì¡°íšŒ ì‹œ ì¸ë³´ì´ìŠ¤ ì •ë³´ í‘œì‹œ
- [ ] Claim ì‹œ ì¸ë³´ì´ìŠ¤ ì—°ë™ í™•ì¸
- [ ] ê´€ë¦¬ì í˜ì´ì§€ì—ì„œ ì¸ë³´ì´ìŠ¤ ì •ë³´ í‘œì‹œ

---

## âš ï¸ ì£¼ì˜ì‚¬í•­ ë° ë¦¬ìŠ¤í¬ ê´€ë¦¬

### 1. ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ ë¦¬ìŠ¤í¬
- **ë¦¬ìŠ¤í¬**: ê¸°ì¡´ ë°ì´í„° ì†ì‹¤
- **ëŒ€ì‘**: ëª¨ë“  ë§ˆì´ê·¸ë ˆì´ì…˜ ì „ ë°±ì—… í•„ìˆ˜
- **ê²€ì¦**: ë§ˆì´ê·¸ë ˆì´ì…˜ í›„ ë°ì´í„° ì •í•©ì„± í™•ì¸
- **íŠ¹ë³„ ì£¼ì˜**: `token_pk` ë§ˆì´ê·¸ë ˆì´ì…˜ì€ PK êµì²´ì´ë¯€ë¡œ ì˜µì…˜ A(í…Œì´ë¸” ì¬ìƒì„± ìŠ¤ì™‘) ê¶Œì¥

### 2. ë™ì‹œì„± ë¬¸ì œ
- **ë¦¬ìŠ¤í¬**: ì¬ê³  ê²½í•©, ì´ì¤‘ íŒë§¤
- **ëŒ€ì‘**: 
  - `FOR UPDATE SKIP LOCKED` ì‚¬ìš© (MySQL 8.0+)
  - **ë½ ìˆœì„œ ê³ ì •**: `stock_units`(ë¬¼ë¦¬) â†’ `orders`(ê²°ì œ) â†’ `warranties`(ê¶Œë¦¬) â†’ `invoices`(ë¬¸ì„œ)
  - `order_item_units.active_lock` íŒ¨í„´ìœ¼ë¡œ ì´ì¤‘ íŒë§¤ ë°©ì§€
- **ê²€ì¦**: ë™ì‹œì„± í…ŒìŠ¤íŠ¸ í•„ìˆ˜

### 3. ìƒíƒœ ì „ì´ ì˜¤ë¥˜
- **ë¦¬ìŠ¤í¬**: ì˜ëª»ëœ ìƒíƒœ ì „ì´
- **ëŒ€ì‘**: 
  - ì›ìì  ì¡°ê±´ ê²€ì¦ (`affectedRows=1`), ìƒíƒœ ì „ì´í‘œ ì¤€ìˆ˜
  - **DB ë ˆë²¨ ì œì•½**: ENUM ë˜ëŠ” CHECK ì œì•½ìœ¼ë¡œ ì •ì˜ë˜ì§€ ì•Šì€ ìƒíƒœê°’ ì°¨ë‹¨
  - **ì• í”Œë¦¬ì¼€ì´ì…˜ ê°€ë“œ**: `owner_user_id` ì¡°ê±´ë¶€ NOT NULL ê·œì¹™ ê°•ì œ
- **ê²€ì¦**: ê° ìƒíƒœ ì „ì´ API í…ŒìŠ¤íŠ¸

### 4. ë©±ë“±ì„± ë¬¸ì œ
- **ë¦¬ìŠ¤í¬**: ì¤‘ë³µ ì²˜ë¦¬, ì¬ì‹œë„/ì¤‘ë³µ ì›¹í›…
- **ëŒ€ì‘**: 
  - UNIQUE ì œì•½ (`paid_events`, `order_idempotency`, `warranties.active_key` ë“±)
  - ë©±ë“±ì„± ì²´í¬ (ê° ë‹¨ê³„ë³„)
  - **ë©±ë“±ì„± ê³„ì¸µí‘œ ì¤€ìˆ˜** (FINAL_EXECUTION_SPEC_REVIEW.md 2067-2173ì¤„ ì°¸ì¡°)
- **ê²€ì¦**: ì¬ì‹œë„ í…ŒìŠ¤íŠ¸, ì¤‘ë³µ ì›¹í›… í…ŒìŠ¤íŠ¸

### 5. ì¬ê³  í•´ì œ ê·œì¹™ (SSOT ì›ì¹™ ì¤€ìˆ˜)
- **ë¦¬ìŠ¤í¬**: `orders.status`ë¡œ íŒì •í•˜ë©´ SSOT ì›ì¹™ ìœ„ë°°
- **ëŒ€ì‘**: 
  - **ë°˜ë“œì‹œ `paid_events` ì¡´ì¬ ì—¬ë¶€ ë˜ëŠ” `paid_at` ê¸°ì¤€ìœ¼ë¡œ íŒì •**
  - `orders.status` ì‚¬ìš© ê¸ˆì§€ (ì§‘ê³„ ê²°ê³¼ì¼ ë¿)
- **ê²€ì¦**: ë°°ì¹˜ ì‘ì—… í…ŒìŠ¤íŠ¸

### 6. ì¬íŒë§¤ ì‹œ ë™ì‹œì„± ë¬¸ì œ
- **ë¦¬ìŠ¤í¬**: ë™ì‹œì— ë‘ ì£¼ë¬¸ì´ ê°™ì€ ì¬ê³ ë¥¼ ì¡ëŠ” ê²½ìš°
- **ëŒ€ì‘**: 
  - ì¬íŒë§¤ ë¡œì§ì€ ë°˜ë“œì‹œ `stock_units ë½ â†’ order_item_units ìƒì„± â†’ warranties ì—…ë°ì´íŠ¸`ê°€ í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜
  - `revoked` â†’ `issued` ì „ì´ëŠ” **ìƒˆë¡œìš´ `paid_events`ê°€ ìƒì„±ëœ ê²½ìš°ë§Œ í—ˆìš©**
  - ê´€ë¦¬ì ìˆ˜ë™ ë³€ê²½ ê¸ˆì§€
- **ê²€ì¦**: ì¬íŒë§¤ ë™ì‹œì„± í…ŒìŠ¤íŠ¸

### 7. warranty_events ê°ì‚¬ ë¡œê·¸ ì¦ê±°ì„±
- **ë¦¬ìŠ¤í¬**: ìƒíƒœ ì „ì´ì™€ ë¡œê·¸ê°€ ë¶„ë¦¬ë˜ë©´ ì¦ê±°ê°€ ëŠê¹€
- **ëŒ€ì‘**: 
  - **Outbox íŒ¨í„´**: íŠ¸ëœì­ì…˜ ë‚´ ìµœì†Œ ì´ë²¤íŠ¸ ê¸°ë¡ í•„ìˆ˜
  - **ì´ë²¤íŠ¸ INSERT ì‹¤íŒ¨ ì‹œ ì „ì´ë„ ë¡¤ë°±** (ì¦ê±°ì„± ë³´ì¥)
  - ìƒì„¸ ë¡œê·¸/ì™¸ë¶€ ì „ì†¡ì€ ë¹„ë™ê¸°ë¡œ í™•ì¥
- **ê²€ì¦**: ì´ë²¤íŠ¸ ë¡œê¹… í…ŒìŠ¤íŠ¸

### 8. orders.status ì§‘ê³„ ë³µì¡ì„±
- **ë¦¬ìŠ¤í¬**: ë¶€ë¶„ë°°ì†¡ ì‹œ ì§‘ê³„ ë¡œì§ ë³µì¡
- **ëŒ€ì‘**: 
  - ì• í”Œë¦¬ì¼€ì´ì…˜ ë ˆë²¨ ì§‘ê³„ í•¨ìˆ˜ êµ¬í˜„
  - `partial_shipped`, `partial_delivered` ìƒíƒœ ì§€ì›
  - ê´€ë¦¬ì ìˆ˜ë™ ìˆ˜ì • ê¸ˆì§€
- **ê²€ì¦**: ì§‘ê³„ í•¨ìˆ˜ í…ŒìŠ¤íŠ¸

---

## ğŸ“Š orders.status ì§‘ê³„ ê·œì¹™ í‘œ

**âš ï¸ ì¤‘ìš”**: `orders.status`ëŠ” ì§‘ê³„ ê²°ê³¼(ë·°/í‘œì‹œìš©)ì´ë©°, ì§ì ‘ ì •ì±… íŒë‹¨ ê¸°ì¤€ìœ¼ë¡œ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

| ì§‘ê³„ ìƒíƒœ | ì¡°ê±´ | ë¹„ê³  |
|----------|------|------|
| `pending` | `paid_events` ì—†ìŒ (ë˜ëŠ” `paid_at` NULL) | ê²°ì œ ì „ |
| `paid` | `paid_events` ì¡´ì¬ (ë˜ëŠ” `paid_at` NOT NULL) AND `unit`ì´ 1ê°œ ì´ìƒ `reserved` ì´ìƒ ì¡´ì¬ | ê²°ì œ ì™„ë£Œ |
| `partial_shipped` | ì¼ë¶€ `unit` `shipped` ì´ìƒ, ì¼ë¶€ëŠ” `reserved` | ë¶€ë¶„ ë°°ì†¡ (í™•ì •) |
| `shipped` | ëª¨ë“  `unit` `shipped` ì´ìƒ | ì „ì²´ ë°°ì†¡ |
| `partial_delivered` | ì¼ë¶€ `delivered` ì´ìƒ, ì¼ë¶€ `shipped` | ë¶€ë¶„ ë°°ì†¡ ì™„ë£Œ (í™•ì •) |
| `delivered` | ëª¨ë“  `unit` `delivered` ì´ìƒ | ì „ì²´ ë°°ì†¡ ì™„ë£Œ |
| `refunded` | ëª¨ë“  `unit`ì´ í™˜ë¶ˆ ìµœì¢… ìƒíƒœ ë„ë‹¬ | í™˜ë¶ˆ ì™„ë£Œ |

**ê·œì¹™ ê³ ì • ë¬¸ì¥**:
- `orders.status`ëŠ” ê³„ì‚° ê²°ê³¼ë‹¤ (ì§‘ê³„ í•¨ìˆ˜ë¡œë§Œ ê°±ì‹ )
- íŒì •ì— ì‚¬ìš© ê¸ˆì§€ (í™˜ë¶ˆ/ì–‘ë„/ì œì¬ íŒë‹¨ì€ `warranties.status`)
- ê´€ë¦¬ì ìˆ˜ë™ ìˆ˜ì • ê¸ˆì§€
- `partial_*` ì‚¬ìš© í™•ì • (ì„ íƒì´ ì•„ë‹˜)
- **ê²°ì œ SSOT ê³ ì •**: `paid_events` ì¡´ì¬ê°€ SSOTì´ë©°, `paid_at`ì€ ìºì‹œ/íŒŒìƒ í•„ë“œ

## ğŸ“‹ ìƒíƒœ ì „ì´í‘œ (warranties.status)

**âš ï¸ ìš´ì˜ ì •ì±… ê³ ì •**: ì•„ë˜ ì „ì´í‘œëŠ” "ëˆ„ê°€ ì–´ë–¤ ìƒíƒœì—ì„œ ë­˜ ëˆŒëŸ¬ë„ ë˜ëŠ”ì§€"ë¥¼ í•œ ëˆˆì— ë³´ì—¬ì£¼ëŠ” ë‹¨ì¼ ì§„ì‹¤(SSOT)ì…ë‹ˆë‹¤.

| í˜„ì¬ ìƒíƒœ | ì „ì´ ê°€ëŠ¥ ìƒíƒœ | ì „ì´ API/ì¡°ê±´ | ë¹„ê³  |
|----------|--------------|------------|------|
| `issued_unassigned` | `issued` | `claim` | ê³„ì • ì—°ë™ë§Œ |
| | `revoked` | `admin refund` | í™˜ë¶ˆ ìŠ¹ì¸ (ê´€ë¦¬ì ìˆ˜ë™) |
| `issued` | `active` | `activate` | í™œì„±í™” (ë™ì˜ í•„ìˆ˜, ì¸ë³´ì´ìŠ¤ ì—°ë™ í™•ì¸) |
| | `revoked` | `admin refund` | í™˜ë¶ˆ ìŠ¹ì¸ (ê´€ë¦¬ì ìˆ˜ë™) |
| | `suspended` | `admin suspend` | ì œì¬ |
| `active` | `revoked` | `admin refund` | í™˜ë¶ˆ ìŠ¹ì¸ (ê´€ë¦¬ì ìˆ˜ë™) |
| | `suspended` | `admin suspend` | ì œì¬ |
| | `active` (ìœ ì§€) | `transfer` | ì–‘ë„ ì™„ë£Œ (ì†Œìœ ìë§Œ ë³€ê²½, ìƒíƒœëŠ” `active` ìœ ì§€, `ownership_transferred` ì´ë²¤íŠ¸) |
| `revoked` | `issued` / `issued_unassigned` | `paid (ì¬íŒë§¤)` | âš ï¸ **paid_events ìƒì„±ëœ ê²½ìš°ë§Œ í—ˆìš©, ê´€ë¦¬ì ìˆ˜ë™ ë³€ê²½ ê¸ˆì§€, affectedRows=1 ê²€ì¦ í•„ìˆ˜** |
| `suspended` | `issued` | `admin resume` | ì œì¬ í•´ì œ (í™œì„±í™”ëŠ” ë³„ë„ ì ˆì°¨) |

**ì „ì´ ë¶ˆê°€ëŠ¥í•œ ìƒíƒœ**:
- `revoked` â†’ `active` (ì§ì ‘ ì „ì´ ë¶ˆê°€, ì¬íŒë§¤ í›„ í™œì„±í™” í•„ìš”)
- `revoked` â†’ `suspended` (ì˜ë¯¸ ì—†ìŒ)
- `active` â†’ `issued` (ë˜ëŒë¦¬ê¸° ë¶ˆê°€)
- `issued` â†’ `issued_unassigned` (ë˜ëŒë¦¬ê¸° ë¶ˆê°€)

**ëª¨ë“  ìƒíƒœ ë³€ê²½ UPDATEëŠ” ë‹¤ìŒ ì›ì¹™ì„ ë”°ë¼ì•¼ í•¨**:
```sql
-- âœ… ì˜¬ë°”ë¥¸ íŒ¨í„´
UPDATE warranties 
SET status = ?, ...
WHERE warranty_id = ? AND status IN (?, ?, ...)  -- í˜„ì¬ ìƒíƒœ ì¡°ê±´ í¬í•¨
-- affectedRows=1 ê²€ì¦ í•„ìˆ˜
```

## ğŸ”„ ë©±ë“±ì„± ê³„ì¸µí‘œ (ì¬ì‹œë„/ì¤‘ë³µ ì›¹í›… ëŒ€ì‘)

**ë¬¸ì œ**: ìš´ì˜ì—ì„œ ì œì¼ ìì£¼ í„°ì§€ëŠ” ê²Œ "ì¬ì‹œë„"ë‹¤. ê° ë‹¨ê³„ê°€ ì¤‘ë³µ í˜¸ì¶œë¼ë„ ê²°ê³¼ê°€ 1ë²ˆë§Œ ë°˜ì˜ë˜ì–´ì•¼ í•¨

| ë‹¨ê³„ | ë©±ë“±ì„± ë©”ì»¤ë‹ˆì¦˜ | ê²€ì¦ ë°©ë²• | ì‹¤íŒ¨ ì‹œ ì²˜ë¦¬ |
|------|---------------|----------|------------|
| **ì£¼ë¬¸ Paid ì²˜ë¦¬** | `paid_events` UNIQUE(`order_id`, `payment_key`) | INSERT ì‹œ ì¤‘ë³µ ì²´í¬, ì´ë¯¸ ìˆìœ¼ë©´ ì¦‰ì‹œ ì¢…ë£Œ | ì´ë¯¸ ì²˜ë¦¬ë¨ ì‘ë‹µ ë°˜í™˜ |
| **ì¬ê³  ë°°ì •** | `stock_units.status` ê¸°ë°˜ + `FOR UPDATE SKIP LOCKED` | `status = 'in_stock'`ì¸ ê²ƒë§Œ ì„ íƒ, ë½ìœ¼ë¡œ ë™ì‹œì„± ì œì–´ | ì¬ê³  ë¶€ì¡± ì—ëŸ¬ |
| **unit ìƒì„±** | `order_item_units`ì— UNIQUE(`order_item_id`, `unit_seq`) ë˜ëŠ” `stock_unit_id` UNIQUE | INSERT ì‹œ ì¤‘ë³µ ì²´í¬ | ì¤‘ë³µ ì—ëŸ¬ (ì´ë¯¸ ìƒì„±ë¨) |
| **ë³´ì¦ì„œ revive** | `UPDATE ... WHERE status='revoked'` + `affectedRows=1` | ì¡°ê±´ë¶€ UPDATE, affectedRows ê²€ì¦ | affectedRows !== 1ì´ë©´ ì‹¤íŒ¨ |
| **ì–‘ë„ ìˆ˜ë½** | `UPDATE transfers WHERE status='requested' ...` + `affectedRows=1` | ì¡°ê±´ë¶€ UPDATE, affectedRows ê²€ì¦ | affectedRows !== 1ì´ë©´ ì‹¤íŒ¨ |
| **ë³´ì¦ì„œ í™œì„±í™”** | `UPDATE ... WHERE status='issued'` + `affectedRows=1` | ì¡°ê±´ë¶€ UPDATE, affectedRows ê²€ì¦ | affectedRows !== 1ì´ë©´ ì‹¤íŒ¨ |
| **í™˜ë¶ˆ ì²˜ë¦¬** | `UPDATE ... WHERE status IN ('issued', 'issued_unassigned')` + `affectedRows=1` | ì¡°ê±´ë¶€ UPDATE, affectedRows ê²€ì¦ | affectedRows !== 1ì´ë©´ ì‹¤íŒ¨ |

**í•µì‹¬ ì›ì¹™**: **"ê° ë‹¨ê³„ê°€ ì¤‘ë³µ í˜¸ì¶œë¼ë„ ê²°ê³¼ê°€ 1ë²ˆë§Œ ë°˜ì˜"ë˜ëŠ” ê³„ì¸µì„ ë¬¸ì„œì— ë°•ì•„ë‘ëŠ” ê²ƒ**

## ğŸ“ ë‹¤ìŒ ë‹¨ê³„ (2026-01-16 ì—…ë°ì´íŠ¸)

### âœ… ì™„ë£Œëœ ì‘ì—…
1. **Phase -1**: `orders.status` ì§ì ‘ ì—…ë°ì´íŠ¸ ì œê±° (ì™„ë£Œ)
2. **Phase 2**: í•µì‹¬ ì¸í”„ë¼ í…Œì´ë¸” ìƒì„± (ì™„ë£Œ)
3. **Phase 5**: ë³´ì¦ì„œ í™œì„±í™” API (ì™„ë£Œ)
4. **Phase 6**: Claim API (ì™„ë£Œ)
5. **Phase 7**: QR ìŠ¤ìº” ë¡œì§ ìˆ˜ì • (ì™„ë£Œ)
   - warranty ìƒì„± ì œê±°, ì¡°íšŒë§Œ ìˆ˜í–‰
   - revoked ìƒíƒœ ë³´ì¦ì„œ ì ‘ê·¼ ê±°ë¶€
6. **Phase 8**: ì–‘ë„ ì‹œìŠ¤í…œ (ì™„ë£Œ)
   - Phase 8-1: ì–‘ë„ ìš”ì²­ API
   - Phase 8-2: ì–‘ë„ ìˆ˜ë½ API
   - Phase 8-3: ì–‘ë„ ë§Œë£Œ ë°°ì¹˜ ì‘ì—…
   - ì›ìì  ì¡°ê±´ ê²€ì¦
   - warranty_events ì´ë²¤íŠ¸ ê¸°ë¡
7. **Phase 9**: í™˜ë¶ˆ ì²˜ë¦¬ API (ì™„ë£Œ)
   - warranties.statusë§Œ ë³¸ë‹¤ (SSOT)
   - credit_note ìƒì„±
   - warranty_events ì´ë²¤íŠ¸ ê¸°ë¡

### âœ… ì™„ë£Œëœ ì‘ì—… (ê³„ì†)
8. **Phase 8-3**: ì–‘ë„ ë§Œë£Œ ë°°ì¹˜ ì‘ì—… (ì™„ë£Œ)
   - 72ì‹œê°„ ì´ˆê³¼ ì–‘ë„ ìš”ì²­ ìë™ ë§Œë£Œ
   - 1ì‹œê°„ë§ˆë‹¤ ìë™ ì‹¤í–‰
9. **Phase 12**: ë°°ì†¡/ì†¡ì¥ ê´€ë¦¬ API (ì™„ë£Œ)
   - Phase 12-1: ì†¡ì¥ ìƒì„± API (shipments/shipment_units ì‚¬ìš©)
   - Phase 12-2: ë°°ì†¡ ì™„ë£Œ ì²˜ë¦¬ API
   - ê¸°ì¡´ `/shipped` API ìˆ˜ì • ì™„ë£Œ (SSOT ì›ì¹™ ì¤€ìˆ˜)
   - orders.status ì§‘ê³„ í•¨ìˆ˜ ìë™ í˜¸ì¶œ
10. **Phase 10**: ë¹„íšŒì› ì£¼ë¬¸ ì¡°íšŒ API (ì™„ë£Œ)
   - guest_order_sessions í…Œì´ë¸” ìƒì„± (ì˜µì…˜ B: ì„¸ì…˜ í† í° êµí™˜)
   - ì„¸ì…˜ ë°œê¸‰ ì—”ë“œí¬ì¸íŠ¸ (`GET /api/guest/orders/session`)
   - ì£¼ë¬¸ ì¡°íšŒ ì—”ë“œí¬ì¸íŠ¸ (`GET /api/guest/orders/:orderNumber`)
   - order_number ê¸°ë°˜ ì¡°íšŒ (ì¼ê´€ì„± ìœ ì§€)
   - ë°°ì†¡ì§€ ì •ë³´ í¬í•¨ ì‘ë‹µ (ì›ë˜ ê³„íšëŒ€ë¡œ)

### ğŸ”´ ë†’ì€ ìš°ì„ ìˆœìœ„ (í•µì‹¬ ê¸°ëŠ¥ ë¯¸êµ¬í˜„)

### ğŸŸ¡ ì¤‘ê°„ ìš°ì„ ìˆœìœ„ (ìš´ì˜ ê¸°ëŠ¥)

**ì´ ë¬¸ì„œë§Œ ë³´ë©´ ì•ìœ¼ë¡œì˜ ëª¨ë“  êµ¬í˜„ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.**

---

## ğŸ”‘ í•µì‹¬ ì •ë¦¬

### 1. SSOT ì›ì¹™
- **`orders.status`**: ì§‘ê³„ ê²°ê³¼(ë·°/í‘œì‹œìš©), íŒì •ì— ì‚¬ìš© ê¸ˆì§€
- **`order_item_units.unit_status`**: ë¬¼ë¥˜ ë‹¨ìœ„ ìƒíƒœì˜ SSOT
- **`stock_units.status`**: ì‹¤ë¬¼ ì¬ê³  ìƒíƒœì˜ SSOT (`in_stock`ì´ ì¬íŒë§¤ ê°€ëŠ¥ ì—¬ë¶€ì˜ ìµœì¢… ê²Œì´íŠ¸)
- **`warranties.status`**: ê¶Œë¦¬/ì •ì±… ìƒíƒœì˜ SSOT (í™˜ë¶ˆ/ì–‘ë„/í™œì„±í™” íŒì • ê¸°ì¤€)
- **`invoices`**: ë¬¸ì„œ(ìŠ¤ëƒ…ìƒ·), ì¦ë¹™/ì¡°íšŒ ì—­í• , íŒì •ì— ì‚¬ìš© ê¸ˆì§€

### 2. ë½ ìˆœì„œ (í•„ìˆ˜)
**ì „ì—­ ë½ ìˆœì„œ**: `stock_units`(ë¬¼ë¦¬) â†’ `orders`(ê²°ì œ) â†’ `warranties`(ê¶Œë¦¬) â†’ `invoices`(ë¬¸ì„œ)

### 3. ë©±ë“±ì„± ë³´ì¥
- `paid_events`: UNIQUE(`order_id`, `payment_key`)
- `order_item_units`: UNIQUE(`stock_unit_id`, `active_lock`)
- `warranties`: UNIQUE(`token_pk`) ë˜ëŠ” `active_key` íŒ¨í„´
- ëª¨ë“  ìƒíƒœ ì „ì´: `UPDATE ... WHERE ì¡°ê±´` + `affectedRows=1` ê²€ì¦

### 4. ì¬íŒë§¤ ì •ì±…
- **ê°™ì€ token ì‚¬ìš©**: í† í° ì¬ë°œê¸‰ ì—†ìŒ
- **ê¸°ì¡´ warranties ì—…ë°ì´íŠ¸**: ìƒˆë¡œìš´ ë ˆì½”ë“œ ìƒì„±í•˜ì§€ ì•ŠìŒ
- **revoked â†’ issued ì „ì´**: `paid_events` ìƒì„±ëœ ê²½ìš°ë§Œ í—ˆìš©, ê´€ë¦¬ì ìˆ˜ë™ ë³€ê²½ ê¸ˆì§€
- **revoked_at ìœ ì§€**: ì¬íŒë§¤ ì‹œì—ë„ `revoked_at`ì€ ê·¸ëŒ€ë¡œ ìœ ì§€ (Aì•ˆ í™•ì •, ì´ë ¥)

### 5. í™˜ë¶ˆ ì •ì±…
- **ê³ ê° ì§ì ‘ ìš”ì²­ ë¶ˆê°€**: ë¬¸ì˜ ì‹œìŠ¤í…œìœ¼ë¡œë§Œ ì ‘ìˆ˜
- **ê´€ë¦¬ì ìˆ˜ë™ ì²˜ë¦¬**: ì‹œë¦¬ì–¼ ë„˜ë²„ì™€ í† í° í™•ì¸ í›„ í™˜ë¶ˆ ì²˜ë¦¬
- **íŒì • ê¸°ì¤€**: `warranties.status`ë§Œ ë³¸ë‹¤ (SSOT)
- **í† í° ì¬ë°œê¸‰ ì—†ìŒ**: ì‹¤ë¬¼ ë³´ì¦ì„œì— ì´ë¯¸ QR ì¸ì‡„ë˜ì–´ ìˆìŒ

### 6. í™œì„±í™” ì •ì±…
- **ì²« í™œì„±í™” ì‹œ ì¸ë³´ì´ìŠ¤ ì—°ë™ í™•ì¸**: í•µì‹¬ ë°©ì–´ ë©”ì»¤ë‹ˆì¦˜ (í™˜ë¶ˆ í›„ QR ì½”ë“œ ì•…ìš© ë°©ì§€)
- **ì–‘ë„ ì‹œ ì¸ë³´ì´ìŠ¤ ì—°ë™ í™•ì¸ ë¶ˆí•„ìš”**: `active` ìƒíƒœ ìœ ì§€, ì†Œìœ ìë§Œ ë³€ê²½

### 7. ì–‘ë„ ì •ì±…
- **í™œì„±í™”ëœ ë³´ì¦ì„œë§Œ ì–‘ë„ ê°€ëŠ¥**: `status = 'active'`
- **ì†Œìœ ìë§Œ ë³€ê²½**: `status = 'active'` ìœ ì§€
- **ì›ìì  ì¡°ê±´ ê²€ì¦**: `affectedRows=1` ê²€ì¦ í•„ìˆ˜
- **1í† í° = 1ì†Œìœ ì**: ì–‘ë„ í›„ ì›ë˜ ì†Œìœ ìëŠ” ì ‘ê·¼ ë¶ˆê°€

---

**ë¬¸ì„œ ë²„ì „**: 2.2  
**ì‘ì„±ì¼**: 2026-01-11  
**ìµœì¢… ìˆ˜ì •ì¼**: 2026-01-16  
**ê¸°ì¤€ ë¬¸ì„œ**: `SYSTEM_FLOW_DETAILED.md`, `FINAL_EXECUTION_SPEC_REVIEW.md`, `ADMIN_QR_WARRANTY_INVOICE_CONSISTENCY_CHECK.md`, `IMPLEMENTATION_DESIGN_COMPARISON.md`

**ì£¼ìš” ë³€ê²½ì‚¬í•­ (v2.2)**:
- Phase -1 ì™„ë£Œ: `orders.status` ì§ì ‘ ì—…ë°ì´íŠ¸ ì œê±°
- Phase 5 ì™„ë£Œ: ë³´ì¦ì„œ í™œì„±í™” API êµ¬í˜„
- Phase 6 ì™„ë£Œ: Claim API êµ¬í˜„ (claim token ìœ íš¨ ì‹œê°„ 30ë¶„ìœ¼ë¡œ ë³€ê²½)
- Phase 7 ì™„ë£Œ: QR ìŠ¤ìº” ë¡œì§ ìˆ˜ì • (warranty ìƒì„± ì œê±°, ì¡°íšŒë§Œ ìˆ˜í–‰)
- Phase 8 ì™„ë£Œ: ì–‘ë„ ì‹œìŠ¤í…œ êµ¬í˜„ (ì–‘ë„ ìš”ì²­/ìˆ˜ë½ API, ë§Œë£Œ ë°°ì¹˜ ì‘ì—…)
- Phase 9 ì™„ë£Œ: í™˜ë¶ˆ ì²˜ë¦¬ API êµ¬í˜„ (ê´€ë¦¬ì ì „ìš©, credit_note ìƒì„± í¬í•¨)
- Phase 12 ì™„ë£Œ: ë°°ì†¡/ì†¡ì¥ ê´€ë¦¬ API êµ¬í˜„ (shipments/shipment_units ì‚¬ìš©)
- í˜„ì¬ êµ¬í˜„ ìƒíƒœ ì„¹ì…˜ ì—…ë°ì´íŠ¸

**ì£¼ìš” ë³€ê²½ì‚¬í•­ (v2.1)**:
- Phase -1 ì¶”ê°€: `orders.status` ì§ì ‘ ì—…ë°ì´íŠ¸ ì œê±° (ì¦‰ì‹œ ìˆ˜ì • í•„ìš”)
- ì™„ë£Œëœ ì‘ì—… ë°˜ì˜: Phase 0, 1, 11, 15-1, 15-2, DB ë§ˆì´ê·¸ë ˆì´ì…˜
- ìš°ì„ ìˆœìœ„ ì¬ì •ë¦½: ì‹¬ê°í•œ ìœ„ë°˜ â†’ ë†’ì€ ìš°ì„ ìˆœìœ„ â†’ ì¤‘ê°„ ìš°ì„ ìˆœìœ„
- ì‹¤í–‰ ìˆœì„œ ì—…ë°ì´íŠ¸: ì˜ì¡´ì„± ê·¸ë˜í”„ ì¬êµ¬ì„±
